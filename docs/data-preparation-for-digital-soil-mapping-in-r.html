<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 1 Data preparation for Digital Soil Mapping in R | DRAFT - Integrated soil information for decision-making </title>
  <meta name="description" content="SoilFER SID Technical Manual" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 Data preparation for Digital Soil Mapping in R | DRAFT - Integrated soil information for decision-making " />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="SoilFER SID Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 1 Data preparation for Digital Soil Mapping in R | DRAFT - Integrated soil information for decision-making " />
  
  <meta name="twitter:description" content="SoilFER SID Technical Manual" />
  

<meta name="author" content="Angelini, M.E, Rodriguez Lado, L.,de Sousa Mendes, W., Ribeiro, E., Luotto, I." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction-to-r-programming.html"/>
<link rel="next" href="sampling-design-for-soil-surveys.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors-and-reviewers.html"><a href="contributors-and-reviewers.html"><i class="fa fa-check"></i>Contributors and reviewers</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html"><i class="fa fa-check"></i>Presentation and basics</a>
<ul>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#background-and-objective"><i class="fa fa-check"></i>Background and Objective</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#what-this-tutorial-is-not"><i class="fa fa-check"></i>What this Tutorial is not</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#how-to-use-this-book"><i class="fa fa-check"></i>How to use this book</a>
<ul>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#required-downloads"><i class="fa fa-check"></i>Required downloads</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#step-by-step-setup-instructions"><i class="fa fa-check"></i>Step-by-step setup instructions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html"><i class="fa fa-check"></i>Introduction to R programming</a>
<ul>
<li class="chapter" data-level="0.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#what-is-r"><i class="fa fa-check"></i><b>0.1</b> What is R?</a>
<ul>
<li class="chapter" data-level="0.1.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#why-r-for-soil-science"><i class="fa fa-check"></i><b>0.1.1</b> Why R for Soil Science?</a></li>
</ul></li>
<li class="chapter" data-level="0.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-r-and-rstudio"><i class="fa fa-check"></i><b>0.2</b> Installing R and RStudio</a>
<ul>
<li class="chapter" data-level="0.2.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-r"><i class="fa fa-check"></i><b>0.2.1</b> Installing R</a></li>
<li class="chapter" data-level="0.2.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-rstudio"><i class="fa fa-check"></i><b>0.2.2</b> Installing RStudio</a></li>
<li class="chapter" data-level="0.2.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#verifying-installation"><i class="fa fa-check"></i><b>0.2.3</b> Verifying Installation</a></li>
</ul></li>
<li class="chapter" data-level="0.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#understanding-the-rstudio-interface"><i class="fa fa-check"></i><b>0.3</b> Understanding the RStudio Interface</a>
<ul>
<li class="chapter" data-level="0.3.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#console-pane-bottom-left"><i class="fa fa-check"></i><b>0.3.1</b> 1. Console Pane (Bottom Left)</a></li>
<li class="chapter" data-level="0.3.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#code-editor-pane-top-left"><i class="fa fa-check"></i><b>0.3.2</b> 2. Code Editor Pane (Top Left)</a></li>
<li class="chapter" data-level="0.3.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#environmenthistory-pane-top-right"><i class="fa fa-check"></i><b>0.3.3</b> 3. Environment/History Pane (Top Right)</a></li>
<li class="chapter" data-level="0.3.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#filesplotspackageshelp-pane-bottom-right"><i class="fa fa-check"></i><b>0.3.4</b> 4. Files/Plots/Packages/Help Pane (Bottom Right)</a></li>
</ul></li>
<li class="chapter" data-level="0.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#r-packages-extending-rs-capabilities"><i class="fa fa-check"></i><b>0.4</b> R Packages: Extending R’s Capabilities</a>
<ul>
<li class="chapter" data-level="0.4.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#what-are-packages"><i class="fa fa-check"></i><b>0.4.1</b> What are Packages?</a></li>
<li class="chapter" data-level="0.4.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-packages"><i class="fa fa-check"></i><b>0.4.2</b> Installing Packages</a></li>
<li class="chapter" data-level="0.4.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#loading-packages"><i class="fa fa-check"></i><b>0.4.3</b> Loading Packages</a></li>
<li class="chapter" data-level="0.4.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#finding-help-on-packages"><i class="fa fa-check"></i><b>0.4.4</b> Finding Help on Packages</a></li>
</ul></li>
<li class="chapter" data-level="0.5" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#object-types"><i class="fa fa-check"></i><b>0.5</b> R Basics: Objects and Data Types</a>
<ul>
<li class="chapter" data-level="0.5.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#object-assignment"><i class="fa fa-check"></i><b>0.5.1</b> Creating Objects with Assignment</a></li>
<li class="chapter" data-level="0.5.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#data-types"><i class="fa fa-check"></i><b>0.5.2</b> Data Types in R</a></li>
<li class="chapter" data-level="0.5.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#check-data"><i class="fa fa-check"></i><b>0.5.3</b> Checking Data Types</a></li>
</ul></li>
<li class="chapter" data-level="0.6" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#structure-data"><i class="fa fa-check"></i><b>0.6</b> Data Structures in R</a>
<ul>
<li class="chapter" data-level="0.6.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#vector-data"><i class="fa fa-check"></i><b>0.6.1</b> Vectors</a></li>
<li class="chapter" data-level="0.6.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#factor-data"><i class="fa fa-check"></i><b>0.6.2</b> Factors</a></li>
<li class="chapter" data-level="0.6.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#matrix-data"><i class="fa fa-check"></i><b>0.6.3</b> Matrices</a></li>
<li class="chapter" data-level="0.6.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dataframe"><i class="fa fa-check"></i><b>0.6.4</b> Data Frames</a></li>
<li class="chapter" data-level="0.6.5" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#list-data"><i class="fa fa-check"></i><b>0.6.5</b> Lists</a></li>
</ul></li>
<li class="chapter" data-level="0.7" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#operators"><i class="fa fa-check"></i><b>0.7</b> Operators in R</a>
<ul>
<li class="chapter" data-level="0.7.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#arithmetic-operators"><i class="fa fa-check"></i><b>0.7.1</b> Arithmetic Operators</a></li>
<li class="chapter" data-level="0.7.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#comparison-operators"><i class="fa fa-check"></i><b>0.7.2</b> Comparison Operators</a></li>
<li class="chapter" data-level="0.7.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#logical-operators"><i class="fa fa-check"></i><b>0.7.3</b> Logical Operators</a></li>
</ul></li>
<li class="chapter" data-level="0.8" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#conditional-statements"><i class="fa fa-check"></i><b>0.8</b> Control Structures: Conditional Statements</a>
<ul>
<li class="chapter" data-level="0.8.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#ifelse-statements"><i class="fa fa-check"></i><b>0.8.1</b> If-Else Statements</a></li>
<li class="chapter" data-level="0.8.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#v-ifelse-statements"><i class="fa fa-check"></i><b>0.8.2</b> Vectorized If-Else: <code>ifelse()</code></a></li>
<li class="chapter" data-level="0.8.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#cut-statements"><i class="fa fa-check"></i><b>0.8.3</b> Vectorized Cut: <code>cut()</code></a></li>
</ul></li>
<li class="chapter" data-level="0.9" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#control-structures"><i class="fa fa-check"></i><b>0.9</b> Control Structures: Loops</a>
<ul>
<li class="chapter" data-level="0.9.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#for-loop"><i class="fa fa-check"></i><b>0.9.1</b> For Loops</a></li>
<li class="chapter" data-level="0.9.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#while-loop"><i class="fa fa-check"></i><b>0.9.2</b> While Loops</a></li>
</ul></li>
<li class="chapter" data-level="0.10" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#r-funtions"><i class="fa fa-check"></i><b>0.10</b> Functions in R</a>
<ul>
<li class="chapter" data-level="0.10.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#built-funtions"><i class="fa fa-check"></i><b>0.10.1</b> Using Built-in Functions</a></li>
<li class="chapter" data-level="0.10.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#build-functions"><i class="fa fa-check"></i><b>0.10.2</b> Creating Custom Functions</a></li>
<li class="chapter" data-level="0.10.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#arguments-functions"><i class="fa fa-check"></i><b>0.10.3</b> Function Arguments and Defaults</a></li>
</ul></li>
<li class="chapter" data-level="0.11" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#R-data-manipulation"><i class="fa fa-check"></i><b>0.11</b> Data Manipulation with Base R</a>
<ul>
<li class="chapter" data-level="0.11.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#R-data-subset"><i class="fa fa-check"></i><b>0.11.1</b> Subsetting and Filtering</a></li>
<li class="chapter" data-level="0.11.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#delete-cols"><i class="fa fa-check"></i><b>0.11.2</b> Deleting Columns</a></li>
<li class="chapter" data-level="0.11.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#sort-rows"><i class="fa fa-check"></i><b>0.11.3</b> Sorting Data</a></li>
<li class="chapter" data-level="0.11.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#aggregate-rows"><i class="fa fa-check"></i><b>0.11.4</b> Aggregating Data</a></li>
</ul></li>
<li class="chapter" data-level="0.12" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-manipultation"><i class="fa fa-check"></i><b>0.12</b> Data Manipulation with the Tidyverse</a>
<ul>
<li class="chapter" data-level="0.12.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-load"><i class="fa fa-check"></i><b>0.12.1</b> Loading the Tidyverse</a></li>
<li class="chapter" data-level="0.12.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-tibbles"><i class="fa fa-check"></i><b>0.12.2</b> Tibbles: Modern Data Frames</a></li>
<li class="chapter" data-level="0.12.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-pipe"><i class="fa fa-check"></i><b>0.12.3</b> The Pipe Operator: <code>%&gt;%</code></a></li>
<li class="chapter" data-level="0.12.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#manipulation-dplyr"><i class="fa fa-check"></i><b>0.12.4</b> Data Manipulation with <code>{dplyr}</code></a></li>
<li class="chapter" data-level="0.12.5" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-rename"><i class="fa fa-check"></i><b>0.12.5</b> Renaming Columns with <code>rename()</code></a></li>
<li class="chapter" data-level="0.12.6" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-group"><i class="fa fa-check"></i><b>0.12.6</b> Grouping and Summarizing Data by columns</a></li>
</ul></li>
<li class="chapter" data-level="0.13" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-join"><i class="fa fa-check"></i><b>0.13</b> Combining Data Frames</a>
<ul>
<li class="chapter" data-level="0.13.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#understand-joins"><i class="fa fa-check"></i><b>0.13.1</b> Understanding Joins</a></li>
<li class="chapter" data-level="0.13.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-bind_rows"><i class="fa fa-check"></i><b>0.13.2</b> Stacking Data with <code>bind_rows()</code></a></li>
</ul></li>
<li class="chapter" data-level="0.14" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#NA"><i class="fa fa-check"></i><b>0.14</b> Missing Data</a>
<ul>
<li class="chapter" data-level="0.14.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#identify-NA"><i class="fa fa-check"></i><b>0.14.1</b> Identifying Missing Data</a></li>
<li class="chapter" data-level="0.14.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#handle-NA"><i class="fa fa-check"></i><b>0.14.2</b> Handling Missing Data</a></li>
</ul></li>
<li class="chapter" data-level="0.15" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#pivoting"><i class="fa fa-check"></i><b>0.15</b> Data Reshaping with <code>{tidyr}</code> package: Pivoting</a></li>
<li class="chapter" data-level="0.16" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dl-data"><i class="fa fa-check"></i><b>0.16</b> Handling Below Detection Limit Data</a></li>
<li class="chapter" data-level="0.17" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#soil-data"><i class="fa fa-check"></i><b>0.17</b> Working with Soil Data</a>
<ul>
<li class="chapter" data-level="0.17.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#set-directory"><i class="fa fa-check"></i><b>0.17.1</b> Setting Working Directory</a></li>
<li class="chapter" data-level="0.17.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#load-packages"><i class="fa fa-check"></i><b>0.17.2</b> Load packages</a></li>
<li class="chapter" data-level="0.17.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#import-files"><i class="fa fa-check"></i><b>0.17.3</b> Importing Data from Files</a></li>
<li class="chapter" data-level="0.17.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#data-exploration"><i class="fa fa-check"></i><b>0.17.4</b> Exploring the Data</a></li>
</ul></li>
<li class="chapter" data-level="0.18" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#references-m1"><i class="fa fa-check"></i><b>0.18</b> References</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html"><i class="fa fa-check"></i><b>1</b> Data preparation for Digital Soil Mapping in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#introduction-1"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#loading-data"><i class="fa fa-check"></i><b>1.2</b> Loading and exploring raw soil data</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#basic-data-loading-and-structure"><i class="fa fa-check"></i><b>1.2.1</b> Basic data loading and structure</a></li>
<li class="chapter" data-level="1.2.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#data-components-and-organization"><i class="fa fa-check"></i><b>1.2.2</b> Data components and organization</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#site-data-preparation"><i class="fa fa-check"></i><b>1.3</b> Preparing site data for analysis</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#adding-a-unique-row-identifier"><i class="fa fa-check"></i><b>1.3.1</b> Adding a unique row identifier</a></li>
<li class="chapter" data-level="1.3.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#extracting-and-standardizing-column-names-for-sites"><i class="fa fa-check"></i><b>1.3.2</b> Extracting and standardizing column names for sites</a></li>
<li class="chapter" data-level="1.3.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#creating-unique-profile-identifiers"><i class="fa fa-check"></i><b>1.3.3</b> Creating unique profile identifiers</a></li>
<li class="chapter" data-level="1.3.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#remove-exact-duplicate-site-records"><i class="fa fa-check"></i><b>1.3.4</b> Remove exact duplicate site records</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#coordinate-validation"><i class="fa fa-check"></i><b>1.4</b> Coordinate validation and correction</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-missing-coordinates"><i class="fa fa-check"></i><b>1.4.1</b> Check 1: Missing coordinates</a></li>
<li class="chapter" data-level="1.4.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-valid-coordinate-ranges"><i class="fa fa-check"></i><b>1.4.2</b> Check 2: Valid coordinate ranges</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#depth-validation"><i class="fa fa-check"></i><b>1.5</b> Soil depth validation and correction</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-missing-depth-boundaries"><i class="fa fa-check"></i><b>1.5.1</b> Check 1: Missing depth boundaries</a></li>
<li class="chapter" data-level="1.5.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-negative-depth-values"><i class="fa fa-check"></i><b>1.5.2</b> Check 2: Negative depth values</a></li>
<li class="chapter" data-level="1.5.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-3-zero-thickness-intervals"><i class="fa fa-check"></i><b>1.5.3</b> Check 3: Zero-thickness intervals</a></li>
<li class="chapter" data-level="1.5.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-4-invalid-depth-logic"><i class="fa fa-check"></i><b>1.5.4</b> Check 4: Invalid depth logic</a></li>
<li class="chapter" data-level="1.5.5" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-5-profiles-without-a-surface-horizon-top-0"><i class="fa fa-check"></i><b>1.5.5</b> Check 5: Profiles without a surface horizon (top &gt; 0)</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#lab-validation"><i class="fa fa-check"></i><b>1.6</b> Preparing lab data: harmonization and validation</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#prepare-and-standardize-laboratory-columns"><i class="fa fa-check"></i><b>1.6.1</b> Prepare and standardize laboratory columns</a></li>
<li class="chapter" data-level="1.6.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-check-each-property-against-feasible-analytical-thresholds"><i class="fa fa-check"></i><b>1.6.2</b> Check 1: Check each property against feasible analytical thresholds</a></li>
<li class="chapter" data-level="1.6.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-texture-validation"><i class="fa fa-check"></i><b>1.6.3</b> Check 2: Texture validation</a></li>
<li class="chapter" data-level="1.6.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-3-correction-of-out-of-bounds-laboratory-values"><i class="fa fa-check"></i><b>1.6.4</b> Check 3: Correction of out-of-bounds laboratory values</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#duplicate-detection"><i class="fa fa-check"></i><b>1.7</b> Resolving duplicated data in soil profiles</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#why-duplicates-occur"><i class="fa fa-check"></i><b>1.7.1</b> Why duplicates occur</a></li>
<li class="chapter" data-level="1.7.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#types-of-duplicate-situations"><i class="fa fa-check"></i><b>1.7.2</b> Types of duplicate situations</a></li>
<li class="chapter" data-level="1.7.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-detect-potential-horizon-duplicates-within-profiles"><i class="fa fa-check"></i><b>1.7.3</b> Check 1: Detect potential horizon duplicates within profiles</a></li>
<li class="chapter" data-level="1.7.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#resolving-profile-duplicates"><i class="fa fa-check"></i><b>1.7.4</b> Resolving Profile Duplicates</a></li>
<li class="chapter" data-level="1.7.5" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#remove-profiles-not-starting-at-the-surface"><i class="fa fa-check"></i><b>1.7.5</b> Remove profiles not starting at the surface</a></li>
<li class="chapter" data-level="1.7.6" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#result"><i class="fa fa-check"></i><b>1.7.6</b> Result</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#harmonization"><i class="fa fa-check"></i><b>1.8</b> Harmonizing data for DSM</a>
<ul>
<li class="chapter" data-level="1.8.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#depth-standardization"><i class="fa fa-check"></i><b>1.8.1</b> Depth standardization</a></li>
<li class="chapter" data-level="1.8.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#processing-standardized-data"><i class="fa fa-check"></i><b>1.8.2</b> Processing standardized data</a></li>
<li class="chapter" data-level="1.8.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#exporting-standardized-data-for-digital-soil-mapping"><i class="fa fa-check"></i><b>1.8.3</b> Exporting standardized data for Digital Soil Mapping</a></li>
</ul></li>
<li class="chapter" data-level="1.9" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#spectroscopy"><i class="fa fa-check"></i><b>1.9</b> Preparing data for spectroscopy analyses</a></li>
<li class="chapter" data-level="1.10" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#exports"><i class="fa fa-check"></i><b>1.10</b> Summary of exported files</a></li>
<li class="chapter" data-level="" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#references"><i class="fa fa-check"></i>References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html"><i class="fa fa-check"></i><b>2</b> Sampling design for soil surveys</a>
<ul>
<li class="chapter" data-level="2.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#sampling-theory"><i class="fa fa-check"></i><b>2.2</b> Sampling methodologies for soil spatial survey</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#selection-methods"><i class="fa fa-check"></i><b>2.2.1</b> Selection of the sampling methodology</a></li>
<li class="chapter" data-level="2.2.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#inference-methods"><i class="fa fa-check"></i><b>2.2.2</b> Inference Methods</a></li>
<li class="chapter" data-level="2.2.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#sampling-purpose"><i class="fa fa-check"></i><b>2.2.3</b> Purpose of Sampling</a></li>
<li class="chapter" data-level="2.2.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#design-types"><i class="fa fa-check"></i><b>2.2.4</b> Sampling Design Types</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#soilfer-design"><i class="fa fa-check"></i><b>2.3</b> SoilFER Sampling Design</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#soil-properties"><i class="fa fa-check"></i><b>2.3.1</b> Soil Properties</a></li>
<li class="chapter" data-level="2.3.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#env-covariates"><i class="fa fa-check"></i><b>2.3.2</b> Environmental Covariates</a></li>
<li class="chapter" data-level="2.3.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#methodology"><i class="fa fa-check"></i><b>2.3.3</b> Understanding the Methodology</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#tutorial"><i class="fa fa-check"></i><b>2.4</b> Tutorial Using R</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#setup"><i class="fa fa-check"></i><b>2.4.1</b> Setting Up the Environment</a></li>
<li class="chapter" data-level="2.4.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#define-parameters"><i class="fa fa-check"></i><b>2.4.2</b> Define Variables and Parameters</a></li>
<li class="chapter" data-level="2.4.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#country-iso-code"><i class="fa fa-check"></i><b>2.4.3</b> Country ISO Code</a></li>
<li class="chapter" data-level="2.4.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#custom-functions"><i class="fa fa-check"></i><b>2.4.4</b> Custom Functions</a></li>
<li class="chapter" data-level="2.4.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-boundaries"><i class="fa fa-check"></i><b>2.4.5</b> Load Country Boundaries and Legacy Data</a></li>
<li class="chapter" data-level="2.4.6" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-covariates-psu"><i class="fa fa-check"></i><b>2.4.6</b> Load Environmental Covariates for PSUs</a></li>
<li class="chapter" data-level="2.4.7" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-main-environmental-covariates"><i class="fa fa-check"></i><b>2.4.7</b> Load Main Environmental Covariates</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#pca"><i class="fa fa-check"></i><b>2.5</b> Principal Component Analysis (PCA)</a></li>
<li class="chapter" data-level="2.6" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#sampling-universe"><i class="fa fa-check"></i><b>2.6</b> Organize the Sampling Universe</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-and-process-land-use-data"><i class="fa fa-check"></i><b>2.6.1</b> Load and Process Land Use Data</a></li>
<li class="chapter" data-level="2.6.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#exclude-protected-areas"><i class="fa fa-check"></i><b>2.6.2</b> Exclude Protected Areas</a></li>
<li class="chapter" data-level="2.6.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#restrict-to-accessible-slopes"><i class="fa fa-check"></i><b>2.6.3</b> Restrict to Accessible Slopes</a></li>
<li class="chapter" data-level="2.6.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#aggregate-to-100m-resolution"><i class="fa fa-check"></i><b>2.6.4</b> Aggregate to 100m Resolution</a></li>
<li class="chapter" data-level="2.6.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#save-processed-land-use"><i class="fa fa-check"></i><b>2.6.5</b> Save Processed Land Use</a></li>
<li class="chapter" data-level="2.6.6" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#filter-legacy-data"><i class="fa fa-check"></i><b>2.6.6</b> Filter Legacy Data</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#create-psu-grid"><i class="fa fa-check"></i><b>2.7</b> Create Primary Sampling Units (PSU Grid)</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#generate-2km-2km-grid"><i class="fa fa-check"></i><b>2.7.1</b> Generate 2km × 2km Grid</a></li>
<li class="chapter" data-level="2.7.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#trim-to-country-boundaries"><i class="fa fa-check"></i><b>2.7.2</b> Trim to Country Boundaries</a></li>
<li class="chapter" data-level="2.7.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#save-psu-grid"><i class="fa fa-check"></i><b>2.7.3</b> Save PSU Grid</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#select-psus"><i class="fa fa-check"></i><b>2.8</b> Select PSUs with Sufficient Land Use Coverage</a>
<ul>
<li class="chapter" data-level="2.8.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#calculate-land-use-percentage"><i class="fa fa-check"></i><b>2.8.1</b> Calculate Land Use Percentage</a></li>
<li class="chapter" data-level="2.8.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#filter-psus"><i class="fa fa-check"></i><b>2.8.2</b> Filter PSUs</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#rasterize-psus"><i class="fa fa-check"></i><b>2.9</b> Rasterize PSUs for Covariate Space Coverage</a></li>
<li class="chapter" data-level="2.10" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#optimal-sample-size"><i class="fa fa-check"></i><b>2.10</b> Compute Optimal Sample Size</a>
<ul>
<li class="chapter" data-level="2.10.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#run-optimization"><i class="fa fa-check"></i><b>2.10.1</b> Run Optimization</a></li>
<li class="chapter" data-level="2.10.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#extract-optimal-sample-size"><i class="fa fa-check"></i><b>2.10.2</b> Extract Optimal Sample Size</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#csc-computing"><i class="fa fa-check"></i><b>2.11</b> Covariate Space Coverage - Computing PSUs</a>
<ul>
<li class="chapter" data-level="2.11.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#prepare-function-parameters"><i class="fa fa-check"></i><b>2.11.1</b> Prepare Function Parameters</a></li>
<li class="chapter" data-level="2.11.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#perform-k-means-clustering"><i class="fa fa-check"></i><b>2.11.2</b> Perform K-means Clustering</a></li>
<li class="chapter" data-level="2.11.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#assign-clusters-and-calculate-distances"><i class="fa fa-check"></i><b>2.11.3</b> Assign Clusters and Calculate Distances</a></li>
<li class="chapter" data-level="2.11.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#extract-selected-psus"><i class="fa fa-check"></i><b>2.11.4</b> Extract Selected PSUs</a></li>
<li class="chapter" data-level="2.11.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#visualize-in-covariate-space"><i class="fa fa-check"></i><b>2.11.5</b> Visualize in Covariate Space</a></li>
</ul></li>
<li class="chapter" data-level="2.12" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#compute-ssu-tsu"><i class="fa fa-check"></i><b>2.12</b> Compute SSUs and TSUs</a>
<ul>
<li class="chapter" data-level="2.12.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-high-resolution-covariates"><i class="fa fa-check"></i><b>2.12.1</b> Load High-Resolution Covariates</a></li>
<li class="chapter" data-level="2.12.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#process-each-psu"><i class="fa fa-check"></i><b>2.12.2</b> Process Each PSU</a></li>
<li class="chapter" data-level="2.12.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#combine-ssus-and-tsus"><i class="fa fa-check"></i><b>2.12.3</b> Combine SSUs and TSUs</a></li>
</ul></li>
<li class="chapter" data-level="2.13" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#export-units"><i class="fa fa-check"></i><b>2.13</b> Export Sampling Units</a>
<ul>
<li class="chapter" data-level="2.13.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#create-cluster-raster"><i class="fa fa-check"></i><b>2.13.1</b> Create Cluster Raster</a></li>
<li class="chapter" data-level="2.13.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#join-cluster-info-to-tsus"><i class="fa fa-check"></i><b>2.13.2</b> Join Cluster Info to TSUs</a></li>
<li class="chapter" data-level="2.13.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#create-site-ids"><i class="fa fa-check"></i><b>2.13.3</b> Create Site IDs</a></li>
<li class="chapter" data-level="2.13.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#export-shapefiles"><i class="fa fa-check"></i><b>2.13.4</b> Export Shapefiles</a></li>
</ul></li>
<li class="chapter" data-level="2.14" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#alternative-psus"><i class="fa fa-check"></i><b>2.14</b> Compute Alternative PSUs</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="merging-results.html"><a href="merging-results.html"><i class="fa fa-check"></i><b>3</b> Merging Results from Multiple Land Uses</a>
<ul>
<li class="chapter" data-level="3.1" data-path="merging-results.html"><a href="merging-results.html#assign-unique-ids"><i class="fa fa-check"></i><b>3.1</b> Assign Country-Wide Unique IDs</a></li>
<li class="chapter" data-level="3.2" data-path="merging-results.html"><a href="merging-results.html#export-unified"><i class="fa fa-check"></i><b>3.2</b> Export Unified Datasets</a></li>
<li class="chapter" data-level="3.3" data-path="merging-results.html"><a href="merging-results.html#summary-stats"><i class="fa fa-check"></i><b>3.3</b> Summary Statistics</a></li>
<li class="chapter" data-level="3.4" data-path="merging-results.html"><a href="merging-results.html#distribution-maps"><i class="fa fa-check"></i><b>3.4</b> Create Distribution Maps</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="field-protocol.html"><a href="field-protocol.html"><i class="fa fa-check"></i><b>4</b> Field Sampling Protocol</a>
<ul>
<li class="chapter" data-level="4.1" data-path="field-protocol.html"><a href="field-protocol.html#gps-prep"><i class="fa fa-check"></i><b>4.1</b> GPS Device Preparation</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="field-protocol.html"><a href="field-protocol.html#export-to-gpx-format"><i class="fa fa-check"></i><b>4.1.1</b> Export to GPX Format</a></li>
<li class="chapter" data-level="4.1.2" data-path="field-protocol.html"><a href="field-protocol.html#load-onto-gps-device"><i class="fa fa-check"></i><b>4.1.2</b> Load onto GPS Device</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="field-protocol.html"><a href="field-protocol.html#sampling-procedure"><i class="fa fa-check"></i><b>4.2</b> Sampling Procedure</a></li>
<li class="chapter" data-level="4.3" data-path="field-protocol.html"><a href="field-protocol.html#data-recording"><i class="fa fa-check"></i><b>4.3</b> Data Recording</a></li>
<li class="chapter" data-level="4.4" data-path="field-protocol.html"><a href="field-protocol.html#qc"><i class="fa fa-check"></i><b>4.4</b> Quality Control</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html"><i class="fa fa-check"></i>Appendices</a>
<ul>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-a-software-and-data-sources"><i class="fa fa-check"></i>Appendix A: Software and Data Sources</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="appendices.html"><a href="appendices.html#software-requirements"><i class="fa fa-check"></i><b>4.4.1</b> Software Requirements</a></li>
<li class="chapter" data-level="4.4.2" data-path="appendices.html"><a href="appendices.html#data-sources"><i class="fa fa-check"></i><b>4.4.2</b> Data Sources</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-b-troubleshooting-common-issues"><i class="fa fa-check"></i>Appendix B: Troubleshooting Common Issues</a>
<ul>
<li class="chapter" data-level="4.4.3" data-path="appendices.html"><a href="appendices.html#memory-issues"><i class="fa fa-check"></i><b>4.4.3</b> Memory Issues</a></li>
<li class="chapter" data-level="4.4.4" data-path="appendices.html"><a href="appendices.html#crs-misalignment"><i class="fa fa-check"></i><b>4.4.4</b> CRS Misalignment</a></li>
<li class="chapter" data-level="4.4.5" data-path="appendices.html"><a href="appendices.html#empty-geometry"><i class="fa fa-check"></i><b>4.4.5</b> Empty Geometry</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-c-acronyms-and-abbreviations"><i class="fa fa-check"></i>Appendix C: Acronyms and Abbreviations</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="tbd.html"><a href="tbd.html"><i class="fa fa-check"></i><b>5</b> TBD</a></li>
<li class="chapter" data-level="6" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html"><i class="fa fa-check"></i><b>6</b> Soil Data Preparation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#introduction-2"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#data-cleaning"><i class="fa fa-check"></i><b>6.2</b> Data cleaning</a></li>
<li class="chapter" data-level="6.3" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#soil-data-harmonization"><i class="fa fa-check"></i><b>6.3</b> Soil Data Harmonization</a></li>
<li class="chapter" data-level="6.4" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#concepts-on-digital-exchange-of-soil-related-data-iso-28258"><i class="fa fa-check"></i><b>6.4</b> Concepts on digital exchange of soil-related data (ISO 28258)</a></li>
<li class="chapter" data-level="6.5" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#plot-data"><i class="fa fa-check"></i><b>6.5</b> Plot data</a></li>
<li class="chapter" data-level="6.6" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#profile-data"><i class="fa fa-check"></i><b>6.6</b> Profile data</a></li>
<li class="chapter" data-level="6.7" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#element-data"><i class="fa fa-check"></i><b>6.7</b> Element data</a></li>
<li class="chapter" data-level="6.8" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#specimen-data"><i class="fa fa-check"></i><b>6.8</b> Specimen data</a></li>
<li class="chapter" data-level="6.9" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#definition-of-laboratory-procedures"><i class="fa fa-check"></i><b>6.9</b> Definition of laboratory procedures</a></li>
<li class="chapter" data-level="6.10" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#data-transformation"><i class="fa fa-check"></i><b>6.10</b> Data transformation</a></li>
<li class="chapter" data-level="6.11" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#organizing-soil-data-according-to-the-glosis-database"><i class="fa fa-check"></i><b>6.11</b> Organizing soil data according to the GloSIS database</a></li>
<li class="chapter" data-level="6.12" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#tools-for-harmonization-of-soil-databases-within-glosis"><i class="fa fa-check"></i><b>6.12</b> Tools for harmonization of soil databases within GloSIS</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html"><i class="fa fa-check"></i><b>7</b> Digital Soil Mapping and Modeling</a></li>
<li class="chapter" data-level="8" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html"><i class="fa fa-check"></i><b>8</b> 1. Fundamentals of Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="8.1" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#introduction-to-digital-soil-mapping"><i class="fa fa-check"></i><b>8.1</b> Introduction to Digital Soil Mapping</a></li>
<li class="chapter" data-level="8.2" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#the-scorpan-framework"><i class="fa fa-check"></i><b>8.2</b> The SCORPAN Framework</a></li>
<li class="chapter" data-level="8.3" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#statistical-theory-for-predictive-soil-mapping"><i class="fa fa-check"></i><b>8.3</b> Statistical Theory for Predictive Soil Mapping</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#mechanistic-versus-empirical-approaches"><i class="fa fa-check"></i><b>8.3.1</b> Mechanistic versus Empirical Approaches</a></li>
<li class="chapter" data-level="8.3.2" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#sources-of-residual-variance"><i class="fa fa-check"></i><b>8.3.2</b> Sources of Residual Variance</a></li>
<li class="chapter" data-level="8.3.3" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#covariates-as-proxies-of-soil-forming-factors"><i class="fa fa-check"></i><b>8.3.3</b> Covariates as Proxies of Soil-Forming Factors</a></li>
<li class="chapter" data-level="8.3.4" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#the-universal-model-of-soil-variation"><i class="fa fa-check"></i><b>8.3.4</b> The Universal Model of Soil Variation</a></li>
<li class="chapter" data-level="8.3.5" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#extending-the-model-space-depth-and-time-3dt"><i class="fa fa-check"></i><b>8.3.5</b> Extending the Model: Space, Depth, and Time (3D+T)</a></li>
<li class="chapter" data-level="8.3.6" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#types-of-soil-variables"><i class="fa fa-check"></i><b>8.3.6</b> Types of Soil Variables</a></li>
<li class="chapter" data-level="8.3.7" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#prediction-methods"><i class="fa fa-check"></i><b>8.3.7</b> Prediction Methods</a></li>
<li class="chapter" data-level="8.3.8" data-path="fundamentals-of-digital-soil-mapping.html"><a href="fundamentals-of-digital-soil-mapping.html#nonlinearity-and-uncertainty"><i class="fa fa-check"></i><b>8.3.8</b> Nonlinearity and Uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html"><i class="fa fa-check"></i><b>9</b> Soil Data Sharing</a>
<ul>
<li class="chapter" data-level="9.1" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#data-sharing-and-export-formats"><i class="fa fa-check"></i><b>9.1</b> Data sharing and export formats</a></li>
<li class="chapter" data-level="9.2" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#metadata"><i class="fa fa-check"></i><b>9.2</b> Metadata</a></li>
<li class="chapter" data-level="9.3" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#web-services"><i class="fa fa-check"></i><b>9.3</b> Web Services</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-2.html"><a href="references-2.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p>DRAFT - Integrated soil information for decision-making
<img src="images/frontcover.jpg" style="top:0px;height:100px;" align="right" /></p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-preparation-for-digital-soil-mapping-in-r" class="section level1 hasAnchor" number="1">
<h1><span class="header-section-number">Chapter 1</span> Data preparation for Digital Soil Mapping in R<a href="data-preparation-for-digital-soil-mapping-in-r.html#data-preparation-for-digital-soil-mapping-in-r" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-1" class="section level2 hasAnchor" number="1.1">
<h2><span class="header-section-number">1.1</span> Introduction<a href="data-preparation-for-digital-soil-mapping-in-r.html#introduction-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Data preparation is one of the most critical and time-consuming steps in Digital Soil Mapping (DSM). Raw soil laboratory data typically contains numerous inconsistencies, errors, and redundancies that must be systematically identified and resolved before use in modeling. Poor data quality at this stage directly translates to poor prediction models and unreliable soil property maps.</p>
<p>This section demonstrates systematic approaches to soil data validation, cleaning, and harmonization using the <strong>Kansas KSSL dataset</strong> as a practical example. The training dataset as well as a tutorial on how to download it can be found in the following section <a href="#how-to-use">How to use this book</a> of this Technical Manual. The goal is to transform raw soil measurements into clean, consistent data ready for Digital Soil Mapping analysis and modeling.</p>
<p>Raw soil laboratory data commonly contains the following types of quality issues:</p>
<ul>
<li><p><strong>Geographic errors</strong>: Missing or out-of-bounds coordinates, coordinate swaps, and unit inconsistencies</p></li>
<li><p><strong>Depth inconsistencies</strong>: Missing soil depths, zero-thickness horizons ((bottom = top), invalid depth logic (bottom &lt; top), overlapping intervals, and duplicate measurements</p></li>
<li><p><strong>Laboratory data problems</strong>: Missing values, out-of-range soil properties, texture validation failures (clay+silt+sand <span class="math inline">\(\neq\)</span> 100%)</p></li>
<li><p><strong>Duplicate profiles</strong>: Multiple measurement sequences at the same location with conflicting depth intervals</p></li>
<li><p><strong>Logical inconsistencies</strong>: Values that are physically or chemically impossible given soil science constraints</p></li>
</ul>
<p>The Kansas KSSL dataset used throughout this section provides real-world examples of these issues, allowing you to practice identifying and correcting them systematically using reproducible R workflows.</p>
<div class="warning-box">
<p><strong>Considerations</strong></p>
<ul>
<li><p>Every soil dataset is unique and may have specific data-quality issues.</p></li>
<li><p>Proper identification of quality problems requires prior understanding of the dataset’s structure.</p></li>
<li><p>When using a different database, the code shown here must be adapted to your actual database column names and data types.</p></li>
</ul>
</div>
</div>
<div id="loading-data" class="section level2 hasAnchor" number="1.2">
<h2><span class="header-section-number">1.2</span> Loading and exploring raw soil data<a href="data-preparation-for-digital-soil-mapping-in-r.html#loading-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before performing any data cleaning or validation, you must first understand the structure and content of your raw data. This exploratory phase reveals data types, identifies potential problems, and informs your validation strategy.</p>
<div id="basic-data-loading-and-structure" class="section level3 hasAnchor" number="1.2.1">
<h3><span class="header-section-number">1.2.1</span> Basic data loading and structure<a href="data-preparation-for-digital-soil-mapping-in-r.html#basic-data-loading-and-structure" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb84-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)        <span class="co"># Data manipulation and visualization</span></span>
<span id="cb84-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)           <span class="co"># Read Excel files</span></span>
<span id="cb84-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)            <span class="co"># For formatted tables</span></span>
<span id="cb84-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Read Excel file containing raw soil data</span></span>
<span id="cb84-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-7" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">&quot;../../01_data/module1/KSSL_data.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="dv">1</span>) </span>
<span id="cb84-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the folder to store the results of the exercise</span></span>
<span id="cb84-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-10" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span><span class="st">&quot;../../03_outputs/module1/&quot;</span></span>
<span id="cb84-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the output directory if not existing</span></span>
<span id="cb84-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(output_dir)){</span>
<span id="cb84-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a new sub directory inside the main path</span></span>
<span id="cb84-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(output_dir)</span>
<span id="cb84-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(raw_data) <span class="co"># Examine the structure of the data</span></span>
<span id="cb84-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(raw_data, <span class="dv">10</span>) <span class="co"># Show the first 10 rows</span></span>
<span id="cb84-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(raw_data[,<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>]) <span class="co"># Summarize the data in 25 first columns</span></span></code></pre></div>
<p>This dataset contains four types of information: <em>site</em> data (location and depth), <em>laboratory</em> data (measured soil properties), and <em>spectral</em> data (mid-infrared, MIR, reflectance). In addition, each row includes identifiers for the sample (<code>smp_id</code>), and other keys related to the spectral analyses (<code>join_key</code>, <code>scan_path_name</code>, <code>file_name</code>). In many cases, soil datasets do not include spectral data. Understanding these components will help you organize the cleaning process systematically.</p>
</div>
<div id="data-components-and-organization" class="section level3 hasAnchor" number="1.2.2">
<h3><span class="header-section-number">1.2.2</span> Data components and organization<a href="data-preparation-for-digital-soil-mapping-in-r.html#data-components-and-organization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Typically, a raw soil dataset includes several types of information:</p>
<ul>
<li><strong>Site information</strong> defines where and at what depth a soil sample was collected:
<ul>
<li>Geographic coordinates (longitude and latitude, often in WGS84 or X, Y in Cartesian projected systems)</li>
<li>Unique identifiers (profile ID, horizon ID, sample ID)</li>
<li>Depth boundaries (top and bottom depth of the analyzed horizons in each soil profile)</li>
</ul></li>
<li><strong>Laboratory data</strong> contains measured soil properties:
<ul>
<li>Physical properties (texture: clay, silt, sand percentages)</li>
<li>Chemical properties (pH, organic carbon, cation exchange capacity)</li>
<li>Other analyzed parameters (salinity, nutrients, etc.)</li>
</ul></li>
<li><strong>Spectral data</strong> (optional) includes:
<ul>
<li>Spectral reflectance values at multiple wavelengths (MIR, VIS-NIR)</li>
<li>Used for predicting soil properties through spectroscopy</li>
</ul></li>
</ul>
</div>
</div>
<div id="site-data-preparation" class="section level2 hasAnchor" number="1.3">
<h2><span class="header-section-number">1.3</span> Preparing site data for analysis<a href="data-preparation-for-digital-soil-mapping-in-r.html#site-data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Data cleaning involves extracting relevant information from raw data, standardizing column names, assigning unique identifiers, and validating data quality. To track changes through this process, we add a unique row identifier to the raw dataset before making any modifications.</p>
<p>We operationally define a <strong>site</strong> as the set of horizons or layers that share the same geographic location (i.e., identical coordinates at the chosen precision). The site has information on location (lat and long coordinates), depth (upper and lower depth boundaries) and metadata-related information (horizon ID).</p>
<div id="adding-a-unique-row-identifier" class="section level3 hasAnchor" number="1.3.1">
<h3><span class="header-section-number">1.3.1</span> Adding a unique row identifier<a href="data-preparation-for-digital-soil-mapping-in-r.html#adding-a-unique-row-identifier" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>During data cleaning, some records may be removed, merged, or modified. Good practice is to add a unique sequential <code>rowID</code> to the raw (unchanged) dataset so you can track each original record throughout the entire workflow. This identifier allows you to trace any result back to its source data and understand which raw records were retained or excluded.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add unique row identifier to track individual records through processing</span></span>
<span id="cb85-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb85-2" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> raw_data <span class="sc">%&gt;%</span></span>
<span id="cb85-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rowID =</span> <span class="fu">row_number</span>(), <span class="at">.before =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The <code>rowID</code> column preserves the link between processed data and raw data, enabling full transparency and reproducibility in your cleaning workflow.</p>
</div>
<div id="extracting-and-standardizing-column-names-for-sites" class="section level3 hasAnchor" number="1.3.2">
<h3><span class="header-section-number">1.3.2</span> Extracting and standardizing column names for sites<a href="data-preparation-for-digital-soil-mapping-in-r.html#extracting-and-standardizing-column-names-for-sites" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Raw soil data often uses inconsistent column naming conventions that vary between data sources, laboratories, and surveys. Standardizing these names prevents errors and makes your code more readable and reusable across different projects</p>
<p>The R object <code>site</code> will store the location, depth, and metadata from the full set of observations, including all sites and their associated horizons or layers in the database.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only the columns needed for site data preparation</span></span>
<span id="cb86-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-2" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> raw_data <span class="sc">%&gt;%</span></span>
<span id="cb86-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb86-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-4" aria-hidden="true" tabindex="-1"></a>    rowID,</span>
<span id="cb86-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-5" aria-hidden="true" tabindex="-1"></a>    Long_Site.x,              <span class="co"># Raw column name for longitude</span></span>
<span id="cb86-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-6" aria-hidden="true" tabindex="-1"></a>    Lat_Site.x,               <span class="co"># Raw column name for latitude</span></span>
<span id="cb86-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-7" aria-hidden="true" tabindex="-1"></a>    smp_id,                   <span class="co"># Sample/horizon identifier</span></span>
<span id="cb86-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-8" aria-hidden="true" tabindex="-1"></a>    Top_depth_cm.x,           <span class="co"># Top depth in centimeters</span></span>
<span id="cb86-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-9" aria-hidden="true" tabindex="-1"></a>    Bottom_depth_cm.x         <span class="co"># Bottom depth in centimeters</span></span>
<span id="cb86-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename columns to standard, consistent names</span></span>
<span id="cb86-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-13" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb86-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb86-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> Long_Site.x,</span>
<span id="cb86-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> Lat_Site.x,</span>
<span id="cb86-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">HorID =</span> smp_id,</span>
<span id="cb86-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> Top_depth_cm.x,</span>
<span id="cb86-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">bottom =</span> Bottom_depth_cm.x</span>
<span id="cb86-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb86-20" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
</div>
<div id="creating-unique-profile-identifiers" class="section level3 hasAnchor" number="1.3.3">
<h3><span class="header-section-number">1.3.3</span> Creating unique profile identifiers<a href="data-preparation-for-digital-soil-mapping-in-r.html#creating-unique-profile-identifiers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each unique geographic location represents a single soil profile. A profile may contain multiple horizons or layers sampled at different depths. We create a unique identifier <code>ProfID</code> for each location based on coordinates so that all horizons from the same location can be grouped together in the same profile.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-1" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb87-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group all horizons at the same location</span></span>
<span id="cb87-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat) <span class="sc">%&gt;%</span></span>
<span id="cb87-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign sequential ID to each unique location (cur_group_id() returns group number)</span></span>
<span id="cb87-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ProfID =</span> <span class="fu">cur_group_id</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb87-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb87-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Format as standardized IDs: PROF0001, PROF0002, etc. with 4 digit resolution</span></span>
<span id="cb87-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ProfID =</span> <span class="fu">sprintf</span>(<span class="st">&quot;PROF%04d&quot;</span>, ProfID))</span>
<span id="cb87-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reorder columns for clarity</span></span>
<span id="cb87-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-11" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb87-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb87-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(rowID, ProfID, HorID, lon, lat, top, bottom)</span></code></pre></div>
<p>After this step, horizons from the same location share a common <code>ProfID</code>, while those from different locations receive distinct <code>ProfID</code> values. When unique profile IDs are not available in the raw data, this method reconstructs profile identity using the geographic position of the samples.</p>
</div>
<div id="remove-exact-duplicate-site-records" class="section level3 hasAnchor" number="1.3.4">
<h3><span class="header-section-number">1.3.4</span> Remove exact duplicate site records<a href="data-preparation-for-digital-soil-mapping-in-r.html#remove-exact-duplicate-site-records" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Multiple site records may correspond to identical observations (i.e., the same location and depth). In this dataset, spectroscopic measurements were performed four times per sample, resulting in duplicate entries. Remove duplicates and retain a single record to prevent redundancy and double counting in subsequent analyses.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove exact duplicate rows</span></span>
<span id="cb88-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb88-2" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb88-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(<span class="fu">across</span>(<span class="sc">-</span>rowID), <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<div class="key-concept">
<p><strong>Standard column naming convention</strong> ensures consistency across all your code and projects:</p>
<ul>
<li><p><code>ProfID</code>: Profile identifier</p></li>
<li><p><code>HorID</code>: Horizon or sample identifier</p></li>
<li><p><code>lon</code>, <code>lat</code>: Geographic coordinates (decimal degrees, WGS84)</p></li>
<li><p><code>top</code>,<code>bottom</code>: Depth boundaries in centimeters</p></li>
</ul>
<div class="warning-box">
<p><strong>Adjust <code>ProfID</code> for locations with multiple profile descriptions</strong></p>
<ul>
<li><p>Horizons or layers measured at different times or for different purposes may occur at the same location. If the <code>ProfID</code> is based only on spatial position, these observations may share the same identifier.</p></li>
<li><p>Identify these profiles and assign a unique <code>ProfID</code> to each one (see the procedure in Section 6 of this chapter).</p></li>
<li><p>Proper identification of unique profiles is necessary to ensure consistent data management and reliable Digital Soil Mapping results.</p></li>
</ul>
</div>
</div>
</div>
</div>
<div id="coordinate-validation" class="section level2 hasAnchor" number="1.4">
<h2><span class="header-section-number">1.4</span> Coordinate validation and correction<a href="data-preparation-for-digital-soil-mapping-in-r.html#coordinate-validation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Spatial coordinates form the basis of all spatial analyses. Invalid or inaccurate coordinates result in erroneous maps and unreliable spatial predictions. Systematic validation is therefore essential to identify and correct coordinate errors before they propagate through the analytical workflow.</p>
<p>Coordinates can be expressed in different coordinate reference systems (CRS):</p>
<ul>
<li><strong>Geographic coordinate</strong>s (longitude and latitude in decimal degrees, typically WGS84)</li>
<li><strong>Projected coordinates</strong> (X and Y in a projected system, such as UTM or a local projection)</li>
</ul>
<p>Any dataset should explicitly document which CRS is used. For Digital Soil Mapping workflows, it is recommended to standardize all coordinates to WGS84 (EPSG:4326) geographic coordinates (longitude and latitude) to ensure interoperability and consistency across projects.</p>
<div id="check-1-missing-coordinates" class="section level3 hasAnchor" number="1.4.1">
<h3><span class="header-section-number">1.4.1</span> Check 1: Missing coordinates<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-missing-coordinates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Records lacking valid spatial coordinates cannot be georeferenced and must be excluded from spatial analyses. Check for missing or null values in both coordinate dimensions (e.g., latitude/longitude or projected X/Y) before proceeding.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb89-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove records with missing coordinates</span></span>
<span id="cb89-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb89-2" aria-hidden="true" tabindex="-1"></a>  site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb89-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb89-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lon) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(lat))</span></code></pre></div>
</div>
<div id="check-2-valid-coordinate-ranges" class="section level3 hasAnchor" number="1.4.2">
<h3><span class="header-section-number">1.4.2</span> Check 2: Valid coordinate ranges<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-valid-coordinate-ranges" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For geographic coordinates (longitude and latitude expressed in decimal degrees), values must fall within the following absolute ranges:</p>
<p><strong>Longitude</strong>: -180° to +180° (negative = West, positive = East)
<strong>Latitude</strong>: -90° to +90° (negative = South, positive = North)</p>
<p>Values outside these limits indicate invalid or incorrectly formatted coordinates.</p>
<p>The following validation routine applies only to geographic coordinates stored in decimal degrees.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only rows with valid lon/lat geographic coordinates inside valid ranges</span></span>
<span id="cb90-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb90-2" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb90-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb90-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb90-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb90-4" aria-hidden="true" tabindex="-1"></a>    lon <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">180</span>, lon <span class="sc">&lt;=</span> <span class="dv">180</span>,</span>
<span id="cb90-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb90-5" aria-hidden="true" tabindex="-1"></a>    lat <span class="sc">&gt;=</span>  <span class="sc">-</span><span class="dv">90</span>, lat <span class="sc">&lt;=</span>  <span class="dv">90</span></span>
<span id="cb90-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb90-6" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>If projected coordinates are used, valid ranges depend on the specific projection and the spatial extent of the study area. In such cases, define the expected bounds for the coordinate reference system (CRS) before performing range checks.</p>
<div class="warning-box">
<p><strong>Coordinate system considerations</strong>:</p>
<ul>
<li><p>Geographic coordinates (longitude/latitude in decimal degrees) have fixed global bounds (−180° to +180°, −90° to +90°) that must not be exceeded.</p></li>
<li><p>Projected coordinates (e.g., X/Y in meters, such as UTM) require CRS-specific limits.</p></li>
<li><p>To minimize CRS-related errors, standardize coordinates to WGS84 (EPSG:4326) early in the workflow. Document the original CRS and any transformations applied to ensure reproducibility and transparency.</p></li>
</ul>
</div>
</div>
</div>
<div id="depth-validation" class="section level2 hasAnchor" number="1.5">
<h2><span class="header-section-number">1.5</span> Soil depth validation and correction<a href="data-preparation-for-digital-soil-mapping-in-r.html#depth-validation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Depth intervals define the soil layer represented by each observation. Missing or inconsistent depth information prevents harmonization across profiles and can lead to incorrect interpretation of depth-dependent patterns and model outputs. This section describes a set of quality-control checks to validate and, where possible, correct depth interval data. The checks are applied sequentially, removing structurally invalid records before attempting logical corrections.</p>
<div class="key-concept">
<p><strong>Understanding depth conventions</strong></p>
<p>Soil horizons (or layers) are represented as depth intervals with explicit upper and lower boundaries, typically recorded as top depth and bottom depth (e.g., “0–15 cm” indicates measurements from 0 to 15 cm below the soil surface). The following rules apply:</p>
<ul>
<li><p>Depth boundaries define a continuous interval in the soil profile.</p></li>
<li><p>Bottom depth must be strictly greater than top depth.</p></li>
<li><p>Depths are measured downward from the soil surface (0 cm).</p></li>
<li><p>Horizon thickness is computed as bottom − top and must be positive.</p></li>
</ul>
</div>
<div id="check-1-missing-depth-boundaries" class="section level3 hasAnchor" number="1.5.1">
<h3><span class="header-section-number">1.5.1</span> Check 1: Missing depth boundaries<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-missing-depth-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Records with missing top or bottom depths cannot be assigned to a valid interval and should be excluded unless depth information can be recovered from the source.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep records where `top` or `bottom` are not NA</span></span>
<span id="cb91-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb91-2" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb91-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(top) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(bottom))</span></code></pre></div>
</div>
<div id="check-2-negative-depth-values" class="section level3 hasAnchor" number="1.5.2">
<h3><span class="header-section-number">1.5.2</span> Check 2: Negative depth values<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-negative-depth-values" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Depth values must be non-negative. Negative depths indicate invalid input and should be removed unless the error can be corrected using metadata or original field notes.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep records where `top` or `bottom` are positive</span></span>
<span id="cb92-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>(top <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> bottom <span class="sc">&lt;</span> <span class="dv">0</span>))</span></code></pre></div>
</div>
<div id="check-3-zero-thickness-intervals" class="section level3 hasAnchor" number="1.5.3">
<h3><span class="header-section-number">1.5.3</span> Check 3: Zero-thickness intervals<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-3-zero-thickness-intervals" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Horizons with top = bottom have zero thickness and do not represent a measurable soil layer. These records should be excluded from analysis unless the error can be corrected.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove zero-thickness horizons</span></span>
<span id="cb93-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb93-2" aria-hidden="true" tabindex="-1"></a>  site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb93-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>(bottom <span class="sc">-</span> top <span class="sc">==</span> <span class="dv">0</span>))</span></code></pre></div>
</div>
<div id="check-4-invalid-depth-logic" class="section level3 hasAnchor" number="1.5.4">
<h3><span class="header-section-number">1.5.4</span> Check 4: Invalid depth logic<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-4-invalid-depth-logic" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For a valid depth interval, bottom &gt; top must hold. Violations typically indicate data entry errors (e.g., swapped boundaries or incorrect units).</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove invalid depth logic</span></span>
<span id="cb94-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb94-2" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(bottom <span class="sc">&gt;</span> top)</span></code></pre></div>
</div>
<div id="check-5-profiles-without-a-surface-horizon-top-0" class="section level3 hasAnchor" number="1.5.5">
<h3><span class="header-section-number">1.5.5</span> Check 5: Profiles without a surface horizon (top &gt; 0)<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-5-profiles-without-a-surface-horizon-top-0" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each profile should represent the complete soil column starting at surface. This is essential for depth harmonization in a later step for Digital Soil Mapping.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Keep only profiles that start at the surface (min top == 0)</span></span>
<span id="cb95-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb95-2" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb95-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(ProfID) <span class="sc">%&gt;%</span></span>
<span id="cb95-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb95-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(top) <span class="sc">&amp;</span> <span class="fu">min</span>(top, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb95-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span></code></pre></div>
<div class="warning-box">
<p><strong>Further checks for depth integrity required</strong></p>
<p>After applying the basic depth validation steps above, some profiles may still contain duplicated or overlapping horizons, or multiple depth sequences for the same <code>ProfID</code>. These situations often arise from repeated sampling or laboratory analyses conducted at different times.</p>
<p>Do not remove these records prematurely. Duplicate horizons may contain complementary analytical measurements that are not consistently available across all repetitions. Eliminating them at this stage may result in unintended data loss.</p>
<p>Depth-sequence conflicts should therefore be resolved only after laboratory data have been cleaned, validated, and consolidated at the horizon level. Once analytical completeness has been ensured, apply the dedicated profile-level procedure described in <strong>‘Detecting and resolving duplicate soil profiles’</strong> to identify and retain a single representative depth sequence per profile.</p>
<p>This staged approach prevents loss of valid measurements and ensures consistent profile harmonization.</p>
</div>
</div>
</div>
<div id="lab-validation" class="section level2 hasAnchor" number="1.6">
<h2><span class="header-section-number">1.6</span> Preparing lab data: harmonization and validation<a href="data-preparation-for-digital-soil-mapping-in-r.html#lab-validation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Laboratory analyses provide the soil property measurements used as soil property inputs for Digital Soil Mapping. Laboratory data must be quality-controlled to ensure completeness, plausible value ranges, and internal consistency (e.g., particle-size fractions summing to ~100%). This section describes standard extraction, harmonization, and validation checks.</p>
<p>Laboratory analyses provide the soil property measurements used as inputs for Digital Soil Mapping. Prior to modelling, laboratory data must be quality-controlled to ensure:</p>
<ol style="list-style-type: lower-roman">
<li>completeness of critical variables,</li>
<li>numeric data types for analytical parameters,</li>
<li>plausibility of measured values based on feasible analytical thresholds, and</li>
<li>traceable handling of potential errors (flagging, correction, or exclusion).</li>
</ol>
<div id="prepare-and-standardize-laboratory-columns" class="section level3 hasAnchor" number="1.6.1">
<h3><span class="header-section-number">1.6.1</span> Prepare and standardize laboratory columns<a href="data-preparation-for-digital-soil-mapping-in-r.html#prepare-and-standardize-laboratory-columns" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this step, you will extract horizon-level laboratory results from the raw dataset, convert relevant fields to numeric, and retain only the records associated with the profiles preserved in the cleaned site dataset. Finally, you will merge the laboratory data back into the site dataset using <code>rowID</code> as the unique record identifier.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract laboratory columns with standardized names</span></span>
<span id="cb96-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-2" aria-hidden="true" tabindex="-1"></a>lab <span class="ot">&lt;-</span> raw_data <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb96-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-4" aria-hidden="true" tabindex="-1"></a>    rowID,</span>
<span id="cb96-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-5" aria-hidden="true" tabindex="-1"></a>    SOC, Carbon_Total,                                <span class="co"># Soil Organic Carbon and Total Carbon (%)                    </span></span>
<span id="cb96-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-6" aria-hidden="true" tabindex="-1"></a>    Bulk.Density_1_3.BAR, Bulk.Density_ovendry,       <span class="co"># Bulk density at 1.3 bar and oven dry (g/cm³)</span></span>
<span id="cb96-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-7" aria-hidden="true" tabindex="-1"></a>    Sand, Silt, Clay,                                 <span class="co"># Texture (%)</span></span>
<span id="cb96-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-8" aria-hidden="true" tabindex="-1"></a>    pH,                                               <span class="co"># pH H2O</span></span>
<span id="cb96-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-9" aria-hidden="true" tabindex="-1"></a>    CEC,                                              <span class="co"># CEC in cmol(+)/kg</span></span>
<span id="cb96-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-10" aria-hidden="true" tabindex="-1"></a>    Nitrogen_Total,                                   <span class="co"># Total nitrogen (%),</span></span>
<span id="cb96-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-11" aria-hidden="true" tabindex="-1"></a>    Phosphorus_Mehlich3, Phosphorus_Olsen, Potassium, <span class="co"># Available P (mg/kg), Exchangeable K (cmol(+)/kg)</span></span>
<span id="cb96-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-12" aria-hidden="true" tabindex="-1"></a>    Calcium_Carbonate_equivalent                      <span class="co"># CaCO3 equivalent (%)</span></span>
<span id="cb96-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb96-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure numeric type for all analytical parameters (prevents issues if stored as text)</span></span>
<span id="cb96-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-16" aria-hidden="true" tabindex="-1"></a>  lab <span class="ot">&lt;-</span> lab <span class="sc">%&gt;%</span></span>
<span id="cb96-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>rowID, as.numeric))</span>
<span id="cb96-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only lab records that are present in the cleaned site dataset</span></span>
<span id="cb96-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-20" aria-hidden="true" tabindex="-1"></a>  lab <span class="ot">&lt;-</span> lab <span class="sc">%&gt;%</span></span>
<span id="cb96-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(rowID <span class="sc">%in%</span> site<span class="sc">$</span>rowID)</span>
<span id="cb96-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join both site and lab data by the common identifier &#39;rowID&#39;</span></span>
<span id="cb96-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-24" aria-hidden="true" tabindex="-1"></a>  site_lab <span class="ot">&lt;-</span> site <span class="sc">%&gt;%</span></span>
<span id="cb96-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb96-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(lab, <span class="at">by =</span> <span class="st">&quot;rowID&quot;</span>)</span></code></pre></div>
<p>After preparing the laboratory dataset, the analytical results are validated through three quality-control checks:</p>
<ul>
<li><p>Check 1: Identify out-of-bounds values — flag measurements that fall outside plausible or admissible ranges.</p></li>
<li><p>Check 2: Texture validation — verify that sand, silt, and clay values are internally consistent (e.g., within expected limits and summing appropriately when expressed as percentages).</p></li>
<li><p>Check 3: Correction of out-of-bounds laboratory values — apply a proper correction strategy (targeted fixes where justified, or replacing suspect values with <code>NA</code>).</p></li>
</ul>
</div>
<div id="check-1-check-each-property-against-feasible-analytical-thresholds" class="section level3 hasAnchor" number="1.6.2">
<h3><span class="header-section-number">1.6.2</span> Check 1: Check each property against feasible analytical thresholds<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-check-each-property-against-feasible-analytical-thresholds" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Soil properties have physically and analytically plausible bounds. Values outside these bounds typically indicate measurement issues, unit inconsistencies, or transcription/data entry errors. Thresholds should be defined a priori and documented (e.g., based on existing soil datasets or peer-reviewed literature), then adjusted as needed for the target region and soil types.</p>
<div id="load-property-thresholds" class="section level4 hasAnchor" number="1.6.2.1">
<h4><span class="header-section-number">1.6.2.1</span> Load property thresholds<a href="data-preparation-for-digital-soil-mapping-in-r.html#load-property-thresholds" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Store thresholds in a configuration file (e.g., <code>property_thresholds.csv</code>) to ensure transparency and reproducibility.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load valid ranges for soil properties</span></span>
<span id="cb97-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: These thresholds are based on global soil datasets and literature.</span></span>
<span id="cb97-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co">#       Adjust for your specific region and soil types.</span></span>
<span id="cb97-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb97-4" aria-hidden="true" tabindex="-1"></a>property_thresholds <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;property_thresholds.csv&quot;</span>)</span>
<span id="cb97-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Display thresholds</span></span>
<span id="cb97-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(property_thresholds)</span></code></pre></div>
</div>
<div id="identify-out-of-bounds-values" class="section level4 hasAnchor" number="1.6.2.2">
<h4><span class="header-section-number">1.6.2.2</span> Identify out-of-bounds values<a href="data-preparation-for-digital-soil-mapping-in-r.html#identify-out-of-bounds-values" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Each soil analytical property is evaluated against its min/max thresholds. Out-of-bounds values are compiled into a structured issue log (<code>out_of_bounds_issues</code>) to support inspection, reporting, and correction.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify out-of-bounds values</span></span>
<span id="cb98-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-2" aria-hidden="true" tabindex="-1"></a>out_of_bounds_issues <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb98-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(property_thresholds))) {</span>
<span id="cb98-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-5" aria-hidden="true" tabindex="-1"></a>  prop <span class="ot">&lt;-</span> property_thresholds<span class="sc">$</span>property[i]</span>
<span id="cb98-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-6" aria-hidden="true" tabindex="-1"></a>  prop_desc <span class="ot">&lt;-</span> property_thresholds<span class="sc">$</span>description[i]</span>
<span id="cb98-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-7" aria-hidden="true" tabindex="-1"></a>  min_val <span class="ot">&lt;-</span> property_thresholds<span class="sc">$</span>min_valid[i]</span>
<span id="cb98-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-8" aria-hidden="true" tabindex="-1"></a>  max_val <span class="ot">&lt;-</span> property_thresholds<span class="sc">$</span>max_valid[i]</span>
<span id="cb98-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check property exists in the dataset</span></span>
<span id="cb98-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (prop <span class="sc">%in%</span> <span class="fu">names</span>(site_lab)) {</span>
<span id="cb98-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-12" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> site_lab[[prop]]</span>
<span id="cb98-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detect out-of-bounds: non-missing values outside [min_val, max_val]</span></span>
<span id="cb98-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-15" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> (x <span class="sc">&lt;</span> min_val <span class="sc">|</span> x <span class="sc">&gt;</span> max_val))</span>
<span id="cb98-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb98-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-18" aria-hidden="true" tabindex="-1"></a>      out_of_bounds_issues[[prop]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb98-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">rowID =</span> site_lab<span class="sc">$</span>rowID[idx],</span>
<span id="cb98-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">property =</span> prop,</span>
<span id="cb98-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> prop_desc,</span>
<span id="cb98-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> x[idx],</span>
<span id="cb98-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_valid =</span> min_val,</span>
<span id="cb98-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">max_valid =</span> max_val,</span>
<span id="cb98-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">issue =</span> <span class="fu">ifelse</span>(</span>
<span id="cb98-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-26" aria-hidden="true" tabindex="-1"></a>          x[idx] <span class="sc">&lt;</span> min_val,</span>
<span id="cb98-27"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">&quot;Below minimum: &quot;</span>, <span class="fu">round</span>(x[idx], <span class="dv">2</span>), <span class="st">&quot; &lt; &quot;</span>, min_val),</span>
<span id="cb98-28"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">&quot;Above maximum: &quot;</span>, <span class="fu">round</span>(x[idx], <span class="dv">2</span>), <span class="st">&quot; &gt; &quot;</span>, max_val)</span>
<span id="cb98-29"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb98-30"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-30" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb98-31"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-32"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-33"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-34"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove temporary objects</span></span>
<span id="cb98-35"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(i,idx,max_val,min_val, prop,prop_desc,x)</span></code></pre></div>
</div>
<div id="reporting-out-of-bounds-for-properties-and-audit-trail" class="section level4 hasAnchor" number="1.6.2.3">
<h4><span class="header-section-number">1.6.2.3</span> Reporting out-of-bounds for properties and audit trail<a href="data-preparation-for-digital-soil-mapping-in-r.html#reporting-out-of-bounds-for-properties-and-audit-trail" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Generate a summary by property, identify records with issues (often indicative of systematic errors), and export a full QC report for review and documentation.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Report out-of-bounds if present</span></span>
<span id="cb99-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(out_of_bounds_issues) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb99-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-3" aria-hidden="true" tabindex="-1"></a>  all_issues <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(out_of_bounds_issues)</span>
<span id="cb99-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st"> Out-of-bounds properties found</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb99-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summary by property</span></span>
<span id="cb99-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-7" aria-hidden="true" tabindex="-1"></a>  issue_summary <span class="ot">&lt;-</span> all_issues <span class="sc">%&gt;%</span></span>
<span id="cb99-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(property, description) <span class="sc">%&gt;%</span></span>
<span id="cb99-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb99-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb99-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_value_found =</span> <span class="fu">min</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb99-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_value_found =</span> <span class="fu">max</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb99-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_valid =</span> <span class="fu">first</span>(min_valid),</span>
<span id="cb99-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_valid =</span> <span class="fu">first</span>(max_valid),</span>
<span id="cb99-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb99-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb99-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span>
<span id="cb99-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Issues by property:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb99-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(issue_summary)</span>
<span id="cb99-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rows with multiple issues</span></span>
<span id="cb99-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-23" aria-hidden="true" tabindex="-1"></a>  rows_with_multiple_issues <span class="ot">&lt;-</span> all_issues <span class="sc">%&gt;%</span></span>
<span id="cb99-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(rowID) <span class="sc">%&gt;%</span></span>
<span id="cb99-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb99-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_issues =</span> <span class="fu">n</span>(),</span>
<span id="cb99-27"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">properties =</span> <span class="fu">paste</span>(property, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>),</span>
<span id="cb99-28"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb99-29"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-29" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb99-30"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n_issues <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-31"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(n_issues))</span>
<span id="cb99-32"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-33"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(rows_with_multiple_issues) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb99-34"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st"> Records with MULTIPLE property issues:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb99-35"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">head</span>(rows_with_multiple_issues, <span class="dv">10</span>))</span>
<span id="cb99-36"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">These records likely have data entry errors and should be reviewed.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb99-37"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb99-38"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-39"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Export QC report</span></span>
<span id="cb99-40"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_xlsx</span>(</span>
<span id="cb99-41"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb99-42"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">Summary =</span> issue_summary,</span>
<span id="cb99-43"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">Issues_by_record =</span> rows_with_multiple_issues,</span>
<span id="cb99-44"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">All_issues =</span> all_issues</span>
<span id="cb99-45"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-45" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb99-46"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(output_dir,<span class="st">&quot;soil_property_validation_report.xlsx&quot;</span>)</span>
<span id="cb99-47"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-48"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-49"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st"> Detailed report saved to: soil_property_validation_report.xlsx</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb99-50"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-51"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(all_issues, issue_summary, rows_with_multiple_issues)</span>
<span id="cb99-52"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-53"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-53" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb99-54"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st"> All soil properties within valid ranges!</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb99-55"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb99-55" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="check-2-texture-validation" class="section level3 hasAnchor" number="1.6.3">
<h3><span class="header-section-number">1.6.3</span> Check 2: Texture validation<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-texture-validation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Particle-size fractions should sum to approximately 100%. This check is used to flag potential inconsistencies (rounding, unit conversion issues, or data errors). The following code just flag inconsistencies in Particle-size fractions. Values failing this check should be reviewed rather than automatically removed.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print rows with texture validation incosistencies </span></span>
<span id="cb100-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-2" aria-hidden="true" tabindex="-1"></a>texture_problems <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb100-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">texture_sum =</span> Clay <span class="sc">+</span> Silt <span class="sc">+</span> Sand,</span>
<span id="cb100-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">texture_valid =</span> <span class="fu">abs</span>(texture_sum <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">&lt;</span> <span class="dv">2</span></span>
<span id="cb100-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb100-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-8" aria-hidden="true" tabindex="-1"></a>texture_problems <span class="ot">&lt;-</span> texture_problems <span class="sc">%&gt;%</span></span>
<span id="cb100-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>texture_valid)</span>
<span id="cb100-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(texture_problems) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb100-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot; Found&quot;</span>, <span class="fu">nrow</span>(texture_problems),</span>
<span id="cb100-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;records with invalid texture sums</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb100-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(texture_problems <span class="sc">%&gt;%</span></span>
<span id="cb100-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(rowID, ProfID, Clay, Silt, Sand, texture_sum))</span>
<span id="cb100-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Flag for review (do not automatically remove)</span></span>
<span id="cb100-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb100-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="check-3-correction-of-out-of-bounds-laboratory-values" class="section level3 hasAnchor" number="1.6.4">
<h3><span class="header-section-number">1.6.4</span> Check 3: Correction of out-of-bounds laboratory values<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-3-correction-of-out-of-bounds-laboratory-values" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Out-of-bounds values identified during validation should be handled systematically and transparently. Corrections must follow clearly defined rules to avoid introducing subjective bias or undocumented changes.</p>
<p>Two complementary approaches are recommended:</p>
<p><strong>Option 1 (preferred): targeted correction</strong>, when the error mechanism is known and the true value can be reasonably inferred (e.g., sign errors or unit-scaling mistakes).</p>
<p><strong>Option 2: replacement with <code>NA</code></strong>, when the true value cannot be reliably reconstructed. This preserves the observation while preventing propagation of erroneous measurements into subsequent analyses.</p>
<div class="warning-box">
<ul>
<li><strong>Option 1</strong> requires a clear understanding of the relevant properties and thresholds to correctly identify errors, which can then be fixed with dedicated code.</li>
<li><strong>Option 2</strong> is a more drastic approach, as it will automatically replace all potential mistakes with <code>NA</code>. This can result in a critical decrease in records for some measured properties.</li>
<li>Choosing between these options is a decision for the data manager. Handle both with care.</li>
</ul>
</div>
<div id="option-1-targeted-corrections-when-error-mechanism-is-known" class="section level4 hasAnchor" number="1.6.4.1">
<h4><span class="header-section-number">1.6.4.1</span> Option 1: Targeted corrections (when error mechanism is known)<a href="data-preparation-for-digital-soil-mapping-in-r.html#option-1-targeted-corrections-when-error-mechanism-is-known" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Apply deterministic corrections only when the source of error is clearly understood and scientifically justified.</p>
<p>The summary of the critical values provides information on the nature of each issue.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (property <span class="cf">in</span> <span class="fu">names</span>(out_of_bounds_issues)){</span>
<span id="cb101-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Total errors in&quot;</span>,property, <span class="st">&quot;:&quot;</span>,<span class="fu">n_distinct</span>(out_of_bounds_issues[[property]]<span class="sc">$</span>rowID), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb101-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(<span class="fu">data.frame</span>(out_of_bounds_issues[property])[<span class="dv">4</span>]))</span>
<span id="cb101-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb101-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In the KSSL dataset provided, <code>SOC</code> is negative in 43 rows while <code>Phosphorus_Mehlich3</code> has wrong values in 1 row.</p>
<p>Example corrections shown below assume:<br />
- Negative <code>SOC</code> values arise from sign errors, and<br />
- Extremely high <code>Phosphorus_Mehlich3</code> values arise from unit scaling (e.g., ppb recorded instead of mg/kg).</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correction: Negative SOC values</span></span>
<span id="cb102-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-2" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(site_lab<span class="sc">$</span>SOC) <span class="sc">&amp;</span> site_lab<span class="sc">$</span>SOC <span class="sc">&lt;</span> <span class="dv">0</span></span>
<span id="cb102-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(idx)) site_lab<span class="sc">$</span>SOC[idx] <span class="ot">&lt;-</span> <span class="fu">abs</span>(site_lab<span class="sc">$</span>SOC[idx])</span>
<span id="cb102-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove temporary objects</span></span>
<span id="cb102-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(idx)</span>
<span id="cb102-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Correction: Phosphorus Mehlich 3 &gt; 2000 mg/kg (likely 1000× error - ppb instead of ppm)</span></span>
<span id="cb102-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-8" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(site_lab<span class="sc">$</span>Phosphorus_Mehlich3) <span class="sc">&amp;</span> site_lab<span class="sc">$</span>Phosphorus_Mehlich3 <span class="sc">&gt;</span> <span class="dv">2000</span></span>
<span id="cb102-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-9" aria-hidden="true" tabindex="-1"></a>n_idx <span class="ot">&lt;-</span> <span class="fu">sum</span>(idx)</span>
<span id="cb102-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (n_idx <span class="sc">&gt;</span> <span class="dv">0</span>) site_lab<span class="sc">$</span>Phosphorus_Mehlich3[idx] <span class="ot">&lt;-</span> site_lab<span class="sc">$</span>Phosphorus_Mehlich3[idx] <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb102-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove temporary objects</span></span>
<span id="cb102-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(idx, n_idx)</span></code></pre></div>
</div>
<div id="option-2-replace-out-of-bounds-values-with-na" class="section level4 hasAnchor" number="1.6.4.2">
<h4><span class="header-section-number">1.6.4.2</span> Option 2: Replace out-of-bounds values with <code>NA</code><a href="data-preparation-for-digital-soil-mapping-in-r.html#option-2-replace-out-of-bounds-values-with-na" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When values cannot be corrected with confidence, replace only the problematic measurements with <code>NA</code> while retaining the rest of the record.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each property in the out_of_bounds_issues list</span></span>
<span id="cb103-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (property <span class="cf">in</span> <span class="fu">names</span>(out_of_bounds_issues)) {</span>
<span id="cb103-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the rowIDs with issues for this property</span></span>
<span id="cb103-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-4" aria-hidden="true" tabindex="-1"></a>  rowIDs_with_issues <span class="ot">&lt;-</span> <span class="fu">unique</span>(out_of_bounds_issues[[property]]<span class="sc">$</span>rowID)</span>
<span id="cb103-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change the values of the property in those rows to NA</span></span>
<span id="cb103-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-6" aria-hidden="true" tabindex="-1"></a>  site_lab <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb103-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;{property}&quot;</span> <span class="sc">:</span><span class="er">=</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(rowID <span class="sc">%in%</span> rowIDs_with_issues,</span>
<span id="cb103-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">as.numeric</span>(<span class="cn">NA</span>), .data[[property]])</span>
<span id="cb103-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb103-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb103-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
<div id="duplicate-detection" class="section level2 hasAnchor" number="1.7">
<h2><span class="header-section-number">1.7</span> Resolving duplicated data in soil profiles<a href="data-preparation-for-digital-soil-mapping-in-r.html#duplicate-detection" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Duplicate or repeated soil profile descriptions may occur when the same location is sampled or analysed multiple times. These situations can produce multiple horizon sequences under the same <code>ProfID</code>, resulting in inconsistent depth intervals, overlapping layers, or conflicting analytical values.</p>
<p>Such inconsistencies must be resolved before depth harmonization and Digital Soil Mapping, as it requires one coherent and unique vertical profile per location.</p>
<p>The objective of this section is to:</p>
<p>-Detect duplicated or overlapping depth descriptions</p>
<p>-Merge replicated analytical measurements when appropriate</p>
<ul>
<li>Separate or select among competing depth sequences</li>
</ul>
<p>-Retain only complete and internally consistent profiles</p>
<div id="why-duplicates-occur" class="section level3 hasAnchor" number="1.7.1">
<h3><span class="header-section-number">1.7.1</span> Why duplicates occur<a href="data-preparation-for-digital-soil-mapping-in-r.html#why-duplicates-occur" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Duplicates typically arise from:</p>
<ul>
<li><p>Re-sampling of the same location in later campaigns (temporal duplicates)</p></li>
<li><p>Multiple laboratory analyses of the same sample (analytical replicates)</p></li>
<li><p>Re-use of identifiers across merged surveys</p></li>
</ul>
<p>These situations may produce:</p>
<ul>
<li><p>Multiple horizon sequences per <code>ProfID</code></p></li>
<li><p>Overlapping or conflicting depth intervals</p></li>
<li><p>Repeated horizons with different values</p></li>
<li><p>Ambiguity about which sequence should be used for modelling</p></li>
</ul>
</div>
<div id="types-of-duplicate-situations" class="section level3 hasAnchor" number="1.7.2">
<h3><span class="header-section-number">1.7.2</span> Types of duplicate situations<a href="data-preparation-for-digital-soil-mapping-in-r.html#types-of-duplicate-situations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It is important to distinguish between two fundamentally different cases:</p>
<p><strong>- Case A — Replicated analyses of the same horizons (same depths)</strong></p>
<pre><code>- Identical top–bottom intervals in the same profile

- Multiple measurements of the same soil layer

- Depth integrity is preserved

- Typical in monitoring databases</code></pre>
<ul>
<li><em>Action</em>: If used for monitoring, use the data for the corresponding period; otherwise, merge measurements (e.g., average values)</li>
</ul>
<p><strong>- Case B — Multiple depth sequences (different depths)</strong></p>
<pre><code>- Different top–bottom structures within the same ProfID

- Represents independent profile descriptions</code></pre>
<ul>
<li><em>Action</em>: select one representative sequence</li>
</ul>
</div>
<div id="check-1-detect-potential-horizon-duplicates-within-profiles" class="section level3 hasAnchor" number="1.7.3">
<h3><span class="header-section-number">1.7.3</span> Check 1: Detect potential horizon duplicates within profiles<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-detect-potential-horizon-duplicates-within-profiles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Profile identifiers <code>ProfID</code> have been previously constructed by grouping horizons with identical coordinates into the same profile. However, if multiple profile descriptions have been created at the same location, the <code>ProfID</code> will be the same. The objective now is to flag <code>ProfID</code> values that appear to contain more than one distinct depth sequence (i.e., multiple sets of horizon boundaries).</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Detect potential horizon duplicates within profiles</span></span>
<span id="cb106-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-2" aria-hidden="true" tabindex="-1"></a>profile_analysis <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb106-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ProfID) <span class="sc">%&gt;%</span></span>
<span id="cb106-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb106-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_horizons =</span> <span class="fu">n</span>(),</span>
<span id="cb106-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_unique_tops =</span> <span class="fu">n_distinct</span>(top),</span>
<span id="cb106-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_unique_bottoms =</span> <span class="fu">n_distinct</span>(bottom),</span>
<span id="cb106-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">max</span>(bottom, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb106-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb106-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb106-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If all horizons have unique top/bottom values, </span></span>
<span id="cb106-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># depths are consistent (no duplicates)</span></span>
<span id="cb106-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">consistent =</span> (n_unique_tops <span class="sc">==</span> n_horizons <span class="sc">&amp;</span> n_unique_bottoms <span class="sc">==</span> n_horizons),</span>
<span id="cb106-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">likely_duplicates =</span> <span class="sc">!</span>consistent</span>
<span id="cb106-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Find profiles with likely duplicates</span></span>
<span id="cb106-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-19" aria-hidden="true" tabindex="-1"></a>duplicates <span class="ot">&lt;-</span> profile_analysis <span class="sc">%&gt;%</span></span>
<span id="cb106-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(likely_duplicates)</span>
<span id="cb106-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(duplicates) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb106-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot; Found&quot;</span>, <span class="fu">nrow</span>(duplicates), </span>
<span id="cb106-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;profiles with likely duplicates measurement sequences</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb106-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(duplicates)</span>
<span id="cb106-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-27"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-28"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Select all profiles presenting duplicate horizons</span></span>
<span id="cb106-29"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-29" aria-hidden="true" tabindex="-1"></a>duplicates <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb106-30"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb106-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ProfID <span class="sc">%in%</span> duplicates<span class="sc">$</span>ProfID)</span></code></pre></div>
</div>
<div id="resolving-profile-duplicates" class="section level3 hasAnchor" number="1.7.4">
<h3><span class="header-section-number">1.7.4</span> Resolving Profile Duplicates<a href="data-preparation-for-digital-soil-mapping-in-r.html#resolving-profile-duplicates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Duplicate handling should follow the order below:</p>
<p><strong>1 → merge duplicated horizons</strong><br />
<strong>2 → resolve competing depth sequences</strong><br />
<strong>3 → remove incomplete profiles</strong></p>
<p>This order prevents premature data loss and preserves maximum analytical information.</p>
<div id="check-1-average-duplicated-horizons-same-depth-intervals" class="section level4 hasAnchor" number="1.7.4.1">
<h4><span class="header-section-number">1.7.4.1</span> Check 1: Average duplicated horizons (same depth intervals)<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-average-duplicated-horizons-same-depth-intervals" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When multiple records share identical <code>ProfID</code>, <code>top</code>, and <code>bottom</code>, they represent repeated measurements of the same soil layer. These should be consolidated into a single horizon. Numeric properties are averaged and common identifiers are retained from the first occurrence.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----</span></span>
<span id="cb107-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Correction 1: Summarize property in duplicated horizons my mean</span></span>
<span id="cb107-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. PROF0237, PROF0262, PROF0271, PROF0284, PROF0368)</span></span>
<span id="cb107-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -----</span></span>
<span id="cb107-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-5" aria-hidden="true" tabindex="-1"></a>site_lab <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb107-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ProfID, top, bottom) <span class="sc">%&gt;%</span></span>
<span id="cb107-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb107-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep identifiers as the first value in each group</span></span>
<span id="cb107-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">c</span>(rowID, HorID, lon, lat), <span class="sc">~</span> <span class="fu">first</span>(.x)),</span>
<span id="cb107-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute mean for all other numeric columns (NA-safe)</span></span>
<span id="cb107-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb107-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">where</span>(is.numeric) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">any_of</span>(<span class="fu">c</span>(<span class="st">&quot;rowID&quot;</span>,<span class="st">&quot;HorID&quot;</span>,<span class="st">&quot;lon&quot;</span>,<span class="st">&quot;lat&quot;</span>,<span class="st">&quot;top&quot;</span>,<span class="st">&quot;bottom&quot;</span>)),</span>
<span id="cb107-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-14" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">is.na</span>(.x))) <span class="cn">NA_real_</span> <span class="cf">else</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb107-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb107-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb107-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb107-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb107-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">names</span>(site_lab))   <span class="co"># &lt;- restores original column order</span></span></code></pre></div>
<div class="key-concept">
<ul>
<li>Replicates increase measurement reliability.</li>
<li>Averaging avoids discarding valid analytical information.</li>
</ul>
</div>
</div>
<div id="check-2-resolve-profid-for-multiple-depth-sequences" class="section level4 hasAnchor" number="1.7.4.2">
<h4><span class="header-section-number">1.7.4.2</span> Check 2: Resolve ProfID for multiple depth sequences<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-resolve-profid-for-multiple-depth-sequences" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Multiple independent profile descriptions likely exist in a single location. This data is valid and must remain in the dataset, but it has to be differentiated by its <code>ProfID</code>.</p>
<p>A <code>chain_horizons</code> function has been created to identify different sequences in horizons within each profile.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect ProfID series with different top-bottom depth sequences</span></span>
<span id="cb108-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. For each profile, check if all rows form ONE continuous depth sequence</span></span>
<span id="cb108-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. If YES → Single profile (done)</span></span>
<span id="cb108-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. If NO → Find the consecutive horizons that ARE continuous</span></span>
<span id="cb108-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. If we find blocks with no gaps → Split the series into subprofiles</span></span>
<span id="cb108-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a function to identify sequences of horizons for each profile</span></span>
<span id="cb108-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-8" aria-hidden="true" tabindex="-1"></a>chain_horizons <span class="ot">&lt;-</span> <span class="cf">function</span>(top, bottom) {</span>
<span id="cb108-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-9" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(top)</span>
<span id="cb108-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-10" aria-hidden="true" tabindex="-1"></a>  remaining <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(n)</span>
<span id="cb108-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-11" aria-hidden="true" tabindex="-1"></a>  chain_id <span class="ot">&lt;-</span> <span class="fu">integer</span>(n)</span>
<span id="cb108-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-12" aria-hidden="true" tabindex="-1"></a>  cid <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb108-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(<span class="fu">length</span>(remaining) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb108-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># start new chain at smallest top</span></span>
<span id="cb108-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-16" aria-hidden="true" tabindex="-1"></a>    cur <span class="ot">&lt;-</span> remaining[<span class="fu">which.min</span>(top[remaining])]</span>
<span id="cb108-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb108-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-18" aria-hidden="true" tabindex="-1"></a>      chain_id[cur] <span class="ot">&lt;-</span> cid</span>
<span id="cb108-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-19" aria-hidden="true" tabindex="-1"></a>      remaining <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(remaining, cur)</span>
<span id="cb108-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-20" aria-hidden="true" tabindex="-1"></a>      nxt <span class="ot">&lt;-</span> remaining[top[remaining] <span class="sc">==</span> bottom[cur]]</span>
<span id="cb108-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(nxt) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">break</span></span>
<span id="cb108-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-22" aria-hidden="true" tabindex="-1"></a>      cur <span class="ot">&lt;-</span> nxt[<span class="dv">1</span>]</span>
<span id="cb108-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb108-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-24" aria-hidden="true" tabindex="-1"></a>    cid <span class="ot">&lt;-</span> cid <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb108-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-26" aria-hidden="true" tabindex="-1"></a>  chain_id</span>
<span id="cb108-27"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-28"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-29"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-29" aria-hidden="true" tabindex="-1"></a>site_lab <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb108-30"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat, ProfID) <span class="sc">%&gt;%</span></span>
<span id="cb108-31"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">chain =</span> <span class="fu">chain_horizons</span>(top, bottom)) <span class="sc">%&gt;%</span>   <span class="co"># detect sequences</span></span>
<span id="cb108-32"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(chain, top, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>         <span class="co"># sort within each chain</span></span>
<span id="cb108-33"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb108-34"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">ProfID =</span> <span class="fu">paste0</span>(ProfID, <span class="st">&quot;_&quot;</span>, chain)             <span class="co"># add a numeric suffix</span></span>
<span id="cb108-35"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb108-36"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb108-37"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-38"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-39"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-39" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">max</span>(site_lab<span class="sc">$</span>chain, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb108-40"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-40" aria-hidden="true" tabindex="-1"></a>  corrected_profiles <span class="ot">&lt;-</span> <span class="fu">unique</span>(site_lab<span class="sc">$</span>ProfID[site_lab<span class="sc">$</span>chain <span class="sc">&gt;=</span> <span class="dv">2</span>])</span>
<span id="cb108-41"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;→ Corrected depth continuity in&quot;</span>, <span class="fu">length</span>(corrected_profiles), <span class="st">&quot;profiles</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb108-42"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;  Corrected Profiles:&quot;</span>, <span class="fu">paste</span>(<span class="fu">sub</span>(<span class="st">&quot;_2$&quot;</span>, <span class="st">&quot;&quot;</span>, corrected_profiles), <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb108-43"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-43" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb108-44"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;→ No depth continuity corrections were needed</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb108-45"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-46"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-47"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete the chain column</span></span>
<span id="cb108-48"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-48" aria-hidden="true" tabindex="-1"></a>site_lab <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb108-49"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>chain)</span>
<span id="cb108-50"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-51"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete temporary objects</span></span>
<span id="cb108-52"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb108-52" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(corrected_profiles,chain_horizons)</span></code></pre></div>
</div>
</div>
<div id="remove-profiles-not-starting-at-the-surface" class="section level3 hasAnchor" number="1.7.5">
<h3><span class="header-section-number">1.7.5</span> Remove profiles not starting at the surface<a href="data-preparation-for-digital-soil-mapping-in-r.html#remove-profiles-not-starting-at-the-surface" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Profiles whose shallowest horizon does not begin at 0 cm represent mistakes or incomplete descriptions and may bias depth harmonization and DSM modelling.</p>
<p>Only profiles whose first horizon begins at the surface (top = 0 cm) should be retained for analyses requiring complete vertical representation.</p>
<div id="check-1-remove-profiles-with-incomplete-surface-coverage" class="section level4 hasAnchor" number="1.7.5.1">
<h4><span class="header-section-number">1.7.5.1</span> Check 1: Remove profiles with incomplete surface coverage<a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-remove-profiles-with-incomplete-surface-coverage" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As a result of the previous steps, some horizons may remain without forming a continuous sequence within their profile. The objective here is to retain only those profiles whose shallowest recorded depth starts at 0 cm.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb109-1" aria-hidden="true" tabindex="-1"></a>site_lab <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb109-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ProfID) <span class="sc">%&gt;%</span></span>
<span id="cb109-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">min</span>(top, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb109-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ProfID, top, bottom, HorID) <span class="sc">%&gt;%</span></span>
<span id="cb109-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
</div>
</div>
<div id="result" class="section level3 hasAnchor" number="1.7.6">
<h3><span class="header-section-number">1.7.6</span> Result<a href="data-preparation-for-digital-soil-mapping-in-r.html#result" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After this procedure, we obtain a clean horizon-level dataset containing validated site, analytical, and metadata information. The dataset contains:</p>
<ul>
<li>One consistent depth sequence per <code>ProfID</code><br />
</li>
<li>No duplicated horizons</li>
<li>Consolidated analytical measurements</li>
<li>Alternative profiles at the same location can coexist</li>
</ul>
<p>This database can be exported to <code>csv</code> and <code>.xlsx</code> files.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb110-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-2" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_cleaned.csv&quot;</span>)</span>
<span id="cb110-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(site_lab, output, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb110-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to Excel</span></span>
<span id="cb110-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-6" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_cleaned.xlsx&quot;</span>)</span>
<span id="cb110-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_xlsx</span>(site_lab, output)</span></code></pre></div>
</div>
</div>
<div id="harmonization" class="section level2 hasAnchor" number="1.8">
<h2><span class="header-section-number">1.8</span> Harmonizing data for DSM<a href="data-preparation-for-digital-soil-mapping-in-r.html#harmonization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As shown in the previous step, the database produced can still present several alternative profiles coexisting at the same location. These profiles present different top-depth valid horizon sequences that must be retained in the soil database. When multiple valid profiles exist at the same coordinates, DSM requires a single profile description at each single location. There are different profile selection criteria based in the data available and/or modeling purpose. Select the option using one of these criteria: :</p>
<pre><code>      -   **Most complete**: Keep sequence with most horizons (more depth detail)
      -   **Best coverage**: Keep sequence extending deepest (most information)
      -   **Best quality** : Keep sequence with fewest missing values
      -   **Monitoring**   : Keep sequence analyzed at the period of interest (requires `Date` information)</code></pre>
<p>In general, for monitoring activities, profiles can be selected upon a time key (e.g., <code>Date</code>, <code>campaign_id</code>) and treat profiles as separate observations information. This will allow to model temporal trends, or time-specific DSM surfaces. When sampling dates or campaign metadata are unavailable, the <strong>most complete</strong> (more depth detail) sequence is typically safest.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new object to store DSM harmonized data</span></span>
<span id="cb112-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep most complete profiles at each location to avoid duplicated profiles  </span></span>
<span id="cb112-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-3" aria-hidden="true" tabindex="-1"></a>horizons <span class="ot">&lt;-</span> site_lab <span class="sc">%&gt;%</span></span>
<span id="cb112-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat, ProfID) <span class="sc">%&gt;%</span></span>
<span id="cb112-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_hz =</span> <span class="fu">n_distinct</span>(<span class="fu">paste</span>(top, bottom)), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb112-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat) <span class="sc">%&gt;%</span></span>
<span id="cb112-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_max</span>(n_hz, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb112-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lon, lat, ProfID) <span class="sc">%&gt;%</span></span>
<span id="cb112-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(site_lab, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;ProfID&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb112-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<div class="key-concept">
<p><strong>DSM requires one profile per location</strong></p>
<ul>
<li><p>If no <code>Date</code>/<code>campaign</code> metadata exists → keep the most complete profile per location.</p></li>
<li><p>If <code>Date</code>/<code>campaign</code> exists and the purpose is monitoring → stratify by <code>Date</code>/<code>campaign</code> and keep one profile per location per <code>Date</code>/<code>campaign</code></p></li>
</ul>
</div>
<div id="depth-standardization" class="section level3 hasAnchor" number="1.8.1">
<h3><span class="header-section-number">1.8.1</span> Depth standardization<a href="data-preparation-for-digital-soil-mapping-in-r.html#depth-standardization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, DSM requires analytical data calculated at standardized depth intervals (the same depths for every profile). The standard depths typically used are 0–30 cm (topsoil), 30–60 cm (subsoil), and 60–100 cm (deep subsoil). These represent meaningful soil zones in terms of soil fertility, root penetration, weathering, and soil formation.</p>
<p>Since the cleaned dataset contains properties at variable-depth horizons for each profile, depth harmonization is needed.</p>
<p>The Algorithms for Quantitative Pedology (<code>aqp</code>) package provides the <code>slab()</code> function for standardizing variable-depth soil data using weighted averaging.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aqp)</span>
<span id="cb113-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define standard depth intervals</span></span>
<span id="cb113-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-4" aria-hidden="true" tabindex="-1"></a>standard_depths <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">60</span>)  <span class="co"># 0-30, 30-60 cm</span></span>
<span id="cb113-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Select properties to standardize</span></span>
<span id="cb113-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-7" aria-hidden="true" tabindex="-1"></a>properties_to_standardize <span class="ot">&lt;-</span> <span class="fu">names</span>(site_lab)[<span class="sc">!</span><span class="fu">names</span>(site_lab) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;rowID&quot;</span>,<span class="st">&quot;ProfID&quot;</span>,<span class="st">&quot;HorID&quot;</span>,<span class="st">&quot;lon&quot;</span>,<span class="st">&quot;lat&quot;</span>,<span class="st">&quot;top&quot;</span>,<span class="st">&quot;bottom&quot;</span>,<span class="st">&quot;texture_sum&quot;</span>,<span class="st">&quot;texture_valid&quot;</span>)]</span>
<span id="cb113-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for aqp</span></span>
<span id="cb113-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create SoilProfileCollection Object</span></span>
<span id="cb113-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="co"># aqp needs profiles + depth structure for proper interpolation</span></span>
<span id="cb113-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="fu">depths</span>(horizons) <span class="ot">&lt;-</span> ProfID <span class="sc">~</span> top <span class="sc">+</span> bottom</span>
<span id="cb113-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Spatial Information to SoilProfileCollection</span></span>
<span id="cb113-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   Links geographic location to soil profiles</span></span>
<span id="cb113-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-17" aria-hidden="true" tabindex="-1"></a><span class="fu">initSpatial</span>(horizons, <span class="at">crs =</span> <span class="st">&quot;EPSG:4326&quot;</span>) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb113-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the standardization formula</span></span>
<span id="cb113-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-20" aria-hidden="true" tabindex="-1"></a>fml <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(</span>
<span id="cb113-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">&quot;ProfID ~&quot;</span>, <span class="fu">paste</span>(properties_to_standardize, <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>))</span>
<span id="cb113-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply slab() to interpolate to standard depths</span></span>
<span id="cb113-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-25" aria-hidden="true" tabindex="-1"></a>KSSL_standardized <span class="ot">&lt;-</span> <span class="fu">slab</span>(</span>
<span id="cb113-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-26" aria-hidden="true" tabindex="-1"></a>  horizons,</span>
<span id="cb113-27"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-27" aria-hidden="true" tabindex="-1"></a>  fml,</span>
<span id="cb113-28"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">slab.structure =</span> standard_depths,  <span class="co"># Target standard depths</span></span>
<span id="cb113-29"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">na.rm =</span> <span class="cn">TRUE</span>                        <span class="co"># Ignore NA values in calculations</span></span>
<span id="cb113-30"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb113-30" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The <code>slab()</code> function produces output with: - <code>p.q5</code>: 5th percentile (lower confidence bound) - <code>p.q50</code>: Median estimate (best estimate) - <code>p.q95</code>: 95th percentile (upper confidence bound)</p>
<p>The 5th to 95th percentile range provides a 90% confidence interval, quantifying uncertainty in the standardized estimates.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Confidence Interval of the estimations (CI column)</span></span>
<span id="cb114-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Shows range of uncertainty (p.q5 to p.q95)</span></span>
<span id="cb114-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-4" aria-hidden="true" tabindex="-1"></a>KSSL_standardized <span class="ot">&lt;-</span> KSSL_standardized <span class="sc">%&gt;%</span></span>
<span id="cb114-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb114-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 90% confidence interval string (p.q5 to p.q95)</span></span>
<span id="cb114-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">CI =</span> <span class="fu">paste0</span>(</span>
<span id="cb114-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(p.q5, <span class="dv">3</span>),                 <span class="co"># Lower bound (5th percentile)</span></span>
<span id="cb114-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;-&quot;</span>,</span>
<span id="cb114-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(p.q95, <span class="dv">3</span>)                 <span class="co"># Upper bound (95th percentile)</span></span>
<span id="cb114-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb114-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb114-12" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="processing-standardized-data" class="section level3 hasAnchor" number="1.8.2">
<h3><span class="header-section-number">1.8.2</span> Processing standardized data<a href="data-preparation-for-digital-soil-mapping-in-r.html#processing-standardized-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The output of the <code>slab()</code> function is a data frame in long format, where soil properties are stored as rows and the estimated percentile values are stored as columns. Each record is identified by <code>ProfID</code>, <code>top</code>, <code>and bottom</code>. For most downstream analyses, the data must be reshaped to wide format (i.e., one row per depth interval, with properties as columns).</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert from long to wide format</span></span>
<span id="cb115-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-2" aria-hidden="true" tabindex="-1"></a>KSSL_standardized <span class="ot">&lt;-</span> KSSL_standardized <span class="sc">%&gt;%</span></span>
<span id="cb115-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb115-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(ProfID, top, bottom), <span class="co"># Keep these as-is</span></span>
<span id="cb115-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> variable,             <span class="co"># Property names become column names</span></span>
<span id="cb115-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(p.q50, CI),        <span class="co"># Both point estimate and CI</span></span>
<span id="cb115-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">&quot;{variable}_{.value}&quot;</span> <span class="co"># Create names like &quot;SOC_p.q50&quot;, &quot;SOC_CI&quot;</span></span>
<span id="cb115-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb115-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add geographic coordinates back</span></span>
<span id="cb115-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-11" aria-hidden="true" tabindex="-1"></a>KSSL_standardized <span class="ot">&lt;-</span> KSSL_standardized <span class="sc">%&gt;%</span></span>
<span id="cb115-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get coordinates from original data (one per profile)</span></span>
<span id="cb115-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb115-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-14" aria-hidden="true" tabindex="-1"></a>    site_lab <span class="sc">%&gt;%</span></span>
<span id="cb115-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(ProfID, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>  <span class="co"># One row per profile</span></span>
<span id="cb115-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(ProfID, lon, lat),</span>
<span id="cb115-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">&quot;ProfID&quot;</span></span>
<span id="cb115-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb115-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Move coordinates to front for readability</span></span>
<span id="cb115-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(lon, lat, <span class="at">.after =</span> ProfID)</span>
<span id="cb115-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Since ProfIDs are now unique at each location, remove tailings ProfID values</span></span>
<span id="cb115-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-23" aria-hidden="true" tabindex="-1"></a>KSSL_standardized<span class="sc">$</span>ProfID <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;_[12]$&quot;</span>, <span class="st">&quot;&quot;</span>, KSSL_standardized<span class="sc">$</span>ProfID)</span>
<span id="cb115-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: One row per profile-depth, with standardized soil properties</span></span>
<span id="cb115-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb115-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(KSSL_standardized)</span></code></pre></div>
<p>The final step is to save this dataset with standardized soil properties at two depths.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb116-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-2" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_standardized.csv&quot;</span>)</span>
<span id="cb116-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(KSSL_standardized, output, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb116-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to Excel</span></span>
<span id="cb116-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-6" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_standardized.xlsx&quot;</span>)</span>
<span id="cb116-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_xlsx</span>(KSSL_standardized, output)</span></code></pre></div>
</div>
<div id="exporting-standardized-data-for-digital-soil-mapping" class="section level3 hasAnchor" number="1.8.3">
<h3><span class="header-section-number">1.8.3</span> Exporting standardized data for Digital Soil Mapping<a href="data-preparation-for-digital-soil-mapping-in-r.html#exporting-standardized-data-for-digital-soil-mapping" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At this stage, the dataset is standardized to one row per profile and standard depth interval. Soil properties at these depths are derived from the original horizon measurements using depth-weighted averaging, and the output includes the percentiles of the weighted estimates (e.g., p05, p50, p95).</p>
<p>For the Digital Soil Modelling exercise in this tutorial, we will work with a subset focused on the topsoil (0–30 cm) and use the median (p50) estimates for the following properties: clay, silt, sand, SOC, and pH.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only 0-30 cm depth and select relevant columns (Clay, Silt, Sand, SOC &amp; pH)</span></span>
<span id="cb117-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-2" aria-hidden="true" tabindex="-1"></a>subset_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb117-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(top <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> bottom <span class="sc">==</span> <span class="dv">30</span>) <span class="sc">%&gt;%</span></span>
<span id="cb117-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb117-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-5" aria-hidden="true" tabindex="-1"></a>    ProfID,</span>
<span id="cb117-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-6" aria-hidden="true" tabindex="-1"></a>    lon,</span>
<span id="cb117-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-7" aria-hidden="true" tabindex="-1"></a>    lat,</span>
<span id="cb117-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-8" aria-hidden="true" tabindex="-1"></a>    top,</span>
<span id="cb117-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-9" aria-hidden="true" tabindex="-1"></a>    bottom,</span>
<span id="cb117-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clay =</span> Clay_p.q50,</span>
<span id="cb117-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Silt =</span> Silt_p.q50,</span>
<span id="cb117-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sand =</span> Sand_p.q50,</span>
<span id="cb117-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">SOC =</span> SOC_p.q50,</span>
<span id="cb117-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pH =</span> pH_p.q50</span>
<span id="cb117-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb117-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb117-18"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-18" aria-hidden="true" tabindex="-1"></a>output_csv <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_DSM_0-301.csv&quot;</span>)</span>
<span id="cb117-19"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-19" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(subset_data, output_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb117-20"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot; Saved to:&quot;</span>, output_csv, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb117-21"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-22"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to Excel</span></span>
<span id="cb117-23"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-23" aria-hidden="true" tabindex="-1"></a>output_xlsx <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_DSM_0-30.xlsx&quot;</span>)</span>
<span id="cb117-24"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-24" aria-hidden="true" tabindex="-1"></a><span class="fu">write_xlsx</span>(subset_data, output_xlsx)</span>
<span id="cb117-25"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot; Saved to:&quot;</span>, output_xlsx, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb117-26"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-27"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot; Subset data ready for Digital Soil Mapping</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb117-28"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb117-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Output file: KSSL_DSM</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="spectroscopy" class="section level2 hasAnchor" number="1.9">
<h2><span class="header-section-number">1.9</span> Preparing data for spectroscopy analyses<a href="data-preparation-for-digital-soil-mapping-in-r.html#spectroscopy" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The original KSSL dataset includes visible–near infrared (vis–NIR) spectral observations associated with each soil horizon. To support spectroscopy-based estimation of soil properties, spectral observations must be integrated with the cleaned horizon dataset (<code>site_lab</code>) that contains unique and consistent soil profiles (<code>ProfID</code>), validated and harmonized horizon depths (<code>top</code>, <code>bottom</code>), corrected laboratory measurements.</p>
<p>Depth-consistent and quality-controlled reference data are essential for building robust spectral calibration models and avoiding bias introduced by duplicated horizons or invalid analytical values.</p>
<p>In this dataset, each soil sample/horizon was measured four times by spectroscopy. Therefore, after merging spectra to the cleaned horizon dataset, the resulting dataset is expected to contain approximately 4× more rows than the resulting cleaned dataset (subject to missing spectra or incomplete records).</p>
<p>Use a <code>left join</code> to preserve the cleaned horizon dataset as the reference. This ensures that every cleaned horizon remains in the merged dataset (even if spectra are missing), and no spectral-only records are introduced without corresponding cleaned horizon metadata. The join key for this operation is <code>HorID</code> in the cleaned dataset and <code>smp_id</code> in the spectral dataset. Then save the results as <code>-csv</code>and <code>.xlsx</code> files.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read and subset spectral data from the original dataset</span></span>
<span id="cb118-2"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-2" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">&quot;../../01_data/module1/MIR_KANSAS_data.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="dv">1</span>) </span>
<span id="cb118-3"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-3" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">&lt;-</span> raw_data[,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span><span class="sc">:</span><span class="dv">22</span>)]</span>
<span id="cb118-4"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge site_lab data to the original Spectral data by their common IDs</span></span>
<span id="cb118-6"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-6" aria-hidden="true" tabindex="-1"></a>site_lab_spec <span class="ot">&lt;-</span> <span class="fu">left_join</span> (site_lab,spec, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;HorID&quot;</span><span class="ot">=</span><span class="st">&quot;smp_id&quot;</span>) )</span>
<span id="cb118-7"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-8"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb118-9"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-9" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_spectral_cleaned.csv&quot;</span>)</span>
<span id="cb118-10"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(site_lab_spec, output, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb118-11"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to Excel</span></span>
<span id="cb118-13"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-13" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">paste0</span>(output_dir,<span class="st">&quot;KSSL_spectral_cleaned.xlsx&quot;</span>)</span>
<span id="cb118-14"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-14" aria-hidden="true" tabindex="-1"></a><span class="fu">write_xlsx</span>(site_lab_spec, output)</span>
<span id="cb118-15"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-16"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove spectral data object</span></span>
<span id="cb118-17"><a href="data-preparation-for-digital-soil-mapping-in-r.html#cb118-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(spec)</span></code></pre></div>
<div class="warning-box">
<p><strong> - Best practices and recommendations</strong></p>
<ul>
<li><p><strong>Trust but verify</strong>: Never assume data is correct. Always validate systematically.</p></li>
<li><p><strong>Document everything</strong>: Record what was removed, why it was removed, and how many records were affected. This documentation is essential for transparency and reproducibility.</p></li>
<li><p><strong>Preserve data lineage</strong>: Use unique row identifiers to track which raw records became which cleaned records. This allows you to trace any result back to its source data.</p></li>
<li><p><strong>Be conservative with removal</strong>: Only remove records if certain they are wrong. When uncertain, flag records for manual review rather than automatically excluding them.</p></li>
<li><p><strong>Automate, don’t manually edit</strong>: Write code that performs all cleaning steps, rather than manually editing spreadsheets. Code-based approaches are reproducible, transparent, and less prone to error.</p></li>
<li><p><strong>Save intermediate steps</strong>: Keep clean versions after each major processing step. This allows you to backtrack if a decision doesn’t work out.</p></li>
</ul>
<p><br />
</p>
<p><strong> - Common pitfalls to avoid</strong></p>
<table>
<colgroup>
<col width="31%" />
<col width="31%" />
<col width="36%" />
</colgroup>
<thead>
<tr class="header">
<th>Pitfall</th>
<th>Problem</th>
<th>Prevention</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Removing too much data</td>
<td>Biased results from non-random loss</td>
<td>Document removal rate; flag &gt;30%</td>
</tr>
<tr class="even">
<td>Skipping validation</td>
<td>Problems propagate to analysis</td>
<td>Use systematic checklists</td>
</tr>
<tr class="odd">
<td>Manual edits</td>
<td>Not reproducible, hard to verify</td>
<td>Everything in code</td>
</tr>
<tr class="even">
<td>Ignoring depth issues</td>
<td>Impossible harmonization</td>
<td>Verify bottom &gt; top for all</td>
</tr>
<tr class="odd">
<td>No documentation</td>
<td>Can’t explain analysis later</td>
<td>Keep detailed notes</td>
</tr>
<tr class="even">
<td>Overconfident correction</td>
<td>Guessing wrong fixes errors</td>
<td>Only correct if confident</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="exports" class="section level2 hasAnchor" number="1.10">
<h2><span class="header-section-number">1.10</span> Summary of exported files<a href="data-preparation-for-digital-soil-mapping-in-r.html#exports" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<table>
<colgroup>
<col width="29%" />
<col width="70%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>KSSL_cleaned</td>
<td>Clean horizon-level dataset with validated analytical data</td>
</tr>
<tr class="even">
<td>KSSL_spectral_cleaned</td>
<td>Clean horizon-level dataset with validated analytical and spectroscopic data</td>
</tr>
<tr class="odd">
<td>KSSL_standardized</td>
<td>Depth-harmonized dataset (0–30 cm; 30–60 cm) of all soil properties</td>
</tr>
<tr class="even">
<td>KSSL_DSM</td>
<td>Depth-harmonized dataset (0–30 cm) for Digital Soil Mapping</td>
</tr>
<tr class="odd">
<td>soil_property_validation_report</td>
<td>Detailed report of analytical properties outside valid ranges</td>
</tr>
</tbody>
</table>
</div>
<div id="references" class="section level2 unnumbered hasAnchor">
<h2>References<a href="data-preparation-for-digital-soil-mapping-in-r.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction-to-r-programming.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sampling-design-for-soil-surveys.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": {},
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  },
  "fig_caption": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
