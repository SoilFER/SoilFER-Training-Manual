<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Tutorial Using R | Integrated Soil Information for decision-making </title>
  <meta name="description" content="SoilFER SID Technical Manual" />
  <meta name="generator" content="bookdown 0.35 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Tutorial Using R | Integrated Soil Information for decision-making " />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="SoilFER SID Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Tutorial Using R | Integrated Soil Information for decision-making " />
  
  <meta name="twitter:description" content="SoilFER SID Technical Manual" />
  

<meta name="author" content="Angelini, M.E, Rodriguez Lado, L.,de Sousa Mendes, W., Ribeiro, E., Luotto, I." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="soilfer-design.html"/>
<link rel="next" href="merging-results.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors-and-reviewers.html"><a href="contributors-and-reviewers.html"><i class="fa fa-check"></i>Contributors and reviewers</a></li>
<li class="chapter" data-level="1" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html"><i class="fa fa-check"></i><b>1</b> Presentation and basics</a>
<ul>
<li class="chapter" data-level="1.1" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#background-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Background and Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.2</b> How to use this book</a></li>
<li class="chapter" data-level="1.3" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#training-material"><i class="fa fa-check"></i><b>1.3</b> Training material</a></li>
<li class="chapter" data-level="1.4" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#setting-up-the-software-environment"><i class="fa fa-check"></i><b>1.4</b> Setting up the software environment</a></li>
<li class="chapter" data-level="1.5" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#resources-to-get-started"><i class="fa fa-check"></i><b>1.5</b> Resources to get started</a></li>
<li class="chapter" data-level="1.6" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#basic-concepts"><i class="fa fa-check"></i><b>1.6</b> Basic concepts</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#digital-soil-mapping"><i class="fa fa-check"></i><b>1.6.1</b> Digital Soil Mapping</a></li>
<li class="chapter" data-level="1.6.2" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#main-concepts-scorpan-model"><i class="fa fa-check"></i><b>1.6.2</b> Main concepts: SCORPAN model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html"><i class="fa fa-check"></i><b>2</b> Sampling design for soil surveys</a></li>
<li class="chapter" data-level="3" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>3</b> Introduction</a></li>
<li class="chapter" data-level="4" data-path="sampling-theory.html"><a href="sampling-theory.html"><i class="fa fa-check"></i><b>4</b> Sampling methodologies for soil spatial survey</a>
<ul>
<li class="chapter" data-level="4.1" data-path="sampling-theory.html"><a href="sampling-theory.html#selection-methods"><i class="fa fa-check"></i><b>4.1</b> Selection of the sampling methodology</a></li>
<li class="chapter" data-level="4.2" data-path="sampling-theory.html"><a href="sampling-theory.html#inference-methods"><i class="fa fa-check"></i><b>4.2</b> Inference Methods</a></li>
<li class="chapter" data-level="4.3" data-path="sampling-theory.html"><a href="sampling-theory.html#sampling-purpose"><i class="fa fa-check"></i><b>4.3</b> Purpose of Sampling</a></li>
<li class="chapter" data-level="4.4" data-path="sampling-theory.html"><a href="sampling-theory.html#design-types"><i class="fa fa-check"></i><b>4.4</b> Sampling Design Types</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="sampling-theory.html"><a href="sampling-theory.html#soils4africa-example"><i class="fa fa-check"></i><b>4.4.1</b> Example: Soils4Africa Sampling Design</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="soilfer-design.html"><a href="soilfer-design.html"><i class="fa fa-check"></i><b>5</b> SoilFER Sampling Design</a>
<ul>
<li class="chapter" data-level="5.1" data-path="soilfer-design.html"><a href="soilfer-design.html#soil-properties"><i class="fa fa-check"></i><b>5.1</b> Soil Properties</a></li>
<li class="chapter" data-level="5.2" data-path="soilfer-design.html"><a href="soilfer-design.html#env-covariates"><i class="fa fa-check"></i><b>5.2</b> Environmental Covariates</a></li>
<li class="chapter" data-level="5.3" data-path="soilfer-design.html"><a href="soilfer-design.html#methodology"><i class="fa fa-check"></i><b>5.3</b> Understanding the Methodology</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="soilfer-design.html"><a href="soilfer-design.html#psu-selection-process"><i class="fa fa-check"></i><b>5.3.1</b> PSU Selection Process</a></li>
<li class="chapter" data-level="5.3.2" data-path="soilfer-design.html"><a href="soilfer-design.html#ssu-tsu-selection"><i class="fa fa-check"></i><b>5.3.2</b> SSU and TSU Selection Process</a></li>
<li class="chapter" data-level="5.3.3" data-path="soilfer-design.html"><a href="soilfer-design.html#site-id"><i class="fa fa-check"></i><b>5.3.3</b> Site Identification System</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="tutorial.html"><a href="tutorial.html"><i class="fa fa-check"></i><b>6</b> Tutorial Using R</a>
<ul>
<li class="chapter" data-level="6.1" data-path="tutorial.html"><a href="tutorial.html#setup"><i class="fa fa-check"></i><b>6.1</b> Setting Up the Environment</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="tutorial.html"><a href="tutorial.html#install-libraries"><i class="fa fa-check"></i><b>6.1.1</b> Install Required Libraries</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="tutorial.html"><a href="tutorial.html#define-parameters"><i class="fa fa-check"></i><b>6.2</b> Define Variables and Parameters</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="tutorial.html"><a href="tutorial.html#country-iso-code"><i class="fa fa-check"></i><b>6.2.1</b> Country ISO Code</a></li>
<li class="chapter" data-level="6.2.2" data-path="tutorial.html"><a href="tutorial.html#land-use-type"><i class="fa fa-check"></i><b>6.2.2</b> Land Use Type</a></li>
<li class="chapter" data-level="6.2.3" data-path="tutorial.html"><a href="tutorial.html#file-paths"><i class="fa fa-check"></i><b>6.2.3</b> File Paths</a></li>
<li class="chapter" data-level="6.2.4" data-path="tutorial.html"><a href="tutorial.html#coordinate-reference-system"><i class="fa fa-check"></i><b>6.2.4</b> Coordinate Reference System</a></li>
<li class="chapter" data-level="6.2.5" data-path="tutorial.html"><a href="tutorial.html#sample-size-calculation"><i class="fa fa-check"></i><b>6.2.5</b> Sample Size Calculation</a></li>
<li class="chapter" data-level="6.2.6" data-path="tutorial.html"><a href="tutorial.html#sampling-unit-definitions"><i class="fa fa-check"></i><b>6.2.6</b> Sampling Unit Definitions</a></li>
<li class="chapter" data-level="6.2.7" data-path="tutorial.html"><a href="tutorial.html#algorithm-parameters"><i class="fa fa-check"></i><b>6.2.7</b> Algorithm Parameters</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="tutorial.html"><a href="tutorial.html#custom-functions"><i class="fa fa-check"></i><b>6.3</b> Custom Functions</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="tutorial.html"><a href="tutorial.html#covariate-space-coverage-function-csis"><i class="fa fa-check"></i><b>6.3.1</b> Covariate Space Coverage Function (CSIS)</a></li>
<li class="chapter" data-level="6.3.2" data-path="tutorial.html"><a href="tutorial.html#tsu-generation-function"><i class="fa fa-check"></i><b>6.3.2</b> TSU Generation Function</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="tutorial.html"><a href="tutorial.html#load-boundaries"><i class="fa fa-check"></i><b>6.4</b> Load Country Boundaries and Legacy Data</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="tutorial.html"><a href="tutorial.html#visualize-boundaries-and-legacy-data"><i class="fa fa-check"></i><b>6.4.1</b> Visualize Boundaries and Legacy Data</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="tutorial.html"><a href="tutorial.html#load-covariates-psu"><i class="fa fa-check"></i><b>6.5</b> Load Environmental Covariates for PSUs</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="tutorial.html"><a href="tutorial.html#optional-auxiliary-data"><i class="fa fa-check"></i><b>6.5.1</b> Optional Auxiliary Data</a></li>
<li class="chapter" data-level="6.5.2" data-path="tutorial.html"><a href="tutorial.html#load-and-process-auxiliary-data"><i class="fa fa-check"></i><b>6.5.2</b> Load and Process Auxiliary Data</a></li>
<li class="chapter" data-level="6.5.3" data-path="tutorial.html"><a href="tutorial.html#load-main-environmental-covariates"><i class="fa fa-check"></i><b>6.5.3</b> Load Main Environmental Covariates</a></li>
<li class="chapter" data-level="6.5.4" data-path="tutorial.html"><a href="tutorial.html#load-and-process-soil-climate-data-newhall"><i class="fa fa-check"></i><b>6.5.4</b> Load and Process Soil Climate Data (Newhall)</a></li>
<li class="chapter" data-level="6.5.5" data-path="tutorial.html"><a href="tutorial.html#convert-categorical-variables-to-dummy-variables"><i class="fa fa-check"></i><b>6.5.5</b> Convert Categorical Variables to Dummy Variables</a></li>
<li class="chapter" data-level="6.5.6" data-path="tutorial.html"><a href="tutorial.html#merge-all-covariate-layers"><i class="fa fa-check"></i><b>6.5.6</b> Merge All Covariate Layers</a></li>
<li class="chapter" data-level="6.5.7" data-path="tutorial.html"><a href="tutorial.html#crop-and-save-covariates"><i class="fa fa-check"></i><b>6.5.7</b> Crop and Save Covariates</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="tutorial.html"><a href="tutorial.html#pca"><i class="fa fa-check"></i><b>6.6</b> Principal Component Analysis (PCA)</a></li>
<li class="chapter" data-level="6.7" data-path="tutorial.html"><a href="tutorial.html#sampling-universe"><i class="fa fa-check"></i><b>6.7</b> Organize the Sampling Universe</a>
<ul>
<li class="chapter" data-level="6.7.1" data-path="tutorial.html"><a href="tutorial.html#load-and-process-land-use-data"><i class="fa fa-check"></i><b>6.7.1</b> Load and Process Land Use Data</a></li>
<li class="chapter" data-level="6.7.2" data-path="tutorial.html"><a href="tutorial.html#exclude-protected-areas"><i class="fa fa-check"></i><b>6.7.2</b> Exclude Protected Areas</a></li>
<li class="chapter" data-level="6.7.3" data-path="tutorial.html"><a href="tutorial.html#restrict-to-accessible-slopes"><i class="fa fa-check"></i><b>6.7.3</b> Restrict to Accessible Slopes</a></li>
<li class="chapter" data-level="6.7.4" data-path="tutorial.html"><a href="tutorial.html#aggregate-to-100m-resolution"><i class="fa fa-check"></i><b>6.7.4</b> Aggregate to 100m Resolution</a></li>
<li class="chapter" data-level="6.7.5" data-path="tutorial.html"><a href="tutorial.html#save-processed-land-use"><i class="fa fa-check"></i><b>6.7.5</b> Save Processed Land Use</a></li>
<li class="chapter" data-level="6.7.6" data-path="tutorial.html"><a href="tutorial.html#filter-legacy-data"><i class="fa fa-check"></i><b>6.7.6</b> Filter Legacy Data</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="tutorial.html"><a href="tutorial.html#create-psu-grid"><i class="fa fa-check"></i><b>6.8</b> Create Primary Sampling Units (PSU Grid)</a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="tutorial.html"><a href="tutorial.html#generate-2km-2km-grid"><i class="fa fa-check"></i><b>6.8.1</b> Generate 2km √ó 2km Grid</a></li>
<li class="chapter" data-level="6.8.2" data-path="tutorial.html"><a href="tutorial.html#trim-to-country-boundaries"><i class="fa fa-check"></i><b>6.8.2</b> Trim to Country Boundaries</a></li>
<li class="chapter" data-level="6.8.3" data-path="tutorial.html"><a href="tutorial.html#save-psu-grid"><i class="fa fa-check"></i><b>6.8.3</b> Save PSU Grid</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="tutorial.html"><a href="tutorial.html#select-psus"><i class="fa fa-check"></i><b>6.9</b> Select PSUs with Sufficient Land Use Coverage</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="tutorial.html"><a href="tutorial.html#calculate-land-use-percentage"><i class="fa fa-check"></i><b>6.9.1</b> Calculate Land Use Percentage</a></li>
<li class="chapter" data-level="6.9.2" data-path="tutorial.html"><a href="tutorial.html#filter-psus"><i class="fa fa-check"></i><b>6.9.2</b> Filter PSUs</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="tutorial.html"><a href="tutorial.html#rasterize-psus"><i class="fa fa-check"></i><b>6.10</b> Rasterize PSUs for Covariate Space Coverage</a></li>
<li class="chapter" data-level="6.11" data-path="tutorial.html"><a href="tutorial.html#optimal-sample-size"><i class="fa fa-check"></i><b>6.11</b> Compute Optimal Sample Size</a>
<ul>
<li class="chapter" data-level="6.11.1" data-path="tutorial.html"><a href="tutorial.html#run-optimization"><i class="fa fa-check"></i><b>6.11.1</b> Run Optimization</a></li>
<li class="chapter" data-level="6.11.2" data-path="tutorial.html"><a href="tutorial.html#extract-optimal-sample-size"><i class="fa fa-check"></i><b>6.11.2</b> Extract Optimal Sample Size</a></li>
</ul></li>
<li class="chapter" data-level="6.12" data-path="tutorial.html"><a href="tutorial.html#csc-computing"><i class="fa fa-check"></i><b>6.12</b> Covariate Space Coverage - Computing PSUs</a>
<ul>
<li class="chapter" data-level="6.12.1" data-path="tutorial.html"><a href="tutorial.html#prepare-function-parameters"><i class="fa fa-check"></i><b>6.12.1</b> Prepare Function Parameters</a></li>
<li class="chapter" data-level="6.12.2" data-path="tutorial.html"><a href="tutorial.html#perform-k-means-clustering"><i class="fa fa-check"></i><b>6.12.2</b> Perform K-means Clustering</a></li>
<li class="chapter" data-level="6.12.3" data-path="tutorial.html"><a href="tutorial.html#assign-clusters-and-calculate-distances"><i class="fa fa-check"></i><b>6.12.3</b> Assign Clusters and Calculate Distances</a></li>
<li class="chapter" data-level="6.12.4" data-path="tutorial.html"><a href="tutorial.html#extract-selected-psus"><i class="fa fa-check"></i><b>6.12.4</b> Extract Selected PSUs</a></li>
<li class="chapter" data-level="6.12.5" data-path="tutorial.html"><a href="tutorial.html#visualize-in-covariate-space"><i class="fa fa-check"></i><b>6.12.5</b> Visualize in Covariate Space</a></li>
</ul></li>
<li class="chapter" data-level="6.13" data-path="tutorial.html"><a href="tutorial.html#compute-ssu-tsu"><i class="fa fa-check"></i><b>6.13</b> Compute SSUs and TSUs</a>
<ul>
<li class="chapter" data-level="6.13.1" data-path="tutorial.html"><a href="tutorial.html#load-high-resolution-covariates"><i class="fa fa-check"></i><b>6.13.1</b> Load High-Resolution Covariates</a></li>
<li class="chapter" data-level="6.13.2" data-path="tutorial.html"><a href="tutorial.html#process-each-psu"><i class="fa fa-check"></i><b>6.13.2</b> Process Each PSU</a></li>
<li class="chapter" data-level="6.13.3" data-path="tutorial.html"><a href="tutorial.html#combine-ssus-and-tsus"><i class="fa fa-check"></i><b>6.13.3</b> Combine SSUs and TSUs</a></li>
</ul></li>
<li class="chapter" data-level="6.14" data-path="tutorial.html"><a href="tutorial.html#export-units"><i class="fa fa-check"></i><b>6.14</b> Export Sampling Units</a>
<ul>
<li class="chapter" data-level="6.14.1" data-path="tutorial.html"><a href="tutorial.html#create-cluster-raster"><i class="fa fa-check"></i><b>6.14.1</b> Create Cluster Raster</a></li>
<li class="chapter" data-level="6.14.2" data-path="tutorial.html"><a href="tutorial.html#join-cluster-info-to-tsus"><i class="fa fa-check"></i><b>6.14.2</b> Join Cluster Info to TSUs</a></li>
<li class="chapter" data-level="6.14.3" data-path="tutorial.html"><a href="tutorial.html#create-site-ids"><i class="fa fa-check"></i><b>6.14.3</b> Create Site IDs</a></li>
<li class="chapter" data-level="6.14.4" data-path="tutorial.html"><a href="tutorial.html#export-shapefiles"><i class="fa fa-check"></i><b>6.14.4</b> Export Shapefiles</a></li>
</ul></li>
<li class="chapter" data-level="6.15" data-path="tutorial.html"><a href="tutorial.html#alternative-psus"><i class="fa fa-check"></i><b>6.15</b> Compute Alternative PSUs</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="merging-results.html"><a href="merging-results.html"><i class="fa fa-check"></i><b>7</b> Merging Results from Multiple Land Uses</a>
<ul>
<li class="chapter" data-level="7.1" data-path="merging-results.html"><a href="merging-results.html#assign-unique-ids"><i class="fa fa-check"></i><b>7.1</b> Assign Country-Wide Unique IDs</a></li>
<li class="chapter" data-level="7.2" data-path="merging-results.html"><a href="merging-results.html#export-unified"><i class="fa fa-check"></i><b>7.2</b> Export Unified Datasets</a></li>
<li class="chapter" data-level="7.3" data-path="merging-results.html"><a href="merging-results.html#summary-stats"><i class="fa fa-check"></i><b>7.3</b> Summary Statistics</a></li>
<li class="chapter" data-level="7.4" data-path="merging-results.html"><a href="merging-results.html#distribution-maps"><i class="fa fa-check"></i><b>7.4</b> Create Distribution Maps</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="field-protocol.html"><a href="field-protocol.html"><i class="fa fa-check"></i><b>8</b> Field Sampling Protocol</a>
<ul>
<li class="chapter" data-level="8.1" data-path="field-protocol.html"><a href="field-protocol.html#gps-prep"><i class="fa fa-check"></i><b>8.1</b> GPS Device Preparation</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="field-protocol.html"><a href="field-protocol.html#export-to-gpx-format"><i class="fa fa-check"></i><b>8.1.1</b> Export to GPX Format</a></li>
<li class="chapter" data-level="8.1.2" data-path="field-protocol.html"><a href="field-protocol.html#load-onto-gps-device"><i class="fa fa-check"></i><b>8.1.2</b> Load onto GPS Device</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="field-protocol.html"><a href="field-protocol.html#sampling-procedure"><i class="fa fa-check"></i><b>8.2</b> Sampling Procedure</a></li>
<li class="chapter" data-level="8.3" data-path="field-protocol.html"><a href="field-protocol.html#data-recording"><i class="fa fa-check"></i><b>8.3</b> Data Recording</a></li>
<li class="chapter" data-level="8.4" data-path="field-protocol.html"><a href="field-protocol.html#qc"><i class="fa fa-check"></i><b>8.4</b> Quality Control</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html"><i class="fa fa-check"></i>Appendices</a>
<ul>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-a-software-and-data-sources"><i class="fa fa-check"></i>Appendix A: Software and Data Sources</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="appendices.html"><a href="appendices.html#software-requirements"><i class="fa fa-check"></i><b>8.4.1</b> Software Requirements</a></li>
<li class="chapter" data-level="8.4.2" data-path="appendices.html"><a href="appendices.html#data-sources"><i class="fa fa-check"></i><b>8.4.2</b> Data Sources</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-b-troubleshooting-common-issues"><i class="fa fa-check"></i>Appendix B: Troubleshooting Common Issues</a>
<ul>
<li class="chapter" data-level="8.4.3" data-path="appendices.html"><a href="appendices.html#memory-issues"><i class="fa fa-check"></i><b>8.4.3</b> Memory Issues</a></li>
<li class="chapter" data-level="8.4.4" data-path="appendices.html"><a href="appendices.html#crs-misalignment"><i class="fa fa-check"></i><b>8.4.4</b> CRS Misalignment</a></li>
<li class="chapter" data-level="8.4.5" data-path="appendices.html"><a href="appendices.html#empty-geometry"><i class="fa fa-check"></i><b>8.4.5</b> Empty Geometry</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-c-acronyms-and-abbreviations"><i class="fa fa-check"></i>Appendix C: Acronyms and Abbreviations</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tbd.html"><a href="tbd.html"><i class="fa fa-check"></i><b>9</b> TBD</a></li>
<li class="chapter" data-level="10" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html"><i class="fa fa-check"></i><b>10</b> Soil Data Preparation</a>
<ul>
<li class="chapter" data-level="10.1" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#introduction-1"><i class="fa fa-check"></i><b>10.1</b> Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#data-cleaning"><i class="fa fa-check"></i><b>10.2</b> Data cleaning</a></li>
<li class="chapter" data-level="10.3" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#soil-data-harmonization"><i class="fa fa-check"></i><b>10.3</b> Soil Data Harmonization</a></li>
<li class="chapter" data-level="10.4" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#concepts-on-digital-exchange-of-soil-related-data-iso-28258"><i class="fa fa-check"></i><b>10.4</b> Concepts on digital exchange of soil-related data (ISO 28258)</a></li>
<li class="chapter" data-level="10.5" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#plot-data"><i class="fa fa-check"></i><b>10.5</b> Plot data</a></li>
<li class="chapter" data-level="10.6" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#profile-data"><i class="fa fa-check"></i><b>10.6</b> Profile data</a></li>
<li class="chapter" data-level="10.7" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#element-data"><i class="fa fa-check"></i><b>10.7</b> Element data</a></li>
<li class="chapter" data-level="10.8" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#specimen-data"><i class="fa fa-check"></i><b>10.8</b> Specimen data</a></li>
<li class="chapter" data-level="10.9" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#definition-of-laboratory-procedures"><i class="fa fa-check"></i><b>10.9</b> Definition of laboratory procedures</a></li>
<li class="chapter" data-level="10.10" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#data-transformation"><i class="fa fa-check"></i><b>10.10</b> Data transformation</a></li>
<li class="chapter" data-level="10.11" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#organizing-soil-data-according-to-the-glosis-database"><i class="fa fa-check"></i><b>10.11</b> Organizing soil data according to the GloSIS database</a></li>
<li class="chapter" data-level="10.12" data-path="soil-data-preparation.html"><a href="soil-data-preparation.html#tools-for-harmonization-of-soil-databases-within-glosis"><i class="fa fa-check"></i><b>10.12</b> Tools for harmonization of soil databases within GloSIS</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html"><i class="fa fa-check"></i><b>11</b> Digital soil mapping and modeling</a></li>
<li class="chapter" data-level="12" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html"><i class="fa fa-check"></i><b>12</b> Soil Data Sharing</a>
<ul>
<li class="chapter" data-level="12.1" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#data-sharing-and-export-formats"><i class="fa fa-check"></i><b>12.1</b> Data sharing and export formats</a></li>
<li class="chapter" data-level="12.2" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#metadata"><i class="fa fa-check"></i><b>12.2</b> Metadata</a></li>
<li class="chapter" data-level="12.3" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#web-services"><i class="fa fa-check"></i><b>12.3</b> Web Services</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p>Integrated Soil Information for decision-making
<img src="images/frontcover.jpg" style="top:0px;height:100px;" align="right" /></p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tutorial" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Tutorial Using R<a href="tutorial.html#tutorial" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This tutorial is designed for users with a basic understanding of R programming and provides a comprehensive guide to implementing a soil sampling design for soil monitoring and mapping. All scripts and data are available at the <a href="https://github.com/FAO-GSP/SoilFER-sampling-design">SoilFER GitHub repository</a>.</p>
<blockquote>
<p><strong>üí° Note</strong>: Ensure you have the <code>tinytex</code>, <code>knitr</code>, <code>rmarkdown</code>, and <code>rstudioapi</code> R packages installed to successfully run and render R Markdown documents before running this script. Additionally, install tinytex by running <code>tinytex::install_tinytex()</code> to enable LaTeX support for PDF generation.</p>
</blockquote>
<div id="setup" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Setting Up the Environment<a href="tutorial.html#setup" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First, set the working directory to the location of your R script. This ensures that all paths in the script are relative to the script‚Äôs location.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="tutorial.html#cb1-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb1-2"><a href="tutorial.html#cb1-2" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to the main folder</span></span>
<span id="cb1-3"><a href="tutorial.html#cb1-3" tabindex="-1"></a><span class="fu">getwd</span>()</span></code></pre></div>
<div id="install-libraries" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Install Required Libraries<a href="tutorial.html#install-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The script uses several R libraries, each serving a specific purpose (Table <a href="tutorial.html#tab:r-libraries">6.1</a>).</p>
<table>
<caption><span id="tab:r-libraries">Table 6.1: </span>Summary of required R libraries and their purposes for SoilFER sampling design</caption>
<thead>
<tr>
<th align="left">Package</th>
<th align="left">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">sp</td>
<td align="left">Spatial data classes</td>
</tr>
<tr>
<td align="left">terra</td>
<td align="left">Raster data manipulation</td>
</tr>
<tr>
<td align="left">raster</td>
<td align="left">Legacy raster support</td>
</tr>
<tr>
<td align="left">sf</td>
<td align="left">Simple features (vector data)</td>
</tr>
<tr>
<td align="left">sgsR</td>
<td align="left">Spatial sampling</td>
</tr>
<tr>
<td align="left">entropy</td>
<td align="left">Entropy calculations</td>
</tr>
<tr>
<td align="left">tripack</td>
<td align="left">Triangulation</td>
</tr>
<tr>
<td align="left">tibble</td>
<td align="left">Data frames</td>
</tr>
<tr>
<td align="left">manipulate</td>
<td align="left">Interactive plotting</td>
</tr>
<tr>
<td align="left">dplyr</td>
<td align="left">Data manipulation</td>
</tr>
<tr>
<td align="left">synoptReg</td>
<td align="left">PCA for rasters</td>
</tr>
<tr>
<td align="left">doSNOW</td>
<td align="left">Parallel processing</td>
</tr>
<tr>
<td align="left">Rfast</td>
<td align="left">Fast R functions</td>
</tr>
<tr>
<td align="left">fields</td>
<td align="left">Distance calculations</td>
</tr>
<tr>
<td align="left">ggplot2</td>
<td align="left">Visualization</td>
</tr>
<tr>
<td align="left">rassta</td>
<td align="left">Terrain analysis</td>
</tr>
</tbody>
</table>
<p>Some libraries might need to be installed from GitHub. Uncomment and run the lines below if needed:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="tutorial.html#cb2-1" tabindex="-1"></a><span class="co"># Install synoptReg package from GitHub</span></span>
<span id="cb2-2"><a href="tutorial.html#cb2-2" tabindex="-1"></a><span class="co"># install.packages(&quot;remotes&quot;) # Install remotes if not installed</span></span>
<span id="cb2-3"><a href="tutorial.html#cb2-3" tabindex="-1"></a><span class="co"># remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb2-4"><a href="tutorial.html#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="tutorial.html#cb2-5" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;raster&quot;</span>, <span class="st">&quot;sf&quot;</span>, <span class="st">&quot;sgsR&quot;</span>, <span class="st">&quot;entropy&quot;</span>, </span>
<span id="cb2-6"><a href="tutorial.html#cb2-6" tabindex="-1"></a>              <span class="st">&quot;tripack&quot;</span>, <span class="st">&quot;tibble&quot;</span>, <span class="st">&quot;manipulate&quot;</span>, <span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;synoptReg&quot;</span>, </span>
<span id="cb2-7"><a href="tutorial.html#cb2-7" tabindex="-1"></a>              <span class="st">&quot;doSNOW&quot;</span>, <span class="st">&quot;Rfast&quot;</span>, <span class="st">&quot;fields&quot;</span>, <span class="st">&quot;ggplot2&quot;</span>, <span class="st">&quot;rassta&quot;</span>)</span>
<span id="cb2-8"><a href="tutorial.html#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="tutorial.html#cb2-9" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-10"><a href="tutorial.html#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="tutorial.html#cb2-11" tabindex="-1"></a><span class="fu">rm</span>(packages)</span></code></pre></div>
<blockquote>
<p><strong>Alternative method</strong>: In RStudio, use the <strong>Packages</strong> tab in the bottom-right pane ‚Üí click <strong>Install</strong> ‚Üí type package name ‚Üí ensure ‚ÄúInstall dependencies‚Äù is checked ‚Üí click <strong>Install</strong>.</p>
</blockquote>
</div>
</div>
<div id="define-parameters" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Define Variables and Parameters<a href="tutorial.html#define-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Several variables and parameters must be defined to establish a consistent framework for the script.</p>
<div id="country-iso-code" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Country ISO Code<a href="tutorial.html#country-iso-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="tutorial.html#cb3-1" tabindex="-1"></a>ISO.code <span class="ot">&lt;-</span> <span class="st">&quot;ZMB&quot;</span>  <span class="co"># Zambia example</span></span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: Use the Alpha-3 ISO code for your country of interest.</p>
</blockquote>
</div>
<div id="land-use-type" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Land Use Type<a href="tutorial.html#land-use-type" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The SoilFER project focuses on three primary land-use types: croplands (80%), grasslands (15%), and forests (5%).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="tutorial.html#cb4-1" tabindex="-1"></a>landuse <span class="ot">&lt;-</span> <span class="st">&quot;crops&quot;</span>  <span class="co"># Options: &quot;crops&quot;, &quot;grassland&quot;, &quot;forest&quot;</span></span></code></pre></div>
</div>
<div id="file-paths" class="section level3 hasAnchor" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> File Paths<a href="tutorial.html#file-paths" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="tutorial.html#cb5-1" tabindex="-1"></a><span class="co"># Path to data folders</span></span>
<span id="cb5-2"><a href="tutorial.html#cb5-2" tabindex="-1"></a>raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb5-3"><a href="tutorial.html#cb5-3" tabindex="-1"></a>shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb5-4"><a href="tutorial.html#cb5-4" tabindex="-1"></a>other.path <span class="ot">&lt;-</span> <span class="st">&quot;data/other/&quot;</span></span>
<span id="cb5-5"><a href="tutorial.html#cb5-5" tabindex="-1"></a>landuse_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/results/&quot;</span>, landuse, <span class="st">&quot;/&quot;</span>)</span>
<span id="cb5-6"><a href="tutorial.html#cb5-6" tabindex="-1"></a>   </span>
<span id="cb5-7"><a href="tutorial.html#cb5-7" tabindex="-1"></a><span class="co"># Check if landuse directory exists; if not, create it</span></span>
<span id="cb5-8"><a href="tutorial.html#cb5-8" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(landuse_dir)) {</span>
<span id="cb5-9"><a href="tutorial.html#cb5-9" tabindex="-1"></a>  <span class="fu">dir.create</span>(landuse_dir)</span>
<span id="cb5-10"><a href="tutorial.html#cb5-10" tabindex="-1"></a>}</span>
<span id="cb5-11"><a href="tutorial.html#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="tutorial.html#cb5-12" tabindex="-1"></a>results.path <span class="ot">&lt;-</span> landuse_dir</span></code></pre></div>
</div>
<div id="coordinate-reference-system" class="section level3 hasAnchor" number="6.2.4">
<h3><span class="header-section-number">6.2.4</span> Coordinate Reference System<a href="tutorial.html#coordinate-reference-system" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="tutorial.html#cb6-1" tabindex="-1"></a>epsg <span class="ot">&lt;-</span> <span class="st">&quot;EPSG:3857&quot;</span>  <span class="co"># WGS 84 / Pseudo-Mercator</span></span>
<span id="cb6-2"><a href="tutorial.html#cb6-2" tabindex="-1"></a><span class="co"># Find your CRS at: https://epsg.io/</span></span></code></pre></div>
</div>
<div id="sample-size-calculation" class="section level3 hasAnchor" number="6.2.5">
<h3><span class="header-section-number">6.2.5</span> Sample Size Calculation<a href="tutorial.html#sample-size-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="tutorial.html#cb7-1" tabindex="-1"></a>nsamples <span class="ot">&lt;-</span> <span class="dv">300</span>  <span class="co"># Total sampling sites</span></span>
<span id="cb7-2"><a href="tutorial.html#cb7-2" tabindex="-1"></a>share <span class="ot">&lt;-</span> <span class="fl">0.80</span>    <span class="co"># 80% for this land use (croplands)</span></span>
<span id="cb7-3"><a href="tutorial.html#cb7-3" tabindex="-1"></a>nsites <span class="ot">&lt;-</span> nsamples <span class="sc">*</span> share  <span class="co"># Final number of sites</span></span>
<span id="cb7-4"><a href="tutorial.html#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="tutorial.html#cb7-5" tabindex="-1"></a><span class="co"># However, we will calculate the optimal sample size statistically later</span></span></code></pre></div>
</div>
<div id="sampling-unit-definitions" class="section level3 hasAnchor" number="6.2.6">
<h3><span class="header-section-number">6.2.6</span> Sampling Unit Definitions<a href="tutorial.html#sampling-unit-definitions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="tutorial.html#cb8-1" tabindex="-1"></a><span class="co"># Define the number of PSUs to sample</span></span>
<span id="cb8-2"><a href="tutorial.html#cb8-2" tabindex="-1"></a>n.psu <span class="ot">&lt;-</span> <span class="fu">round</span>(nsamples<span class="sc">/</span><span class="dv">8</span>)  <span class="co"># Will be optimized later</span></span>
<span id="cb8-3"><a href="tutorial.html#cb8-3" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="tutorial.html#cb8-4" tabindex="-1"></a><span class="co"># Define PSU and SSU sizes </span></span>
<span id="cb8-5"><a href="tutorial.html#cb8-5" tabindex="-1"></a>psu_size <span class="ot">&lt;-</span> <span class="dv">2000</span>  <span class="co"># 2km √ó 2 km</span></span>
<span id="cb8-6"><a href="tutorial.html#cb8-6" tabindex="-1"></a>ssu_size <span class="ot">&lt;-</span> <span class="dv">100</span>   <span class="co"># 100m √ó 100m = 1 ha</span></span>
<span id="cb8-7"><a href="tutorial.html#cb8-7" tabindex="-1"></a>  </span>
<span id="cb8-8"><a href="tutorial.html#cb8-8" tabindex="-1"></a><span class="co"># Define number of target and alternative SSUs at each PSU</span></span>
<span id="cb8-9"><a href="tutorial.html#cb8-9" tabindex="-1"></a>num_primary_ssus <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb8-10"><a href="tutorial.html#cb8-10" tabindex="-1"></a>num_alternative_ssus <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb8-11"><a href="tutorial.html#cb8-11" tabindex="-1"></a>    </span>
<span id="cb8-12"><a href="tutorial.html#cb8-12" tabindex="-1"></a><span class="co"># Define number of TSUs at each SSU</span></span>
<span id="cb8-13"><a href="tutorial.html#cb8-13" tabindex="-1"></a>number_TSUs <span class="ot">&lt;-</span> <span class="dv">3</span></span></code></pre></div>
</div>
<div id="algorithm-parameters" class="section level3 hasAnchor" number="6.2.7">
<h3><span class="header-section-number">6.2.7</span> Algorithm Parameters<a href="tutorial.html#algorithm-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="tutorial.html#cb9-1" tabindex="-1"></a><span class="co"># Number of iterations for clustering algorithm</span></span>
<span id="cb9-2"><a href="tutorial.html#cb9-2" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># 10 is sufficient</span></span>
<span id="cb9-3"><a href="tutorial.html#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="tutorial.html#cb9-4" tabindex="-1"></a><span class="co"># Minimum crop percentage in selected PSUs</span></span>
<span id="cb9-5"><a href="tutorial.html#cb9-5" tabindex="-1"></a>percent_crop <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># At least 10% crop coverage</span></span></code></pre></div>
</div>
</div>
<div id="custom-functions" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Custom Functions<a href="tutorial.html#custom-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="covariate-space-coverage-function-csis" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Covariate Space Coverage Function (CSIS)<a href="tutorial.html#covariate-space-coverage-function-csis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The CSIS function is the backbone of clustering sampling units in covariate space. It ensures optimal distribution while considering any fixed legacy data.</p>
<p><strong>How it works</strong>:</p>
<ol style="list-style-type: decimal">
<li><strong>Input Parameters</strong>:
<ul>
<li><code>fixed</code>: Preselected (legacy) sampling points</li>
<li><code>nsup</code>: Number of additional (new) sampling points to select</li>
<li><code>nstarts</code>: Number of random starting points for clustering</li>
<li><code>mygrd</code>: Grid of covariate data for ROI</li>
</ul></li>
<li><strong>Workflow</strong>:
<ul>
<li>Extract fixed points and exclude from grid</li>
<li>Randomly initialize new sampling points</li>
<li>Combine fixed and new centers</li>
<li>Compute distances and assign points to nearest cluster</li>
<li>Update cluster centers iteratively until convergence</li>
<li>Calculate Mean Squared Shortest Distance (MSSSD)</li>
<li>Save best clustering result</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="tutorial.html#cb10-1" tabindex="-1"></a><span class="co"># Clustering CSC function with fixed legacy data</span></span>
<span id="cb10-2"><a href="tutorial.html#cb10-2" tabindex="-1"></a>CSIS <span class="ot">&lt;-</span> <span class="cf">function</span>(fixed, nsup, nstarts, mygrd) {</span>
<span id="cb10-3"><a href="tutorial.html#cb10-3" tabindex="-1"></a>  n_fix <span class="ot">&lt;-</span> <span class="fu">nrow</span>(fixed)</span>
<span id="cb10-4"><a href="tutorial.html#cb10-4" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(mygrd)</span>
<span id="cb10-5"><a href="tutorial.html#cb10-5" tabindex="-1"></a>  units <span class="ot">&lt;-</span> fixed<span class="sc">$</span>units</span>
<span id="cb10-6"><a href="tutorial.html#cb10-6" tabindex="-1"></a>  mygrd_minfx <span class="ot">&lt;-</span> mygrd[<span class="sc">-</span>units, ]</span>
<span id="cb10-7"><a href="tutorial.html#cb10-7" tabindex="-1"></a>  MSSSD_cur <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb10-8"><a href="tutorial.html#cb10-8" tabindex="-1"></a>  </span>
<span id="cb10-9"><a href="tutorial.html#cb10-9" tabindex="-1"></a>  <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nstarts) {</span>
<span id="cb10-10"><a href="tutorial.html#cb10-10" tabindex="-1"></a>    units <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(mygrd_minfx), nsup)</span>
<span id="cb10-11"><a href="tutorial.html#cb10-11" tabindex="-1"></a>    centers_sup <span class="ot">&lt;-</span> mygrd_minfx[units, ]</span>
<span id="cb10-12"><a href="tutorial.html#cb10-12" tabindex="-1"></a>    centers <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fixed[, <span class="fu">names</span>(mygrd)], centers_sup)</span>
<span id="cb10-13"><a href="tutorial.html#cb10-13" tabindex="-1"></a>    </span>
<span id="cb10-14"><a href="tutorial.html#cb10-14" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb10-15"><a href="tutorial.html#cb10-15" tabindex="-1"></a>      D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> centers, <span class="at">x2 =</span> mygrd)</span>
<span id="cb10-16"><a href="tutorial.html#cb10-16" tabindex="-1"></a>      cluster <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="at">X =</span> D, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> which.min) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>(.)</span>
<span id="cb10-17"><a href="tutorial.html#cb10-17" tabindex="-1"></a>      centers_cur <span class="ot">&lt;-</span> centers</span>
<span id="cb10-18"><a href="tutorial.html#cb10-18" tabindex="-1"></a>      </span>
<span id="cb10-19"><a href="tutorial.html#cb10-19" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb10-20"><a href="tutorial.html#cb10-20" tabindex="-1"></a>        centers[, i] <span class="ot">&lt;-</span> <span class="fu">tapply</span>(mygrd[, i], <span class="at">INDEX =</span> cluster, <span class="at">FUN =</span> mean)</span>
<span id="cb10-21"><a href="tutorial.html#cb10-21" tabindex="-1"></a>      }</span>
<span id="cb10-22"><a href="tutorial.html#cb10-22" tabindex="-1"></a>      </span>
<span id="cb10-23"><a href="tutorial.html#cb10-23" tabindex="-1"></a>      <span class="co"># Restore fixed centers</span></span>
<span id="cb10-24"><a href="tutorial.html#cb10-24" tabindex="-1"></a>      centers[<span class="dv">1</span><span class="sc">:</span>n_fix, ] <span class="ot">&lt;-</span> centers_cur[<span class="dv">1</span><span class="sc">:</span>n_fix, ]</span>
<span id="cb10-25"><a href="tutorial.html#cb10-25" tabindex="-1"></a>      </span>
<span id="cb10-26"><a href="tutorial.html#cb10-26" tabindex="-1"></a>      <span class="co"># Check convergence</span></span>
<span id="cb10-27"><a href="tutorial.html#cb10-27" tabindex="-1"></a>      sumd <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">rdist</span>(<span class="at">x1 =</span> centers, <span class="at">x2 =</span> centers_cur)) <span class="sc">%&gt;%</span> <span class="fu">sum</span>(.)</span>
<span id="cb10-28"><a href="tutorial.html#cb10-28" tabindex="-1"></a>      <span class="cf">if</span> (sumd <span class="sc">&lt;</span> <span class="fl">1E-12</span>) {</span>
<span id="cb10-29"><a href="tutorial.html#cb10-29" tabindex="-1"></a>        D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> centers, <span class="at">x2 =</span> mygrd)</span>
<span id="cb10-30"><a href="tutorial.html#cb10-30" tabindex="-1"></a>        Dmin <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="at">X =</span> D, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> min)</span>
<span id="cb10-31"><a href="tutorial.html#cb10-31" tabindex="-1"></a>        MSSSD <span class="ot">&lt;-</span> <span class="fu">mean</span>(Dmin<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-32"><a href="tutorial.html#cb10-32" tabindex="-1"></a>        </span>
<span id="cb10-33"><a href="tutorial.html#cb10-33" tabindex="-1"></a>        <span class="cf">if</span> (s <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> MSSSD <span class="sc">&lt;</span> MSSSD_cur) {</span>
<span id="cb10-34"><a href="tutorial.html#cb10-34" tabindex="-1"></a>          centers_best <span class="ot">&lt;-</span> centers</span>
<span id="cb10-35"><a href="tutorial.html#cb10-35" tabindex="-1"></a>          clusters_best <span class="ot">&lt;-</span> cluster</span>
<span id="cb10-36"><a href="tutorial.html#cb10-36" tabindex="-1"></a>          MSSSD_cur <span class="ot">&lt;-</span> MSSSD</span>
<span id="cb10-37"><a href="tutorial.html#cb10-37" tabindex="-1"></a>        }</span>
<span id="cb10-38"><a href="tutorial.html#cb10-38" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb10-39"><a href="tutorial.html#cb10-39" tabindex="-1"></a>      }</span>
<span id="cb10-40"><a href="tutorial.html#cb10-40" tabindex="-1"></a>    }</span>
<span id="cb10-41"><a href="tutorial.html#cb10-41" tabindex="-1"></a>    </span>
<span id="cb10-42"><a href="tutorial.html#cb10-42" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(s, <span class="st">&quot; out of &quot;</span>, nstarts))</span>
<span id="cb10-43"><a href="tutorial.html#cb10-43" tabindex="-1"></a>  }</span>
<span id="cb10-44"><a href="tutorial.html#cb10-44" tabindex="-1"></a>  </span>
<span id="cb10-45"><a href="tutorial.html#cb10-45" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">centers =</span> centers_best, <span class="at">cluster =</span> clusters_best)</span>
<span id="cb10-46"><a href="tutorial.html#cb10-46" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: This function creates spatially balanced sampling designs by considering existing sampling points and covariate distributions.</p>
</blockquote>
</div>
<div id="tsu-generation-function" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> TSU Generation Function<a href="tutorial.html#tsu-generation-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This function generates TSUs within SSUs, ensuring random distribution while respecting land-use constraints.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="tutorial.html#cb11-1" tabindex="-1"></a>generate_tsu_points_within_ssu <span class="ot">&lt;-</span> <span class="cf">function</span>(ssu, number_TSUs, index, ssu_type, crops) {</span>
<span id="cb11-2"><a href="tutorial.html#cb11-2" tabindex="-1"></a>  <span class="co"># Convert SSU to SpatVector for masking</span></span>
<span id="cb11-3"><a href="tutorial.html#cb11-3" tabindex="-1"></a>  ssu_vect <span class="ot">&lt;-</span> ssu_grid_sf[index, ]</span>
<span id="cb11-4"><a href="tutorial.html#cb11-4" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="tutorial.html#cb11-5" tabindex="-1"></a>  <span class="co"># Clip the raster to the SSU boundaries</span></span>
<span id="cb11-6"><a href="tutorial.html#cb11-6" tabindex="-1"></a>  clipped_lu <span class="ot">&lt;-</span> <span class="fu">crop</span>(crops, ssu_vect)</span>
<span id="cb11-7"><a href="tutorial.html#cb11-7" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="tutorial.html#cb11-8" tabindex="-1"></a>  <span class="co"># Generate random points within the clipped raster</span></span>
<span id="cb11-9"><a href="tutorial.html#cb11-9" tabindex="-1"></a>  sampled_points <span class="ot">&lt;-</span> <span class="fu">sample_srs</span>(clipped_lu, <span class="at">nSamp =</span> number_TSUs)</span>
<span id="cb11-10"><a href="tutorial.html#cb11-10" tabindex="-1"></a>  </span>
<span id="cb11-11"><a href="tutorial.html#cb11-11" tabindex="-1"></a>  <span class="co"># Ensure required number of TSUs</span></span>
<span id="cb11-12"><a href="tutorial.html#cb11-12" tabindex="-1"></a>  <span class="cf">while</span> (<span class="fu">nrow</span>(sampled_points) <span class="sc">&lt;</span> number_TSUs) {</span>
<span id="cb11-13"><a href="tutorial.html#cb11-13" tabindex="-1"></a>    sampled_points <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(clipped_lu, <span class="at">size =</span> number_TSUs)</span>
<span id="cb11-14"><a href="tutorial.html#cb11-14" tabindex="-1"></a>  }</span>
<span id="cb11-15"><a href="tutorial.html#cb11-15" tabindex="-1"></a>  </span>
<span id="cb11-16"><a href="tutorial.html#cb11-16" tabindex="-1"></a>  <span class="co"># Add metadata</span></span>
<span id="cb11-17"><a href="tutorial.html#cb11-17" tabindex="-1"></a>  sampled_points<span class="sc">$</span>PSU_ID <span class="ot">&lt;-</span> selected_psu<span class="sc">$</span>ID</span>
<span id="cb11-18"><a href="tutorial.html#cb11-18" tabindex="-1"></a>  sampled_points<span class="sc">$</span>SSU_ID <span class="ot">&lt;-</span> index</span>
<span id="cb11-19"><a href="tutorial.html#cb11-19" tabindex="-1"></a>  sampled_points<span class="sc">$</span>TSU_ID <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(sampled_points))</span>
<span id="cb11-20"><a href="tutorial.html#cb11-20" tabindex="-1"></a>  sampled_points<span class="sc">$</span>SSU_Type <span class="ot">&lt;-</span> ssu_type</span>
<span id="cb11-21"><a href="tutorial.html#cb11-21" tabindex="-1"></a>  sampled_points<span class="sc">$</span>TSU_Name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(ISO.code, <span class="fu">sprintf</span>(<span class="st">&quot;%04d&quot;</span>, sampled_points<span class="sc">$</span>PSU_ID),</span>
<span id="cb11-22"><a href="tutorial.html#cb11-22" tabindex="-1"></a>                                    <span class="st">&quot;-&quot;</span>, sampled_points<span class="sc">$</span>SSU_ID, <span class="st">&quot;-&quot;</span>, </span>
<span id="cb11-23"><a href="tutorial.html#cb11-23" tabindex="-1"></a>                                    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(sampled_points)))</span>
<span id="cb11-24"><a href="tutorial.html#cb11-24" tabindex="-1"></a>  </span>
<span id="cb11-25"><a href="tutorial.html#cb11-25" tabindex="-1"></a>  <span class="fu">return</span>(sampled_points)</span>
<span id="cb11-26"><a href="tutorial.html#cb11-26" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="load-boundaries" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Load Country Boundaries and Legacy Data<a href="tutorial.html#load-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load and transform country boundaries and legacy soil data to the desired CRS:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="tutorial.html#cb12-1" tabindex="-1"></a><span class="co"># Define file locations</span></span>
<span id="cb12-2"><a href="tutorial.html#cb12-2" tabindex="-1"></a>country_boundaries <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;roi_epsg_3857.shp&quot;</span>))</span>
<span id="cb12-3"><a href="tutorial.html#cb12-3" tabindex="-1"></a>legacy <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;zmb_legacy_v2_clipped_epsg_3857.shp&quot;</span>))</span>
<span id="cb12-4"><a href="tutorial.html#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="tutorial.html#cb12-5" tabindex="-1"></a><span class="co"># Load and transform country boundaries</span></span>
<span id="cb12-6"><a href="tutorial.html#cb12-6" tabindex="-1"></a>country_boundaries <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(country_boundaries, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-7"><a href="tutorial.html#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="tutorial.html#cb12-8" tabindex="-1"></a><span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(country_boundaries)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb12-9"><a href="tutorial.html#cb12-9" tabindex="-1"></a>  country_boundaries <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(country_boundaries, <span class="at">crs =</span> epsg)</span>
<span id="cb12-10"><a href="tutorial.html#cb12-10" tabindex="-1"></a>}</span>
<span id="cb12-11"><a href="tutorial.html#cb12-11" tabindex="-1"></a></span>
<span id="cb12-12"><a href="tutorial.html#cb12-12" tabindex="-1"></a><span class="co"># Load legacy data (if it exists)</span></span>
<span id="cb12-13"><a href="tutorial.html#cb12-13" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(legacy)) {</span>
<span id="cb12-14"><a href="tutorial.html#cb12-14" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(legacy, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-15"><a href="tutorial.html#cb12-15" tabindex="-1"></a>  </span>
<span id="cb12-16"><a href="tutorial.html#cb12-16" tabindex="-1"></a>  <span class="co"># Transform coordinates</span></span>
<span id="cb12-17"><a href="tutorial.html#cb12-17" tabindex="-1"></a>  <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(legacy)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb12-18"><a href="tutorial.html#cb12-18" tabindex="-1"></a>    legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(legacy, <span class="at">crs =</span> epsg)</span>
<span id="cb12-19"><a href="tutorial.html#cb12-19" tabindex="-1"></a>  }</span>
<span id="cb12-20"><a href="tutorial.html#cb12-20" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb12-21"><a href="tutorial.html#cb12-21" tabindex="-1"></a>  <span class="co"># If legacy data does not exist, delete the object</span></span>
<span id="cb12-22"><a href="tutorial.html#cb12-22" tabindex="-1"></a>  <span class="fu">rm</span>(legacy)</span>
<span id="cb12-23"><a href="tutorial.html#cb12-23" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: Always verify that all geospatial datasets use the same CRS before performing spatial operations. Misaligned CRSs can lead to incorrect analyses.</p>
</blockquote>
<div id="visualize-boundaries-and-legacy-data" class="section level3 hasAnchor" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Visualize Boundaries and Legacy Data<a href="tutorial.html#visualize-boundaries-and-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="tutorial.html#cb13-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb13-2"><a href="tutorial.html#cb13-2" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb13-3"><a href="tutorial.html#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="tutorial.html#cb13-4" tabindex="-1"></a>basemap <span class="ot">&lt;-</span> <span class="fu">annotation_map_tile</span>(<span class="st">&quot;osm&quot;</span>)</span>
<span id="cb13-5"><a href="tutorial.html#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="tutorial.html#cb13-6" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> country_boundaries) <span class="sc">+</span></span>
<span id="cb13-7"><a href="tutorial.html#cb13-7" tabindex="-1"></a>  basemap <span class="sc">+</span></span>
<span id="cb13-8"><a href="tutorial.html#cb13-8" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-9"><a href="tutorial.html#cb13-9" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> legacy, <span class="fu">aes</span>(<span class="at">geometry =</span> geometry),</span>
<span id="cb13-10"><a href="tutorial.html#cb13-10" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb13-11"><a href="tutorial.html#cb13-11" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Country Boundaries and Legacy Data&quot;</span>,</span>
<span id="cb13-12"><a href="tutorial.html#cb13-12" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Data source: OpenStreetMap&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-13"><a href="tutorial.html#cb13-13" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-14"><a href="tutorial.html#cb13-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code></pre></div>
</div>
</div>
<div id="load-covariates-psu" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Load Environmental Covariates for PSUs<a href="tutorial.html#load-covariates-psu" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="optional-auxiliary-data" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> Optional Auxiliary Data<a href="tutorial.html#optional-auxiliary-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Additional data layers can improve PSU selection:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="tutorial.html#cb14-1" tabindex="-1"></a><span class="co"># Non-protected areas (shapefile or raster)</span></span>
<span id="cb14-2"><a href="tutorial.html#cb14-2" tabindex="-1"></a>npa <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;zmb_national_parks_zari_clipped_epsg_3857.shp&quot;</span>))</span>
<span id="cb14-3"><a href="tutorial.html#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="tutorial.html#cb14-4" tabindex="-1"></a><span class="co"># High slopes (binary raster: 1 = &lt;50%, NA = &gt;=50%)</span></span>
<span id="cb14-5"><a href="tutorial.html#cb14-5" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;zmb_clipped_slope_mask_epsg_3857.tif&quot;</span>)) </span>
<span id="cb14-6"><a href="tutorial.html#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="tutorial.html#cb14-7" tabindex="-1"></a><span class="co"># Geology</span></span>
<span id="cb14-8"><a href="tutorial.html#cb14-8" tabindex="-1"></a>geo <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;zmb_geology_clipped_epsg_3857.shp&quot;</span>))</span>
<span id="cb14-9"><a href="tutorial.html#cb14-9" tabindex="-1"></a>geo.classes <span class="ot">&lt;-</span> <span class="st">&quot;GEO&quot;</span>  <span class="co"># Field name for geologic classes</span></span>
<span id="cb14-10"><a href="tutorial.html#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="tutorial.html#cb14-11" tabindex="-1"></a><span class="co"># Geomorphology</span></span>
<span id="cb14-12"><a href="tutorial.html#cb14-12" tabindex="-1"></a>geomorph <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;zmb_clipped_Geomorphon.tif&quot;</span>))</span>
<span id="cb14-13"><a href="tutorial.html#cb14-13" tabindex="-1"></a>geomorph.classes <span class="ot">&lt;-</span> <span class="st">&quot;CODR&quot;</span>  <span class="co"># Field name for geomorphology classes</span></span></code></pre></div>
</div>
<div id="load-and-process-auxiliary-data" class="section level3 hasAnchor" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Load and Process Auxiliary Data<a href="tutorial.html#load-and-process-auxiliary-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="tutorial.html#cb15-1" tabindex="-1"></a><span class="co"># Non-protected areas</span></span>
<span id="cb15-2"><a href="tutorial.html#cb15-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(npa)) {</span>
<span id="cb15-3"><a href="tutorial.html#cb15-3" tabindex="-1"></a>  npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(npa, <span class="at">quiet =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-4"><a href="tutorial.html#cb15-4" tabindex="-1"></a>  npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_union</span>(npa)</span>
<span id="cb15-5"><a href="tutorial.html#cb15-5" tabindex="-1"></a>  npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_difference</span>(country_boundaries, npa)</span>
<span id="cb15-6"><a href="tutorial.html#cb15-6" tabindex="-1"></a>  </span>
<span id="cb15-7"><a href="tutorial.html#cb15-7" tabindex="-1"></a>  <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(npa)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb15-8"><a href="tutorial.html#cb15-8" tabindex="-1"></a>    npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(npa, <span class="at">crs =</span> epsg)</span>
<span id="cb15-9"><a href="tutorial.html#cb15-9" tabindex="-1"></a>  }</span>
<span id="cb15-10"><a href="tutorial.html#cb15-10" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-11"><a href="tutorial.html#cb15-11" tabindex="-1"></a>  <span class="fu">rm</span>(npa)</span>
<span id="cb15-12"><a href="tutorial.html#cb15-12" tabindex="-1"></a>}</span>
<span id="cb15-13"><a href="tutorial.html#cb15-13" tabindex="-1"></a></span>
<span id="cb15-14"><a href="tutorial.html#cb15-14" tabindex="-1"></a><span class="co"># Slope mask</span></span>
<span id="cb15-15"><a href="tutorial.html#cb15-15" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(slope)) {</span>
<span id="cb15-16"><a href="tutorial.html#cb15-16" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">rast</span>(slope)</span>
<span id="cb15-17"><a href="tutorial.html#cb15-17" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">crs</span>(slope) <span class="sc">!=</span> epsg) {</span>
<span id="cb15-18"><a href="tutorial.html#cb15-18" tabindex="-1"></a>    slope <span class="ot">&lt;-</span> <span class="fu">project</span>(slope, epsg, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb15-19"><a href="tutorial.html#cb15-19" tabindex="-1"></a>  }</span>
<span id="cb15-20"><a href="tutorial.html#cb15-20" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> slope <span class="sc">/</span> slope  <span class="co"># Normalize to 0/1</span></span>
<span id="cb15-21"><a href="tutorial.html#cb15-21" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-22"><a href="tutorial.html#cb15-22" tabindex="-1"></a>  <span class="fu">rm</span>(slope)</span>
<span id="cb15-23"><a href="tutorial.html#cb15-23" tabindex="-1"></a>}</span>
<span id="cb15-24"><a href="tutorial.html#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a href="tutorial.html#cb15-25" tabindex="-1"></a><span class="co"># Geology</span></span>
<span id="cb15-26"><a href="tutorial.html#cb15-26" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(geo)) {</span>
<span id="cb15-27"><a href="tutorial.html#cb15-27" tabindex="-1"></a>  geo <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(geo, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-28"><a href="tutorial.html#cb15-28" tabindex="-1"></a>  <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(geo)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb15-29"><a href="tutorial.html#cb15-29" tabindex="-1"></a>    geo <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(geo, <span class="at">crs =</span> epsg)</span>
<span id="cb15-30"><a href="tutorial.html#cb15-30" tabindex="-1"></a>  }</span>
<span id="cb15-31"><a href="tutorial.html#cb15-31" tabindex="-1"></a>  geo<span class="sc">$</span>GEO <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(geo[[geo.classes]]))</span>
<span id="cb15-32"><a href="tutorial.html#cb15-32" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-33"><a href="tutorial.html#cb15-33" tabindex="-1"></a>  <span class="fu">rm</span>(geo)</span>
<span id="cb15-34"><a href="tutorial.html#cb15-34" tabindex="-1"></a>}</span>
<span id="cb15-35"><a href="tutorial.html#cb15-35" tabindex="-1"></a></span>
<span id="cb15-36"><a href="tutorial.html#cb15-36" tabindex="-1"></a><span class="co"># Geomorphology</span></span>
<span id="cb15-37"><a href="tutorial.html#cb15-37" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(geomorph)) {</span>
<span id="cb15-38"><a href="tutorial.html#cb15-38" tabindex="-1"></a>  file_extension <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_ext</span>(geomorph)</span>
<span id="cb15-39"><a href="tutorial.html#cb15-39" tabindex="-1"></a>  </span>
<span id="cb15-40"><a href="tutorial.html#cb15-40" tabindex="-1"></a>  <span class="cf">if</span> (file_extension <span class="sc">==</span> <span class="st">&quot;tif&quot;</span>) {</span>
<span id="cb15-41"><a href="tutorial.html#cb15-41" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">rast</span>(geomorph)</span>
<span id="cb15-42"><a href="tutorial.html#cb15-42" tabindex="-1"></a>    <span class="fu">names</span>(geomorph) <span class="ot">&lt;-</span> <span class="st">&#39;GEOMORPH&#39;</span></span>
<span id="cb15-43"><a href="tutorial.html#cb15-43" tabindex="-1"></a>    </span>
<span id="cb15-44"><a href="tutorial.html#cb15-44" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">crs</span>(geomorph) <span class="sc">!=</span> epsg) {</span>
<span id="cb15-45"><a href="tutorial.html#cb15-45" tabindex="-1"></a>      geomorph <span class="ot">&lt;-</span> <span class="fu">project</span>(geomorph, epsg, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb15-46"><a href="tutorial.html#cb15-46" tabindex="-1"></a>    }</span>
<span id="cb15-47"><a href="tutorial.html#cb15-47" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (file_extension <span class="sc">==</span> <span class="st">&quot;shp&quot;</span>) {</span>
<span id="cb15-48"><a href="tutorial.html#cb15-48" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(geomorph, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-49"><a href="tutorial.html#cb15-49" tabindex="-1"></a>    </span>
<span id="cb15-50"><a href="tutorial.html#cb15-50" tabindex="-1"></a>    <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(geomorph)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb15-51"><a href="tutorial.html#cb15-51" tabindex="-1"></a>      geomorph <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(geomorph, <span class="at">crs =</span> epsg)</span>
<span id="cb15-52"><a href="tutorial.html#cb15-52" tabindex="-1"></a>    }</span>
<span id="cb15-53"><a href="tutorial.html#cb15-53" tabindex="-1"></a>    geomorph<span class="sc">$</span>GEOMORPH <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(geomorph[[geomorph.classes]]))</span>
<span id="cb15-54"><a href="tutorial.html#cb15-54" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-55"><a href="tutorial.html#cb15-55" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File format not recognized. Expected .tif or .shp.&quot;</span>)</span>
<span id="cb15-56"><a href="tutorial.html#cb15-56" tabindex="-1"></a>    <span class="fu">rm</span>(geomorph)</span>
<span id="cb15-57"><a href="tutorial.html#cb15-57" tabindex="-1"></a>  }</span>
<span id="cb15-58"><a href="tutorial.html#cb15-58" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-59"><a href="tutorial.html#cb15-59" tabindex="-1"></a>  <span class="fu">rm</span>(geomorph)</span>
<span id="cb15-60"><a href="tutorial.html#cb15-60" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="load-main-environmental-covariates" class="section level3 hasAnchor" number="6.5.3">
<h3><span class="header-section-number">6.5.3</span> Load Main Environmental Covariates<a href="tutorial.html#load-main-environmental-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="tutorial.html#cb16-1" tabindex="-1"></a><span class="co"># Load covariate stack</span></span>
<span id="cb16-2"><a href="tutorial.html#cb16-2" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">list.files</span>(raster.path, </span>
<span id="cb16-3"><a href="tutorial.html#cb16-3" tabindex="-1"></a>                      <span class="at">pattern =</span> <span class="st">&quot;covs_zam_clipped.tif$&quot;</span>,  </span>
<span id="cb16-4"><a href="tutorial.html#cb16-4" tabindex="-1"></a>                      <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb16-5"><a href="tutorial.html#cb16-5" tabindex="-1"></a>                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-6"><a href="tutorial.html#cb16-6" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat)</span>
<span id="cb16-7"><a href="tutorial.html#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="tutorial.html#cb16-8" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Loaded %d environmental covariates</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat)))</span>
<span id="cb16-9"><a href="tutorial.html#cb16-9" tabindex="-1"></a></span>
<span id="cb16-10"><a href="tutorial.html#cb16-10" tabindex="-1"></a><span class="co"># Display covariate names in a table</span></span>
<span id="cb16-11"><a href="tutorial.html#cb16-11" tabindex="-1"></a>cov.dat.names <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">names</span>(cov.dat), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-12"><a href="tutorial.html#cb16-12" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cov.dat.names, <span class="at">format =</span> <span class="st">&quot;markdown&quot;</span>, </span>
<span id="cb16-13"><a href="tutorial.html#cb16-13" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">&quot;Environmental covariates&quot;</span>)</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: Initial number of environmental covariates: 68</p>
</blockquote>
</div>
<div id="load-and-process-soil-climate-data-newhall" class="section level3 hasAnchor" number="6.5.4">
<h3><span class="header-section-number">6.5.4</span> Load and Process Soil Climate Data (Newhall)<a href="tutorial.html#load-and-process-soil-climate-data-newhall" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="tutorial.html#cb17-1" tabindex="-1"></a><span class="co"># Load soil climate data</span></span>
<span id="cb17-2"><a href="tutorial.html#cb17-2" tabindex="-1"></a>newhall <span class="ot">&lt;-</span> <span class="fu">list.files</span>(raster.path, </span>
<span id="cb17-3"><a href="tutorial.html#cb17-3" tabindex="-1"></a>                      <span class="at">pattern =</span> <span class="st">&quot;newhall_zam_clipped.tif$&quot;</span>,  </span>
<span id="cb17-4"><a href="tutorial.html#cb17-4" tabindex="-1"></a>                      <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb17-5"><a href="tutorial.html#cb17-5" tabindex="-1"></a>                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-6"><a href="tutorial.html#cb17-6" tabindex="-1"></a>newhall <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(newhall)</span>
<span id="cb17-7"><a href="tutorial.html#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="tutorial.html#cb17-8" tabindex="-1"></a><span class="co"># Display variable names</span></span>
<span id="cb17-9"><a href="tutorial.html#cb17-9" tabindex="-1"></a>newhall.names <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">names</span>(newhall), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-10"><a href="tutorial.html#cb17-10" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(newhall.names, <span class="at">format =</span> <span class="st">&quot;markdown&quot;</span>, </span>
<span id="cb17-11"><a href="tutorial.html#cb17-11" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">&quot;Soil climate variables&quot;</span>)</span>
<span id="cb17-12"><a href="tutorial.html#cb17-12" tabindex="-1"></a></span>
<span id="cb17-13"><a href="tutorial.html#cb17-13" tabindex="-1"></a><span class="co"># Remove unnecessary subdivisions</span></span>
<span id="cb17-14"><a href="tutorial.html#cb17-14" tabindex="-1"></a>newhall<span class="sc">$</span>regimeSubdivision1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb17-15"><a href="tutorial.html#cb17-15" tabindex="-1"></a>newhall<span class="sc">$</span>regimeSubdivision2 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb17-16"><a href="tutorial.html#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="tutorial.html#cb17-17" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Soil climate variables: %d (after removing subdivisions)</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(newhall)))</span></code></pre></div>
</div>
<div id="convert-categorical-variables-to-dummy-variables" class="section level3 hasAnchor" number="6.5.5">
<h3><span class="header-section-number">6.5.5</span> Convert Categorical Variables to Dummy Variables<a href="tutorial.html#convert-categorical-variables-to-dummy-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="tutorial.html#cb18-1" tabindex="-1"></a><span class="co"># Convert temperatureRegime and moistureRegime to dummy variables</span></span>
<span id="cb18-2"><a href="tutorial.html#cb18-2" tabindex="-1"></a>temperatureRegime <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> newhall<span class="sc">$</span>temperatureRegime, </span>
<span id="cb18-3"><a href="tutorial.html#cb18-3" tabindex="-1"></a>                             <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb18-4"><a href="tutorial.html#cb18-4" tabindex="-1"></a>moistureRegime <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> newhall<span class="sc">$</span>moistureRegime, </span>
<span id="cb18-5"><a href="tutorial.html#cb18-5" tabindex="-1"></a>                          <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb18-6"><a href="tutorial.html#cb18-6" tabindex="-1"></a></span>
<span id="cb18-7"><a href="tutorial.html#cb18-7" tabindex="-1"></a><span class="co"># Remove original categorical layers</span></span>
<span id="cb18-8"><a href="tutorial.html#cb18-8" tabindex="-1"></a>newhall<span class="sc">$</span>temperatureRegime <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb18-9"><a href="tutorial.html#cb18-9" tabindex="-1"></a>newhall<span class="sc">$</span>moistureRegime <span class="ot">&lt;-</span> <span class="fu">c</span>()</span></code></pre></div>
</div>
<div id="merge-all-covariate-layers" class="section level3 hasAnchor" number="6.5.6">
<h3><span class="header-section-number">6.5.6</span> Merge All Covariate Layers<a href="tutorial.html#merge-all-covariate-layers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="tutorial.html#cb19-1" tabindex="-1"></a><span class="co"># Merge covariates and climate data</span></span>
<span id="cb19-2"><a href="tutorial.html#cb19-2" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat, newhall, temperatureRegime, moistureRegime)</span>
<span id="cb19-3"><a href="tutorial.html#cb19-3" tabindex="-1"></a>    </span>
<span id="cb19-4"><a href="tutorial.html#cb19-4" tabindex="-1"></a><span class="co"># Project if necessary</span></span>
<span id="cb19-5"><a href="tutorial.html#cb19-5" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">crs</span>(cov.dat) <span class="sc">!=</span> epsg) {</span>
<span id="cb19-6"><a href="tutorial.html#cb19-6" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(cov.dat, epsg, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb19-7"><a href="tutorial.html#cb19-7" tabindex="-1"></a>}</span>
<span id="cb19-8"><a href="tutorial.html#cb19-8" tabindex="-1"></a></span>
<span id="cb19-9"><a href="tutorial.html#cb19-9" tabindex="-1"></a><span class="co"># Add geology if exists</span></span>
<span id="cb19-10"><a href="tutorial.html#cb19-10" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;geo&quot;</span>)) {</span>
<span id="cb19-11"><a href="tutorial.html#cb19-11" tabindex="-1"></a>  geo <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">as</span>(geo, <span class="st">&quot;SpatVector&quot;</span>), cov.dat, <span class="at">field =</span> <span class="st">&quot;GEO&quot;</span>)</span>
<span id="cb19-12"><a href="tutorial.html#cb19-12" tabindex="-1"></a>  geo <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> geo<span class="sc">$</span>GEO, <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb19-13"><a href="tutorial.html#cb19-13" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat, geo)</span>
<span id="cb19-14"><a href="tutorial.html#cb19-14" tabindex="-1"></a>}</span>
<span id="cb19-15"><a href="tutorial.html#cb19-15" tabindex="-1"></a></span>
<span id="cb19-16"><a href="tutorial.html#cb19-16" tabindex="-1"></a><span class="co"># Add geomorphology if exists</span></span>
<span id="cb19-17"><a href="tutorial.html#cb19-17" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;geomorph&quot;</span>)) {</span>
<span id="cb19-18"><a href="tutorial.html#cb19-18" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(geomorph, <span class="st">&quot;SpatRaster&quot;</span>)) {</span>
<span id="cb19-19"><a href="tutorial.html#cb19-19" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">as</span>(geomorph, <span class="st">&quot;SpatVector&quot;</span>), cov.dat, <span class="at">field =</span> <span class="st">&quot;GEOMORPH&quot;</span>)</span>
<span id="cb19-20"><a href="tutorial.html#cb19-20" tabindex="-1"></a>  }</span>
<span id="cb19-21"><a href="tutorial.html#cb19-21" tabindex="-1"></a>  geomorph <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> geomorph<span class="sc">$</span>GEOMORPH, <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb19-22"><a href="tutorial.html#cb19-22" tabindex="-1"></a>  </span>
<span id="cb19-23"><a href="tutorial.html#cb19-23" tabindex="-1"></a>  <span class="co"># Ensure matching extent and resolution</span></span>
<span id="cb19-24"><a href="tutorial.html#cb19-24" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">identical</span>(<span class="fu">ext</span>(cov.dat), <span class="fu">ext</span>(geomorph))) {</span>
<span id="cb19-25"><a href="tutorial.html#cb19-25" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">extend</span>(geomorph, cov.dat)</span>
<span id="cb19-26"><a href="tutorial.html#cb19-26" tabindex="-1"></a>  }</span>
<span id="cb19-27"><a href="tutorial.html#cb19-27" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">res</span>(cov.dat) <span class="sc">==</span> <span class="fu">res</span>(geomorph))) {</span>
<span id="cb19-28"><a href="tutorial.html#cb19-28" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">resample</span>(geomorph, cov.dat, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb19-29"><a href="tutorial.html#cb19-29" tabindex="-1"></a>  }</span>
<span id="cb19-30"><a href="tutorial.html#cb19-30" tabindex="-1"></a>  </span>
<span id="cb19-31"><a href="tutorial.html#cb19-31" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat, geomorph)</span>
<span id="cb19-32"><a href="tutorial.html#cb19-32" tabindex="-1"></a>}</span>
<span id="cb19-33"><a href="tutorial.html#cb19-33" tabindex="-1"></a></span>
<span id="cb19-34"><a href="tutorial.html#cb19-34" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb19-35"><a href="tutorial.html#cb19-35" tabindex="-1"></a><span class="fu">rm</span>(newhall, geomorph, geo)</span>
<span id="cb19-36"><a href="tutorial.html#cb19-36" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb19-37"><a href="tutorial.html#cb19-37" tabindex="-1"></a></span>
<span id="cb19-38"><a href="tutorial.html#cb19-38" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Final covariate stack: %d layers</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat)))</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: <strong>Stacking</strong> is the process of combining multiple spatial data layers (raster datasets) into a single multi-layer object. This is useful when multiple variables need to be analyzed together.</p>
</blockquote>
</div>
<div id="crop-and-save-covariates" class="section level3 hasAnchor" number="6.5.7">
<h3><span class="header-section-number">6.5.7</span> Crop and Save Covariates<a href="tutorial.html#crop-and-save-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="tutorial.html#cb20-1" tabindex="-1"></a><span class="co"># Crop covariates to administrative boundary</span></span>
<span id="cb20-2"><a href="tutorial.html#cb20-2" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, country_boundaries, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-3"><a href="tutorial.html#cb20-3" tabindex="-1"></a><span class="fu">writeRaster</span>(cov.dat, </span>
<span id="cb20-4"><a href="tutorial.html#cb20-4" tabindex="-1"></a>            <span class="fu">paste0</span>(raster.path, <span class="st">&quot;cov_dat_stack.tif&quot;</span>), </span>
<span id="cb20-5"><a href="tutorial.html#cb20-5" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-6"><a href="tutorial.html#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="tutorial.html#cb20-7" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb20-8"><a href="tutorial.html#cb20-8" tabindex="-1"></a><span class="co"># cov.dat &lt;- rast(paste0(raster.path, &quot;cov_dat_stack.tif&quot;))</span></span></code></pre></div>
</div>
</div>
<div id="pca" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Principal Component Analysis (PCA)<a href="tutorial.html#pca" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>PCA reduces dimensionality while retaining the most important information. Components explaining 99% of variance are kept.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="tutorial.html#cb21-1" tabindex="-1"></a><span class="co"># Perform PCA</span></span>
<span id="cb21-2"><a href="tutorial.html#cb21-2" tabindex="-1"></a>pca <span class="ot">&lt;-</span> synoptReg<span class="sc">::</span><span class="fu">raster_pca</span>(cov.dat)  <span class="co"># Faster than terra::princomp</span></span>
<span id="cb21-3"><a href="tutorial.html#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="tutorial.html#cb21-4" tabindex="-1"></a><span class="co"># Get SpatRaster layers</span></span>
<span id="cb21-5"><a href="tutorial.html#cb21-5" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb21-6"><a href="tutorial.html#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="tutorial.html#cb21-7" tabindex="-1"></a><span class="co"># Display summary</span></span>
<span id="cb21-8"><a href="tutorial.html#cb21-8" tabindex="-1"></a><span class="fu">summary</span>(cov.dat)</span>
<span id="cb21-9"><a href="tutorial.html#cb21-9" tabindex="-1"></a></span>
<span id="cb21-10"><a href="tutorial.html#cb21-10" tabindex="-1"></a><span class="co"># Subset to main PCs (variance explained &gt;= 0.99)</span></span>
<span id="cb21-11"><a href="tutorial.html#cb21-11" tabindex="-1"></a>n_comps <span class="ot">&lt;-</span> <span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,] <span class="sc">&gt;</span> <span class="fl">0.99</span>))</span>
<span id="cb21-12"><a href="tutorial.html#cb21-12" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span>n_comps]]</span>
<span id="cb21-13"><a href="tutorial.html#cb21-13" tabindex="-1"></a></span>
<span id="cb21-14"><a href="tutorial.html#cb21-14" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Retained %d principal components (99%% variance)</span><span class="sc">\n</span><span class="st">&quot;</span>, n_comps))</span>
<span id="cb21-15"><a href="tutorial.html#cb21-15" tabindex="-1"></a></span>
<span id="cb21-16"><a href="tutorial.html#cb21-16" tabindex="-1"></a><span class="co"># Save PCA rasters</span></span>
<span id="cb21-17"><a href="tutorial.html#cb21-17" tabindex="-1"></a><span class="fu">writeRaster</span>(cov.dat, </span>
<span id="cb21-18"><a href="tutorial.html#cb21-18" tabindex="-1"></a>            <span class="fu">paste0</span>(results.path, <span class="st">&quot;PCA_projected.tif&quot;</span>), </span>
<span id="cb21-19"><a href="tutorial.html#cb21-19" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-20"><a href="tutorial.html#cb21-20" tabindex="-1"></a></span>
<span id="cb21-21"><a href="tutorial.html#cb21-21" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb21-22"><a href="tutorial.html#cb21-22" tabindex="-1"></a><span class="fu">rm</span>(pca)</span>
<span id="cb21-23"><a href="tutorial.html#cb21-23" tabindex="-1"></a></span>
<span id="cb21-24"><a href="tutorial.html#cb21-24" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb21-25"><a href="tutorial.html#cb21-25" tabindex="-1"></a><span class="co"># cov.dat &lt;- rast(paste0(results.path, &quot;PCA_projected.tif&quot;))</span></span></code></pre></div>
</div>
<div id="sampling-universe" class="section level2 hasAnchor" number="6.7">
<h2><span class="header-section-number">6.7</span> Organize the Sampling Universe<a href="tutorial.html#sampling-universe" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="load-and-process-land-use-data" class="section level3 hasAnchor" number="6.7.1">
<h3><span class="header-section-number">6.7.1</span> Load and Process Land Use Data<a href="tutorial.html#load-and-process-land-use-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="tutorial.html#cb22-1" tabindex="-1"></a><span class="co"># Define land-use raster path</span></span>
<span id="cb22-2"><a href="tutorial.html#cb22-2" tabindex="-1"></a>landuse <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;cropland_clipped_zmb_v1_epsg_3857.tif&quot;</span>))</span>
<span id="cb22-3"><a href="tutorial.html#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="tutorial.html#cb22-4" tabindex="-1"></a><span class="co"># Load binary raster (1 = target land use, NA = other)</span></span>
<span id="cb22-5"><a href="tutorial.html#cb22-5" tabindex="-1"></a>crops <span class="ot">&lt;-</span> <span class="fu">rast</span>(landuse)</span>
<span id="cb22-6"><a href="tutorial.html#cb22-6" tabindex="-1"></a>crops <span class="ot">&lt;-</span> crops <span class="sc">/</span> crops  <span class="co"># Normalize</span></span>
<span id="cb22-7"><a href="tutorial.html#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="tutorial.html#cb22-8" tabindex="-1"></a><span class="fu">names</span>(crops) <span class="ot">&lt;-</span> <span class="st">&quot;lu&quot;</span></span>
<span id="cb22-9"><a href="tutorial.html#cb22-9" tabindex="-1"></a></span>
<span id="cb22-10"><a href="tutorial.html#cb22-10" tabindex="-1"></a><span class="co"># Display raster info</span></span>
<span id="cb22-11"><a href="tutorial.html#cb22-11" tabindex="-1"></a>crops</span></code></pre></div>
</div>
<div id="exclude-protected-areas" class="section level3 hasAnchor" number="6.7.2">
<h3><span class="header-section-number">6.7.2</span> Exclude Protected Areas<a href="tutorial.html#exclude-protected-areas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="tutorial.html#cb23-1" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;npa&quot;</span>)) {</span>
<span id="cb23-2"><a href="tutorial.html#cb23-2" tabindex="-1"></a>  <span class="co"># If npa is a shapefile</span></span>
<span id="cb23-3"><a href="tutorial.html#cb23-3" tabindex="-1"></a>  crops <span class="ot">&lt;-</span> <span class="fu">mask</span>(crops, npa)</span>
<span id="cb23-4"><a href="tutorial.html#cb23-4" tabindex="-1"></a>  </span>
<span id="cb23-5"><a href="tutorial.html#cb23-5" tabindex="-1"></a>  <span class="co"># If npa is a raster (uncomment if applicable)</span></span>
<span id="cb23-6"><a href="tutorial.html#cb23-6" tabindex="-1"></a>  <span class="co"># npa &lt;- resample(npa, crops, method = &quot;near&quot;)</span></span>
<span id="cb23-7"><a href="tutorial.html#cb23-7" tabindex="-1"></a>  <span class="co"># crops &lt;- crops * npa</span></span>
<span id="cb23-8"><a href="tutorial.html#cb23-8" tabindex="-1"></a>}</span>
<span id="cb23-9"><a href="tutorial.html#cb23-9" tabindex="-1"></a></span>
<span id="cb23-10"><a href="tutorial.html#cb23-10" tabindex="-1"></a><span class="fu">rm</span>(npa)</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: Use the correct operation for your npa dataset type (shapefile or raster).</p>
</blockquote>
</div>
<div id="restrict-to-accessible-slopes" class="section level3 hasAnchor" number="6.7.3">
<h3><span class="header-section-number">6.7.3</span> Restrict to Accessible Slopes<a href="tutorial.html#restrict-to-accessible-slopes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="tutorial.html#cb24-1" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;slope&quot;</span>)) {</span>
<span id="cb24-2"><a href="tutorial.html#cb24-2" tabindex="-1"></a>  <span class="co"># Resample to match crops resolution</span></span>
<span id="cb24-3"><a href="tutorial.html#cb24-3" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">resample</span>(slope, crops, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb24-4"><a href="tutorial.html#cb24-4" tabindex="-1"></a>  crops <span class="ot">&lt;-</span> crops <span class="sc">*</span> slope</span>
<span id="cb24-5"><a href="tutorial.html#cb24-5" tabindex="-1"></a>}</span>
<span id="cb24-6"><a href="tutorial.html#cb24-6" tabindex="-1"></a></span>
<span id="cb24-7"><a href="tutorial.html#cb24-7" tabindex="-1"></a><span class="fu">rm</span>(slope)</span></code></pre></div>
</div>
<div id="aggregate-to-100m-resolution" class="section level3 hasAnchor" number="6.7.4">
<h3><span class="header-section-number">6.7.4</span> Aggregate to 100m Resolution<a href="tutorial.html#aggregate-to-100m-resolution" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Resampling to 100m resolution significantly optimizes processing speed and reduces storage requirements.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="tutorial.html#cb25-1" tabindex="-1"></a><span class="co"># Aggregate 20m pixels to 100m (5√ó5 grid using modal value)</span></span>
<span id="cb25-2"><a href="tutorial.html#cb25-2" tabindex="-1"></a>lu <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(crops, <span class="dv">5</span>, <span class="at">fun =</span> modal, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-3"><a href="tutorial.html#cb25-3" tabindex="-1"></a>lu <span class="ot">&lt;-</span> lu <span class="sc">/</span> lu</span>
<span id="cb25-4"><a href="tutorial.html#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="tutorial.html#cb25-5" tabindex="-1"></a><span class="co"># Display new resolution</span></span>
<span id="cb25-6"><a href="tutorial.html#cb25-6" tabindex="-1"></a>lu</span></code></pre></div>
</div>
<div id="save-processed-land-use" class="section level3 hasAnchor" number="6.7.5">
<h3><span class="header-section-number">6.7.5</span> Save Processed Land Use<a href="tutorial.html#save-processed-land-use" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="tutorial.html#cb26-1" tabindex="-1"></a><span class="fu">writeRaster</span>(lu, </span>
<span id="cb26-2"><a href="tutorial.html#cb26-2" tabindex="-1"></a>            <span class="fu">paste0</span>(raster.path, <span class="st">&quot;cropland_zmb_100m_v1_epsg_3857.tif&quot;</span>), </span>
<span id="cb26-3"><a href="tutorial.html#cb26-3" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-4"><a href="tutorial.html#cb26-4" tabindex="-1"></a></span>
<span id="cb26-5"><a href="tutorial.html#cb26-5" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb26-6"><a href="tutorial.html#cb26-6" tabindex="-1"></a>lu <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;cropland_zmb_100m_v1_epsg_3857.tif&quot;</span>))</span></code></pre></div>
</div>
<div id="filter-legacy-data" class="section level3 hasAnchor" number="6.7.6">
<h3><span class="header-section-number">6.7.6</span> Filter Legacy Data<a href="tutorial.html#filter-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="tutorial.html#cb27-1" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb27-2"><a href="tutorial.html#cb27-2" tabindex="-1"></a>  <span class="co"># Keep only legacy points within land-use areas</span></span>
<span id="cb27-3"><a href="tutorial.html#cb27-3" tabindex="-1"></a>  legacy<span class="sc">$</span>INSIDE <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(crops, legacy) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(lu)</span>
<span id="cb27-4"><a href="tutorial.html#cb27-4" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> legacy[<span class="sc">!</span><span class="fu">is.na</span>(legacy<span class="sc">$</span>INSIDE), ] <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="tutorial.html#cb27-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="st">&quot;INSIDE&quot;</span>)</span>
<span id="cb27-6"><a href="tutorial.html#cb27-6" tabindex="-1"></a>  </span>
<span id="cb27-7"><a href="tutorial.html#cb27-7" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Legacy points within land-use areas: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(legacy)))</span>
<span id="cb27-8"><a href="tutorial.html#cb27-8" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="create-psu-grid" class="section level2 hasAnchor" number="6.8">
<h2><span class="header-section-number">6.8</span> Create Primary Sampling Units (PSU Grid)<a href="tutorial.html#create-psu-grid" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="generate-2km-2km-grid" class="section level3 hasAnchor" number="6.8.1">
<h3><span class="header-section-number">6.8.1</span> Generate 2km √ó 2km Grid<a href="tutorial.html#generate-2km-2km-grid" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="tutorial.html#cb28-1" tabindex="-1"></a><span class="co"># Create grid</span></span>
<span id="cb28-2"><a href="tutorial.html#cb28-2" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(country_boundaries, </span>
<span id="cb28-3"><a href="tutorial.html#cb28-3" tabindex="-1"></a>                         <span class="at">cellsize =</span> <span class="fu">c</span>(psu_size, psu_size), </span>
<span id="cb28-4"><a href="tutorial.html#cb28-4" tabindex="-1"></a>                         <span class="at">square =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-5"><a href="tutorial.html#cb28-5" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> psu_grid)</span>
<span id="cb28-6"><a href="tutorial.html#cb28-6" tabindex="-1"></a>psu_grid<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(psu_grid)</span>
<span id="cb28-7"><a href="tutorial.html#cb28-7" tabindex="-1"></a></span>
<span id="cb28-8"><a href="tutorial.html#cb28-8" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Generated %d PSU grid cells</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(psu_grid)))</span></code></pre></div>
</div>
<div id="trim-to-country-boundaries" class="section level3 hasAnchor" number="6.8.2">
<h3><span class="header-section-number">6.8.2</span> Trim to Country Boundaries<a href="tutorial.html#trim-to-country-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="tutorial.html#cb29-1" tabindex="-1"></a><span class="co"># This operation is computationally intensive</span></span>
<span id="cb29-2"><a href="tutorial.html#cb29-2" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> psu_grid[country_boundaries[<span class="dv">1</span>], ]</span>
<span id="cb29-3"><a href="tutorial.html#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a href="tutorial.html#cb29-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;PSUs within country boundaries: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(psu_grid)))</span></code></pre></div>
</div>
<div id="save-psu-grid" class="section level3 hasAnchor" number="6.8.3">
<h3><span class="header-section-number">6.8.3</span> Save PSU Grid<a href="tutorial.html#save-psu-grid" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="tutorial.html#cb30-1" tabindex="-1"></a><span class="fu">write_sf</span>(psu_grid, </span>
<span id="cb30-2"><a href="tutorial.html#cb30-2" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;../grid2k.shp&quot;</span>), </span>
<span id="cb30-3"><a href="tutorial.html#cb30-3" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-4"><a href="tutorial.html#cb30-4" tabindex="-1"></a></span>
<span id="cb30-5"><a href="tutorial.html#cb30-5" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb30-6"><a href="tutorial.html#cb30-6" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path, <span class="st">&quot;../grid2k.shp&quot;</span>)))</span></code></pre></div>
</div>
</div>
<div id="select-psus" class="section level2 hasAnchor" number="6.9">
<h2><span class="header-section-number">6.9</span> Select PSUs with Sufficient Land Use Coverage<a href="tutorial.html#select-psus" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="calculate-land-use-percentage" class="section level3 hasAnchor" number="6.9.1">
<h3><span class="header-section-number">6.9.1</span> Calculate Land Use Percentage<a href="tutorial.html#calculate-land-use-percentage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="tutorial.html#cb31-1" tabindex="-1"></a><span class="co"># Extract land-use values for each PSU</span></span>
<span id="cb31-2"><a href="tutorial.html#cb31-2" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(lu, psu_grid)</span>
<span id="cb31-3"><a href="tutorial.html#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="tutorial.html#cb31-4" tabindex="-1"></a><span class="co"># Calculate percentage (400 pixels = 2km √ó 2km PSU at 100m resolution)</span></span>
<span id="cb31-5"><a href="tutorial.html#cb31-5" tabindex="-1"></a>crop_perc <span class="ot">&lt;-</span> extracted_values <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="tutorial.html#cb31-6" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb31-7"><a href="tutorial.html#cb31-7" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">crop_perc =</span> <span class="fu">sum</span>(lu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> <span class="dv">400</span>)</span>
<span id="cb31-8"><a href="tutorial.html#cb31-8" tabindex="-1"></a></span>
<span id="cb31-9"><a href="tutorial.html#cb31-9" tabindex="-1"></a><span class="fu">rm</span>(extracted_values)</span>
<span id="cb31-10"><a href="tutorial.html#cb31-10" tabindex="-1"></a></span>
<span id="cb31-11"><a href="tutorial.html#cb31-11" tabindex="-1"></a><span class="co"># Add to PSU grid</span></span>
<span id="cb31-12"><a href="tutorial.html#cb31-12" tabindex="-1"></a>psu_grid<span class="sc">$</span>crop_perc <span class="ot">&lt;-</span> crop_perc<span class="sc">$</span>crop_perc</span>
<span id="cb31-13"><a href="tutorial.html#cb31-13" tabindex="-1"></a></span>
<span id="cb31-14"><a href="tutorial.html#cb31-14" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Crop percentage calculated for all PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
</div>
<div id="filter-psus" class="section level3 hasAnchor" number="6.9.2">
<h3><span class="header-section-number">6.9.2</span> Filter PSUs<a href="tutorial.html#filter-psus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="tutorial.html#cb32-1" tabindex="-1"></a><span class="co"># Keep only PSUs with sufficient crop coverage</span></span>
<span id="cb32-2"><a href="tutorial.html#cb32-2" tabindex="-1"></a>psu_grid_filtered <span class="ot">&lt;-</span> psu_grid[psu_grid<span class="sc">$</span>crop_perc <span class="sc">&gt;</span> percent_crop, <span class="st">&quot;ID&quot;</span>]</span>
<span id="cb32-3"><a href="tutorial.html#cb32-3" tabindex="-1"></a></span>
<span id="cb32-4"><a href="tutorial.html#cb32-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;PSUs with &gt;%d%% crop coverage: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb32-5"><a href="tutorial.html#cb32-5" tabindex="-1"></a>            percent_crop, <span class="fu">nrow</span>(psu_grid_filtered)))</span>
<span id="cb32-6"><a href="tutorial.html#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="tutorial.html#cb32-7" tabindex="-1"></a><span class="co"># Save filtered grid</span></span>
<span id="cb32-8"><a href="tutorial.html#cb32-8" tabindex="-1"></a><span class="fu">write_sf</span>(psu_grid_filtered, </span>
<span id="cb32-9"><a href="tutorial.html#cb32-9" tabindex="-1"></a>         <span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path, <span class="st">&quot;/psu_grid_counts.shp&quot;</span>)), </span>
<span id="cb32-10"><a href="tutorial.html#cb32-10" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
</div>
<div id="rasterize-psus" class="section level2 hasAnchor" number="6.10">
<h2><span class="header-section-number">6.10</span> Rasterize PSUs for Covariate Space Coverage<a href="tutorial.html#rasterize-psus" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="tutorial.html#cb33-1" tabindex="-1"></a><span class="co"># Create raster template at PSU resolution</span></span>
<span id="cb33-2"><a href="tutorial.html#cb33-2" tabindex="-1"></a>template <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">vect</span>(psu_grid_filtered), <span class="at">res =</span> psu_size)</span>
<span id="cb33-3"><a href="tutorial.html#cb33-3" tabindex="-1"></a>template <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">vect</span>(psu_grid_filtered), template, <span class="at">field =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb33-4"><a href="tutorial.html#cb33-4" tabindex="-1"></a></span>
<span id="cb33-5"><a href="tutorial.html#cb33-5" tabindex="-1"></a><span class="co"># Crop covariates to filtered PSUs</span></span>
<span id="cb33-6"><a href="tutorial.html#cb33-6" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, psu_grid_filtered, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-7"><a href="tutorial.html#cb33-7" tabindex="-1"></a></span>
<span id="cb33-8"><a href="tutorial.html#cb33-8" tabindex="-1"></a><span class="co"># Resample covariates to match PSU template</span></span>
<span id="cb33-9"><a href="tutorial.html#cb33-9" tabindex="-1"></a>PSU.r <span class="ot">&lt;-</span> <span class="fu">resample</span>(cov.dat, template)</span>
<span id="cb33-10"><a href="tutorial.html#cb33-10" tabindex="-1"></a></span>
<span id="cb33-11"><a href="tutorial.html#cb33-11" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Covariates resampled to PSU resolution</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
<blockquote>
<p><strong>üí° Why this matters</strong>: Cropping and resampling ensure that spatial resolution and extent of covariates match the PSU grid, facilitating accurate clustering.</p>
</blockquote>
</div>
<div id="optimal-sample-size" class="section level2 hasAnchor" number="6.11">
<h2><span class="header-section-number">6.11</span> Compute Optimal Sample Size<a href="tutorial.html#optimal-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After rasterizing PSUs for Covariate Space Coverage, calculate the optimal sample size based on divergence metrics <span class="citation">(<a href="#ref-saurette2023"><strong>saurette2023?</strong></a>)</span>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="tutorial.html#cb34-1" tabindex="-1"></a><span class="co"># Load optimization script</span></span>
<span id="cb34-2"><a href="tutorial.html#cb34-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;scripts/opt_sample.R&quot;</span>)</span>
<span id="cb34-3"><a href="tutorial.html#cb34-3" tabindex="-1"></a></span>
<span id="cb34-4"><a href="tutorial.html#cb34-4" tabindex="-1"></a><span class="co"># Prepare covariate data</span></span>
<span id="cb34-5"><a href="tutorial.html#cb34-5" tabindex="-1"></a>psu.r.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(PSU.r)</span>
<span id="cb34-6"><a href="tutorial.html#cb34-6" tabindex="-1"></a></span>
<span id="cb34-7"><a href="tutorial.html#cb34-7" tabindex="-1"></a><span class="co"># Define parameters</span></span>
<span id="cb34-8"><a href="tutorial.html#cb34-8" tabindex="-1"></a>initial.n <span class="ot">&lt;-</span> <span class="dv">50</span>     <span class="co"># Minimum sample size</span></span>
<span id="cb34-9"><a href="tutorial.html#cb34-9" tabindex="-1"></a>final.n <span class="ot">&lt;-</span> <span class="dv">3000</span>     <span class="co"># Maximum sample size</span></span>
<span id="cb34-10"><a href="tutorial.html#cb34-10" tabindex="-1"></a>by.n <span class="ot">&lt;-</span> <span class="dv">25</span>          <span class="co"># Increment step</span></span>
<span id="cb34-11"><a href="tutorial.html#cb34-11" tabindex="-1"></a>iters <span class="ot">&lt;-</span> <span class="dv">4</span>          <span class="co"># Iterations per trial</span></span></code></pre></div>
<div id="run-optimization" class="section level3 hasAnchor" number="6.11.1">
<h3><span class="header-section-number">6.11.1</span> Run Optimization<a href="tutorial.html#run-optimization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="tutorial.html#cb35-1" tabindex="-1"></a><span class="co"># Calculate optimal sample size using normalized KL-divergence</span></span>
<span id="cb35-2"><a href="tutorial.html#cb35-2" tabindex="-1"></a>opt_N_fcs <span class="ot">&lt;-</span> <span class="fu">opt_sample</span>(</span>
<span id="cb35-3"><a href="tutorial.html#cb35-3" tabindex="-1"></a>  <span class="at">alg =</span> <span class="st">&quot;fcs&quot;</span>,              <span class="co"># Feature coverage sampling</span></span>
<span id="cb35-4"><a href="tutorial.html#cb35-4" tabindex="-1"></a>  <span class="at">s_min =</span> initial.n, </span>
<span id="cb35-5"><a href="tutorial.html#cb35-5" tabindex="-1"></a>  <span class="at">s_max =</span> final.n, </span>
<span id="cb35-6"><a href="tutorial.html#cb35-6" tabindex="-1"></a>  <span class="at">s_step =</span> by.n, </span>
<span id="cb35-7"><a href="tutorial.html#cb35-7" tabindex="-1"></a>  <span class="at">s_reps =</span> iters, </span>
<span id="cb35-8"><a href="tutorial.html#cb35-8" tabindex="-1"></a>  <span class="at">covs =</span> psu.r.df, </span>
<span id="cb35-9"><a href="tutorial.html#cb35-9" tabindex="-1"></a>  <span class="at">cpus =</span> <span class="cn">NULL</span>,              <span class="co"># Use all available cores</span></span>
<span id="cb35-10"><a href="tutorial.html#cb35-10" tabindex="-1"></a>  <span class="at">conf =</span> <span class="fl">0.95</span></span>
<span id="cb35-11"><a href="tutorial.html#cb35-11" tabindex="-1"></a>)</span>
<span id="cb35-12"><a href="tutorial.html#cb35-12" tabindex="-1"></a></span>
<span id="cb35-13"><a href="tutorial.html#cb35-13" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb35-14"><a href="tutorial.html#cb35-14" tabindex="-1"></a><span class="fu">print</span>(opt_N_fcs<span class="sc">$</span>optimal_sites)</span></code></pre></div>
</div>
<div id="extract-optimal-sample-size" class="section level3 hasAnchor" number="6.11.2">
<h3><span class="header-section-number">6.11.2</span> Extract Optimal Sample Size<a href="tutorial.html#extract-optimal-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="tutorial.html#cb36-1" tabindex="-1"></a><span class="co"># Use Kullback-Leibler Divergence (most reliable)</span></span>
<span id="cb36-2"><a href="tutorial.html#cb36-2" tabindex="-1"></a>optimal_N_KLD <span class="ot">&lt;-</span> opt_N_fcs<span class="sc">$</span>optimal_sites[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb36-3"><a href="tutorial.html#cb36-3" tabindex="-1"></a></span>
<span id="cb36-4"><a href="tutorial.html#cb36-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">‚úì Optimal sample size: %d PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>, optimal_N_KLD))</span>
<span id="cb36-5"><a href="tutorial.html#cb36-5" tabindex="-1"></a></span>
<span id="cb36-6"><a href="tutorial.html#cb36-6" tabindex="-1"></a><span class="co"># Set final PSU count</span></span>
<span id="cb36-7"><a href="tutorial.html#cb36-7" tabindex="-1"></a>n.psu <span class="ot">&lt;-</span> optimal_N_KLD</span>
<span id="cb36-8"><a href="tutorial.html#cb36-8" tabindex="-1"></a></span>
<span id="cb36-9"><a href="tutorial.html#cb36-9" tabindex="-1"></a><span class="co"># Expected total sampling sites (4 per PSU)</span></span>
<span id="cb36-10"><a href="tutorial.html#cb36-10" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Expected total target sites: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, n.psu <span class="sc">*</span> <span class="dv">4</span>))</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: The optimal sample size is based on Kullback-Leibler Divergence, which does not overestimate like Jensen-Shannon methods.</p>
</blockquote>
</div>
</div>
<div id="csc-computing" class="section level2 hasAnchor" number="6.12">
<h2><span class="header-section-number">6.12</span> Covariate Space Coverage - Computing PSUs<a href="tutorial.html#csc-computing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Covariate Space Coverage (CSC) sampling ensures sampling units are distributed effectively across the multidimensional space of environmental covariates.</p>
<div id="prepare-function-parameters" class="section level3 hasAnchor" number="6.12.1">
<h3><span class="header-section-number">6.12.1</span> Prepare Function Parameters<a href="tutorial.html#prepare-function-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="tutorial.html#cb37-1" tabindex="-1"></a><span class="co"># Convert raster to dataframe with coordinates</span></span>
<span id="cb37-2"><a href="tutorial.html#cb37-2" tabindex="-1"></a>PSU.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(PSU.r, <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-3"><a href="tutorial.html#cb37-3" tabindex="-1"></a></span>
<span id="cb37-4"><a href="tutorial.html#cb37-4" tabindex="-1"></a><span class="co"># Get covariate names</span></span>
<span id="cb37-5"><a href="tutorial.html#cb37-5" tabindex="-1"></a>covs <span class="ot">&lt;-</span> <span class="fu">names</span>(cov.dat)</span>
<span id="cb37-6"><a href="tutorial.html#cb37-6" tabindex="-1"></a></span>
<span id="cb37-7"><a href="tutorial.html#cb37-7" tabindex="-1"></a><span class="co"># Scale covariates (mean = 0, SD = 1)</span></span>
<span id="cb37-8"><a href="tutorial.html#cb37-8" tabindex="-1"></a>mygrd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">scale</span>(PSU.df[, covs]))</span>
<span id="cb37-9"><a href="tutorial.html#cb37-9" tabindex="-1"></a></span>
<span id="cb37-10"><a href="tutorial.html#cb37-10" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Prepared %d PSUs with %d covariates for clustering</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb37-11"><a href="tutorial.html#cb37-11" tabindex="-1"></a>            <span class="fu">nrow</span>(mygrd), <span class="fu">ncol</span>(mygrd)))</span></code></pre></div>
</div>
<div id="perform-k-means-clustering" class="section level3 hasAnchor" number="6.12.2">
<h3><span class="header-section-number">6.12.2</span> Perform K-means Clustering<a href="tutorial.html#perform-k-means-clustering" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="tutorial.html#cb38-1" tabindex="-1"></a><span class="co"># With legacy data</span></span>
<span id="cb38-2"><a href="tutorial.html#cb38-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb38-3"><a href="tutorial.html#cb38-3" tabindex="-1"></a>  <span class="co"># Filter legacy to PSU grid extent</span></span>
<span id="cb38-4"><a href="tutorial.html#cb38-4" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> <span class="fu">st_filter</span>(legacy, psu_grid_filtered)</span>
<span id="cb38-5"><a href="tutorial.html#cb38-5" tabindex="-1"></a>  legacy_df <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(legacy)</span>
<span id="cb38-6"><a href="tutorial.html#cb38-6" tabindex="-1"></a>  </span>
<span id="cb38-7"><a href="tutorial.html#cb38-7" tabindex="-1"></a>  <span class="co"># Find nearest PSU for each legacy point</span></span>
<span id="cb38-8"><a href="tutorial.html#cb38-8" tabindex="-1"></a>  units <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(legacy_df))</span>
<span id="cb38-9"><a href="tutorial.html#cb38-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(legacy_df)) {</span>
<span id="cb38-10"><a href="tutorial.html#cb38-10" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((PSU.df<span class="sc">$</span>x <span class="sc">-</span> legacy_df[i, <span class="st">&quot;X&quot;</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb38-11"><a href="tutorial.html#cb38-11" tabindex="-1"></a>                     (PSU.df<span class="sc">$</span>y <span class="sc">-</span> legacy_df[i, <span class="st">&quot;Y&quot;</span>])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb38-12"><a href="tutorial.html#cb38-12" tabindex="-1"></a>    units[i] <span class="ot">&lt;-</span> <span class="fu">which.min</span>(distances)</span>
<span id="cb38-13"><a href="tutorial.html#cb38-13" tabindex="-1"></a>  }</span>
<span id="cb38-14"><a href="tutorial.html#cb38-14" tabindex="-1"></a>  </span>
<span id="cb38-15"><a href="tutorial.html#cb38-15" tabindex="-1"></a>  <span class="co"># Create fixed centers from legacy points</span></span>
<span id="cb38-16"><a href="tutorial.html#cb38-16" tabindex="-1"></a>  fixed <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">data.frame</span>(units, <span class="fu">scale</span>(PSU.df[, covs])[units, ]))</span>
<span id="cb38-17"><a href="tutorial.html#cb38-17" tabindex="-1"></a>  </span>
<span id="cb38-18"><a href="tutorial.html#cb38-18" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Incorporating %d legacy points as fixed centers</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(fixed)))</span>
<span id="cb38-19"><a href="tutorial.html#cb38-19" tabindex="-1"></a>  </span>
<span id="cb38-20"><a href="tutorial.html#cb38-20" tabindex="-1"></a>  <span class="co"># Run constrained clustering</span></span>
<span id="cb38-21"><a href="tutorial.html#cb38-21" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">CSIS</span>(<span class="at">fixed =</span> fixed, </span>
<span id="cb38-22"><a href="tutorial.html#cb38-22" tabindex="-1"></a>              <span class="at">nsup =</span> n.psu, </span>
<span id="cb38-23"><a href="tutorial.html#cb38-23" tabindex="-1"></a>              <span class="at">nstarts =</span> iterations, </span>
<span id="cb38-24"><a href="tutorial.html#cb38-24" tabindex="-1"></a>              <span class="at">mygrd =</span> mygrd)</span>
<span id="cb38-25"><a href="tutorial.html#cb38-25" tabindex="-1"></a>  </span>
<span id="cb38-26"><a href="tutorial.html#cb38-26" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-27"><a href="tutorial.html#cb38-27" tabindex="-1"></a>  <span class="co"># Standard k-means without legacy data</span></span>
<span id="cb38-28"><a href="tutorial.html#cb38-28" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(mygrd, </span>
<span id="cb38-29"><a href="tutorial.html#cb38-29" tabindex="-1"></a>                <span class="at">centers =</span> n.psu, </span>
<span id="cb38-30"><a href="tutorial.html#cb38-30" tabindex="-1"></a>                <span class="at">iter.max =</span> <span class="dv">10000</span>, </span>
<span id="cb38-31"><a href="tutorial.html#cb38-31" tabindex="-1"></a>                <span class="at">nstart =</span> <span class="dv">100</span>)</span>
<span id="cb38-32"><a href="tutorial.html#cb38-32" tabindex="-1"></a>  </span>
<span id="cb38-33"><a href="tutorial.html#cb38-33" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Running standard k-means with %d centers</span><span class="sc">\n</span><span class="st">&quot;</span>, n.psu))</span>
<span id="cb38-34"><a href="tutorial.html#cb38-34" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>üí° Note</strong>: Progress is printed as ‚ÄúX out of Y‚Äù for each clustering iteration.</p>
</blockquote>
</div>
<div id="assign-clusters-and-calculate-distances" class="section level3 hasAnchor" number="6.12.3">
<h3><span class="header-section-number">6.12.3</span> Assign Clusters and Calculate Distances<a href="tutorial.html#assign-clusters-and-calculate-distances" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="tutorial.html#cb39-1" tabindex="-1"></a><span class="co"># Assign clusters to PSUs</span></span>
<span id="cb39-2"><a href="tutorial.html#cb39-2" tabindex="-1"></a>PSU.df<span class="sc">$</span>cluster <span class="ot">&lt;-</span> res<span class="sc">$</span>cluster</span>
<span id="cb39-3"><a href="tutorial.html#cb39-3" tabindex="-1"></a></span>
<span id="cb39-4"><a href="tutorial.html#cb39-4" tabindex="-1"></a><span class="co"># Compute distances to nearest cluster center</span></span>
<span id="cb39-5"><a href="tutorial.html#cb39-5" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> res<span class="sc">$</span>centers, <span class="at">x2 =</span> <span class="fu">scale</span>(PSU.df[, covs]))</span>
<span id="cb39-6"><a href="tutorial.html#cb39-6" tabindex="-1"></a>units <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> which.min)</span>
<span id="cb39-7"><a href="tutorial.html#cb39-7" tabindex="-1"></a></span>
<span id="cb39-8"><a href="tutorial.html#cb39-8" tabindex="-1"></a><span class="co"># Calculate Mean Squared Shortest Distance (MSSSD)</span></span>
<span id="cb39-9"><a href="tutorial.html#cb39-9" tabindex="-1"></a>dmin <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">2</span>, min)</span>
<span id="cb39-10"><a href="tutorial.html#cb39-10" tabindex="-1"></a>MSSSD <span class="ot">&lt;-</span> <span class="fu">mean</span>(dmin<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb39-11"><a href="tutorial.html#cb39-11" tabindex="-1"></a></span>
<span id="cb39-12"><a href="tutorial.html#cb39-12" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;MSSSD: %.6f</span><span class="sc">\n</span><span class="st">&quot;</span>, MSSSD))</span></code></pre></div>
</div>
<div id="extract-selected-psus" class="section level3 hasAnchor" number="6.12.4">
<h3><span class="header-section-number">6.12.4</span> Extract Selected PSUs<a href="tutorial.html#extract-selected-psus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="tutorial.html#cb40-1" tabindex="-1"></a><span class="co"># Get selected PSU coordinates and covariates</span></span>
<span id="cb40-2"><a href="tutorial.html#cb40-2" tabindex="-1"></a>myCSCsample <span class="ot">&lt;-</span> PSU.df[units, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, covs)]</span>
<span id="cb40-3"><a href="tutorial.html#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="tutorial.html#cb40-4" tabindex="-1"></a><span class="co"># Label as legacy or new</span></span>
<span id="cb40-5"><a href="tutorial.html#cb40-5" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb40-6"><a href="tutorial.html#cb40-6" tabindex="-1"></a>  myCSCsample<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;legacy&quot;</span>, <span class="fu">nrow</span>(fixed)), </span>
<span id="cb40-7"><a href="tutorial.html#cb40-7" tabindex="-1"></a>                        <span class="fu">rep</span>(<span class="st">&quot;new&quot;</span>, <span class="fu">length</span>(units) <span class="sc">-</span> <span class="fu">nrow</span>(fixed)))</span>
<span id="cb40-8"><a href="tutorial.html#cb40-8" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb40-9"><a href="tutorial.html#cb40-9" tabindex="-1"></a>  myCSCsample<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;new&quot;</span></span>
<span id="cb40-10"><a href="tutorial.html#cb40-10" tabindex="-1"></a>}</span>
<span id="cb40-11"><a href="tutorial.html#cb40-11" tabindex="-1"></a></span>
<span id="cb40-12"><a href="tutorial.html#cb40-12" tabindex="-1"></a><span class="co"># Convert to spatial object</span></span>
<span id="cb40-13"><a href="tutorial.html#cb40-13" tabindex="-1"></a>myCSCsample <span class="ot">&lt;-</span> myCSCsample <span class="sc">%&gt;%</span></span>
<span id="cb40-14"><a href="tutorial.html#cb40-14" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> epsg)</span>
<span id="cb40-15"><a href="tutorial.html#cb40-15" tabindex="-1"></a></span>
<span id="cb40-16"><a href="tutorial.html#cb40-16" tabindex="-1"></a><span class="co"># Separate legacy and new points</span></span>
<span id="cb40-17"><a href="tutorial.html#cb40-17" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb40-18"><a href="tutorial.html#cb40-18" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> myCSCsample[myCSCsample<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;legacy&quot;</span>, ]</span>
<span id="cb40-19"><a href="tutorial.html#cb40-19" tabindex="-1"></a>}</span>
<span id="cb40-20"><a href="tutorial.html#cb40-20" tabindex="-1"></a>new <span class="ot">&lt;-</span> myCSCsample[myCSCsample<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;new&quot;</span>, ]</span>
<span id="cb40-21"><a href="tutorial.html#cb40-21" tabindex="-1"></a></span>
<span id="cb40-22"><a href="tutorial.html#cb40-22" tabindex="-1"></a><span class="co"># Get PSU IDs</span></span>
<span id="cb40-23"><a href="tutorial.html#cb40-23" tabindex="-1"></a>PSUs <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_intersection</span>(psu_grid_filtered, new) <span class="sc">%&gt;%</span> </span>
<span id="cb40-24"><a href="tutorial.html#cb40-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(ID)</span>
<span id="cb40-25"><a href="tutorial.html#cb40-25" tabindex="-1"></a></span>
<span id="cb40-26"><a href="tutorial.html#cb40-26" tabindex="-1"></a><span class="co"># Extract target PSUs</span></span>
<span id="cb40-27"><a href="tutorial.html#cb40-27" tabindex="-1"></a>target.PSUs <span class="ot">&lt;-</span> psu_grid_filtered[psu_grid_filtered<span class="sc">$</span>ID <span class="sc">%in%</span> PSUs<span class="sc">$</span>ID, ] <span class="sc">%&gt;%</span> </span>
<span id="cb40-28"><a href="tutorial.html#cb40-28" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(ID)</span>
<span id="cb40-29"><a href="tutorial.html#cb40-29" tabindex="-1"></a></span>
<span id="cb40-30"><a href="tutorial.html#cb40-30" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">‚úì Selected %d target PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(target.PSUs)))</span>
<span id="cb40-31"><a href="tutorial.html#cb40-31" tabindex="-1"></a></span>
<span id="cb40-32"><a href="tutorial.html#cb40-32" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb40-33"><a href="tutorial.html#cb40-33" tabindex="-1"></a><span class="fu">rm</span>(new, dmin, MSSSD)</span></code></pre></div>
</div>
<div id="visualize-in-covariate-space" class="section level3 hasAnchor" number="6.12.5">
<h3><span class="header-section-number">6.12.5</span> Visualize in Covariate Space<a href="tutorial.html#visualize-in-covariate-space" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
</div>
<div id="compute-ssu-tsu" class="section level2 hasAnchor" number="6.13">
<h2><span class="header-section-number">6.13</span> Compute SSUs and TSUs<a href="tutorial.html#compute-ssu-tsu" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now we generate Secondary Sampling Units (100m √ó 100m) within each PSU and Tertiary Sampling Units (20m √ó 20m points) within each SSU.</p>
<div id="load-high-resolution-covariates" class="section level3 hasAnchor" number="6.13.1">
<h3><span class="header-section-number">6.13.1</span> Load High-Resolution Covariates<a href="tutorial.html#load-high-resolution-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="tutorial.html#cb41-1" tabindex="-1"></a><span class="co"># Load SSU-level covariates (100m resolution)</span></span>
<span id="cb41-2"><a href="tutorial.html#cb41-2" tabindex="-1"></a>cov.dat.ssu <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">paste0</span>(raster.path, </span>
<span id="cb41-3"><a href="tutorial.html#cb41-3" tabindex="-1"></a>                                   <span class="st">&quot;hres_data/covs_stack_ssu_1ha_ZMB.tif&quot;</span>))</span>
<span id="cb41-4"><a href="tutorial.html#cb41-4" tabindex="-1"></a></span>
<span id="cb41-5"><a href="tutorial.html#cb41-5" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Loaded %d high-resolution covariates</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat.ssu)))</span>
<span id="cb41-6"><a href="tutorial.html#cb41-6" tabindex="-1"></a></span>
<span id="cb41-7"><a href="tutorial.html#cb41-7" tabindex="-1"></a><span class="co"># Display covariate names</span></span>
<span id="cb41-8"><a href="tutorial.html#cb41-8" tabindex="-1"></a><span class="fu">names</span>(cov.dat.ssu)</span>
<span id="cb41-9"><a href="tutorial.html#cb41-9" tabindex="-1"></a></span>
<span id="cb41-10"><a href="tutorial.html#cb41-10" tabindex="-1"></a><span class="co"># Remove system-specific bands if needed</span></span>
<span id="cb41-11"><a href="tutorial.html#cb41-11" tabindex="-1"></a>cov.dat.ssu <span class="ot">&lt;-</span> <span class="fu">subset</span>(cov.dat.ssu, </span>
<span id="cb41-12"><a href="tutorial.html#cb41-12" tabindex="-1"></a>                      <span class="fu">names</span>(cov.dat.ssu)[<span class="sc">!</span><span class="fu">names</span>(cov.dat.ssu) <span class="sc">%in%</span> </span>
<span id="cb41-13"><a href="tutorial.html#cb41-13" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="st">&quot;sysisen_B2&quot;</span>, <span class="st">&quot;sysisen_B3&quot;</span>, <span class="st">&quot;sysisen_B4&quot;</span>, <span class="st">&quot;sysisen_B5&quot;</span>,</span>
<span id="cb41-14"><a href="tutorial.html#cb41-14" tabindex="-1"></a>                          <span class="st">&quot;sysisen_B6&quot;</span>, <span class="st">&quot;sysisen_B7&quot;</span>, <span class="st">&quot;sysisen_B8&quot;</span>, <span class="st">&quot;sysisen_B8A&quot;</span>,</span>
<span id="cb41-15"><a href="tutorial.html#cb41-15" tabindex="-1"></a>                          <span class="st">&quot;sysisen_B11&quot;</span>, <span class="st">&quot;sysisen_B12&quot;</span>)])</span>
<span id="cb41-16"><a href="tutorial.html#cb41-16" tabindex="-1"></a></span>
<span id="cb41-17"><a href="tutorial.html#cb41-17" tabindex="-1"></a><span class="co"># Replace NA with 0 (for categorical variables)</span></span>
<span id="cb41-18"><a href="tutorial.html#cb41-18" tabindex="-1"></a>cov.dat.ssu[<span class="fu">is.na</span>(cov.dat.ssu)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb41-19"><a href="tutorial.html#cb41-19" tabindex="-1"></a></span>
<span id="cb41-20"><a href="tutorial.html#cb41-20" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Final SSU covariates: %d layers</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat.ssu)))</span></code></pre></div>
</div>
<div id="process-each-psu" class="section level3 hasAnchor" number="6.13.2">
<h3><span class="header-section-number">6.13.2</span> Process Each PSU<a href="tutorial.html#process-each-psu" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="tutorial.html#cb42-1" tabindex="-1"></a><span class="co"># Initialize storage lists</span></span>
<span id="cb42-2"><a href="tutorial.html#cb42-2" tabindex="-1"></a>selected_ssus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb42-3"><a href="tutorial.html#cb42-3" tabindex="-1"></a>all_psus_tsus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb42-4"><a href="tutorial.html#cb42-4" tabindex="-1"></a></span>
<span id="cb42-5"><a href="tutorial.html#cb42-5" tabindex="-1"></a><span class="co"># Main loop: Process each PSU</span></span>
<span id="cb42-6"><a href="tutorial.html#cb42-6" tabindex="-1"></a><span class="cf">for</span> (psu_id <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(target.PSUs)) {</span>
<span id="cb42-7"><a href="tutorial.html#cb42-7" tabindex="-1"></a>  </span>
<span id="cb42-8"><a href="tutorial.html#cb42-8" tabindex="-1"></a>  selected_psu <span class="ot">&lt;-</span> target.PSUs[psu_id, ]</span>
<span id="cb42-9"><a href="tutorial.html#cb42-9" tabindex="-1"></a>  </span>
<span id="cb42-10"><a href="tutorial.html#cb42-10" tabindex="-1"></a>  <span class="co"># Generate 100m √ó 100m SSU grid</span></span>
<span id="cb42-11"><a href="tutorial.html#cb42-11" tabindex="-1"></a>  ssu_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(selected_psu, </span>
<span id="cb42-12"><a href="tutorial.html#cb42-12" tabindex="-1"></a>                           <span class="at">cellsize =</span> <span class="fu">c</span>(ssu_size, ssu_size), </span>
<span id="cb42-13"><a href="tutorial.html#cb42-13" tabindex="-1"></a>                           <span class="at">square =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-14"><a href="tutorial.html#cb42-14" tabindex="-1"></a>  ssu_grid_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> ssu_grid)</span>
<span id="cb42-15"><a href="tutorial.html#cb42-15" tabindex="-1"></a>  </span>
<span id="cb42-16"><a href="tutorial.html#cb42-16" tabindex="-1"></a>  <span class="co"># Convert to SpatVector for extraction</span></span>
<span id="cb42-17"><a href="tutorial.html#cb42-17" tabindex="-1"></a>  ssu_grid_vect <span class="ot">&lt;-</span> <span class="fu">vect</span>(ssu_grid_sf)</span>
<span id="cb42-18"><a href="tutorial.html#cb42-18" tabindex="-1"></a>  </span>
<span id="cb42-19"><a href="tutorial.html#cb42-19" tabindex="-1"></a>  <span class="co"># Extract land-use values to filter SSUs</span></span>
<span id="cb42-20"><a href="tutorial.html#cb42-20" tabindex="-1"></a>  extracted_values <span class="ot">&lt;-</span> <span class="fu">extract</span>(crops, ssu_grid_vect, <span class="at">fun =</span> table)</span>
<span id="cb42-21"><a href="tutorial.html#cb42-21" tabindex="-1"></a>  </span>
<span id="cb42-22"><a href="tutorial.html#cb42-22" tabindex="-1"></a>  <span class="co"># Calculate land-use percentage (25 pixels per SSU at 20m resolution)</span></span>
<span id="cb42-23"><a href="tutorial.html#cb42-23" tabindex="-1"></a>  ssu_grid_sf<span class="sc">$</span>lu <span class="ot">&lt;-</span> (extracted_values[, <span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">/</span> <span class="dv">25</span></span>
<span id="cb42-24"><a href="tutorial.html#cb42-24" tabindex="-1"></a>  ssu_grid_sf <span class="ot">&lt;-</span> ssu_grid_sf[ssu_grid_sf<span class="sc">$</span>lu <span class="sc">&gt;</span> percent_crop, ]</span>
<span id="cb42-25"><a href="tutorial.html#cb42-25" tabindex="-1"></a>  </span>
<span id="cb42-26"><a href="tutorial.html#cb42-26" tabindex="-1"></a>  <span class="co"># Progress update</span></span>
<span id="cb42-27"><a href="tutorial.html#cb42-27" tabindex="-1"></a>  <span class="cf">if</span> (psu_id <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> psu_id <span class="sc">==</span> <span class="fu">nrow</span>(target.PSUs)) {</span>
<span id="cb42-28"><a href="tutorial.html#cb42-28" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">Progress: %.2f%% (%d out of %d)&quot;</span>, </span>
<span id="cb42-29"><a href="tutorial.html#cb42-29" tabindex="-1"></a>                (psu_id <span class="sc">/</span> <span class="fu">nrow</span>(target.PSUs)) <span class="sc">*</span> <span class="dv">100</span>, </span>
<span id="cb42-30"><a href="tutorial.html#cb42-30" tabindex="-1"></a>                psu_id, <span class="fu">nrow</span>(target.PSUs)))</span>
<span id="cb42-31"><a href="tutorial.html#cb42-31" tabindex="-1"></a>    <span class="fu">flush.console</span>()</span>
<span id="cb42-32"><a href="tutorial.html#cb42-32" tabindex="-1"></a>  }</span>
<span id="cb42-33"><a href="tutorial.html#cb42-33" tabindex="-1"></a>  </span>
<span id="cb42-34"><a href="tutorial.html#cb42-34" tabindex="-1"></a>  <span class="co"># Check minimum SSU requirement</span></span>
<span id="cb42-35"><a href="tutorial.html#cb42-35" tabindex="-1"></a>  total_ssus <span class="ot">&lt;-</span> <span class="fu">nrow</span>(ssu_grid_sf)</span>
<span id="cb42-36"><a href="tutorial.html#cb42-36" tabindex="-1"></a>  <span class="cf">if</span> (total_ssus <span class="sc">&lt;</span> (num_primary_ssus <span class="sc">+</span> num_alternative_ssus)) {</span>
<span id="cb42-37"><a href="tutorial.html#cb42-37" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">&quot;PSU&quot;</span>, psu_id, <span class="st">&quot;does not have enough SSUs. Skipping.&quot;</span>))</span>
<span id="cb42-38"><a href="tutorial.html#cb42-38" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb42-39"><a href="tutorial.html#cb42-39" tabindex="-1"></a>  }</span>
<span id="cb42-40"><a href="tutorial.html#cb42-40" tabindex="-1"></a>  </span>
<span id="cb42-41"><a href="tutorial.html#cb42-41" tabindex="-1"></a>  <span class="co"># Extract covariate values for each SSU</span></span>
<span id="cb42-42"><a href="tutorial.html#cb42-42" tabindex="-1"></a>  ssu_covariates <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(cov.dat.ssu, <span class="fu">vect</span>(ssu_grid_sf), <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-43"><a href="tutorial.html#cb42-43" tabindex="-1"></a>  </span>
<span id="cb42-44"><a href="tutorial.html#cb42-44" tabindex="-1"></a>  <span class="co"># Merge with SSU spatial data</span></span>
<span id="cb42-45"><a href="tutorial.html#cb42-45" tabindex="-1"></a>  ssu_data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ssu_grid_sf, ssu_covariates[, <span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb42-46"><a href="tutorial.html#cb42-46" tabindex="-1"></a>  ssu_data_values <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(ssu_data)</span>
<span id="cb42-47"><a href="tutorial.html#cb42-47" tabindex="-1"></a>  </span>
<span id="cb42-48"><a href="tutorial.html#cb42-48" tabindex="-1"></a>  <span class="co"># Identify columns to exclude from scaling (categorical)</span></span>
<span id="cb42-49"><a href="tutorial.html#cb42-49" tabindex="-1"></a>  exclude <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;^geomorph_|^lu$&quot;</span>, <span class="fu">names</span>(ssu_data_values), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-50"><a href="tutorial.html#cb42-50" tabindex="-1"></a>  </span>
<span id="cb42-51"><a href="tutorial.html#cb42-51" tabindex="-1"></a>  <span class="co"># Separate scalable and non-scalable data</span></span>
<span id="cb42-52"><a href="tutorial.html#cb42-52" tabindex="-1"></a>  to_scale <span class="ot">&lt;-</span> ssu_data_values[, <span class="sc">!</span><span class="fu">names</span>(ssu_data_values) <span class="sc">%in%</span> exclude]</span>
<span id="cb42-53"><a href="tutorial.html#cb42-53" tabindex="-1"></a>  to_keep  <span class="ot">&lt;-</span> ssu_data_values[, <span class="fu">names</span>(ssu_data_values) <span class="sc">%in%</span> exclude, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb42-54"><a href="tutorial.html#cb42-54" tabindex="-1"></a>  </span>
<span id="cb42-55"><a href="tutorial.html#cb42-55" tabindex="-1"></a>  <span class="co"># Remove NA-only columns</span></span>
<span id="cb42-56"><a href="tutorial.html#cb42-56" tabindex="-1"></a>  to_scale <span class="ot">&lt;-</span> to_scale[, <span class="fu">colSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(to_scale)) <span class="sc">&gt;</span> <span class="dv">0</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb42-57"><a href="tutorial.html#cb42-57" tabindex="-1"></a>  </span>
<span id="cb42-58"><a href="tutorial.html#cb42-58" tabindex="-1"></a>  <span class="co"># Identify zero-variance columns</span></span>
<span id="cb42-59"><a href="tutorial.html#cb42-59" tabindex="-1"></a>  zero_variance_cols <span class="ot">&lt;-</span> <span class="fu">sapply</span>(to_scale, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb42-60"><a href="tutorial.html#cb42-60" tabindex="-1"></a>  zero_variance_cols[<span class="fu">is.na</span>(zero_variance_cols)] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb42-61"><a href="tutorial.html#cb42-61" tabindex="-1"></a>  </span>
<span id="cb42-62"><a href="tutorial.html#cb42-62" tabindex="-1"></a>  <span class="co"># Scale only non-zero-variance columns</span></span>
<span id="cb42-63"><a href="tutorial.html#cb42-63" tabindex="-1"></a>  scaled_part <span class="ot">&lt;-</span> to_scale</span>
<span id="cb42-64"><a href="tutorial.html#cb42-64" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>zero_variance_cols)) {</span>
<span id="cb42-65"><a href="tutorial.html#cb42-65" tabindex="-1"></a>    scaled_part[, <span class="sc">!</span>zero_variance_cols] <span class="ot">&lt;-</span> <span class="fu">scale</span>(to_scale[, <span class="sc">!</span>zero_variance_cols])</span>
<span id="cb42-66"><a href="tutorial.html#cb42-66" tabindex="-1"></a>  }</span>
<span id="cb42-67"><a href="tutorial.html#cb42-67" tabindex="-1"></a>  </span>
<span id="cb42-68"><a href="tutorial.html#cb42-68" tabindex="-1"></a>  <span class="co"># Recombine</span></span>
<span id="cb42-69"><a href="tutorial.html#cb42-69" tabindex="-1"></a>  mygrd_ssu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(to_keep, scaled_part)</span>
<span id="cb42-70"><a href="tutorial.html#cb42-70" tabindex="-1"></a>  </span>
<span id="cb42-71"><a href="tutorial.html#cb42-71" tabindex="-1"></a>  <span class="co"># Perform k-means clustering for this PSU</span></span>
<span id="cb42-72"><a href="tutorial.html#cb42-72" tabindex="-1"></a>  optimal_k <span class="ot">&lt;-</span> num_primary_ssus  <span class="co"># 4 clusters</span></span>
<span id="cb42-73"><a href="tutorial.html#cb42-73" tabindex="-1"></a>  kmeans_result <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(mygrd_ssu[, <span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb42-74"><a href="tutorial.html#cb42-74" tabindex="-1"></a>                          <span class="at">centers =</span> optimal_k, </span>
<span id="cb42-75"><a href="tutorial.html#cb42-75" tabindex="-1"></a>                          <span class="at">iter.max =</span> <span class="dv">10000</span>, </span>
<span id="cb42-76"><a href="tutorial.html#cb42-76" tabindex="-1"></a>                          <span class="at">nstart =</span> <span class="dv">10</span>)</span>
<span id="cb42-77"><a href="tutorial.html#cb42-77" tabindex="-1"></a>  </span>
<span id="cb42-78"><a href="tutorial.html#cb42-78" tabindex="-1"></a>  ssu_data<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(kmeans_result<span class="sc">$</span>cluster)</span>
<span id="cb42-79"><a href="tutorial.html#cb42-79" tabindex="-1"></a>  </span>
<span id="cb42-80"><a href="tutorial.html#cb42-80" tabindex="-1"></a>  <span class="co"># CSC Sampling: Select closest SSUs to cluster centers</span></span>
<span id="cb42-81"><a href="tutorial.html#cb42-81" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> kmeans_result<span class="sc">$</span>centers, <span class="at">x2 =</span> mygrd_ssu[, <span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb42-82"><a href="tutorial.html#cb42-82" tabindex="-1"></a>  </span>
<span id="cb42-83"><a href="tutorial.html#cb42-83" tabindex="-1"></a>  <span class="co"># Target SSUs (closest to centers)</span></span>
<span id="cb42-84"><a href="tutorial.html#cb42-84" tabindex="-1"></a>  target_units <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">order</span>(x)[<span class="dv">1</span>])</span>
<span id="cb42-85"><a href="tutorial.html#cb42-85" tabindex="-1"></a>  target_ssus <span class="ot">&lt;-</span> ssu_data[target_units, ]</span>
<span id="cb42-86"><a href="tutorial.html#cb42-86" tabindex="-1"></a>  </span>
<span id="cb42-87"><a href="tutorial.html#cb42-87" tabindex="-1"></a>  <span class="co"># Replacement SSUs (second closest to centers)</span></span>
<span id="cb42-88"><a href="tutorial.html#cb42-88" tabindex="-1"></a>  replacement_units <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">order</span>(x)[<span class="dv">2</span>])</span>
<span id="cb42-89"><a href="tutorial.html#cb42-89" tabindex="-1"></a>  replacement_ssus <span class="ot">&lt;-</span> ssu_data[replacement_units, ]</span>
<span id="cb42-90"><a href="tutorial.html#cb42-90" tabindex="-1"></a>  </span>
<span id="cb42-91"><a href="tutorial.html#cb42-91" tabindex="-1"></a>  <span class="co"># Add metadata</span></span>
<span id="cb42-92"><a href="tutorial.html#cb42-92" tabindex="-1"></a>  target_ssus<span class="sc">$</span>SSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Target&quot;</span></span>
<span id="cb42-93"><a href="tutorial.html#cb42-93" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>SSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Replacement&quot;</span></span>
<span id="cb42-94"><a href="tutorial.html#cb42-94" tabindex="-1"></a>  </span>
<span id="cb42-95"><a href="tutorial.html#cb42-95" tabindex="-1"></a>  target_ssus<span class="sc">$</span>SSU_ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(target_ssus)</span>
<span id="cb42-96"><a href="tutorial.html#cb42-96" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>SSU_ID <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(target_ssus) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">nrow</span>(target_ssus))</span>
<span id="cb42-97"><a href="tutorial.html#cb42-97" tabindex="-1"></a>  </span>
<span id="cb42-98"><a href="tutorial.html#cb42-98" tabindex="-1"></a>  <span class="co"># Link replacements to targets by cluster</span></span>
<span id="cb42-99"><a href="tutorial.html#cb42-99" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>replacement_for <span class="ot">&lt;-</span> <span class="fu">sapply</span>(replacement_ssus<span class="sc">$</span>cluster, <span class="cf">function</span>(cl) {</span>
<span id="cb42-100"><a href="tutorial.html#cb42-100" tabindex="-1"></a>    matched <span class="ot">&lt;-</span> target_ssus<span class="sc">$</span>SSU_ID[target_ssus<span class="sc">$</span>cluster <span class="sc">==</span> cl]</span>
<span id="cb42-101"><a href="tutorial.html#cb42-101" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(matched) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">return</span>(matched[<span class="dv">1</span>]) <span class="cf">else</span> <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb42-102"><a href="tutorial.html#cb42-102" tabindex="-1"></a>  })</span>
<span id="cb42-103"><a href="tutorial.html#cb42-103" tabindex="-1"></a>  target_ssus<span class="sc">$</span>replacement_for <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb42-104"><a href="tutorial.html#cb42-104" tabindex="-1"></a>  </span>
<span id="cb42-105"><a href="tutorial.html#cb42-105" tabindex="-1"></a>  <span class="co"># Add PSU ID</span></span>
<span id="cb42-106"><a href="tutorial.html#cb42-106" tabindex="-1"></a>  target_ssus<span class="sc">$</span>PSU_ID <span class="ot">&lt;-</span> selected_psu<span class="sc">$</span>ID</span>
<span id="cb42-107"><a href="tutorial.html#cb42-107" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>PSU_ID <span class="ot">&lt;-</span> selected_psu<span class="sc">$</span>ID</span>
<span id="cb42-108"><a href="tutorial.html#cb42-108" tabindex="-1"></a>  </span>
<span id="cb42-109"><a href="tutorial.html#cb42-109" tabindex="-1"></a>  <span class="co"># Store SSUs</span></span>
<span id="cb42-110"><a href="tutorial.html#cb42-110" tabindex="-1"></a>  selected_ssus[[psu_id]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(target_ssus, replacement_ssus)</span>
<span id="cb42-111"><a href="tutorial.html#cb42-111" tabindex="-1"></a>  </span>
<span id="cb42-112"><a href="tutorial.html#cb42-112" tabindex="-1"></a>  <span class="co"># Generate TSUs for target SSUs</span></span>
<span id="cb42-113"><a href="tutorial.html#cb42-113" tabindex="-1"></a>  primary_tsus <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rownames</span>(target_ssus), <span class="cf">function</span>(index) {</span>
<span id="cb42-114"><a href="tutorial.html#cb42-114" tabindex="-1"></a>    <span class="fu">generate_tsu_points_within_ssu</span>(</span>
<span id="cb42-115"><a href="tutorial.html#cb42-115" tabindex="-1"></a>      ssu_grid_sf[<span class="fu">rownames</span>(ssu_grid_sf) <span class="sc">==</span> index, ], </span>
<span id="cb42-116"><a href="tutorial.html#cb42-116" tabindex="-1"></a>      number_TSUs, </span>
<span id="cb42-117"><a href="tutorial.html#cb42-117" tabindex="-1"></a>      index, </span>
<span id="cb42-118"><a href="tutorial.html#cb42-118" tabindex="-1"></a>      <span class="st">&quot;Target&quot;</span>, </span>
<span id="cb42-119"><a href="tutorial.html#cb42-119" tabindex="-1"></a>      crops</span>
<span id="cb42-120"><a href="tutorial.html#cb42-120" tabindex="-1"></a>    )</span>
<span id="cb42-121"><a href="tutorial.html#cb42-121" tabindex="-1"></a>  })</span>
<span id="cb42-122"><a href="tutorial.html#cb42-122" tabindex="-1"></a>  </span>
<span id="cb42-123"><a href="tutorial.html#cb42-123" tabindex="-1"></a>  <span class="co"># Generate TSUs for replacement SSUs</span></span>
<span id="cb42-124"><a href="tutorial.html#cb42-124" tabindex="-1"></a>  alternative_tsus <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rownames</span>(replacement_ssus), <span class="cf">function</span>(index) {</span>
<span id="cb42-125"><a href="tutorial.html#cb42-125" tabindex="-1"></a>    <span class="fu">generate_tsu_points_within_ssu</span>(</span>
<span id="cb42-126"><a href="tutorial.html#cb42-126" tabindex="-1"></a>      ssu_grid_sf[<span class="fu">rownames</span>(ssu_grid_sf) <span class="sc">==</span> index, ], </span>
<span id="cb42-127"><a href="tutorial.html#cb42-127" tabindex="-1"></a>      number_TSUs, </span>
<span id="cb42-128"><a href="tutorial.html#cb42-128" tabindex="-1"></a>      index, </span>
<span id="cb42-129"><a href="tutorial.html#cb42-129" tabindex="-1"></a>      <span class="st">&quot;Replacement&quot;</span>, </span>
<span id="cb42-130"><a href="tutorial.html#cb42-130" tabindex="-1"></a>      crops</span>
<span id="cb42-131"><a href="tutorial.html#cb42-131" tabindex="-1"></a>    )</span>
<span id="cb42-132"><a href="tutorial.html#cb42-132" tabindex="-1"></a>  })</span>
<span id="cb42-133"><a href="tutorial.html#cb42-133" tabindex="-1"></a>  </span>
<span id="cb42-134"><a href="tutorial.html#cb42-134" tabindex="-1"></a>  <span class="co"># Combine all TSUs for this PSU</span></span>
<span id="cb42-135"><a href="tutorial.html#cb42-135" tabindex="-1"></a>  all_psus_tsus[[psu_id]] <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">c</span>(primary_tsus, alternative_tsus))</span>
<span id="cb42-136"><a href="tutorial.html#cb42-136" tabindex="-1"></a>}</span>
<span id="cb42-137"><a href="tutorial.html#cb42-137" tabindex="-1"></a></span>
<span id="cb42-138"><a href="tutorial.html#cb42-138" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">‚úì Processing complete</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb42-139"><a href="tutorial.html#cb42-139" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  Successful PSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">length</span>(selected_ssus)))</span></code></pre></div>
</div>
<div id="combine-ssus-and-tsus" class="section level3 hasAnchor" number="6.13.3">
<h3><span class="header-section-number">6.13.3</span> Combine SSUs and TSUs<a href="tutorial.html#combine-ssus-and-tsus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="tutorial.html#cb43-1" tabindex="-1"></a><span class="co"># Combine all SSUs</span></span>
<span id="cb43-2"><a href="tutorial.html#cb43-2" tabindex="-1"></a>all_ssus <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, selected_ssus)</span>
<span id="cb43-3"><a href="tutorial.html#cb43-3" tabindex="-1"></a>all_ssus <span class="ot">&lt;-</span> all_ssus <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="tutorial.html#cb43-4" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(PSU_ID, SSU_ID), as.numeric)</span>
<span id="cb43-5"><a href="tutorial.html#cb43-5" tabindex="-1"></a></span>
<span id="cb43-6"><a href="tutorial.html#cb43-6" tabindex="-1"></a><span class="co"># Combine all TSUs</span></span>
<span id="cb43-7"><a href="tutorial.html#cb43-7" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, all_psus_tsus)</span>
<span id="cb43-8"><a href="tutorial.html#cb43-8" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb43-9"><a href="tutorial.html#cb43-9" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(PSU_ID, SSU_ID), as.numeric)</span>
<span id="cb43-10"><a href="tutorial.html#cb43-10" tabindex="-1"></a></span>
<span id="cb43-11"><a href="tutorial.html#cb43-11" tabindex="-1"></a><span class="co"># Join TSU and SSU metadata</span></span>
<span id="cb43-12"><a href="tutorial.html#cb43-12" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> <span class="fu">st_join</span>(all_tsus, </span>
<span id="cb43-13"><a href="tutorial.html#cb43-13" tabindex="-1"></a>                    all_ssus[<span class="fu">c</span>(<span class="st">&quot;PSU_ID&quot;</span>, <span class="st">&quot;SSU_ID&quot;</span>, <span class="st">&quot;SSU_Type&quot;</span>, <span class="st">&quot;replacement_for&quot;</span>)])</span>
<span id="cb43-14"><a href="tutorial.html#cb43-14" tabindex="-1"></a></span>
<span id="cb43-15"><a href="tutorial.html#cb43-15" tabindex="-1"></a><span class="co"># Reorganize columns</span></span>
<span id="cb43-16"><a href="tutorial.html#cb43-16" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb43-17"><a href="tutorial.html#cb43-17" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PSU_ID =</span> PSU_ID.x, </span>
<span id="cb43-18"><a href="tutorial.html#cb43-18" tabindex="-1"></a>         <span class="at">SSU_ID =</span> SSU_ID.y, </span>
<span id="cb43-19"><a href="tutorial.html#cb43-19" tabindex="-1"></a>         <span class="at">SSU_Type =</span> SSU_Type.y,</span>
<span id="cb43-20"><a href="tutorial.html#cb43-20" tabindex="-1"></a>         <span class="at">Replacement_for =</span> replacement_for, </span>
<span id="cb43-21"><a href="tutorial.html#cb43-21" tabindex="-1"></a>         TSU_ID, </span>
<span id="cb43-22"><a href="tutorial.html#cb43-22" tabindex="-1"></a>         geometry)</span>
<span id="cb43-23"><a href="tutorial.html#cb43-23" tabindex="-1"></a></span>
<span id="cb43-24"><a href="tutorial.html#cb43-24" tabindex="-1"></a><span class="co"># Label TSU types</span></span>
<span id="cb43-25"><a href="tutorial.html#cb43-25" tabindex="-1"></a>all_tsus<span class="sc">$</span>TSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Target&quot;</span></span>
<span id="cb43-26"><a href="tutorial.html#cb43-26" tabindex="-1"></a>all_tsus[all_tsus<span class="sc">$</span>TSU_ID <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="st">&quot;TSU_Type&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Alternative&quot;</span></span>
<span id="cb43-27"><a href="tutorial.html#cb43-27" tabindex="-1"></a>all_tsus<span class="sc">$</span>PSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Target&quot;</span></span>
<span id="cb43-28"><a href="tutorial.html#cb43-28" tabindex="-1"></a></span>
<span id="cb43-29"><a href="tutorial.html#cb43-29" tabindex="-1"></a><span class="co"># Final column selection</span></span>
<span id="cb43-30"><a href="tutorial.html#cb43-30" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb43-31"><a href="tutorial.html#cb43-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">&quot;PSU_ID&quot;</span>, <span class="st">&quot;SSU_ID&quot;</span>, <span class="st">&quot;SSU_Type&quot;</span>, <span class="st">&quot;Replacement_for&quot;</span>, </span>
<span id="cb43-32"><a href="tutorial.html#cb43-32" tabindex="-1"></a>                <span class="st">&quot;TSU_ID&quot;</span>, <span class="st">&quot;TSU_Type&quot;</span>, <span class="st">&quot;geometry&quot;</span>)</span>
<span id="cb43-33"><a href="tutorial.html#cb43-33" tabindex="-1"></a></span>
<span id="cb43-34"><a href="tutorial.html#cb43-34" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">‚úì Total SSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(all_ssus)))</span>
<span id="cb43-35"><a href="tutorial.html#cb43-35" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;‚úì Total TSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(all_tsus)))</span>
<span id="cb43-36"><a href="tutorial.html#cb43-36" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;‚úì Target sampling sites: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb43-37"><a href="tutorial.html#cb43-37" tabindex="-1"></a>            <span class="fu">sum</span>(all_tsus<span class="sc">$</span>SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> all_tsus<span class="sc">$</span>TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)))</span></code></pre></div>
</div>
</div>
<div id="export-units" class="section level2 hasAnchor" number="6.14">
<h2><span class="header-section-number">6.14</span> Export Sampling Units<a href="tutorial.html#export-units" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="create-cluster-raster" class="section level3 hasAnchor" number="6.14.1">
<h3><span class="header-section-number">6.14.1</span> Create Cluster Raster<a href="tutorial.html#create-cluster-raster" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="tutorial.html#cb44-1" tabindex="-1"></a><span class="co"># Convert cluster information to raster</span></span>
<span id="cb44-2"><a href="tutorial.html#cb44-2" tabindex="-1"></a>dfr <span class="ot">&lt;-</span> PSU.df[, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;cluster&quot;</span>)]</span>
<span id="cb44-3"><a href="tutorial.html#cb44-3" tabindex="-1"></a>dfr<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(dfr<span class="sc">$</span>cluster)</span>
<span id="cb44-4"><a href="tutorial.html#cb44-4" tabindex="-1"></a>dfr <span class="ot">&lt;-</span> <span class="fu">rasterFromXYZ</span>(dfr)</span>
<span id="cb44-5"><a href="tutorial.html#cb44-5" tabindex="-1"></a><span class="fu">crs</span>(dfr) <span class="ot">&lt;-</span> epsg</span>
<span id="cb44-6"><a href="tutorial.html#cb44-6" tabindex="-1"></a></span>
<span id="cb44-7"><a href="tutorial.html#cb44-7" tabindex="-1"></a><span class="co"># Associate clusters with PSUs</span></span>
<span id="cb44-8"><a href="tutorial.html#cb44-8" tabindex="-1"></a>PSU_cluster.id <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">extract</span>(dfr, target.PSUs))</span>
<span id="cb44-9"><a href="tutorial.html#cb44-9" tabindex="-1"></a></span>
<span id="cb44-10"><a href="tutorial.html#cb44-10" tabindex="-1"></a>valid.PSU_clusters <span class="ot">&lt;-</span> target.PSUs <span class="sc">%&gt;%</span> </span>
<span id="cb44-11"><a href="tutorial.html#cb44-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">extract</span>(dfr, target.PSUs, <span class="at">fun =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb44-12"><a href="tutorial.html#cb44-12" tabindex="-1"></a></span>
<span id="cb44-13"><a href="tutorial.html#cb44-13" tabindex="-1"></a>all.PSU_clusters <span class="ot">&lt;-</span> psu_grid_filtered <span class="sc">%&gt;%</span> </span>
<span id="cb44-14"><a href="tutorial.html#cb44-14" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">extract</span>(dfr, psu_grid_filtered, <span class="at">fun =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb44-15"><a href="tutorial.html#cb44-15" tabindex="-1"></a></span>
<span id="cb44-16"><a href="tutorial.html#cb44-16" tabindex="-1"></a>all.PSU_clusters <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(all.PSU_clusters)</span></code></pre></div>
</div>
<div id="join-cluster-info-to-tsus" class="section level3 hasAnchor" number="6.14.2">
<h3><span class="header-section-number">6.14.2</span> Join Cluster Info to TSUs<a href="tutorial.html#join-cluster-info-to-tsus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="tutorial.html#cb45-1" tabindex="-1"></a><span class="co"># Rename cluster column</span></span>
<span id="cb45-2"><a href="tutorial.html#cb45-2" tabindex="-1"></a>valid.PSU_clusters <span class="ot">&lt;-</span> valid.PSU_clusters <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="tutorial.html#cb45-3" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Replace_ID =</span> cluster)</span>
<span id="cb45-4"><a href="tutorial.html#cb45-4" tabindex="-1"></a></span>
<span id="cb45-5"><a href="tutorial.html#cb45-5" tabindex="-1"></a><span class="co"># Join to TSUs</span></span>
<span id="cb45-6"><a href="tutorial.html#cb45-6" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> <span class="fu">st_join</span>(all_tsus, valid.PSU_clusters)</span>
<span id="cb45-7"><a href="tutorial.html#cb45-7" tabindex="-1"></a></span>
<span id="cb45-8"><a href="tutorial.html#cb45-8" tabindex="-1"></a><span class="co"># Assign sampling order</span></span>
<span id="cb45-9"><a href="tutorial.html#cb45-9" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb45-10"><a href="tutorial.html#cb45-10" tabindex="-1"></a>  <span class="fu">group_by</span>(PSU_ID) <span class="sc">%&gt;%</span></span>
<span id="cb45-11"><a href="tutorial.html#cb45-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">order =</span> <span class="fu">match</span>(SSU_ID, <span class="fu">unique</span>(SSU_ID))) <span class="sc">%&gt;%</span></span>
<span id="cb45-12"><a href="tutorial.html#cb45-12" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
</div>
<div id="create-site-ids" class="section level3 hasAnchor" number="6.14.3">
<h3><span class="header-section-number">6.14.3</span> Create Site IDs<a href="tutorial.html#create-site-ids" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="tutorial.html#cb46-1" tabindex="-1"></a><span class="co"># Generate unique site IDs</span></span>
<span id="cb46-2"><a href="tutorial.html#cb46-2" tabindex="-1"></a>all_tsus<span class="sc">$</span>site_id <span class="ot">&lt;-</span> <span class="fu">paste0</span>(ISO.code, </span>
<span id="cb46-3"><a href="tutorial.html#cb46-3" tabindex="-1"></a>                           <span class="fu">sprintf</span>(<span class="st">&quot;%04d&quot;</span>, all_tsus<span class="sc">$</span>PSU_ID), </span>
<span id="cb46-4"><a href="tutorial.html#cb46-4" tabindex="-1"></a>                           <span class="st">&quot;-&quot;</span>, all_tsus<span class="sc">$</span>SSU_ID, </span>
<span id="cb46-5"><a href="tutorial.html#cb46-5" tabindex="-1"></a>                           <span class="st">&quot;-&quot;</span>, all_tsus<span class="sc">$</span>TSU_ID, </span>
<span id="cb46-6"><a href="tutorial.html#cb46-6" tabindex="-1"></a>                           <span class="st">&quot;C&quot;</span>)  <span class="co"># C = Cropland</span></span>
<span id="cb46-7"><a href="tutorial.html#cb46-7" tabindex="-1"></a></span>
<span id="cb46-8"><a href="tutorial.html#cb46-8" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Created %d unique site IDs</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(all_tsus)))</span></code></pre></div>
</div>
<div id="export-shapefiles" class="section level3 hasAnchor" number="6.14.4">
<h3><span class="header-section-number">6.14.4</span> Export Shapefiles<a href="tutorial.html#export-shapefiles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="tutorial.html#cb47-1" tabindex="-1"></a><span class="co"># Export target PSUs</span></span>
<span id="cb47-2"><a href="tutorial.html#cb47-2" tabindex="-1"></a><span class="fu">write_sf</span>(valid.PSU_clusters, </span>
<span id="cb47-3"><a href="tutorial.html#cb47-3" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/PSUs_target.shp&quot;</span>), </span>
<span id="cb47-4"><a href="tutorial.html#cb47-4" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-5"><a href="tutorial.html#cb47-5" tabindex="-1"></a></span>
<span id="cb47-6"><a href="tutorial.html#cb47-6" tabindex="-1"></a><span class="co"># Export target TSUs</span></span>
<span id="cb47-7"><a href="tutorial.html#cb47-7" tabindex="-1"></a><span class="fu">write_sf</span>(all_tsus, </span>
<span id="cb47-8"><a href="tutorial.html#cb47-8" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/TSUs_target.shp&quot;</span>), </span>
<span id="cb47-9"><a href="tutorial.html#cb47-9" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-10"><a href="tutorial.html#cb47-10" tabindex="-1"></a></span>
<span id="cb47-11"><a href="tutorial.html#cb47-11" tabindex="-1"></a><span class="co"># Export all PSU clusters</span></span>
<span id="cb47-12"><a href="tutorial.html#cb47-12" tabindex="-1"></a><span class="fu">write_sf</span>(all.PSU_clusters, </span>
<span id="cb47-13"><a href="tutorial.html#cb47-13" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/PSU_pattern_cl.shp&quot;</span>), </span>
<span id="cb47-14"><a href="tutorial.html#cb47-14" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-15"><a href="tutorial.html#cb47-15" tabindex="-1"></a></span>
<span id="cb47-16"><a href="tutorial.html#cb47-16" tabindex="-1"></a><span class="co"># Export cluster raster</span></span>
<span id="cb47-17"><a href="tutorial.html#cb47-17" tabindex="-1"></a><span class="fu">writeRaster</span>(dfr, </span>
<span id="cb47-18"><a href="tutorial.html#cb47-18" tabindex="-1"></a>            <span class="fu">paste0</span>(results.path, <span class="st">&quot;/clusters.tif&quot;</span>), </span>
<span id="cb47-19"><a href="tutorial.html#cb47-19" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-20"><a href="tutorial.html#cb47-20" tabindex="-1"></a></span>
<span id="cb47-21"><a href="tutorial.html#cb47-21" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">‚úì All files exported successfully</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb47-22"><a href="tutorial.html#cb47-22" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  Location: %s</span><span class="sc">\n</span><span class="st">&quot;</span>, results.path))</span></code></pre></div>
</div>
</div>
<div id="alternative-psus" class="section level2 hasAnchor" number="6.15">
<h2><span class="header-section-number">6.15</span> Compute Alternative PSUs<a href="tutorial.html#alternative-psus" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Generate replacement PSUs from the same environmental clusters as targets.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="tutorial.html#cb48-1" tabindex="-1"></a><span class="co"># Filter out already selected PSUs</span></span>
<span id="cb48-2"><a href="tutorial.html#cb48-2" tabindex="-1"></a>remaining_psus <span class="ot">&lt;-</span> all.PSU_clusters <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="tutorial.html#cb48-3" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(ID <span class="sc">%in%</span> target.PSUs<span class="sc">$</span>ID))</span>
<span id="cb48-4"><a href="tutorial.html#cb48-4" tabindex="-1"></a></span>
<span id="cb48-5"><a href="tutorial.html#cb48-5" tabindex="-1"></a><span class="co"># Get unique cluster IDs from targets</span></span>
<span id="cb48-6"><a href="tutorial.html#cb48-6" tabindex="-1"></a>unique_clusters <span class="ot">&lt;-</span> <span class="fu">unique</span>(valid.PSU_clusters<span class="sc">$</span>Replace_ID)</span>
<span id="cb48-7"><a href="tutorial.html#cb48-7" tabindex="-1"></a></span>
<span id="cb48-8"><a href="tutorial.html#cb48-8" tabindex="-1"></a><span class="co"># Initialize list for replacements</span></span>
<span id="cb48-9"><a href="tutorial.html#cb48-9" tabindex="-1"></a>replacement_psus <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb48-10"><a href="tutorial.html#cb48-10" tabindex="-1"></a></span>
<span id="cb48-11"><a href="tutorial.html#cb48-11" tabindex="-1"></a><span class="co"># For each target cluster, select a replacement</span></span>
<span id="cb48-12"><a href="tutorial.html#cb48-12" tabindex="-1"></a><span class="cf">for</span> (clust_id <span class="cf">in</span> unique_clusters) {</span>
<span id="cb48-13"><a href="tutorial.html#cb48-13" tabindex="-1"></a>  <span class="co"># Find candidates in same cluster</span></span>
<span id="cb48-14"><a href="tutorial.html#cb48-14" tabindex="-1"></a>  candidates <span class="ot">&lt;-</span> remaining_psus <span class="sc">%&gt;%</span> </span>
<span id="cb48-15"><a href="tutorial.html#cb48-15" tabindex="-1"></a>    <span class="fu">filter</span>(cluster <span class="sc">==</span> clust_id)</span>
<span id="cb48-16"><a href="tutorial.html#cb48-16" tabindex="-1"></a>  </span>
<span id="cb48-17"><a href="tutorial.html#cb48-17" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(candidates) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb48-18"><a href="tutorial.html#cb48-18" tabindex="-1"></a>    <span class="co"># Random selection from candidates</span></span>
<span id="cb48-19"><a href="tutorial.html#cb48-19" tabindex="-1"></a>    replacement <span class="ot">&lt;-</span> candidates[<span class="fu">sample</span>(<span class="fu">nrow</span>(candidates), <span class="dv">1</span>), ]</span>
<span id="cb48-20"><a href="tutorial.html#cb48-20" tabindex="-1"></a>    replacement<span class="sc">$</span>replaces_PSU <span class="ot">&lt;-</span> valid.PSU_clusters<span class="sc">$</span>ID[</span>
<span id="cb48-21"><a href="tutorial.html#cb48-21" tabindex="-1"></a>      valid.PSU_clusters<span class="sc">$</span>Replace_ID <span class="sc">==</span> clust_id</span>
<span id="cb48-22"><a href="tutorial.html#cb48-22" tabindex="-1"></a>    ][<span class="dv">1</span>]</span>
<span id="cb48-23"><a href="tutorial.html#cb48-23" tabindex="-1"></a>    </span>
<span id="cb48-24"><a href="tutorial.html#cb48-24" tabindex="-1"></a>    replacement_psus <span class="ot">&lt;-</span> <span class="fu">rbind</span>(replacement_psus, replacement)</span>
<span id="cb48-25"><a href="tutorial.html#cb48-25" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb48-26"><a href="tutorial.html#cb48-26" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">sprintf</span>(<span class="st">&quot;No replacement found for cluster %d&quot;</span>, clust_id))</span>
<span id="cb48-27"><a href="tutorial.html#cb48-27" tabindex="-1"></a>  }</span>
<span id="cb48-28"><a href="tutorial.html#cb48-28" tabindex="-1"></a>}</span>
<span id="cb48-29"><a href="tutorial.html#cb48-29" tabindex="-1"></a></span>
<span id="cb48-30"><a href="tutorial.html#cb48-30" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">‚úì Generated %d replacement PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(replacement_psus)))</span>
<span id="cb48-31"><a href="tutorial.html#cb48-31" tabindex="-1"></a></span>
<span id="cb48-32"><a href="tutorial.html#cb48-32" tabindex="-1"></a><span class="co"># Export replacement PSUs</span></span>
<span id="cb48-33"><a href="tutorial.html#cb48-33" tabindex="-1"></a><span class="fu">write_sf</span>(replacement_psus, </span>
<span id="cb48-34"><a href="tutorial.html#cb48-34" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/PSUs_replacements.shp&quot;</span>), </span>
<span id="cb48-35"><a href="tutorial.html#cb48-35" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<blockquote>
<p><strong>Note</strong>: Follow the same SSU and TSU generation process for replacement PSUs to create complete backup sampling locations.</p>
</blockquote>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="soilfer-design.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="merging-results.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["GSNmap_Technical_Manual.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"fig_caption": true
});
});
</script>

</body>

</html>
