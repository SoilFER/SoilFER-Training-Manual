<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Sampling design for soil surveys | DRAFT - Integrated soil information for decision-making </title>
  <meta name="description" content="SoilFER SID Technical Manual" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Sampling design for soil surveys | DRAFT - Integrated soil information for decision-making " />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="SoilFER SID Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Sampling design for soil surveys | DRAFT - Integrated soil information for decision-making " />
  
  <meta name="twitter:description" content="SoilFER SID Technical Manual" />
  

<meta name="author" content="Angelini, M.E., Rodriguez Lado, L., Mendes, W. S., Ribeiro, E., Luotto, I." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatial-analysis-in-r.html"/>
<link rel="next" href="appendices.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors-and-reviewers.html"><a href="contributors-and-reviewers.html"><i class="fa fa-check"></i>Contributors and reviewers</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html"><i class="fa fa-check"></i>Presentation and basics</a>
<ul>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#background-and-objective"><i class="fa fa-check"></i>Background and Objective</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#what-this-tutorial-is-not"><i class="fa fa-check"></i>What this Tutorial is not</a></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#the-training-dataset"><i class="fa fa-check"></i>The Training Dataset</a>
<ul>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#data-structure"><i class="fa fa-check"></i>Data Structure</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#how-to-use-this-manual"><i class="fa fa-check"></i>How to Use This Manual</a>
<ul>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#manual-structure"><i class="fa fa-check"></i>Manual Structure</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#required-downloads"><i class="fa fa-check"></i>Required downloads</a>
<ul>
<li class="chapter" data-level="" data-path="presentation-and-basics.html"><a href="presentation-and-basics.html#step-by-step-setup-instructions"><i class="fa fa-check"></i>Step-by-step setup instructions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html"><i class="fa fa-check"></i>Introduction to R programming</a>
<ul>
<li class="chapter" data-level="0.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#what-is-r"><i class="fa fa-check"></i><b>0.1</b> What is R?</a>
<ul>
<li class="chapter" data-level="0.1.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#why-r-for-soil-science"><i class="fa fa-check"></i><b>0.1.1</b> Why R for Soil Science?</a></li>
</ul></li>
<li class="chapter" data-level="0.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-r-and-rstudio"><i class="fa fa-check"></i><b>0.2</b> Installing R and RStudio</a>
<ul>
<li class="chapter" data-level="0.2.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-r"><i class="fa fa-check"></i><b>0.2.1</b> Installing R</a></li>
<li class="chapter" data-level="0.2.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-rstudio"><i class="fa fa-check"></i><b>0.2.2</b> Installing RStudio</a></li>
<li class="chapter" data-level="0.2.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#verifying-installation"><i class="fa fa-check"></i><b>0.2.3</b> Verifying Installation</a></li>
</ul></li>
<li class="chapter" data-level="0.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#understanding-the-rstudio-interface"><i class="fa fa-check"></i><b>0.3</b> Understanding the RStudio Interface</a>
<ul>
<li class="chapter" data-level="0.3.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#console-pane-bottom-left"><i class="fa fa-check"></i><b>0.3.1</b> 1. Console Pane (Bottom Left)</a></li>
<li class="chapter" data-level="0.3.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#code-editor-pane-top-left"><i class="fa fa-check"></i><b>0.3.2</b> 2. Code Editor Pane (Top Left)</a></li>
<li class="chapter" data-level="0.3.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#environmenthistory-pane-top-right"><i class="fa fa-check"></i><b>0.3.3</b> 3. Environment/History Pane (Top Right)</a></li>
<li class="chapter" data-level="0.3.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#filesplotspackageshelp-pane-bottom-right"><i class="fa fa-check"></i><b>0.3.4</b> 4. Files/Plots/Packages/Help Pane (Bottom Right)</a></li>
</ul></li>
<li class="chapter" data-level="0.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#r-packages-extending-rs-capabilities"><i class="fa fa-check"></i><b>0.4</b> R Packages: Extending Râ€™s Capabilities</a>
<ul>
<li class="chapter" data-level="0.4.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#what-are-packages"><i class="fa fa-check"></i><b>0.4.1</b> What are Packages?</a></li>
<li class="chapter" data-level="0.4.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#installing-packages"><i class="fa fa-check"></i><b>0.4.2</b> Installing Packages</a></li>
<li class="chapter" data-level="0.4.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#loading-packages"><i class="fa fa-check"></i><b>0.4.3</b> Loading Packages</a></li>
<li class="chapter" data-level="0.4.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#finding-help-on-packages"><i class="fa fa-check"></i><b>0.4.4</b> Finding Help on Packages</a></li>
</ul></li>
<li class="chapter" data-level="0.5" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#object-types"><i class="fa fa-check"></i><b>0.5</b> R Basics: Objects and Data Types</a>
<ul>
<li class="chapter" data-level="0.5.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#object-assignment"><i class="fa fa-check"></i><b>0.5.1</b> Creating Objects with Assignment</a></li>
<li class="chapter" data-level="0.5.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#data-types"><i class="fa fa-check"></i><b>0.5.2</b> Data Types in R</a></li>
<li class="chapter" data-level="0.5.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#check-data"><i class="fa fa-check"></i><b>0.5.3</b> Checking Data Types</a></li>
</ul></li>
<li class="chapter" data-level="0.6" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#structure-data"><i class="fa fa-check"></i><b>0.6</b> Data Structures in R</a>
<ul>
<li class="chapter" data-level="0.6.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#vector-data"><i class="fa fa-check"></i><b>0.6.1</b> Vectors</a></li>
<li class="chapter" data-level="0.6.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#factor-data"><i class="fa fa-check"></i><b>0.6.2</b> Factors</a></li>
<li class="chapter" data-level="0.6.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#matrix-data"><i class="fa fa-check"></i><b>0.6.3</b> Matrices</a></li>
<li class="chapter" data-level="0.6.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dataframe"><i class="fa fa-check"></i><b>0.6.4</b> Data Frames</a></li>
<li class="chapter" data-level="0.6.5" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#list-data"><i class="fa fa-check"></i><b>0.6.5</b> Lists</a></li>
</ul></li>
<li class="chapter" data-level="0.7" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#operators"><i class="fa fa-check"></i><b>0.7</b> Operators in R</a>
<ul>
<li class="chapter" data-level="0.7.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#arithmetic-operators"><i class="fa fa-check"></i><b>0.7.1</b> Arithmetic Operators</a></li>
<li class="chapter" data-level="0.7.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#comparison-operators"><i class="fa fa-check"></i><b>0.7.2</b> Comparison Operators</a></li>
<li class="chapter" data-level="0.7.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#logical-operators"><i class="fa fa-check"></i><b>0.7.3</b> Logical Operators</a></li>
</ul></li>
<li class="chapter" data-level="0.8" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#conditional-statements"><i class="fa fa-check"></i><b>0.8</b> Control Structures: Conditional Statements</a>
<ul>
<li class="chapter" data-level="0.8.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#ifelse-statements"><i class="fa fa-check"></i><b>0.8.1</b> If-Else Statements</a></li>
<li class="chapter" data-level="0.8.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#v-ifelse-statements"><i class="fa fa-check"></i><b>0.8.2</b> Vectorized If-Else: <code>ifelse()</code></a></li>
<li class="chapter" data-level="0.8.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#cut-statements"><i class="fa fa-check"></i><b>0.8.3</b> Vectorized Cut: <code>cut()</code></a></li>
</ul></li>
<li class="chapter" data-level="0.9" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#control-structures"><i class="fa fa-check"></i><b>0.9</b> Control Structures: Loops</a>
<ul>
<li class="chapter" data-level="0.9.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#for-loop"><i class="fa fa-check"></i><b>0.9.1</b> For Loops</a></li>
<li class="chapter" data-level="0.9.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#while-loop"><i class="fa fa-check"></i><b>0.9.2</b> While Loops</a></li>
</ul></li>
<li class="chapter" data-level="0.10" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#r-funtions"><i class="fa fa-check"></i><b>0.10</b> Functions in R</a>
<ul>
<li class="chapter" data-level="0.10.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#built-funtions"><i class="fa fa-check"></i><b>0.10.1</b> Using Built-in Functions</a></li>
<li class="chapter" data-level="0.10.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#build-functions"><i class="fa fa-check"></i><b>0.10.2</b> Creating Custom Functions</a></li>
<li class="chapter" data-level="0.10.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#arguments-functions"><i class="fa fa-check"></i><b>0.10.3</b> Function Arguments and Defaults</a></li>
</ul></li>
<li class="chapter" data-level="0.11" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#R-data-manipulation"><i class="fa fa-check"></i><b>0.11</b> Data Manipulation with Base R</a>
<ul>
<li class="chapter" data-level="0.11.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#R-data-subset"><i class="fa fa-check"></i><b>0.11.1</b> Subsetting and Filtering</a></li>
<li class="chapter" data-level="0.11.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#delete-cols"><i class="fa fa-check"></i><b>0.11.2</b> Deleting Columns</a></li>
<li class="chapter" data-level="0.11.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#sort-rows"><i class="fa fa-check"></i><b>0.11.3</b> Sorting Data</a></li>
<li class="chapter" data-level="0.11.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#aggregate-rows"><i class="fa fa-check"></i><b>0.11.4</b> Aggregating Data</a></li>
</ul></li>
<li class="chapter" data-level="0.12" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-manipultation"><i class="fa fa-check"></i><b>0.12</b> Data Manipulation with the Tidyverse</a>
<ul>
<li class="chapter" data-level="0.12.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-load"><i class="fa fa-check"></i><b>0.12.1</b> Loading the Tidyverse</a></li>
<li class="chapter" data-level="0.12.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-tibbles"><i class="fa fa-check"></i><b>0.12.2</b> Tibbles: Modern Data Frames</a></li>
<li class="chapter" data-level="0.12.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#tidyverse-pipe"><i class="fa fa-check"></i><b>0.12.3</b> The Pipe Operator: <code>%&gt;%</code></a></li>
<li class="chapter" data-level="0.12.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#manipulation-dplyr"><i class="fa fa-check"></i><b>0.12.4</b> Data Manipulation with <code>{dplyr}</code></a></li>
<li class="chapter" data-level="0.12.5" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-rename"><i class="fa fa-check"></i><b>0.12.5</b> Renaming Columns with <code>rename()</code></a></li>
<li class="chapter" data-level="0.12.6" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-group"><i class="fa fa-check"></i><b>0.12.6</b> Grouping and Summarizing Data by columns</a></li>
</ul></li>
<li class="chapter" data-level="0.13" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-join"><i class="fa fa-check"></i><b>0.13</b> Combining Data Frames</a>
<ul>
<li class="chapter" data-level="0.13.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#understand-joins"><i class="fa fa-check"></i><b>0.13.1</b> Understanding Joins</a></li>
<li class="chapter" data-level="0.13.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dplyr-bind_rows"><i class="fa fa-check"></i><b>0.13.2</b> Stacking Data with <code>bind_rows()</code></a></li>
</ul></li>
<li class="chapter" data-level="0.14" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#NA"><i class="fa fa-check"></i><b>0.14</b> Missing Data</a>
<ul>
<li class="chapter" data-level="0.14.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#identify-NA"><i class="fa fa-check"></i><b>0.14.1</b> Identifying Missing Data</a></li>
<li class="chapter" data-level="0.14.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#handle-NA"><i class="fa fa-check"></i><b>0.14.2</b> Handling Missing Data</a></li>
</ul></li>
<li class="chapter" data-level="0.15" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#pivoting"><i class="fa fa-check"></i><b>0.15</b> Data Reshaping with <code>{tidyr}</code> package: Pivoting</a></li>
<li class="chapter" data-level="0.16" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#dl-data"><i class="fa fa-check"></i><b>0.16</b> Handling Below Detection Limit Data</a></li>
<li class="chapter" data-level="0.17" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#soil-data"><i class="fa fa-check"></i><b>0.17</b> Working with Soil Data</a>
<ul>
<li class="chapter" data-level="0.17.1" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#set-directory"><i class="fa fa-check"></i><b>0.17.1</b> Setting Working Directory</a></li>
<li class="chapter" data-level="0.17.2" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#load-packages"><i class="fa fa-check"></i><b>0.17.2</b> Load packages</a></li>
<li class="chapter" data-level="0.17.3" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#import-files"><i class="fa fa-check"></i><b>0.17.3</b> Importing Data from Files</a></li>
<li class="chapter" data-level="0.17.4" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#data-exploration"><i class="fa fa-check"></i><b>0.17.4</b> Exploring the Data</a></li>
</ul></li>
<li class="chapter" data-level="0.18" data-path="introduction-to-r-programming.html"><a href="introduction-to-r-programming.html#references-m1"><i class="fa fa-check"></i><b>0.18</b> References</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html"><i class="fa fa-check"></i><b>1</b> Data preparation for Digital Soil Mapping in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#introduction-1"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#loading-data"><i class="fa fa-check"></i><b>1.2</b> Loading and exploring raw soil data</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#basic-data-loading-and-structure"><i class="fa fa-check"></i><b>1.2.1</b> Basic data loading and structure</a></li>
<li class="chapter" data-level="1.2.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#data-components-and-organization"><i class="fa fa-check"></i><b>1.2.2</b> Data components and organization</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#site-data-preparation"><i class="fa fa-check"></i><b>1.3</b> Preparing site data for analysis</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#adding-a-unique-row-identifier"><i class="fa fa-check"></i><b>1.3.1</b> Adding a unique row identifier</a></li>
<li class="chapter" data-level="1.3.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#extracting-and-standardizing-column-names-for-sites"><i class="fa fa-check"></i><b>1.3.2</b> Extracting and standardizing column names for sites</a></li>
<li class="chapter" data-level="1.3.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#creating-unique-profile-identifiers"><i class="fa fa-check"></i><b>1.3.3</b> Creating unique profile identifiers</a></li>
<li class="chapter" data-level="1.3.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#remove-exact-duplicate-site-records"><i class="fa fa-check"></i><b>1.3.4</b> Remove exact duplicate site records</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#coordinate-validation"><i class="fa fa-check"></i><b>1.4</b> Coordinate validation and correction</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-missing-coordinates"><i class="fa fa-check"></i><b>1.4.1</b> Check 1: Missing coordinates</a></li>
<li class="chapter" data-level="1.4.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-valid-coordinate-ranges"><i class="fa fa-check"></i><b>1.4.2</b> Check 2: Valid coordinate ranges</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#depth-validation"><i class="fa fa-check"></i><b>1.5</b> Soil depth validation and correction</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-missing-depth-boundaries"><i class="fa fa-check"></i><b>1.5.1</b> Check 1: Missing depth boundaries</a></li>
<li class="chapter" data-level="1.5.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-negative-depth-values"><i class="fa fa-check"></i><b>1.5.2</b> Check 2: Negative depth values</a></li>
<li class="chapter" data-level="1.5.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-3-zero-thickness-intervals"><i class="fa fa-check"></i><b>1.5.3</b> Check 3: Zero-thickness intervals</a></li>
<li class="chapter" data-level="1.5.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-4-invalid-depth-logic"><i class="fa fa-check"></i><b>1.5.4</b> Check 4: Invalid depth logic</a></li>
<li class="chapter" data-level="1.5.5" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-5-profiles-without-a-surface-horizon-top-0"><i class="fa fa-check"></i><b>1.5.5</b> Check 5: Profiles without a surface horizon (top &gt; 0)</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#lab-validation"><i class="fa fa-check"></i><b>1.6</b> Preparing lab data: harmonization and validation</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#prepare-and-standardize-laboratory-columns"><i class="fa fa-check"></i><b>1.6.1</b> Prepare and standardize laboratory columns</a></li>
<li class="chapter" data-level="1.6.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-check-each-property-against-feasible-analytical-thresholds"><i class="fa fa-check"></i><b>1.6.2</b> Check 1: Check each property against feasible analytical thresholds</a></li>
<li class="chapter" data-level="1.6.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-2-texture-validation"><i class="fa fa-check"></i><b>1.6.3</b> Check 2: Texture validation</a></li>
<li class="chapter" data-level="1.6.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-3-correction-of-out-of-bounds-laboratory-values"><i class="fa fa-check"></i><b>1.6.4</b> Check 3: Correction of out-of-bounds laboratory values</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#duplicate-detection"><i class="fa fa-check"></i><b>1.7</b> Resolving duplicated data in soil profiles</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#why-duplicates-occur"><i class="fa fa-check"></i><b>1.7.1</b> Why duplicates occur</a></li>
<li class="chapter" data-level="1.7.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#types-of-duplicate-situations"><i class="fa fa-check"></i><b>1.7.2</b> Types of duplicate situations</a></li>
<li class="chapter" data-level="1.7.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#check-1-detect-potential-horizon-duplicates-within-profiles"><i class="fa fa-check"></i><b>1.7.3</b> Check 1: Detect potential horizon duplicates within profiles</a></li>
<li class="chapter" data-level="1.7.4" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#resolving-profile-duplicates"><i class="fa fa-check"></i><b>1.7.4</b> Resolving Profile Duplicates</a></li>
<li class="chapter" data-level="1.7.5" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#remove-profiles-not-starting-at-the-surface"><i class="fa fa-check"></i><b>1.7.5</b> Remove profiles not starting at the surface</a></li>
<li class="chapter" data-level="1.7.6" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#result"><i class="fa fa-check"></i><b>1.7.6</b> Result</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#harmonization"><i class="fa fa-check"></i><b>1.8</b> Harmonizing data for DSM</a>
<ul>
<li class="chapter" data-level="1.8.1" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#depth-standardization"><i class="fa fa-check"></i><b>1.8.1</b> Depth standardization</a></li>
<li class="chapter" data-level="1.8.2" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#processing-standardized-data"><i class="fa fa-check"></i><b>1.8.2</b> Processing standardized data</a></li>
<li class="chapter" data-level="1.8.3" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#exporting-standardized-data-for-digital-soil-mapping"><i class="fa fa-check"></i><b>1.8.3</b> Exporting standardized data for Digital Soil Mapping</a></li>
</ul></li>
<li class="chapter" data-level="1.9" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#spectroscopy"><i class="fa fa-check"></i><b>1.9</b> Preparing data for spectroscopy analyses</a></li>
<li class="chapter" data-level="1.10" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#exports"><i class="fa fa-check"></i><b>1.10</b> Summary of exported files</a></li>
<li class="chapter" data-level="" data-path="data-preparation-for-digital-soil-mapping-in-r.html"><a href="data-preparation-for-digital-soil-mapping-in-r.html#references"><i class="fa fa-check"></i>References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html"><i class="fa fa-check"></i><b>2</b> Spatial Analysis in R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#spatial-data-concepts"><i class="fa fa-check"></i><b>2.1</b> Spatial Data Concepts</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#vector-vs-raster-data"><i class="fa fa-check"></i><b>2.1.1</b> Vector vs Raster Data</a></li>
<li class="chapter" data-level="2.1.2" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#coordinate-reference-systems-crs-and-projections"><i class="fa fa-check"></i><b>2.1.2</b> Coordinate Reference Systems (CRS) and Projections</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#spatial-packages-in-r-sf-and-terra"><i class="fa fa-check"></i><b>2.2</b> Spatial Packages in R: <code>{sf}</code> and <code>{terra}</code></a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#installing-and-loading-spatial-packages"><i class="fa fa-check"></i><b>2.2.1</b> Installing and Loading Spatial Packages</a></li>
<li class="chapter" data-level="2.2.2" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#working-with-vector-data-using-sf"><i class="fa fa-check"></i><b>2.2.2</b> Working with Vector Data using <code>{sf}</code></a></li>
<li class="chapter" data-level="2.2.3" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#importing-vector-data"><i class="fa fa-check"></i><b>2.2.3</b> Importing Vector Data</a></li>
<li class="chapter" data-level="2.2.4" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#spatial-relationships-and-joins"><i class="fa fa-check"></i><b>2.2.4</b> Spatial Relationships and Joins</a></li>
<li class="chapter" data-level="2.2.5" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#importing-raster-data"><i class="fa fa-check"></i><b>2.2.5</b> Importing Raster Data</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#combining-vector-and-raster-data"><i class="fa fa-check"></i><b>2.3</b> Combining Vector and Raster Data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#extracting-raster-values-to-points-and-polygons"><i class="fa fa-check"></i><b>2.3.1</b> Extracting Raster Values to Points and Polygons</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#exporting-and-sharing-spatial-data"><i class="fa fa-check"></i><b>2.4</b> Exporting and Sharing Spatial Data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#exporting-vector-data"><i class="fa fa-check"></i><b>2.4.1</b> Exporting Vector Data</a></li>
<li class="chapter" data-level="2.4.2" data-path="spatial-analysis-in-r.html"><a href="spatial-analysis-in-r.html#exporting-raster-data"><i class="fa fa-check"></i><b>2.4.2</b> Exporting Raster Data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html"><i class="fa fa-check"></i><b>3</b> Sampling design for soil surveys</a>
<ul>
<li class="chapter" data-level="3.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#introduction-ssd"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#sampling-theory"><i class="fa fa-check"></i><b>3.2</b> Sampling methodologies for soil spatial survey</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#selection-methods"><i class="fa fa-check"></i><b>3.2.1</b> Selection of the sampling methodology</a></li>
<li class="chapter" data-level="3.2.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#inference-methods"><i class="fa fa-check"></i><b>3.2.2</b> Inference Methods</a></li>
<li class="chapter" data-level="3.2.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#sampling-purpose"><i class="fa fa-check"></i><b>3.2.3</b> Purpose of Sampling</a></li>
<li class="chapter" data-level="3.2.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#design-types"><i class="fa fa-check"></i><b>3.2.4</b> Sampling Design Types</a></li>
<li class="chapter" data-level="3.2.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#soils4africa-example"><i class="fa fa-check"></i><b>3.2.5</b> Example: Soils4Africa Sampling Design</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#soilfer-design"><i class="fa fa-check"></i><b>3.3</b> SoilFER Sampling Design</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#soil-properties"><i class="fa fa-check"></i><b>3.3.1</b> Soil Properties</a></li>
<li class="chapter" data-level="3.3.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#env-covariates"><i class="fa fa-check"></i><b>3.3.2</b> Environmental Covariates</a></li>
<li class="chapter" data-level="3.3.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#methodology"><i class="fa fa-check"></i><b>3.3.3</b> Understanding the Methodology</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#tutorial"><i class="fa fa-check"></i><b>3.4</b> Tutorial using R</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#setup"><i class="fa fa-check"></i><b>3.4.1</b> Setting Up the Environment</a></li>
<li class="chapter" data-level="3.4.2" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#define-parameters"><i class="fa fa-check"></i><b>3.4.2</b> Define Variables and Parameters</a></li>
<li class="chapter" data-level="3.4.3" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#country-iso-code"><i class="fa fa-check"></i><b>3.4.3</b> Country ISO Code</a></li>
<li class="chapter" data-level="3.4.4" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#custom-functions"><i class="fa fa-check"></i><b>3.4.4</b> Custom Functions</a></li>
<li class="chapter" data-level="3.4.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-boundaries"><i class="fa fa-check"></i><b>3.4.5</b> Load Country Boundaries and Legacy Data</a></li>
<li class="chapter" data-level="3.4.6" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-covariates-psu"><i class="fa fa-check"></i><b>3.4.6</b> Load Environmental Covariates for PSUs</a></li>
<li class="chapter" data-level="3.4.7" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#load-main-environmental-covariates"><i class="fa fa-check"></i><b>3.4.7</b> Load Main Environmental Covariates</a></li>
<li class="chapter" data-level="3.4.8" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#pca"><i class="fa fa-check"></i><b>3.4.8</b> Principal Component Analysis (PCA)</a></li>
<li class="chapter" data-level="3.4.9" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#sampling-universe"><i class="fa fa-check"></i><b>3.4.9</b> Organize the Sampling Universe</a></li>
<li class="chapter" data-level="3.4.10" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#save-processed-land-use"><i class="fa fa-check"></i><b>3.4.10</b> Save Processed Land Use</a></li>
<li class="chapter" data-level="3.4.11" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#create-psu-grid"><i class="fa fa-check"></i><b>3.4.11</b> Create Primary Sampling Units (PSU Grid)</a></li>
<li class="chapter" data-level="3.4.12" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#select-psus"><i class="fa fa-check"></i><b>3.4.12</b> Select PSUs with Sufficient Land Use Coverage</a></li>
<li class="chapter" data-level="3.4.13" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#rasterize-psus"><i class="fa fa-check"></i><b>3.4.13</b> Rasterize PSUs for Covariate Space Coverage</a></li>
<li class="chapter" data-level="3.4.14" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#optimal-sample-size"><i class="fa fa-check"></i><b>3.4.14</b> Compute Optimal Sample Size</a></li>
<li class="chapter" data-level="3.4.15" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#csc-computing"><i class="fa fa-check"></i><b>3.4.15</b> Covariate Space Coverage - Computing PSUs</a></li>
<li class="chapter" data-level="3.4.16" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#compute-ssu-tsu"><i class="fa fa-check"></i><b>3.4.16</b> Compute SSUs and TSUs</a></li>
<li class="chapter" data-level="3.4.17" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#export-units"><i class="fa fa-check"></i><b>3.4.17</b> Export Sampling Units</a></li>
<li class="chapter" data-level="3.4.18" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#alternative-psus"><i class="fa fa-check"></i><b>3.4.18</b> Compute Alternative PSUs</a></li>
<li class="chapter" data-level="3.4.19" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#merging-results"><i class="fa fa-check"></i><b>3.4.19</b> Merging Results from Multiple Land Uses</a></li>
<li class="chapter" data-level="3.4.20" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#field-protocol"><i class="fa fa-check"></i><b>3.4.20</b> Field Sampling Protocol</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="sampling-design-for-soil-surveys.html"><a href="sampling-design-for-soil-surveys.html#references-sdg1"><i class="fa fa-check"></i><b>3.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html"><i class="fa fa-check"></i>Appendices</a>
<ul>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-a-software-and-data-sources"><i class="fa fa-check"></i>Appendix A: Software and Data Sources</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="appendices.html"><a href="appendices.html#software-requirements"><i class="fa fa-check"></i><b>3.5.1</b> Software Requirements</a></li>
<li class="chapter" data-level="3.5.2" data-path="appendices.html"><a href="appendices.html#data-sources"><i class="fa fa-check"></i><b>3.5.2</b> Data Sources</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-b-troubleshooting-common-issues"><i class="fa fa-check"></i>Appendix B: Troubleshooting Common Issues</a>
<ul>
<li class="chapter" data-level="3.5.3" data-path="appendices.html"><a href="appendices.html#memory-issues"><i class="fa fa-check"></i><b>3.5.3</b> Memory Issues</a></li>
<li class="chapter" data-level="3.5.4" data-path="appendices.html"><a href="appendices.html#crs-misalignment"><i class="fa fa-check"></i><b>3.5.4</b> CRS Misalignment</a></li>
<li class="chapter" data-level="3.5.5" data-path="appendices.html"><a href="appendices.html#empty-geometry"><i class="fa fa-check"></i><b>3.5.5</b> Empty Geometry</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendices.html"><a href="appendices.html#appendix-c-acronyms-and-abbreviations"><i class="fa fa-check"></i>Appendix C: Acronyms and Abbreviations</a></li>
<li class="chapter" data-level="3.6" data-path="appendices.html"><a href="appendices.html#section"><i class="fa fa-check"></i><b>3.6</b> =======</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="tbd.html"><a href="tbd.html"><i class="fa fa-check"></i><b>4</b> TBD</a></li>
<li class="chapter" data-level="5" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html"><i class="fa fa-check"></i><b>5</b> GloSIS Soil Data Preparation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#introduction"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#the-glosis-database"><i class="fa fa-check"></i><b>5.2</b> The GloSIS database</a></li>
<li class="chapter" data-level="5.3" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#features-of-interest-understanding-the-xlsx-template"><i class="fa fa-check"></i><b>5.3</b> Features of interest: Understanding the XLSX Template</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#plot-data-sheet"><i class="fa fa-check"></i><b>5.3.1</b> Plot Data Sheet</a></li>
<li class="chapter" data-level="5.3.2" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#profile-data-sheet"><i class="fa fa-check"></i><b>5.3.2</b> Profile Data Sheet</a></li>
<li class="chapter" data-level="5.3.3" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#element-data-sheet"><i class="fa fa-check"></i><b>5.3.3</b> Element Data Sheet</a></li>
<li class="chapter" data-level="5.3.4" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#specimen-data-sheet"><i class="fa fa-check"></i><b>5.3.4</b> Specimen Data Sheet</a></li>
<li class="chapter" data-level="5.3.5" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#procedures-sheet"><i class="fa fa-check"></i><b>5.3.5</b> Procedures Sheet</a></li>
<li class="chapter" data-level="5.3.6" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#metadata-sheet"><i class="fa fa-check"></i><b>5.3.6</b> Metadata Sheet</a></li>
<li class="chapter" data-level="5.3.7" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#original-data-sheet"><i class="fa fa-check"></i><b>5.3.7</b> Original Data Sheet</a></li>
<li class="chapter" data-level="5.3.8" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#glosis-methods-sheet"><i class="fa fa-check"></i><b>5.3.8</b> GloSIS Methods sheet</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#glosis-etl"><i class="fa fa-check"></i><b>5.4</b> GloSIS-ETL</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#glosis-data-harmonization"><i class="fa fa-check"></i><b>5.4.1</b> GloSIS Data Harmonization</a></li>
<li class="chapter" data-level="5.4.2" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-1-data-ingestion-variable-mapping"><i class="fa fa-check"></i><b>5.4.2</b> Step 1: Data Ingestion &amp; Variable Mapping</a></li>
<li class="chapter" data-level="5.4.3" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-2-quality-check-and-quality-report-generation"><i class="fa fa-check"></i><b>5.4.3</b> Step 2: Quality Check and Quality Report Generation</a></li>
<li class="chapter" data-level="5.4.4" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-2a-geographic-data-validation"><i class="fa fa-check"></i><b>5.4.4</b> Step 2a: Geographic Data Validation</a></li>
<li class="chapter" data-level="5.4.5" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-2b-soil-depth-validation"><i class="fa fa-check"></i><b>5.4.5</b> Step 2b: Soil Depth Validation</a></li>
<li class="chapter" data-level="5.4.6" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-2c-soil-properties-validation"><i class="fa fa-check"></i><b>5.4.6</b> Step 2c: Soil Properties Validation</a></li>
<li class="chapter" data-level="5.4.7" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-3-data-correction-and-resubmission"><i class="fa fa-check"></i><b>5.4.7</b> Step 3: Data Correction and Resubmission</a></li>
<li class="chapter" data-level="5.4.8" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#step-4-download-harmonized-data"><i class="fa fa-check"></i><b>5.4.8</b> Step 4: Download Harmonized Data</a></li>
<li class="chapter" data-level="5.4.9" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#glosis-data-standardization"><i class="fa fa-check"></i><b>5.4.9</b> GloSIS Data Standardization</a></li>
<li class="chapter" data-level="5.4.10" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#glosis-data-viewer"><i class="fa fa-check"></i><b>5.4.10</b> GloSIS Data Viewer</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#installation-and-setup-of-the-glosis-etl"><i class="fa fa-check"></i><b>5.5</b> Installation and Setup of the GloSIS-ETL</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#install-docker-desktop"><i class="fa fa-check"></i><b>5.5.1</b> Install Docker Desktop</a></li>
<li class="chapter" data-level="5.5.2" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#install-the-glosis-etl-services"><i class="fa fa-check"></i><b>5.5.2</b> Install the GloSIS-ETL Services</a></li>
<li class="chapter" data-level="5.5.3" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#verify-installation"><i class="fa fa-check"></i><b>5.5.3</b> Verify Installation</a></li>
<li class="chapter" data-level="5.5.4" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#pgadmin"><i class="fa fa-check"></i><b>5.5.4</b> Optional: pgAdmin Web Interface</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#accessing-the-services"><i class="fa fa-check"></i><b>5.6</b> Accessing the Services</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#landing-page"><i class="fa fa-check"></i><b>5.6.1</b> Landing Page</a></li>
<li class="chapter" data-level="5.6.2" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#shiny-application-modules"><i class="fa fa-check"></i><b>5.6.2</b> Shiny Application Modules</a></li>
<li class="chapter" data-level="5.6.3" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#glosis-database"><i class="fa fa-check"></i><b>5.6.3</b> GloSIS Database</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#docker-compose-file"><i class="fa fa-check"></i><b>5.7</b> The <code>docker-compose.yml</code> File</a></li>
<li class="chapter" data-level="5.8" data-path="glosis-soil-data-preparation.html"><a href="glosis-soil-data-preparation.html#env-file"><i class="fa fa-check"></i><b>5.8</b> The <code>.env</code> File</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html"><i class="fa fa-check"></i><b>6</b> Digital Soil Mapping and Modeling</a>
<ul>
<li class="chapter" data-level="" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#part-i-theoretical-foundations"><i class="fa fa-check"></i>Part I: Theoretical Foundations</a></li>
<li class="chapter" data-level="6.1" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#fundamentals-of-digital-soil-mapping"><i class="fa fa-check"></i><b>6.1</b> Fundamentals of Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#introduction-to-digital-soil-mapping"><i class="fa fa-check"></i><b>6.1.1</b> Introduction to Digital Soil Mapping</a></li>
<li class="chapter" data-level="6.1.2" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#the-scorpan-framework"><i class="fa fa-check"></i><b>6.1.2</b> The SCORPAN Framework</a></li>
<li class="chapter" data-level="6.1.3" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#statistical-theory-for-predictive-soil-mapping"><i class="fa fa-check"></i><b>6.1.3</b> Statistical Theory for Predictive Soil Mapping</a></li>
<li class="chapter" data-level="6.1.4" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#types-of-soil-variables"><i class="fa fa-check"></i><b>6.1.4</b> Types of Soil Variables</a></li>
<li class="chapter" data-level="6.1.5" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#prediction-methods"><i class="fa fa-check"></i><b>6.1.5</b> Prediction Methods</a></li>
<li class="chapter" data-level="6.1.6" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#nonlinearity-and-uncertainty"><i class="fa fa-check"></i><b>6.1.6</b> Nonlinearity and Uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#part-ii-practical-application"><i class="fa fa-check"></i>Part II: Practical Application</a></li>
<li class="chapter" data-level="6.2" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#workflow-overview"><i class="fa fa-check"></i><b>6.2</b> Workflow Overview</a></li>
<li class="chapter" data-level="6.3" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#continuous-modelling-ph"><i class="fa fa-check"></i><b>6.3</b> Continuous Modelling (pH)</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#nature-of-the-variable"><i class="fa fa-check"></i><b>6.3.1</b> Nature of the Variable</a></li>
<li class="chapter" data-level="6.3.2" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#data-and-covariates"><i class="fa fa-check"></i><b>6.3.2</b> Data and Covariates</a></li>
<li class="chapter" data-level="6.3.3" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#feature-selection-boruta"><i class="fa fa-check"></i><b>6.3.3</b> Feature Selection (Boruta)</a></li>
<li class="chapter" data-level="6.3.4" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#model-training"><i class="fa fa-check"></i><b>6.3.4</b> Model Training</a></li>
<li class="chapter" data-level="6.3.5" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#variable-importance"><i class="fa fa-check"></i><b>6.3.5</b> Variable Importance</a></li>
<li class="chapter" data-level="6.3.6" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#validation-metrics"><i class="fa fa-check"></i><b>6.3.6</b> Validation Metrics</a></li>
<li class="chapter" data-level="6.3.7" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#prediction-maps"><i class="fa fa-check"></i><b>6.3.7</b> Prediction Maps</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#nominal-classification-clay_ph_class"><i class="fa fa-check"></i><b>6.4</b> Nominal Classification (Clay_pH_Class)</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#nature-of-the-variable-1"><i class="fa fa-check"></i><b>6.4.1</b> Nature of the Variable</a></li>
<li class="chapter" data-level="6.4.2" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#feature-selection"><i class="fa fa-check"></i><b>6.4.2</b> Feature Selection</a></li>
<li class="chapter" data-level="6.4.3" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#model-training-1"><i class="fa fa-check"></i><b>6.4.3</b> Model Training</a></li>
<li class="chapter" data-level="6.4.4" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#validation"><i class="fa fa-check"></i><b>6.4.4</b> Validation</a></li>
<li class="chapter" data-level="6.4.5" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#prediction-maps-1"><i class="fa fa-check"></i><b>6.4.5</b> Prediction Maps</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#ordinal-modelling-ph_class"><i class="fa fa-check"></i><b>6.5</b> Ordinal Modelling (pH_Class)</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#nature-of-the-variable-2"><i class="fa fa-check"></i><b>6.5.1</b> Nature of the Variable</a></li>
<li class="chapter" data-level="6.5.2" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#ordinal-encoding"><i class="fa fa-check"></i><b>6.5.2</b> Ordinal Encoding</a></li>
<li class="chapter" data-level="6.5.3" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#feature-selection-1"><i class="fa fa-check"></i><b>6.5.3</b> Feature Selection</a></li>
<li class="chapter" data-level="6.5.4" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#model-training-2"><i class="fa fa-check"></i><b>6.5.4</b> Model Training</a></li>
<li class="chapter" data-level="6.5.5" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#validation-1"><i class="fa fa-check"></i><b>6.5.5</b> Validation</a></li>
<li class="chapter" data-level="6.5.6" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#prediction-maps-2"><i class="fa fa-check"></i><b>6.5.6</b> Prediction Maps</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#area-of-applicability-aoa"><i class="fa fa-check"></i><b>6.6</b> Area of Applicability (AOA)</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#why-aoa-is-necessary"><i class="fa fa-check"></i><b>6.6.1</b> Why AOA is Necessary</a></li>
<li class="chapter" data-level="6.6.2" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#dissimilarity-index-di"><i class="fa fa-check"></i><b>6.6.2</b> Dissimilarity Index (DI)</a></li>
<li class="chapter" data-level="6.6.3" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#aoa-binary-mask"><i class="fa fa-check"></i><b>6.6.3</b> AOA Binary Mask</a></li>
<li class="chapter" data-level="6.6.4" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#local-point-density-lpd"><i class="fa fa-check"></i><b>6.6.4</b> Local Point Density (LPD)</a></li>
<li class="chapter" data-level="6.6.5" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#predictions-masked-to-aoa"><i class="fa fa-check"></i><b>6.6.5</b> Predictions Masked to AOA</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#summary"><i class="fa fa-check"></i><b>6.7</b> Summary</a></li>
<li class="chapter" data-level="" data-path="digital-soil-mapping-and-modeling.html"><a href="digital-soil-mapping-and-modeling.html#references-1"><i class="fa fa-check"></i>References</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html"><i class="fa fa-check"></i><b>7</b> Soil Data Sharing</a>
<ul>
<li class="chapter" data-level="7.1" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#data-sharing-and-export-formats"><i class="fa fa-check"></i><b>7.1</b> Data sharing and export formats</a></li>
<li class="chapter" data-level="7.2" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#metadata"><i class="fa fa-check"></i><b>7.2</b> Metadata</a></li>
<li class="chapter" data-level="7.3" data-path="soil-data-sharing.html"><a href="soil-data-sharing.html#web-services"><i class="fa fa-check"></i><b>7.3</b> Web Services</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-2.html"><a href="references-2.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p>DRAFT - Integrated soil information for decision-making
<img src="images/frontcover.jpg" style="top:0px;height:100px;" align="right" /></p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sampling-design-for-soil-surveys" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Sampling design for soil surveys<a href="sampling-design-for-soil-surveys.html#sampling-design-for-soil-surveys" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-ssd" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Introduction<a href="sampling-design-for-soil-surveys.html#introduction-ssd" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Soil surveys play a critical role in environmental monitoring, evaluating soil degradation, and formulating sustainable land use strategies <span class="citation">(<a href="#ref-bui2020" role="doc-biblioref">Bui, 2020</a>)</span>. They offer essential information on soil characteristics, including texture, structure, pH levels, organic matter content, nutrient availability, and other physicochemical attributes of interest. These data are essential for making informed choices about crop selection, fertilizer use, irrigation planning, and soil conservation and management strategies. Therefore, soil information and data are key components in any comprehensive soil survey that supplies necessary information for soil management decisions at local to global scales. In this sense, the Soil Mapping for Resilient Agrifood Systems (SoilFER) framework aims to provide open-access soil information system to support the formulation of digital soil maps, fertiliser recommendations, establish crop suitability, determine soil quality indicators, assess soil health, implement soil conservation practices, and create a national soil spectral library.</p>
<p>State-of-the-art soil sampling protocols adopt a systematic approach that considers factors such as soil variability, sampling depth, land-use, farming activities, and sampling density <span class="citation">(<a href="#ref-brevik2016" role="doc-biblioref">Brevik <em>et al.</em>, 2016</a>; <a href="#ref-clay2018" role="doc-biblioref">Clay <em>et al.</em>, 2001</a>; <a href="#ref-morton2000" role="doc-biblioref">Morton and Heinemeyer, 2000</a>; <a href="#ref-norris2020" role="doc-biblioref">Norris <em>et al.</em>, 2013</a>)</span>. This chapter provides general guidance on soil sampling design methodologies to ensure precision, reproducibility, and reliability in the collection of soil samples for digital soil mapping and monitoring. It presents a three-stage hierarchical hybrid method incorporating both probability and non-probability sampling for soil mapping and monitoring within the SoilFER framework. At the first and second hierarchical levels, the primary and secondary sampling units are selected using a covariate space coverage sampling method based on environmental covariates (model-based). At the third hierarchical level, the tertiary sampling units are selected using simple random sampling without replacement (design-based). This sampling approach standardises soil sampling methodologies across the countries participating in the project.</p>
</div>
<div id="sampling-theory" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Sampling methodologies for soil spatial survey<a href="sampling-design-for-soil-surveys.html#sampling-theory" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Soil monitoring and mapping are essential to understand soil variability and manage soil resources efficiently. In this context, it is important to understand the basics of choosing a sampling methodology that best fits the projectâ€™s objectives, whether focused on mapping, monitoring, or a combination of both. This section provides an overview of key sampling design concepts, presented in a manner accessible for both academic and non-academic audiences. Letâ€™s take a look!</p>
<div id="selection-methods" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Selection of the sampling methodology<a href="sampling-design-for-soil-surveys.html#selection-methods" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Purposive</strong> (also known as <em>traditional</em> or <em>expert</em>) and <strong>probability sampling</strong> are the most used methods for selecting sampling units in soil surveys. Both methods differ basically in their objectives. In simple terms, <em>expert</em> sampling involves selecting specific points along a slope or landscape feature, either at individual locations or along transects, such as a <u>catena</u> or <u>toposequence</u>. This approach aims to capture the relationships between the variation in soil properties and the different geographical features that make up the landscape. This concept has been widely used as stated in the literature for soil mapping <span class="citation">(<a href="#ref-borden2020" role="doc-biblioref">Borden, Thomas and Rivard, 2020</a>; <a href="#ref-gobin2000" role="doc-biblioref">Gobin, Campling and Feyen, 2001</a>; <a href="#ref-milne1936" role="doc-biblioref">Milne, 1936</a>)</span>. This selection method effectively captures local variations in soil properties and is useful for understanding how these properties change in relation to terrain and hydrological characteristics. However, this sampling method may not always reflect the overall variability of soil properties across the entire study area. Moreover, implementing this approach generally requires significant effort, time, and funding, particularly for large study areas.</p>
<p>On the other hand, <strong><em>probability sampling</em></strong> assigns a known probability of selection to each sampling unit, ensuring that each sampling unit has a chance of being included in the sample. This approach focuses on obtaining representative samples to make unbiased inferences about the entire population under study <span class="citation">(<a href="#ref-degruijter2006" role="doc-biblioref">Gruijter <em>et al.</em>, 2006</a>)</span>. This method requires careful planning and implementation to ensure that the sampling design is both <em>unbiased</em> and <em>representative</em> of the population. In addition, its implementation can be more complex compared to the expert sampling method. However, its main advantage is that every sampling unit has a chance of being included in the sample, resulting in a more representative sample of the variability in the study area. Additionally, it allows statistical inferences about the entire population from the sample. This last aspect, if not the most important, allows soil surveyors to monitor and better report the current and future status of soil properties. In general, traditional/expert (i.e., <em>non-probabilistic</em>) sampling is less flexible than <em>probabilistic</em> sampling since the latter allows for both types of inference methods, as we will see in the next subsection.</p>
</div>
<div id="inference-methods" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Inference Methods<a href="sampling-design-for-soil-surveys.html#inference-methods" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Two primary statistical inference methods are used in soil survey: <em>design</em>- and <em>model</em>-based inference approaches <span class="citation">(<a href="#ref-degruijter2006" role="doc-biblioref">Gruijter <em>et al.</em>, 2006</a>)</span>. <strong>Design-based</strong> inference utilises the sample design to make inferences about the entire population including probabilities of the sampling units. This approach is suitable for estimating global quantities, such as means and totals, or local quantities for large domains based on the design of the sampling scheme. Briefly, global quantities encompass the spatial cumulative distribution function of the response variable in the sampling universe, or quantities derived from it, such as quantiles, median, mean, and standard deviation. Local quantities, on the other hand, pertain to individual estimates within sub-areas of the sampling universe, also known as domains. <strong>Model-based</strong> inference uses statistical models to make inferences about unsampled locations based on the relationships observed in the sampled data. This approach is valuable for predicting soil properties at unsampled locations, especially in areas where sampling is limited. Further information about design- and model-based approaches can be found in <span class="citation">Brus, Kempen and Heuvelink (<a href="#ref-brus2021" role="doc-biblioref">2011 a</a>)</span>. In simple words, the difference between them lies in where the uncertainty comes from and how conclusions are drawn.</p>
<p>For instance, <em>design-based inference</em>, sampling locations are selected using a probability sampling design, such as simple random sampling without replacement. Every location in the study area has a known and non-zero probability of being selected. In this framework, randomness arises from the sampling process itself. The sampled data are then used to estimate characteristics of the entire study area. The validity of the results therefore depends on how well the sampling design was constructed and implemented. If the design is appropriate and correctly applied, the resulting estimates are unbiased, regardless of the spatial pattern of the soil property. Design-based inference can also be used to estimate values for sub-areas, or domains, provided that the sampling design ensures sufficient representation within those areas. In simple terms, the sample represents the whole study area if the sampling is random and properly designed. This approach is particularly useful for estimating population summaries (i.e., monitoring), such as mean soil organic carbon or total nutrient stocks.</p>
<p>In contrast, <em>model-based inference</em> begins by collecting soil samples at selected locations and then fitting a statistical model that relates soil properties to environmental covariates, such as elevation, slope, or climate variables. The fitted model is subsequently used to predict soil properties at unsampled locations. In this case, randomness arises from the assumptions of the statistical model rather than from the sampling design. The validity of the inference depends on how well the model captures the relationship between the soil property and the explanatory variables (i.e., environmental covariates). If the model is appropriate, it can be used to generate continuous prediction maps across the entire study area. In simple terms, soil properties can be predicted everywhere if the model correctly describes the underlying relationships. This approach is particularly useful for spatial prediction and for filling gaps in areas where no samples were collected.</p>
<p><strong>Summary</strong></p>
<ul>
<li><p>Monitoring: design-based inference is generally preferred.</p></li>
<li><p>Mapping: model-based inference is generally preferred.</p></li>
<li><p>Hybrid designs: combine both strenghts.</p></li>
</ul>
</div>
<div id="sampling-purpose" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Purpose of Sampling<a href="sampling-design-for-soil-surveys.html#sampling-purpose" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Bounding together selection and inference methods, one can better determine which one of those combinations works best for their project goals. The choice of sampling method in soil survey and monitoring depends on the surveyâ€™s purpose <span class="citation">(<a href="#ref-brus2022" role="doc-biblioref">Brus, 2022</a>)</span>. For monitoring soil properties over time, design-based inference and probability sampling selection are suitable. These methods allow for the unbiased estimation of changes in soil properties at specific locations over time. For mapping soil properties across a landscape, model-based inference and non-probabilistic sampling are more appropriate. These methods allow for the spatial prediction of soil properties at unsampled locations based on the relationships observed in the sampled data. Monitoring differs from estimating soil parameters of domains at a given point in time. However, similar to monitoring, design-based inference and probability sampling are the most suitable methods for estimating soil properties within a certain domain. These approaches ensure that the estimates of soil parameters (e.g., mean, variance, mode, median) are unbiased and representative of the study area.</p>
</div>
<div id="design-types" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Sampling Design Types<a href="sampling-design-for-soil-surveys.html#design-types" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The sequence of decision-making for a soil survey or monitoring project should follow a logical order to ensure that the objectives of the project are met effectively. <em>Begin by defining the purpose of the project</em>. Determine whether the goal is to monitor changes in soil properties over time or to map them across landscape. <em>Based on the purpose</em>, one can choose an appropriate <em>selection method</em>. After that, one can select the <em>inference method</em> which best suits the project. For instance, if the goal is monitoring, consider probability sampling. For mapping, consider either non-probability or probability methods. Once the <em>purpose, selection</em> and <em>inference methods</em> are defined, one can select the <u><em>appropriate sampling design</em></u>.</p>
<p>Before diving into the types of sampling design, it is important to take into consideration the stratification of the sampling universe. Stratification involves dividing the sampling universe into strata or sub-areas based on certain criteria, such as soil-climate types or land-use. This approach can increase the efficiency of the sampling design by obtaining separate estimates for each stratum, leading to more precise estimates for specific regions of interest (ROI). For example, if the ROI has distinct soil types, stratifying the sample by soil type can ensure that each soil type is adequately represented in the sample. Another example is using explanatory variables (i.e., environmental covariates) from remote sensing as a means of spatial coverage and stratification.</p>
<p>Stratification is not a separate sampling design type rather it is a structural feature that can be incorporated into different sampling designs to improve efficiency, representativeness, and precision. In other words, stratification modifies how a design is implemented, not the fundamental logic of the design itself. For clarity, sampling design types can be broadly grouped according to whether the primary objective is monitoring or mapping (Table <a href="sampling-design-for-soil-surveys.html#tab:design-comparison">3.1</a>). For monitoring, one can certainly choose among simple random sampling (SRS), stratified SRS, or two-stage cluster random sampling. In SRS, each sampling unit in the ROI has equal probability of being selected. This approach is straightforward and easy to implement but may not account for spatial variability in soil properties. Stratified simple random sampling divides the ROI into strata based on certain criteria, such as soil-climate types or land-use. Then, SRS is conducted within each stratum. This method ensures that each stratum is adequately represented in the sample, leading to more precise estimates for specific ROI. Finally, two-stage cluster random sampling, the sampling units are grouped into clusters, and then clusters are randomly selected for sampling. This method is useful for large study areas where it may be impractical to sample every unit individually.</p>
<p>An important concept that can be incorporated into these probability-based designs is balanced acceptance sampling (BAS) <span class="citation">(<a href="#ref-robertson2013" role="doc-biblioref">Robertson <em>et al.</em>, 2013</a>)</span>. BAS is not a separate design category but rather a strategy that promotes spatial balance within a probability sampling framework. It can be applied within simple random, stratified, or cluster sampling to ensure that selected sampling units are well distributed across the study area or across strata. By improving spatial balance, BAS can enhance representativeness and reduce estimation variance while preserving the benefits of probability-based inference. In a stratified sampling design, BAS would aim to balance the number of sampling points across strata. In a two-stage cluster random sampling design, BAS would involve ensuring a balanced selection of clusters from each stratum. In essence, BAS is a principle or strategy that can be incorporated into various sampling design types to reduce bias in the estimation of soil properties.</p>
<p>If the main goal of a sampling design is to map soil properties, non-probability methods such as conditioned Latin Hypercube sampling <span class="citation">(<a href="#ref-minasny2006" role="doc-biblioref">Minasny and McBratney, 2006</a>)</span>, catena or topo-sequence sampling <span class="citation">(<a href="#ref-milne1936" role="doc-biblioref">Milne, 1936</a>)</span>, grid sampling, or covariate space coverage sampling <span class="citation">(<a href="#ref-brus2018" role="doc-biblioref">Brus, Kempen and Heuvelink, 2011 b</a>; <a href="#ref-degruijter2006" role="doc-biblioref">Gruijter <em>et al.</em>, 2006</a>)</span> are the most suitable choices. Conditioned Latin Hypercube sampling (CLHS) selects sampling points that ensure a representative distribution of soil properties across the study area. This approach is particularly useful for capturing spatial variability within the explanatory variables that describe the pattern of the response variable, leading to more accurate soil property maps. Catena or topo-sequence sampling was already discussed in section <a href="sampling-design-for-soil-surveys.html#selection-methods">3.2.1</a>. Covariate space coverage sampling (CSCS) selects sampling points to provide complete spatial coverage of the ROI. <span class="citation">Ma <em>et al.</em> (<a href="#ref-ma2020" role="doc-biblioref">2020</a>)</span> compared the efficiency of SRS, CLHS, and CSCS, being the latter the most efficient.</p>
<p>In addition to the aforementioned methods, there are sampling approaches designed to produce samples that are evenly distributed across the study area, known as spatially balanced designs. These methods ensure that all areas are considered for inclusion in fieldwork, often requiring fewer samples compared to simple random sampling (SRS). Generalized Random Tessellation Stratified (GRTS) sampling <span class="citation">(<a href="#ref-stevens1999" role="doc-biblioref">Stevens and Olsen, 2004</a>)</span> and BAS are two popular approaches within the balanced sampling framework. The rationale behind these methods is that for estimating overall properties over a landscape, such as mean soil carbon, the estimate is most reliable when samples cover all areas of interest. While SRS, GRTS, and BAS are among the many sampling methods available, each with its own set of advantages and disadvantages, selecting the most suitable method can be daunting for field scientists. They often need to choose sites for fieldwork while adhering to constraints such as budget and time. For instance, the GRTS method can be used to provide a spatially balanced, probability sample with design-based, unbiased variance estimators with a minimum sample size.</p>
<pre><code>## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<table>
<caption><span id="tab:design-comparison">Table 3.1: </span>Short description of pros and cons within each soil sampling design type</caption>
<colgroup>
<col width="36%" />
<col width="9%" />
<col width="28%" />
<col width="25%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Sampling Design</th>
<th align="left">Purpose</th>
<th align="left">Pros</th>
<th align="left">Cons</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Simple Random (SR)</td>
<td align="left">Monitoring</td>
<td align="left">Simple, unbiased</td>
<td align="left">May miss rare features</td>
</tr>
<tr class="even">
<td align="left">Stratified Simple Random (SSR)</td>
<td align="left">Monitoring</td>
<td align="left">Better precision per stratum</td>
<td align="left">Requires prior stratification</td>
</tr>
<tr class="odd">
<td align="left">Two-Stage Cluster Random (TSCR)</td>
<td align="left">Monitoring</td>
<td align="left">Cost-effective for large areas</td>
<td align="left">Higher variance</td>
</tr>
<tr class="even">
<td align="left">Conditioned Latin Hypercube (CLH)</td>
<td align="left">Mapping</td>
<td align="left">Environmental representativeness</td>
<td align="left">Complex implementation</td>
</tr>
<tr class="odd">
<td align="left">Catena/Toposequence (CT)</td>
<td align="left">Mapping</td>
<td align="left">Captures terrain relationships</td>
<td align="left">Subjective, labor-intensive</td>
</tr>
<tr class="even">
<td align="left">Covariate Space Coverage (CSC)</td>
<td align="left">Mapping</td>
<td align="left">Most efficient for mapping</td>
<td align="left">Computationally intensive</td>
</tr>
<tr class="odd">
<td align="left">Generalized Tessellation Stratified (GRT)</td>
<td align="left">Both</td>
<td align="left">Spatially balanced</td>
<td align="left">Complex variance estimation</td>
</tr>
<tr class="even">
<td align="left">Balanced Acceptance (BA)</td>
<td align="left">Both</td>
<td align="left">Reduces bias</td>
<td align="left">Requires careful planning</td>
</tr>
</tbody>
</table>
</div>
<div id="soils4africa-example" class="section level3 hasAnchor" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> Example: Soils4Africa Sampling Design<a href="sampling-design-for-soil-surveys.html#soils4africa-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The EU-funded project Soils4Africa<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> aimed to provide open-access information about the condition and spatio-temporal dynamics of African soils, accompanied by a methodology for repeated soil monitoring and mapping across the African continent to support sustainable agriculture in Africa. The projectâ€™s purpose was to monitor and map African Soils. Given this purpose, probability sampling was identified as the most suitable selection method. This method allowed both inference methods, design- and model-based mapping. Once the purpose, selection and inference methods are defined, the final step was to choose the appropriate sampling design, which was a three-stage random sampling. The sampling design was based in a hierarchical sampling method with involves the selection of sampling sites at three scale levels:</p>
<p><strong>Primary Sampling Units (PSUs)</strong>: PSUs constitute the broadest spatial units within the study area, typically defined based on geographical, administrative, ecological boundaries, or soil management types. The size of each PSU is 4 square kilometers (2 Ã— 2 km grid cells). The total number of PSUs selected depends on the sample size and ideally should be sufficient to cover the range of environmental gradients present in the study area.</p>
<p><strong>Secondary Sampling Units (SSUs)</strong>: Within each PSU, a predefined number of SSUs are selected for detailed sampling. SSUs offer a finer resolution level of sampling within each PSU. The size of an SSU is determined based on the need to capture localized environmental conditions and variability. In this case the size of the SSUs is 1 hectare (100 Ã— 100 m grid cells). This approach involves a random selection of 7 SSUs per PSU to ensure a comprehensive coverage of the PSUâ€™s environmental diversity. Four of these SSU are target SSUs and 3 are alternative SSUs to be used as replacement areas due to potential sampling challenges encountered in the field.</p>
<p><strong>Tertiary Sampling Units (TSUs)</strong>: TSUs represent the most detailed level of sampling, focusing on specific points within SSUs. The number of TSUs within each SSU is 3, one which acts as the primary target point and 2 as replacement points for the primary point.</p>
<p>The sampling design in Soils4Africa proceeds as follows: (i) a first selection of PSUs is made using a stratified random sampling on farming systems strata. The farming system classification data comes from the FAO farming systems map for Africa which provides information for 46 different farming classes or stratum. (ii) Within each of the selected PSUs, a second sampling level is done upon a regular division of the PSU into cells of 1 ha, the SSU. For each PSU, 4 random SSUs are selected for sampling and 3 additional cells are stored as alternative cells. These cells are used as replacements in case some of the target SSUs cannot be sampled for some reason. The selection of SSUs is done by simple random sampling within the PSU. (iii) Within each SSU, 3 simple random sampling points are located. The first point serves as the target point to be sampled and the remaining 2 are stored as replacement points to be used as in the previous step. This Hierarchical Sampling design helps reduce bias in the data, allowing for accurate assessments of soil constraints, quantification of risk factors, and reliable evaluations of changes in soil health/quality.</p>
</div>
</div>
<div id="soilfer-design" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> SoilFER Sampling Design<a href="sampling-design-for-soil-surveys.html#soilfer-design" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The SoilFER spatial soil sampling campaign is designed to support both monitoring and mapping objectives by integrating land-use stratification and environmental covariate information within a unified sampling framework. The survey aims to estimate population-level means and totals for a defined set of target soil properties and soil quality indicators across three principal land-use domains, namely croplands (85%), grasslands (10%), and forests (5%), within each participating country. The percentages for each domain are relative to the total sampling points, considering the sampling density required for high-resolution digital soil maps. Once the purpose was defined, the most suitable selection method identified was probability sampling, which allows for both design- and model-based inference methods. Given the purpose, selection and inference methods, the final step was to choose the appropriate sampling design. Like the Soils4Africa project, the SoilFER project employs three sampling units, which are discrete entities in space, and thus a three-stage hierarchical hybrid method incorporating both probability and non-probability sampling was selected for mapping and monitoring within the SoilFER sampling design.</p>
<p>In the literature, covariate space coverage (CSC) sampling has proven to be more efficient than other approaches for mapping a continuous soil property or class <span class="citation">(<a href="#ref-brus2018" role="doc-biblioref">Brus, Kempen and Heuvelink, 2011 b</a>; <a href="#ref-degruijter2006" role="doc-biblioref">Gruijter <em>et al.</em>, 2006</a>; <a href="#ref-ma2020" role="doc-biblioref">Ma <em>et al.</em>, 2020</a>; <a href="#ref-schmidinger2024" role="doc-biblioref">Schmidinger, Heuvelink and Brus, 2024</a>)</span>. Therefore, in the SoilFER sampling design, the first stage or first hierarchical level selects the primary sampling units (PSUs) (i.e., 2km Ã— 2km) using a CSC sampling method, or k-means sampling if you will (i.e., model-based). K-means is an unsupervised clustering method used when no response variable is available, partitioning data into k groups by maximizing similarity within groups and differences between them. Like the selection of PSUs, the second hierarchical level selects the secondary sampling units (SSUs) (i.e., 100m Ã— 100m) using CSC sampling and a second set of environmental covariates (i.e., model-based). Lastly, the third hierarchical levels select the tertiary sampling units using simple random sampling without replacement (i.e., design-based). This multi-stage sampling framework enhances both spatial representativeness and statistical reliability.</p>
<div id="soil-properties" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Soil Properties<a href="sampling-design-for-soil-surveys.html#soil-properties" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Understanding and assessing soil properties are critical for evaluating soil health, guiding fertiliser recommendations, and informing land management decisions. In the SoilFER project, both chemical and physical soil attributes are measured to provide a comprehensive evaluation of soil quality and health (Table <a href="sampling-design-for-soil-surveys.html#tab:soil-properties">3.2</a>). Some key chemical properties include soil organic carbon, pH, cation exchange capacity, and nutrient levels such as nitrogen, phosphorus, and potassium. On the physical side, attributes like soil texture, soil depth, rockiness of surface soil, drainage, surface cracks, soil color, soil erosion and gypsum content are analyzed to understand soil structure, compaction, and water infiltration rates. Collectively, these attributes offer valuable insights into the soilâ€™s ability to support plant growth, resist erosion, and store carbon, making them indispensable for both mapping soil health and tailoring site-specific fertilizer recommendations. While biological indicators are widely recognised as important components of soil health assessment, they are not included in the current survey framework. Their omission reflects considerations related to methodological harmonisation, analytical complexity, and resource allocation within a large-scale, multi-country implementation. Biological measurements often require specialised laboratory protocols, strict sample handling procedures, and advanced analytical infrastructure to ensure comparability across regions. Given the projectâ€™s emphasis on harmonised, scalable, and operationally feasible methodologies, the present design prioritises chemical and physical indicators that can be consistently standardised across participating countries.</p>
<pre><code>## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<table>
<caption><span id="tab:soil-properties">Table 3.2: </span>Some of the chemical and physical soil properties to be quantified in the SoilFER project</caption>
<thead>
<tr class="header">
<th align="left">Category</th>
<th align="left">Property</th>
<th align="left">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Chemical</td>
<td align="left">Soil Organic Carbon</td>
<td align="left">%</td>
</tr>
<tr class="even">
<td align="left">Chemical</td>
<td align="left">pH</td>
<td align="left">pH units</td>
</tr>
<tr class="odd">
<td align="left">Chemical</td>
<td align="left">Cation Exchange Capacity</td>
<td align="left">cmol(+)/kg</td>
</tr>
<tr class="even">
<td align="left">Chemical</td>
<td align="left">Total Nitrogen</td>
<td align="left">%</td>
</tr>
<tr class="odd">
<td align="left">Chemical</td>
<td align="left">Available Phosphorus</td>
<td align="left">mg/kg</td>
</tr>
<tr class="even">
<td align="left">Chemical</td>
<td align="left">Exchangeable Potassium</td>
<td align="left">cmol(+)/kg</td>
</tr>
<tr class="odd">
<td align="left">Chemical</td>
<td align="left">Micronutrients</td>
<td align="left">mg/kg</td>
</tr>
<tr class="even">
<td align="left">Chemical</td>
<td align="left">Electrical Conductivity</td>
<td align="left">dS/m</td>
</tr>
<tr class="odd">
<td align="left">Physical</td>
<td align="left">Soil Texture</td>
<td align="left">% sand/silt/clay</td>
</tr>
<tr class="even">
<td align="left">Physical</td>
<td align="left">Soil Depth</td>
<td align="left">cm</td>
</tr>
<tr class="odd">
<td align="left">Physical</td>
<td align="left">Rockiness</td>
<td align="left">% coverage</td>
</tr>
<tr class="even">
<td align="left">Physical</td>
<td align="left">Drainage</td>
<td align="left">class</td>
</tr>
<tr class="odd">
<td align="left">Physical</td>
<td align="left">Surface Cracks</td>
<td align="left">present/absent</td>
</tr>
<tr class="even">
<td align="left">Physical</td>
<td align="left">Soil Color</td>
<td align="left">Munsell</td>
</tr>
<tr class="odd">
<td align="left">Physical</td>
<td align="left">Erosion</td>
<td align="left">severity class</td>
</tr>
<tr class="even">
<td align="left">Physical</td>
<td align="left">Gypsum Content</td>
<td align="left">%</td>
</tr>
</tbody>
</table>
<div class="warning-box">
<p><strong>Note</strong>: Both wet and dry chemistry (i.e., infrared spectroscopy) will be conducted in the laboratory for soil analysis as part of the SoilFER project. These methods are not listed here, as a standard operating procedure exists for each one of them.</p>
</div>
</div>
<div id="env-covariates" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Environmental Covariates<a href="sampling-design-for-soil-surveys.html#env-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Environmental covariates, also referred to as explanatory or environmental variables or simply covariates, are essential for understanding the spatial variability of soil properties and landscape processes. The SoilFER sampling design incorporates <strong>85 environmental covariates</strong> (Table <a href="sampling-design-for-soil-surveys.html#tab:psu-covariates">3.3</a>) to optimise the identification and allocation of PSUs (2km Ã— 2km) across diverse landscapes at a national scale. As SoilFER targets soil mapping at national scale, the first set of environmental covariates have pixel resolution varying from 250 m to 1 km. To align with the PSU size (2km Ã— 2km), these covariates were upscaled to ensure that each PSU is represented by a single aggregated value per covariate. This resolution provides a balance between sufficient spatial detail and computational efficiency, ensuring accurate large-scale mapping while manageable computational processing requirements, ensuring efficient data handling and analysis. Moreover, this comprehensive set of covariates ensures that the selected PSUs capture the full range of environmental conditions and soil diversity within a country.</p>
<p>Additionally, a second set of <strong>24 environmental covariates</strong> (Table <a href="sampling-design-for-soil-surveys.html#tab:ssu-covariates">3.4</a>) is used to refine site selection at farm level. This high-resolution dataset (e.g., â‰¤ 90 m pixel resolution) was upscaled to match the SSU size (100m Ã— 100m), ensuring that each SSU is characterized by a single representative value for each covariate. This significantly enhances the precision of SSU selection by capturing finer spatial variability. If additional high-resolution environmental covariates are available for a given country, it is highly recommended to incorporate them into the analysis to further improve sampling precision. These two sets of environmental covariates were carefully chosen based on their relevance to soil formation processes, spatial variability, and their role as proxies for key soil properties. Further information on how to retrieve these environmental covariates can be found in the SoilFER GitHub repository.</p>
<pre><code>## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<table>
<caption><span id="tab:psu-covariates">Table 3.3: </span>Environmental covariates used to delineate the primary sampling units</caption>
<colgroup>
<col width="29%" />
<col width="55%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Source</th>
<th align="left">Variable</th>
<th align="left">Resolution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">bio1 â€“ Annual Mean Temperature</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">bio5 â€“ Max Temperature (Warmest Month)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">bio6 â€“ Min Temperature (Coldest Month)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">bio12 â€“ Annual Precipitation</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">bio13 â€“ Precipitation (Wettest Month)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">bio14 â€“ Precipitation (Driest Month)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">bio16 â€“ Precipitation (Wettest Quarter)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">bio17 â€“ Precipitation (Driest Quarter)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">Growing Degree Days</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">Potential Evapotranspiration</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">Surface Wind Speed</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">NDVI (Quarterly Mean/SD)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">FPAR (Quarterly Mean/SD)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">LST Day (Quarterly Mean/SD)</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">CHELSA Climate</td>
<td align="left">Elevation</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">CHELSA Climate</td>
<td align="left">Slope</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Aspect</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Topographic Wetness Index</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Crop Proportion</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Forest Cover</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Grassland Cover</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Temperature Regime</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Moisture Regime</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Annual Water Balance</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="even">
<td align="left">MODIS Vegetation</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“500 m</td>
</tr>
<tr class="odd">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="even">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="odd">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="even">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="odd">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="even">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="odd">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="even">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="odd">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="even">
<td align="left">OpenLandMap Terrain</td>
<td align="left">Additional derived covariate</td>
<td align="left">250 m</td>
</tr>
<tr class="odd">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="even">
<td align="left">Land Cover</td>
<td align="left">Additional derived covariate</td>
<td align="left">250â€“1000 m</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="even">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
<tr class="odd">
<td align="left">Newhall Soil Climate</td>
<td align="left">Additional derived covariate</td>
<td align="left">~4 km</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Note</strong>: NSM, Normalized Soil Moisture; SWIR, Shortwave Infrared. Full list contains 85 variables.</p>
</blockquote>
<pre><code>## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<table>
<caption><span id="tab:ssu-covariates">Table 3.4: </span>Environmental covariates used to delineate the secondary sampling units</caption>
<thead>
<tr class="header">
<th align="left">Source</th>
<th align="left">Variable</th>
<th align="left">Resolution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SRTM Terrain</td>
<td align="left">Elevation</td>
<td align="left">90â€“100 m</td>
</tr>
<tr class="even">
<td align="left">SRTM Terrain</td>
<td align="left">Slope</td>
<td align="left">90â€“100 m</td>
</tr>
<tr class="odd">
<td align="left">SRTM Terrain</td>
<td align="left">Aspect</td>
<td align="left">90â€“100 m</td>
</tr>
<tr class="even">
<td align="left">SRTM Terrain</td>
<td align="left">Topographic Position Index</td>
<td align="left">90â€“100 m</td>
</tr>
<tr class="odd">
<td align="left">SRTM Terrain</td>
<td align="left">Hillshade</td>
<td align="left">90â€“100 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B2 (Blue)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B3 (Green)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B4 (Red)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B5 (Red Edge 1)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B6 (Red Edge 2)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B7 (Red Edge 3)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B8 (NIR)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B8A (NIR Narrow)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B11 (SWIR 1)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Spectral</td>
<td align="left">B12 (SWIR 2)</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Indices</td>
<td align="left">NDVI</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Indices</td>
<td align="left">EVI</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Indices</td>
<td align="left">NDBSI</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Indices</td>
<td align="left">Brightness Index</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Sentinel-2 Indices</td>
<td align="left">Redness Index</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="odd">
<td align="left">Sentinel-2 Indices</td>
<td align="left">VNSIR</td>
<td align="left">10â€“20 m</td>
</tr>
<tr class="even">
<td align="left">Geomorphology</td>
<td align="left">Geomorphon Class</td>
<td align="left">90 m</td>
</tr>
<tr class="odd">
<td align="left">Geomorphology</td>
<td align="left">Landform Type</td>
<td align="left">90 m</td>
</tr>
<tr class="even">
<td align="left">Geomorphology</td>
<td align="left">Terrain Unit</td>
<td align="left">90 m</td>
</tr>
</tbody>
</table>
</div>
<div id="methodology" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Understanding the Methodology<a href="sampling-design-for-soil-surveys.html#methodology" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The SoilFER sampling design methodology follows a hierarchical sampling approach with three levels of increasing spatial resolution: Primary Sampling Units (PSUs), Secondary Sampling Units (SSUs), and Tertiary Sampling Units (TSUs) (Figure <a href="sampling-design-for-soil-surveys.html#fig:three-stage">3.1</a>). This design is similar to the Soils4Africa project but differs in two key aspects. First, we use covariate space coverage (CSC) to select PSUs <span class="citation">(<a href="#ref-brus2022" role="doc-biblioref">Brus, 2022</a>)</span>, whereas Soils4Africa employed stratified random sampling at this stage. At the first hierarchical level, CSC is used to select PSUs (2km Ã— 2km areas), ensuring a well-distributed spread across the covariate space to maximise environmental variation and represent soil diversity across the region at national scale. Second key aspect, we select SSUs using CSC rather than simple random sampling, as done in Soils4Africa. At this second hierarchical level, CSC is applied to select SSUs (100m Ã— 100m) based on a refined set of environmental covariates at farm scale. It is of note that each project adopted a methodology tailored to its specific objectives/purposes, ensuring that the sampling design aligns with its intended goals. Each PSU contains multiple SSUs, each measuring 100m Ã— 100m, and each SSU consists of three TSUs, each measuring 20m Ã— 20m. This structured yet flexible sampling design captures soil variability across different spatial scales (Figure <a href="sampling-design-for-soil-surveys.html#fig:three-stage">3.1</a>).</p>
<div class="figure"><span style="display:block;" id="fig:three-stage"></span>
<img src="images/module2/Fig_1_sampling_design_explained_v7.png" alt="Example of a primary sampling unit with eight secondary sampling units, each containing three tertiary sampling units. Target units or points are in green, and replacements are in red." width="100%" />
<p class="caption">
Figure 3.1: Example of a primary sampling unit with eight secondary sampling units, each containing three tertiary sampling units. Target units or points are in green, and replacements are in red.
</p>
</div>
<div id="psu-selection-process" class="section level4 hasAnchor" number="3.3.3.1">
<h4><span class="header-section-number">3.3.3.1</span> PSU Selection Process<a href="sampling-design-for-soil-surveys.html#psu-selection-process" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The process of selecting the PSUs is summarized as follows:</p>
<p><strong>Step 1: Create 2km Ã— 2km Grid</strong> (Figure <a href="sampling-design-for-soil-surveys.html#fig:grid-creation">3.2</a>) - A 2km Ã— 2km grid covering the entire region of interest (ROI) is created - This grid serves as the foundational structure for stratification and spatial analysis</p>
<p><strong>Step 2: Overlay Land Use and Protected Areas</strong> (Figure <a href="sampling-design-for-soil-surveys.html#fig:grid-overlay">3.3</a>) - Land-use and land cover (LULC) mask layer identifying cropland, forest, or grassland is overlaid - Protected area boundaries are incorporated - Grid cells where cropland, forest, or grassland cover more than 10% (or specified percentage) are retained - This ensures that only PSUs containing target land uses are selected</p>
<p><strong>Step 3: Apply Covariate Space Coverage</strong> (Figure <a href="sampling-design-for-soil-surveys.html#fig:csc-application">3.4</a>) - PSUs are selected through CSC sampling using 85 environmental covariates - Covariates are resampled to 250m resolution - Principal Component Analysis (PCA) transforms covariates into PC layers - PC layers accounting for up to 99% of variance are retained - PC layers are upscaled to 2km Ã— 2km resolution</p>
<p><strong>Step 4: Determine Optimal Sample Size</strong> - Optimal number of PSUs determined using divergence metrics - Kullback-Leibler Divergence (KLD) quantifies how well sampled data represent full environmental covariate space - Unlike Jensen-Shannon methods, KLD does not overestimate optimal sample size <span class="citation">(<a href="#ref-saurette2023" role="doc-biblioref">Saurette <em>et al.</em>, 2023</a>)</span></p>
<p><strong>Step 5: Perform K-means Clustering</strong> - K-means clustering creates homogeneous clusters (strata) - Number of clusters equals total number of PSUs to be sampled - Legacy point data can be incorporated (clusters fixed at legacy locations) - Mean Squared Shortest Distance (MSSD) in covariate space is calculated - Process repeated 10 times, retaining trial with minimum MSSD</p>
<p><strong>Step 6: Select Target and Replacement PSUs</strong> (Figure <a href="sampling-design-for-soil-surveys.html#fig:psu-selection">3.5</a>) - PSUs allocated by minimizing MSSD within environmental covariate space - Output: N PSUs where N equals total number of samples - Replacement PSUs calculated by randomly selecting grid cells within same cluster class</p>
<div class="figure"><span style="display:block;" id="fig:grid-creation"></span>
<img src="images/module2/fig_2_grid_creation.png" alt="A 2Ã—2 km grid is created across the region of interest." width="80%" />
<p class="caption">
Figure 3.2: A 2Ã—2 km grid is created across the region of interest.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:grid-overlay"></span>
<img src="images/module2/fig_3_grid-overlay.png" alt="The grid is overlaid with legacy point data, crop layer data and protected area boundaries." width="80%" />
<p class="caption">
Figure 3.3: The grid is overlaid with legacy point data, crop layer data and protected area boundaries.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:csc-application"></span>
<img src="images/module2/Fig_4_csc-application.png" alt="PSUs located in non-protected areas and containing more than 10% or any specified percentage of crop coverage are selected. The Covariate Space Coverage sampling method, incorporating 85 environmental covariates, is applied to identify target and replacement PSUs." width="80%" />
<p class="caption">
Figure 3.4: PSUs located in non-protected areas and containing more than 10% or any specified percentage of crop coverage are selected. The Covariate Space Coverage sampling method, incorporating 85 environmental covariates, is applied to identify target and replacement PSUs.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:psu-selection"></span>
<img src="images/module2/fig_5_psu-selection.png" alt="The selected target and replacement PSUs." width="80%" />
<p class="caption">
Figure 3.5: The selected target and replacement PSUs.
</p>
</div>
</div>
<div id="ssu-tsu-selection" class="section level4 hasAnchor" number="3.3.3.2">
<h4><span class="header-section-number">3.3.3.2</span> SSU and TSU Selection Process<a href="sampling-design-for-soil-surveys.html#ssu-tsu-selection" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><strong>Stage 2: Secondary Sampling Units (SSUs)</strong></p>
<p>The second stage involves selecting SSUs using Covariate Space Coverage Sampling (CSCS) based on 24 high-resolution environmental covariates. Each SSU represents a 100m Ã— 100m (1 hectare) area divided into 25 regular sampling plots of 20m Ã— 20m (Figure <a href="sampling-design-for-soil-surveys.html#fig:ssu-detail">3.6</a>).</p>
<p><strong>Selection scheme</strong>: - 8 SSUs selected from each PSU - 4 target SSUs (1-4): where samples will be collected<br />
- 4 replacement SSUs (5-8): pre-identified substitutes - Replacement SSUs directly linked to targets (one-to-one basis): - SSU 5 replaces SSU 1 - SSU 6 replaces SSU 2 - SSU 7 replaces SSU 3 - SSU 8 replaces SSU 4</p>
<p>If all SSUs within a target PSU are exhausted, missing SSUs must be selected from the designated PSU replacement. The designated PSU replacements were selected with the same spatial variability as their PSU targets.</p>
<div class="figure"><span style="display:block;" id="fig:ssu-detail"></span>
<img src="images/module2/Fig_6_ssu_detail.png" alt="Single primary sampling unit displaying secondary sampling units (a), and a zoomed-in view of a secondary sampling unit with tertiary sampling units (b)." width="100%" />
<p class="caption">
Figure 3.6: Single primary sampling unit displaying secondary sampling units (a), and a zoomed-in view of a secondary sampling unit with tertiary sampling units (b).
</p>
</div>
<p><strong>Stage 3: Tertiary Sampling Units (TSUs)</strong></p>
<p>The third and final stage involves selecting TSUs using <strong>simple random sampling without replacement</strong>. Each SSU contains 25 possible TSUs of 20m Ã— 20m, corresponding to the pixel size of the crop raster layer.</p>
<p><strong>Selection scheme</strong>: - 3 TSUs per SSU: - 1 target TSU (primary sampling location) - 2 replacement TSUs (alternatives) - If a TSU is unsuitable, any replacement can be used - If all TSUs within an SSU are unsuitable, entire SSU is rejected</p>
<p><strong>Soil sampling protocol</strong>: - Sampling conducted strictly at designated TSU locations - <strong>Maximum shift</strong>: 10 metres from defined coordinates</p>
</div>
<div id="site-id" class="section level4 hasAnchor" number="3.3.3.3">
<h4><span class="header-section-number">3.3.3.3</span> Site Identification System<a href="sampling-design-for-soil-surveys.html#site-id" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The final site ID is an alphanumeric identifier structured as follows (Figure <a href="sampling-design-for-soil-surveys.html#fig:site-id">3.7</a>):</p>
<p><strong>Format</strong>: <code>AAA####-#-#X</code></p>
<p>Where: - <code>AAA</code> = Three-letter country ISO code (e.g., KEN for Kenya) - <code>####</code> = Primary Sampling Unit number (zero-padded, e.g., 0001) - First <code>#</code> = Secondary Sampling Unit number (1-8) - Second <code>#</code> = Tertiary Sampling Unit number (1-3) - <code>X</code> = Land use type code: - <code>C</code> = Cropland - <code>G</code> = Grassland - <code>F</code> = Forest</p>
<p><strong>Example</strong>: <code>KEN0001-1-1C</code> - Country: Kenya - PSU: 1 - SSU: 1 (target) - TSU: 1 (target) - Land use: Cropland</p>
<div class="figure"><span style="display:block;" id="fig:site-id"></span>
<img src="images/module2/Fig_7_site_id.png" alt="Deciphering the site identification." width="60%" />
<p class="caption">
Figure 3.7: Deciphering the site identification.
</p>
</div>
</div>
</div>
</div>
<div id="tutorial" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Tutorial using R<a href="sampling-design-for-soil-surveys.html#tutorial" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This tutorial is designed for users with a basic understanding of R programming and provides a comprehensive guide to implementing a soil sampling design for soil monitoring and mapping. All scripts and data are available at the <a href="https://github.com/FAO-GSP/SoilFER-sampling-design">SoilFER GitHub repository</a>.</p>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: Ensure you have the <code>tinytex</code>, <code>knitr</code>, <code>rmarkdown</code>, and <code>rstudioapi</code> R packages installed to successfully run and render R Markdown documents before running this script. Additionally, install tinytex by running <code>tinytex::install_tinytex()</code> to enable LaTeX support for PDF generation.</p>
</blockquote>
<div id="setup" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Setting Up the Environment<a href="sampling-design-for-soil-surveys.html#setup" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, set the working directory to the location of your R script. This ensures that all paths in the script are relative to the scriptâ€™s location.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="sampling-design-for-soil-surveys.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb136-2"><a href="sampling-design-for-soil-surveys.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to the main folder</span></span>
<span id="cb136-3"><a href="sampling-design-for-soil-surveys.html#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="fu">getwd</span>()</span></code></pre></div>
<div id="install-libraries" class="section level4 hasAnchor" number="3.4.1.1">
<h4><span class="header-section-number">3.4.1.1</span> Install Required Libraries<a href="sampling-design-for-soil-surveys.html#install-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The script uses several R libraries, each serving a specific purpose (Table <a href="sampling-design-for-soil-surveys.html#tab:r-libraries">3.5</a>).</p>
<pre><code>## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<table>
<caption><span id="tab:r-libraries">Table 3.5: </span>Summary of required R libraries and their purposes for SoilFER sampling design</caption>
<thead>
<tr class="header">
<th align="left">Package</th>
<th align="left">Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sp</td>
<td align="left">Spatial data classes</td>
</tr>
<tr class="even">
<td align="left">terra</td>
<td align="left">Raster data manipulation</td>
</tr>
<tr class="odd">
<td align="left">raster</td>
<td align="left">Legacy raster support</td>
</tr>
<tr class="even">
<td align="left">sf</td>
<td align="left">Simple features (vector data)</td>
</tr>
<tr class="odd">
<td align="left">sgsR</td>
<td align="left">Spatial sampling</td>
</tr>
<tr class="even">
<td align="left">entropy</td>
<td align="left">Entropy calculations</td>
</tr>
<tr class="odd">
<td align="left">tripack</td>
<td align="left">Triangulation</td>
</tr>
<tr class="even">
<td align="left">tibble</td>
<td align="left">Data frames</td>
</tr>
<tr class="odd">
<td align="left">manipulate</td>
<td align="left">Interactive plotting</td>
</tr>
<tr class="even">
<td align="left">dplyr</td>
<td align="left">Data manipulation</td>
</tr>
<tr class="odd">
<td align="left">synoptReg</td>
<td align="left">PCA for rasters</td>
</tr>
<tr class="even">
<td align="left">doSNOW</td>
<td align="left">Parallel processing</td>
</tr>
<tr class="odd">
<td align="left">Rfast</td>
<td align="left">Fast R functions</td>
</tr>
<tr class="even">
<td align="left">fields</td>
<td align="left">Distance calculations</td>
</tr>
<tr class="odd">
<td align="left">ggplot2</td>
<td align="left">Visualization</td>
</tr>
<tr class="even">
<td align="left">rassta</td>
<td align="left">Terrain analysis</td>
</tr>
</tbody>
</table>
<p>Some libraries might need to be installed from GitHub. Uncomment and run the lines below if needed:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="sampling-design-for-soil-surveys.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install synoptReg package from GitHub</span></span>
<span id="cb138-2"><a href="sampling-design-for-soil-surveys.html#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;remotes&quot;) # Install remotes if not installed</span></span>
<span id="cb138-3"><a href="sampling-design-for-soil-surveys.html#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb138-4"><a href="sampling-design-for-soil-surveys.html#cb138-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-5"><a href="sampling-design-for-soil-surveys.html#cb138-5" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;raster&quot;</span>, <span class="st">&quot;sf&quot;</span>, <span class="st">&quot;sgsR&quot;</span>, <span class="st">&quot;entropy&quot;</span>, </span>
<span id="cb138-6"><a href="sampling-design-for-soil-surveys.html#cb138-6" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;tripack&quot;</span>, <span class="st">&quot;tibble&quot;</span>, <span class="st">&quot;manipulate&quot;</span>, <span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;synoptReg&quot;</span>, </span>
<span id="cb138-7"><a href="sampling-design-for-soil-surveys.html#cb138-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;doSNOW&quot;</span>, <span class="st">&quot;Rfast&quot;</span>, <span class="st">&quot;fields&quot;</span>, <span class="st">&quot;ggplot2&quot;</span>, <span class="st">&quot;rassta&quot;</span>)</span>
<span id="cb138-8"><a href="sampling-design-for-soil-surveys.html#cb138-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-9"><a href="sampling-design-for-soil-surveys.html#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb138-10"><a href="sampling-design-for-soil-surveys.html#cb138-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-11"><a href="sampling-design-for-soil-surveys.html#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(packages)</span></code></pre></div>
<blockquote>
<p><strong>Alternative method</strong>: In RStudio, use the <strong>Packages</strong> tab in the bottom-right pane â†’ click <strong>Install</strong> â†’ type package name â†’ ensure â€œInstall dependenciesâ€ is checked â†’ click <strong>Install</strong>.</p>
</blockquote>
</div>
</div>
<div id="define-parameters" class="section level3 hasAnchor" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> Define Variables and Parameters<a href="sampling-design-for-soil-surveys.html#define-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Several variables and parameters must be defined to establish a consistent framework for the script.</p>
</div>
<div id="country-iso-code" class="section level3 hasAnchor" number="3.4.3">
<h3><span class="header-section-number">3.4.3</span> Country ISO Code<a href="sampling-design-for-soil-surveys.html#country-iso-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="sampling-design-for-soil-surveys.html#cb139-1" aria-hidden="true" tabindex="-1"></a>ISO.code <span class="ot">&lt;-</span> <span class="st">&quot;ZMB&quot;</span>  <span class="co"># Zambia example</span></span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: Use the Alpha-3 ISO code for your country of interest.</p>
</blockquote>
<div id="land-use-type" class="section level4 hasAnchor" number="3.4.3.1">
<h4><span class="header-section-number">3.4.3.1</span> Land Use Type<a href="sampling-design-for-soil-surveys.html#land-use-type" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The SoilFER project focuses on three primary land-use types: croplands (80%), grasslands (15%), and forests (5%).</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="sampling-design-for-soil-surveys.html#cb140-1" aria-hidden="true" tabindex="-1"></a>landuse <span class="ot">&lt;-</span> <span class="st">&quot;crops&quot;</span>  <span class="co"># Options: &quot;crops&quot;, &quot;grassland&quot;, &quot;forest&quot;</span></span></code></pre></div>
</div>
<div id="file-paths" class="section level4 hasAnchor" number="3.4.3.2">
<h4><span class="header-section-number">3.4.3.2</span> File Paths<a href="sampling-design-for-soil-surveys.html#file-paths" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="sampling-design-for-soil-surveys.html#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to data folders</span></span>
<span id="cb141-2"><a href="sampling-design-for-soil-surveys.html#cb141-2" aria-hidden="true" tabindex="-1"></a>raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb141-3"><a href="sampling-design-for-soil-surveys.html#cb141-3" aria-hidden="true" tabindex="-1"></a>shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb141-4"><a href="sampling-design-for-soil-surveys.html#cb141-4" aria-hidden="true" tabindex="-1"></a>other.path <span class="ot">&lt;-</span> <span class="st">&quot;data/other/&quot;</span></span>
<span id="cb141-5"><a href="sampling-design-for-soil-surveys.html#cb141-5" aria-hidden="true" tabindex="-1"></a>landuse_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/results/&quot;</span>, landuse, <span class="st">&quot;/&quot;</span>)</span>
<span id="cb141-6"><a href="sampling-design-for-soil-surveys.html#cb141-6" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb141-7"><a href="sampling-design-for-soil-surveys.html#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if landuse directory exists; if not, create it</span></span>
<span id="cb141-8"><a href="sampling-design-for-soil-surveys.html#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(landuse_dir)) {</span>
<span id="cb141-9"><a href="sampling-design-for-soil-surveys.html#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(landuse_dir)</span>
<span id="cb141-10"><a href="sampling-design-for-soil-surveys.html#cb141-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb141-11"><a href="sampling-design-for-soil-surveys.html#cb141-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-12"><a href="sampling-design-for-soil-surveys.html#cb141-12" aria-hidden="true" tabindex="-1"></a>results.path <span class="ot">&lt;-</span> landuse_dir</span></code></pre></div>
</div>
<div id="coordinate-reference-system" class="section level4 hasAnchor" number="3.4.3.3">
<h4><span class="header-section-number">3.4.3.3</span> Coordinate Reference System<a href="sampling-design-for-soil-surveys.html#coordinate-reference-system" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="sampling-design-for-soil-surveys.html#cb142-1" aria-hidden="true" tabindex="-1"></a>epsg <span class="ot">&lt;-</span> <span class="st">&quot;EPSG:3857&quot;</span>  <span class="co"># WGS 84 / Pseudo-Mercator</span></span>
<span id="cb142-2"><a href="sampling-design-for-soil-surveys.html#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Find your CRS at: https://epsg.io/</span></span></code></pre></div>
</div>
<div id="sample-size-calculation" class="section level4 hasAnchor" number="3.4.3.4">
<h4><span class="header-section-number">3.4.3.4</span> Sample Size Calculation<a href="sampling-design-for-soil-surveys.html#sample-size-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="sampling-design-for-soil-surveys.html#cb143-1" aria-hidden="true" tabindex="-1"></a>nsamples <span class="ot">&lt;-</span> <span class="dv">300</span>  <span class="co"># Total sampling sites</span></span>
<span id="cb143-2"><a href="sampling-design-for-soil-surveys.html#cb143-2" aria-hidden="true" tabindex="-1"></a>share <span class="ot">&lt;-</span> <span class="fl">0.80</span>    <span class="co"># 80% for this land use (croplands)</span></span>
<span id="cb143-3"><a href="sampling-design-for-soil-surveys.html#cb143-3" aria-hidden="true" tabindex="-1"></a>nsites <span class="ot">&lt;-</span> nsamples <span class="sc">*</span> share  <span class="co"># Final number of sites</span></span>
<span id="cb143-4"><a href="sampling-design-for-soil-surveys.html#cb143-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-5"><a href="sampling-design-for-soil-surveys.html#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co"># However, we will calculate the optimal sample size statistically later</span></span></code></pre></div>
</div>
<div id="sampling-unit-definitions" class="section level4 hasAnchor" number="3.4.3.5">
<h4><span class="header-section-number">3.4.3.5</span> Sampling Unit Definitions<a href="sampling-design-for-soil-surveys.html#sampling-unit-definitions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="sampling-design-for-soil-surveys.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of PSUs to sample</span></span>
<span id="cb144-2"><a href="sampling-design-for-soil-surveys.html#cb144-2" aria-hidden="true" tabindex="-1"></a>n.psu <span class="ot">&lt;-</span> <span class="fu">round</span>(nsamples<span class="sc">/</span><span class="dv">8</span>)  <span class="co"># Will be optimized later</span></span>
<span id="cb144-3"><a href="sampling-design-for-soil-surveys.html#cb144-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-4"><a href="sampling-design-for-soil-surveys.html#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define PSU and SSU sizes </span></span>
<span id="cb144-5"><a href="sampling-design-for-soil-surveys.html#cb144-5" aria-hidden="true" tabindex="-1"></a>psu_size <span class="ot">&lt;-</span> <span class="dv">2000</span>  <span class="co"># 2km Ã— 2 km</span></span>
<span id="cb144-6"><a href="sampling-design-for-soil-surveys.html#cb144-6" aria-hidden="true" tabindex="-1"></a>ssu_size <span class="ot">&lt;-</span> <span class="dv">100</span>   <span class="co"># 100m Ã— 100m = 1 ha</span></span>
<span id="cb144-7"><a href="sampling-design-for-soil-surveys.html#cb144-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-8"><a href="sampling-design-for-soil-surveys.html#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define number of target and alternative SSUs at each PSU</span></span>
<span id="cb144-9"><a href="sampling-design-for-soil-surveys.html#cb144-9" aria-hidden="true" tabindex="-1"></a>num_primary_ssus <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb144-10"><a href="sampling-design-for-soil-surveys.html#cb144-10" aria-hidden="true" tabindex="-1"></a>num_alternative_ssus <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb144-11"><a href="sampling-design-for-soil-surveys.html#cb144-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-12"><a href="sampling-design-for-soil-surveys.html#cb144-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define number of TSUs at each SSU</span></span>
<span id="cb144-13"><a href="sampling-design-for-soil-surveys.html#cb144-13" aria-hidden="true" tabindex="-1"></a>number_TSUs <span class="ot">&lt;-</span> <span class="dv">3</span></span></code></pre></div>
</div>
<div id="algorithm-parameters" class="section level4 hasAnchor" number="3.4.3.6">
<h4><span class="header-section-number">3.4.3.6</span> Algorithm Parameters<a href="sampling-design-for-soil-surveys.html#algorithm-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="sampling-design-for-soil-surveys.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of iterations for clustering algorithm</span></span>
<span id="cb145-2"><a href="sampling-design-for-soil-surveys.html#cb145-2" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># 10 is sufficient</span></span>
<span id="cb145-3"><a href="sampling-design-for-soil-surveys.html#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="sampling-design-for-soil-surveys.html#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum crop percentage in selected PSUs</span></span>
<span id="cb145-5"><a href="sampling-design-for-soil-surveys.html#cb145-5" aria-hidden="true" tabindex="-1"></a>percent_crop <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># At least 10% crop coverage</span></span></code></pre></div>
</div>
</div>
<div id="custom-functions" class="section level3 hasAnchor" number="3.4.4">
<h3><span class="header-section-number">3.4.4</span> Custom Functions<a href="sampling-design-for-soil-surveys.html#custom-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="covariate-space-coverage-function-csis" class="section level4 hasAnchor" number="3.4.4.1">
<h4><span class="header-section-number">3.4.4.1</span> Covariate Space Coverage Function (CSIS)<a href="sampling-design-for-soil-surveys.html#covariate-space-coverage-function-csis" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The CSIS function is the backbone of clustering sampling units in covariate space. It ensures optimal distribution while considering any fixed legacy data.</p>
<p><strong>How it works</strong>:</p>
<ol style="list-style-type: decimal">
<li><strong>Input Parameters</strong>:
<ul>
<li><code>fixed</code>: Preselected (legacy) sampling points</li>
<li><code>nsup</code>: Number of additional (new) sampling points to select</li>
<li><code>nstarts</code>: Number of random starting points for clustering</li>
<li><code>mygrd</code>: Grid of covariate data for ROI</li>
</ul></li>
<li><strong>Workflow</strong>:
<ul>
<li>Extract fixed points and exclude from grid</li>
<li>Randomly initialize new sampling points</li>
<li>Combine fixed and new centers</li>
<li>Compute distances and assign points to nearest cluster</li>
<li>Update cluster centers iteratively until convergence</li>
<li>Calculate Mean Squared Shortest Distance (MSSSD)</li>
<li>Save best clustering result</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="sampling-design-for-soil-surveys.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clustering CSC function with fixed legacy data</span></span>
<span id="cb146-2"><a href="sampling-design-for-soil-surveys.html#cb146-2" aria-hidden="true" tabindex="-1"></a>CSIS <span class="ot">&lt;-</span> <span class="cf">function</span>(fixed, nsup, nstarts, mygrd) {</span>
<span id="cb146-3"><a href="sampling-design-for-soil-surveys.html#cb146-3" aria-hidden="true" tabindex="-1"></a>  n_fix <span class="ot">&lt;-</span> <span class="fu">nrow</span>(fixed)</span>
<span id="cb146-4"><a href="sampling-design-for-soil-surveys.html#cb146-4" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(mygrd)</span>
<span id="cb146-5"><a href="sampling-design-for-soil-surveys.html#cb146-5" aria-hidden="true" tabindex="-1"></a>  units <span class="ot">&lt;-</span> fixed<span class="sc">$</span>units</span>
<span id="cb146-6"><a href="sampling-design-for-soil-surveys.html#cb146-6" aria-hidden="true" tabindex="-1"></a>  mygrd_minfx <span class="ot">&lt;-</span> mygrd[<span class="sc">-</span>units, ]</span>
<span id="cb146-7"><a href="sampling-design-for-soil-surveys.html#cb146-7" aria-hidden="true" tabindex="-1"></a>  MSSSD_cur <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb146-8"><a href="sampling-design-for-soil-surveys.html#cb146-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-9"><a href="sampling-design-for-soil-surveys.html#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nstarts) {</span>
<span id="cb146-10"><a href="sampling-design-for-soil-surveys.html#cb146-10" aria-hidden="true" tabindex="-1"></a>    units <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(mygrd_minfx), nsup)</span>
<span id="cb146-11"><a href="sampling-design-for-soil-surveys.html#cb146-11" aria-hidden="true" tabindex="-1"></a>    centers_sup <span class="ot">&lt;-</span> mygrd_minfx[units, ]</span>
<span id="cb146-12"><a href="sampling-design-for-soil-surveys.html#cb146-12" aria-hidden="true" tabindex="-1"></a>    centers <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fixed[, <span class="fu">names</span>(mygrd)], centers_sup)</span>
<span id="cb146-13"><a href="sampling-design-for-soil-surveys.html#cb146-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-14"><a href="sampling-design-for-soil-surveys.html#cb146-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb146-15"><a href="sampling-design-for-soil-surveys.html#cb146-15" aria-hidden="true" tabindex="-1"></a>      D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> centers, <span class="at">x2 =</span> mygrd)</span>
<span id="cb146-16"><a href="sampling-design-for-soil-surveys.html#cb146-16" aria-hidden="true" tabindex="-1"></a>      cluster <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="at">X =</span> D, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> which.min) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>(.)</span>
<span id="cb146-17"><a href="sampling-design-for-soil-surveys.html#cb146-17" aria-hidden="true" tabindex="-1"></a>      centers_cur <span class="ot">&lt;-</span> centers</span>
<span id="cb146-18"><a href="sampling-design-for-soil-surveys.html#cb146-18" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb146-19"><a href="sampling-design-for-soil-surveys.html#cb146-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb146-20"><a href="sampling-design-for-soil-surveys.html#cb146-20" aria-hidden="true" tabindex="-1"></a>        centers[, i] <span class="ot">&lt;-</span> <span class="fu">tapply</span>(mygrd[, i], <span class="at">INDEX =</span> cluster, <span class="at">FUN =</span> mean)</span>
<span id="cb146-21"><a href="sampling-design-for-soil-surveys.html#cb146-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb146-22"><a href="sampling-design-for-soil-surveys.html#cb146-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb146-23"><a href="sampling-design-for-soil-surveys.html#cb146-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Restore fixed centers</span></span>
<span id="cb146-24"><a href="sampling-design-for-soil-surveys.html#cb146-24" aria-hidden="true" tabindex="-1"></a>      centers[<span class="dv">1</span><span class="sc">:</span>n_fix, ] <span class="ot">&lt;-</span> centers_cur[<span class="dv">1</span><span class="sc">:</span>n_fix, ]</span>
<span id="cb146-25"><a href="sampling-design-for-soil-surveys.html#cb146-25" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb146-26"><a href="sampling-design-for-soil-surveys.html#cb146-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check convergence</span></span>
<span id="cb146-27"><a href="sampling-design-for-soil-surveys.html#cb146-27" aria-hidden="true" tabindex="-1"></a>      sumd <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">rdist</span>(<span class="at">x1 =</span> centers, <span class="at">x2 =</span> centers_cur)) <span class="sc">%&gt;%</span> <span class="fu">sum</span>(.)</span>
<span id="cb146-28"><a href="sampling-design-for-soil-surveys.html#cb146-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (sumd <span class="sc">&lt;</span> <span class="fl">1E-12</span>) {</span>
<span id="cb146-29"><a href="sampling-design-for-soil-surveys.html#cb146-29" aria-hidden="true" tabindex="-1"></a>        D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> centers, <span class="at">x2 =</span> mygrd)</span>
<span id="cb146-30"><a href="sampling-design-for-soil-surveys.html#cb146-30" aria-hidden="true" tabindex="-1"></a>        Dmin <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="at">X =</span> D, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> min)</span>
<span id="cb146-31"><a href="sampling-design-for-soil-surveys.html#cb146-31" aria-hidden="true" tabindex="-1"></a>        MSSSD <span class="ot">&lt;-</span> <span class="fu">mean</span>(Dmin<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb146-32"><a href="sampling-design-for-soil-surveys.html#cb146-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb146-33"><a href="sampling-design-for-soil-surveys.html#cb146-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (s <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> MSSSD <span class="sc">&lt;</span> MSSSD_cur) {</span>
<span id="cb146-34"><a href="sampling-design-for-soil-surveys.html#cb146-34" aria-hidden="true" tabindex="-1"></a>          centers_best <span class="ot">&lt;-</span> centers</span>
<span id="cb146-35"><a href="sampling-design-for-soil-surveys.html#cb146-35" aria-hidden="true" tabindex="-1"></a>          clusters_best <span class="ot">&lt;-</span> cluster</span>
<span id="cb146-36"><a href="sampling-design-for-soil-surveys.html#cb146-36" aria-hidden="true" tabindex="-1"></a>          MSSSD_cur <span class="ot">&lt;-</span> MSSSD</span>
<span id="cb146-37"><a href="sampling-design-for-soil-surveys.html#cb146-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb146-38"><a href="sampling-design-for-soil-surveys.html#cb146-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb146-39"><a href="sampling-design-for-soil-surveys.html#cb146-39" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb146-40"><a href="sampling-design-for-soil-surveys.html#cb146-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb146-41"><a href="sampling-design-for-soil-surveys.html#cb146-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-42"><a href="sampling-design-for-soil-surveys.html#cb146-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(s, <span class="st">&quot; out of &quot;</span>, nstarts))</span>
<span id="cb146-43"><a href="sampling-design-for-soil-surveys.html#cb146-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-44"><a href="sampling-design-for-soil-surveys.html#cb146-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-45"><a href="sampling-design-for-soil-surveys.html#cb146-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">centers =</span> centers_best, <span class="at">cluster =</span> clusters_best)</span>
<span id="cb146-46"><a href="sampling-design-for-soil-surveys.html#cb146-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: This function creates spatially balanced sampling designs by considering existing sampling points and covariate distributions.</p>
</blockquote>
</div>
<div id="tsu-generation-function" class="section level4 hasAnchor" number="3.4.4.2">
<h4><span class="header-section-number">3.4.4.2</span> TSU Generation Function<a href="sampling-design-for-soil-surveys.html#tsu-generation-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function generates TSUs within SSUs, ensuring random distribution while respecting land-use constraints.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="sampling-design-for-soil-surveys.html#cb147-1" aria-hidden="true" tabindex="-1"></a>generate_tsu_points_within_ssu <span class="ot">&lt;-</span> <span class="cf">function</span>(ssu, number_TSUs, index, ssu_type, crops) {</span>
<span id="cb147-2"><a href="sampling-design-for-soil-surveys.html#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert SSU to SpatVector for masking</span></span>
<span id="cb147-3"><a href="sampling-design-for-soil-surveys.html#cb147-3" aria-hidden="true" tabindex="-1"></a>  ssu_vect <span class="ot">&lt;-</span> ssu_grid_sf[index, ]</span>
<span id="cb147-4"><a href="sampling-design-for-soil-surveys.html#cb147-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-5"><a href="sampling-design-for-soil-surveys.html#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clip the raster to the SSU boundaries</span></span>
<span id="cb147-6"><a href="sampling-design-for-soil-surveys.html#cb147-6" aria-hidden="true" tabindex="-1"></a>  clipped_lu <span class="ot">&lt;-</span> <span class="fu">crop</span>(crops, ssu_vect)</span>
<span id="cb147-7"><a href="sampling-design-for-soil-surveys.html#cb147-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-8"><a href="sampling-design-for-soil-surveys.html#cb147-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate random points within the clipped raster</span></span>
<span id="cb147-9"><a href="sampling-design-for-soil-surveys.html#cb147-9" aria-hidden="true" tabindex="-1"></a>  sampled_points <span class="ot">&lt;-</span> <span class="fu">sample_srs</span>(clipped_lu, <span class="at">nSamp =</span> number_TSUs)</span>
<span id="cb147-10"><a href="sampling-design-for-soil-surveys.html#cb147-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-11"><a href="sampling-design-for-soil-surveys.html#cb147-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure required number of TSUs</span></span>
<span id="cb147-12"><a href="sampling-design-for-soil-surveys.html#cb147-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="fu">nrow</span>(sampled_points) <span class="sc">&lt;</span> number_TSUs) {</span>
<span id="cb147-13"><a href="sampling-design-for-soil-surveys.html#cb147-13" aria-hidden="true" tabindex="-1"></a>    sampled_points <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(clipped_lu, <span class="at">size =</span> number_TSUs)</span>
<span id="cb147-14"><a href="sampling-design-for-soil-surveys.html#cb147-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-15"><a href="sampling-design-for-soil-surveys.html#cb147-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-16"><a href="sampling-design-for-soil-surveys.html#cb147-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add metadata</span></span>
<span id="cb147-17"><a href="sampling-design-for-soil-surveys.html#cb147-17" aria-hidden="true" tabindex="-1"></a>  sampled_points<span class="sc">$</span>PSU_ID <span class="ot">&lt;-</span> selected_psu<span class="sc">$</span>ID</span>
<span id="cb147-18"><a href="sampling-design-for-soil-surveys.html#cb147-18" aria-hidden="true" tabindex="-1"></a>  sampled_points<span class="sc">$</span>SSU_ID <span class="ot">&lt;-</span> index</span>
<span id="cb147-19"><a href="sampling-design-for-soil-surveys.html#cb147-19" aria-hidden="true" tabindex="-1"></a>  sampled_points<span class="sc">$</span>TSU_ID <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(sampled_points))</span>
<span id="cb147-20"><a href="sampling-design-for-soil-surveys.html#cb147-20" aria-hidden="true" tabindex="-1"></a>  sampled_points<span class="sc">$</span>SSU_Type <span class="ot">&lt;-</span> ssu_type</span>
<span id="cb147-21"><a href="sampling-design-for-soil-surveys.html#cb147-21" aria-hidden="true" tabindex="-1"></a>  sampled_points<span class="sc">$</span>TSU_Name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(ISO.code, <span class="fu">sprintf</span>(<span class="st">&quot;%04d&quot;</span>, sampled_points<span class="sc">$</span>PSU_ID),</span>
<span id="cb147-22"><a href="sampling-design-for-soil-surveys.html#cb147-22" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;-&quot;</span>, sampled_points<span class="sc">$</span>SSU_ID, <span class="st">&quot;-&quot;</span>, </span>
<span id="cb147-23"><a href="sampling-design-for-soil-surveys.html#cb147-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(sampled_points)))</span>
<span id="cb147-24"><a href="sampling-design-for-soil-surveys.html#cb147-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-25"><a href="sampling-design-for-soil-surveys.html#cb147-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sampled_points)</span>
<span id="cb147-26"><a href="sampling-design-for-soil-surveys.html#cb147-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="load-boundaries" class="section level3 hasAnchor" number="3.4.5">
<h3><span class="header-section-number">3.4.5</span> Load Country Boundaries and Legacy Data<a href="sampling-design-for-soil-surveys.html#load-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Load and transform country boundaries and legacy soil data to the desired CRS:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="sampling-design-for-soil-surveys.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define file locations</span></span>
<span id="cb148-2"><a href="sampling-design-for-soil-surveys.html#cb148-2" aria-hidden="true" tabindex="-1"></a>country_boundaries <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;roi_epsg_3857.shp&quot;</span>))</span>
<span id="cb148-3"><a href="sampling-design-for-soil-surveys.html#cb148-3" aria-hidden="true" tabindex="-1"></a>legacy <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;zmb_legacy_v2_clipped_epsg_3857.shp&quot;</span>))</span>
<span id="cb148-4"><a href="sampling-design-for-soil-surveys.html#cb148-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-5"><a href="sampling-design-for-soil-surveys.html#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and transform country boundaries</span></span>
<span id="cb148-6"><a href="sampling-design-for-soil-surveys.html#cb148-6" aria-hidden="true" tabindex="-1"></a>country_boundaries <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(country_boundaries, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb148-7"><a href="sampling-design-for-soil-surveys.html#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="sampling-design-for-soil-surveys.html#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(country_boundaries)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb148-9"><a href="sampling-design-for-soil-surveys.html#cb148-9" aria-hidden="true" tabindex="-1"></a>  country_boundaries <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(country_boundaries, <span class="at">crs =</span> epsg)</span>
<span id="cb148-10"><a href="sampling-design-for-soil-surveys.html#cb148-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-11"><a href="sampling-design-for-soil-surveys.html#cb148-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-12"><a href="sampling-design-for-soil-surveys.html#cb148-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load legacy data (if it exists)</span></span>
<span id="cb148-13"><a href="sampling-design-for-soil-surveys.html#cb148-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(legacy)) {</span>
<span id="cb148-14"><a href="sampling-design-for-soil-surveys.html#cb148-14" aria-hidden="true" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(legacy, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb148-15"><a href="sampling-design-for-soil-surveys.html#cb148-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-16"><a href="sampling-design-for-soil-surveys.html#cb148-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform coordinates</span></span>
<span id="cb148-17"><a href="sampling-design-for-soil-surveys.html#cb148-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(legacy)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb148-18"><a href="sampling-design-for-soil-surveys.html#cb148-18" aria-hidden="true" tabindex="-1"></a>    legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(legacy, <span class="at">crs =</span> epsg)</span>
<span id="cb148-19"><a href="sampling-design-for-soil-surveys.html#cb148-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-20"><a href="sampling-design-for-soil-surveys.html#cb148-20" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb148-21"><a href="sampling-design-for-soil-surveys.html#cb148-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If legacy data does not exist, delete the object</span></span>
<span id="cb148-22"><a href="sampling-design-for-soil-surveys.html#cb148-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(legacy)</span>
<span id="cb148-23"><a href="sampling-design-for-soil-surveys.html#cb148-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: Always verify that all geospatial datasets use the same CRS before performing spatial operations. Misaligned CRSs can lead to incorrect analyses.</p>
</blockquote>
<div id="visualize-boundaries-and-legacy-data" class="section level4 hasAnchor" number="3.4.5.1">
<h4><span class="header-section-number">3.4.5.1</span> Visualize Boundaries and Legacy Data<a href="sampling-design-for-soil-surveys.html#visualize-boundaries-and-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="sampling-design-for-soil-surveys.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb149-2"><a href="sampling-design-for-soil-surveys.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb149-3"><a href="sampling-design-for-soil-surveys.html#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="sampling-design-for-soil-surveys.html#cb149-4" aria-hidden="true" tabindex="-1"></a>basemap <span class="ot">&lt;-</span> <span class="fu">annotation_map_tile</span>(<span class="st">&quot;osm&quot;</span>)</span>
<span id="cb149-5"><a href="sampling-design-for-soil-surveys.html#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="sampling-design-for-soil-surveys.html#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> country_boundaries) <span class="sc">+</span></span>
<span id="cb149-7"><a href="sampling-design-for-soil-surveys.html#cb149-7" aria-hidden="true" tabindex="-1"></a>  basemap <span class="sc">+</span></span>
<span id="cb149-8"><a href="sampling-design-for-soil-surveys.html#cb149-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb149-9"><a href="sampling-design-for-soil-surveys.html#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> legacy, <span class="fu">aes</span>(<span class="at">geometry =</span> geometry),</span>
<span id="cb149-10"><a href="sampling-design-for-soil-surveys.html#cb149-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb149-11"><a href="sampling-design-for-soil-surveys.html#cb149-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Country Boundaries and Legacy Data&quot;</span>,</span>
<span id="cb149-12"><a href="sampling-design-for-soil-surveys.html#cb149-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Data source: OpenStreetMap&quot;</span>) <span class="sc">+</span></span>
<span id="cb149-13"><a href="sampling-design-for-soil-surveys.html#cb149-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb149-14"><a href="sampling-design-for-soil-surveys.html#cb149-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code></pre></div>
</div>
</div>
<div id="load-covariates-psu" class="section level3 hasAnchor" number="3.4.6">
<h3><span class="header-section-number">3.4.6</span> Load Environmental Covariates for PSUs<a href="sampling-design-for-soil-surveys.html#load-covariates-psu" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="optional-auxiliary-data" class="section level4 hasAnchor" number="3.4.6.1">
<h4><span class="header-section-number">3.4.6.1</span> Optional Auxiliary Data<a href="sampling-design-for-soil-surveys.html#optional-auxiliary-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Additional data layers can improve PSU selection:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="sampling-design-for-soil-surveys.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-protected areas (shapefile or raster)</span></span>
<span id="cb150-2"><a href="sampling-design-for-soil-surveys.html#cb150-2" aria-hidden="true" tabindex="-1"></a>npa <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;zmb_national_parks_zari_clipped_epsg_3857.shp&quot;</span>))</span>
<span id="cb150-3"><a href="sampling-design-for-soil-surveys.html#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="sampling-design-for-soil-surveys.html#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="co"># High slopes (binary raster: 1 = &lt;50%, NA = &gt;=50%)</span></span>
<span id="cb150-5"><a href="sampling-design-for-soil-surveys.html#cb150-5" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;zmb_clipped_slope_mask_epsg_3857.tif&quot;</span>)) </span>
<span id="cb150-6"><a href="sampling-design-for-soil-surveys.html#cb150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-7"><a href="sampling-design-for-soil-surveys.html#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Geology</span></span>
<span id="cb150-8"><a href="sampling-design-for-soil-surveys.html#cb150-8" aria-hidden="true" tabindex="-1"></a>geo <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path, <span class="st">&quot;zmb_geology_clipped_epsg_3857.shp&quot;</span>))</span>
<span id="cb150-9"><a href="sampling-design-for-soil-surveys.html#cb150-9" aria-hidden="true" tabindex="-1"></a>geo.classes <span class="ot">&lt;-</span> <span class="st">&quot;GEO&quot;</span>  <span class="co"># Field name for geologic classes</span></span>
<span id="cb150-10"><a href="sampling-design-for-soil-surveys.html#cb150-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-11"><a href="sampling-design-for-soil-surveys.html#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Geomorphology</span></span>
<span id="cb150-12"><a href="sampling-design-for-soil-surveys.html#cb150-12" aria-hidden="true" tabindex="-1"></a>geomorph <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;zmb_clipped_Geomorphon.tif&quot;</span>))</span>
<span id="cb150-13"><a href="sampling-design-for-soil-surveys.html#cb150-13" aria-hidden="true" tabindex="-1"></a>geomorph.classes <span class="ot">&lt;-</span> <span class="st">&quot;CODR&quot;</span>  <span class="co"># Field name for geomorphology classes</span></span></code></pre></div>
</div>
<div id="load-and-process-auxiliary-data" class="section level4 hasAnchor" number="3.4.6.2">
<h4><span class="header-section-number">3.4.6.2</span> Load and Process Auxiliary Data<a href="sampling-design-for-soil-surveys.html#load-and-process-auxiliary-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="sampling-design-for-soil-surveys.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-protected areas</span></span>
<span id="cb151-2"><a href="sampling-design-for-soil-surveys.html#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(npa)) {</span>
<span id="cb151-3"><a href="sampling-design-for-soil-surveys.html#cb151-3" aria-hidden="true" tabindex="-1"></a>  npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(npa, <span class="at">quiet =</span> <span class="cn">FALSE</span>)</span>
<span id="cb151-4"><a href="sampling-design-for-soil-surveys.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_union</span>(npa)</span>
<span id="cb151-5"><a href="sampling-design-for-soil-surveys.html#cb151-5" aria-hidden="true" tabindex="-1"></a>  npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_difference</span>(country_boundaries, npa)</span>
<span id="cb151-6"><a href="sampling-design-for-soil-surveys.html#cb151-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-7"><a href="sampling-design-for-soil-surveys.html#cb151-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(npa)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb151-8"><a href="sampling-design-for-soil-surveys.html#cb151-8" aria-hidden="true" tabindex="-1"></a>    npa <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(npa, <span class="at">crs =</span> epsg)</span>
<span id="cb151-9"><a href="sampling-design-for-soil-surveys.html#cb151-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-10"><a href="sampling-design-for-soil-surveys.html#cb151-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb151-11"><a href="sampling-design-for-soil-surveys.html#cb151-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(npa)</span>
<span id="cb151-12"><a href="sampling-design-for-soil-surveys.html#cb151-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb151-13"><a href="sampling-design-for-soil-surveys.html#cb151-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-14"><a href="sampling-design-for-soil-surveys.html#cb151-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Slope mask</span></span>
<span id="cb151-15"><a href="sampling-design-for-soil-surveys.html#cb151-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(slope)) {</span>
<span id="cb151-16"><a href="sampling-design-for-soil-surveys.html#cb151-16" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">rast</span>(slope)</span>
<span id="cb151-17"><a href="sampling-design-for-soil-surveys.html#cb151-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">crs</span>(slope) <span class="sc">!=</span> epsg) {</span>
<span id="cb151-18"><a href="sampling-design-for-soil-surveys.html#cb151-18" aria-hidden="true" tabindex="-1"></a>    slope <span class="ot">&lt;-</span> <span class="fu">project</span>(slope, epsg, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb151-19"><a href="sampling-design-for-soil-surveys.html#cb151-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-20"><a href="sampling-design-for-soil-surveys.html#cb151-20" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> slope <span class="sc">/</span> slope  <span class="co"># Normalize to 0/1</span></span>
<span id="cb151-21"><a href="sampling-design-for-soil-surveys.html#cb151-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb151-22"><a href="sampling-design-for-soil-surveys.html#cb151-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(slope)</span>
<span id="cb151-23"><a href="sampling-design-for-soil-surveys.html#cb151-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb151-24"><a href="sampling-design-for-soil-surveys.html#cb151-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-25"><a href="sampling-design-for-soil-surveys.html#cb151-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Geology</span></span>
<span id="cb151-26"><a href="sampling-design-for-soil-surveys.html#cb151-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(geo)) {</span>
<span id="cb151-27"><a href="sampling-design-for-soil-surveys.html#cb151-27" aria-hidden="true" tabindex="-1"></a>  geo <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(geo, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb151-28"><a href="sampling-design-for-soil-surveys.html#cb151-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(geo)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb151-29"><a href="sampling-design-for-soil-surveys.html#cb151-29" aria-hidden="true" tabindex="-1"></a>    geo <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(geo, <span class="at">crs =</span> epsg)</span>
<span id="cb151-30"><a href="sampling-design-for-soil-surveys.html#cb151-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-31"><a href="sampling-design-for-soil-surveys.html#cb151-31" aria-hidden="true" tabindex="-1"></a>  geo<span class="sc">$</span>GEO <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(geo[[geo.classes]]))</span>
<span id="cb151-32"><a href="sampling-design-for-soil-surveys.html#cb151-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb151-33"><a href="sampling-design-for-soil-surveys.html#cb151-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(geo)</span>
<span id="cb151-34"><a href="sampling-design-for-soil-surveys.html#cb151-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb151-35"><a href="sampling-design-for-soil-surveys.html#cb151-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-36"><a href="sampling-design-for-soil-surveys.html#cb151-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Geomorphology</span></span>
<span id="cb151-37"><a href="sampling-design-for-soil-surveys.html#cb151-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(geomorph)) {</span>
<span id="cb151-38"><a href="sampling-design-for-soil-surveys.html#cb151-38" aria-hidden="true" tabindex="-1"></a>  file_extension <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_ext</span>(geomorph)</span>
<span id="cb151-39"><a href="sampling-design-for-soil-surveys.html#cb151-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-40"><a href="sampling-design-for-soil-surveys.html#cb151-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (file_extension <span class="sc">==</span> <span class="st">&quot;tif&quot;</span>) {</span>
<span id="cb151-41"><a href="sampling-design-for-soil-surveys.html#cb151-41" aria-hidden="true" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">rast</span>(geomorph)</span>
<span id="cb151-42"><a href="sampling-design-for-soil-surveys.html#cb151-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(geomorph) <span class="ot">&lt;-</span> <span class="st">&#39;GEOMORPH&#39;</span></span>
<span id="cb151-43"><a href="sampling-design-for-soil-surveys.html#cb151-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-44"><a href="sampling-design-for-soil-surveys.html#cb151-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">crs</span>(geomorph) <span class="sc">!=</span> epsg) {</span>
<span id="cb151-45"><a href="sampling-design-for-soil-surveys.html#cb151-45" aria-hidden="true" tabindex="-1"></a>      geomorph <span class="ot">&lt;-</span> <span class="fu">project</span>(geomorph, epsg, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb151-46"><a href="sampling-design-for-soil-surveys.html#cb151-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-47"><a href="sampling-design-for-soil-surveys.html#cb151-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (file_extension <span class="sc">==</span> <span class="st">&quot;shp&quot;</span>) {</span>
<span id="cb151-48"><a href="sampling-design-for-soil-surveys.html#cb151-48" aria-hidden="true" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(geomorph, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb151-49"><a href="sampling-design-for-soil-surveys.html#cb151-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-50"><a href="sampling-design-for-soil-surveys.html#cb151-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sf<span class="sc">::</span><span class="fu">st_crs</span>(geomorph)<span class="sc">$</span>epsg <span class="sc">!=</span> epsg) {</span>
<span id="cb151-51"><a href="sampling-design-for-soil-surveys.html#cb151-51" aria-hidden="true" tabindex="-1"></a>      geomorph <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(geomorph, <span class="at">crs =</span> epsg)</span>
<span id="cb151-52"><a href="sampling-design-for-soil-surveys.html#cb151-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-53"><a href="sampling-design-for-soil-surveys.html#cb151-53" aria-hidden="true" tabindex="-1"></a>    geomorph<span class="sc">$</span>GEOMORPH <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(geomorph[[geomorph.classes]]))</span>
<span id="cb151-54"><a href="sampling-design-for-soil-surveys.html#cb151-54" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb151-55"><a href="sampling-design-for-soil-surveys.html#cb151-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File format not recognized. Expected .tif or .shp.&quot;</span>)</span>
<span id="cb151-56"><a href="sampling-design-for-soil-surveys.html#cb151-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(geomorph)</span>
<span id="cb151-57"><a href="sampling-design-for-soil-surveys.html#cb151-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-58"><a href="sampling-design-for-soil-surveys.html#cb151-58" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb151-59"><a href="sampling-design-for-soil-surveys.html#cb151-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(geomorph)</span>
<span id="cb151-60"><a href="sampling-design-for-soil-surveys.html#cb151-60" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="load-main-environmental-covariates" class="section level3 hasAnchor" number="3.4.7">
<h3><span class="header-section-number">3.4.7</span> Load Main Environmental Covariates<a href="sampling-design-for-soil-surveys.html#load-main-environmental-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="sampling-design-for-soil-surveys.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load covariate stack</span></span>
<span id="cb152-2"><a href="sampling-design-for-soil-surveys.html#cb152-2" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">list.files</span>(raster.path, </span>
<span id="cb152-3"><a href="sampling-design-for-soil-surveys.html#cb152-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">pattern =</span> <span class="st">&quot;covs_zam_clipped.tif$&quot;</span>,  </span>
<span id="cb152-4"><a href="sampling-design-for-soil-surveys.html#cb152-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb152-5"><a href="sampling-design-for-soil-surveys.html#cb152-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb152-6"><a href="sampling-design-for-soil-surveys.html#cb152-6" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat)</span>
<span id="cb152-7"><a href="sampling-design-for-soil-surveys.html#cb152-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-8"><a href="sampling-design-for-soil-surveys.html#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Loaded %d environmental covariates</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat)))</span>
<span id="cb152-9"><a href="sampling-design-for-soil-surveys.html#cb152-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-10"><a href="sampling-design-for-soil-surveys.html#cb152-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display covariate names in a table</span></span>
<span id="cb152-11"><a href="sampling-design-for-soil-surveys.html#cb152-11" aria-hidden="true" tabindex="-1"></a>cov.dat.names <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">names</span>(cov.dat), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb152-12"><a href="sampling-design-for-soil-surveys.html#cb152-12" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cov.dat.names, <span class="at">format =</span> <span class="st">&quot;markdown&quot;</span>, </span>
<span id="cb152-13"><a href="sampling-design-for-soil-surveys.html#cb152-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">&quot;Environmental covariates&quot;</span>)</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: Initial number of environmental covariates: 68</p>
</blockquote>
<div id="load-and-process-soil-climate-data-newhall" class="section level4 hasAnchor" number="3.4.7.1">
<h4><span class="header-section-number">3.4.7.1</span> Load and Process Soil Climate Data (Newhall)<a href="sampling-design-for-soil-surveys.html#load-and-process-soil-climate-data-newhall" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="sampling-design-for-soil-surveys.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load soil climate data</span></span>
<span id="cb153-2"><a href="sampling-design-for-soil-surveys.html#cb153-2" aria-hidden="true" tabindex="-1"></a>newhall <span class="ot">&lt;-</span> <span class="fu">list.files</span>(raster.path, </span>
<span id="cb153-3"><a href="sampling-design-for-soil-surveys.html#cb153-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">pattern =</span> <span class="st">&quot;newhall_zam_clipped.tif$&quot;</span>,  </span>
<span id="cb153-4"><a href="sampling-design-for-soil-surveys.html#cb153-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb153-5"><a href="sampling-design-for-soil-surveys.html#cb153-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb153-6"><a href="sampling-design-for-soil-surveys.html#cb153-6" aria-hidden="true" tabindex="-1"></a>newhall <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(newhall)</span>
<span id="cb153-7"><a href="sampling-design-for-soil-surveys.html#cb153-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-8"><a href="sampling-design-for-soil-surveys.html#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display variable names</span></span>
<span id="cb153-9"><a href="sampling-design-for-soil-surveys.html#cb153-9" aria-hidden="true" tabindex="-1"></a>newhall.names <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">names</span>(newhall), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb153-10"><a href="sampling-design-for-soil-surveys.html#cb153-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(newhall.names, <span class="at">format =</span> <span class="st">&quot;markdown&quot;</span>, </span>
<span id="cb153-11"><a href="sampling-design-for-soil-surveys.html#cb153-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">&quot;Soil climate variables&quot;</span>)</span>
<span id="cb153-12"><a href="sampling-design-for-soil-surveys.html#cb153-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-13"><a href="sampling-design-for-soil-surveys.html#cb153-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove unnecessary subdivisions</span></span>
<span id="cb153-14"><a href="sampling-design-for-soil-surveys.html#cb153-14" aria-hidden="true" tabindex="-1"></a>newhall<span class="sc">$</span>regimeSubdivision1 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb153-15"><a href="sampling-design-for-soil-surveys.html#cb153-15" aria-hidden="true" tabindex="-1"></a>newhall<span class="sc">$</span>regimeSubdivision2 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb153-16"><a href="sampling-design-for-soil-surveys.html#cb153-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-17"><a href="sampling-design-for-soil-surveys.html#cb153-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Soil climate variables: %d (after removing subdivisions)</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(newhall)))</span></code></pre></div>
</div>
<div id="convert-categorical-variables-to-dummy-variables" class="section level4 hasAnchor" number="3.4.7.2">
<h4><span class="header-section-number">3.4.7.2</span> Convert Categorical Variables to Dummy Variables<a href="sampling-design-for-soil-surveys.html#convert-categorical-variables-to-dummy-variables" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="sampling-design-for-soil-surveys.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert temperatureRegime and moistureRegime to dummy variables</span></span>
<span id="cb154-2"><a href="sampling-design-for-soil-surveys.html#cb154-2" aria-hidden="true" tabindex="-1"></a>temperatureRegime <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> newhall<span class="sc">$</span>temperatureRegime, </span>
<span id="cb154-3"><a href="sampling-design-for-soil-surveys.html#cb154-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb154-4"><a href="sampling-design-for-soil-surveys.html#cb154-4" aria-hidden="true" tabindex="-1"></a>moistureRegime <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> newhall<span class="sc">$</span>moistureRegime, </span>
<span id="cb154-5"><a href="sampling-design-for-soil-surveys.html#cb154-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb154-6"><a href="sampling-design-for-soil-surveys.html#cb154-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-7"><a href="sampling-design-for-soil-surveys.html#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove original categorical layers</span></span>
<span id="cb154-8"><a href="sampling-design-for-soil-surveys.html#cb154-8" aria-hidden="true" tabindex="-1"></a>newhall<span class="sc">$</span>temperatureRegime <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb154-9"><a href="sampling-design-for-soil-surveys.html#cb154-9" aria-hidden="true" tabindex="-1"></a>newhall<span class="sc">$</span>moistureRegime <span class="ot">&lt;-</span> <span class="fu">c</span>()</span></code></pre></div>
</div>
<div id="merge-all-covariate-layers" class="section level4 hasAnchor" number="3.4.7.3">
<h4><span class="header-section-number">3.4.7.3</span> Merge All Covariate Layers<a href="sampling-design-for-soil-surveys.html#merge-all-covariate-layers" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="sampling-design-for-soil-surveys.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge covariates and climate data</span></span>
<span id="cb155-2"><a href="sampling-design-for-soil-surveys.html#cb155-2" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat, newhall, temperatureRegime, moistureRegime)</span>
<span id="cb155-3"><a href="sampling-design-for-soil-surveys.html#cb155-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-4"><a href="sampling-design-for-soil-surveys.html#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Project if necessary</span></span>
<span id="cb155-5"><a href="sampling-design-for-soil-surveys.html#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">crs</span>(cov.dat) <span class="sc">!=</span> epsg) {</span>
<span id="cb155-6"><a href="sampling-design-for-soil-surveys.html#cb155-6" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(cov.dat, epsg, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb155-7"><a href="sampling-design-for-soil-surveys.html#cb155-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-8"><a href="sampling-design-for-soil-surveys.html#cb155-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-9"><a href="sampling-design-for-soil-surveys.html#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add geology if exists</span></span>
<span id="cb155-10"><a href="sampling-design-for-soil-surveys.html#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;geo&quot;</span>)) {</span>
<span id="cb155-11"><a href="sampling-design-for-soil-surveys.html#cb155-11" aria-hidden="true" tabindex="-1"></a>  geo <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">as</span>(geo, <span class="st">&quot;SpatVector&quot;</span>), cov.dat, <span class="at">field =</span> <span class="st">&quot;GEO&quot;</span>)</span>
<span id="cb155-12"><a href="sampling-design-for-soil-surveys.html#cb155-12" aria-hidden="true" tabindex="-1"></a>  geo <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> geo<span class="sc">$</span>GEO, <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb155-13"><a href="sampling-design-for-soil-surveys.html#cb155-13" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat, geo)</span>
<span id="cb155-14"><a href="sampling-design-for-soil-surveys.html#cb155-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-15"><a href="sampling-design-for-soil-surveys.html#cb155-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-16"><a href="sampling-design-for-soil-surveys.html#cb155-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add geomorphology if exists</span></span>
<span id="cb155-17"><a href="sampling-design-for-soil-surveys.html#cb155-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;geomorph&quot;</span>)) {</span>
<span id="cb155-18"><a href="sampling-design-for-soil-surveys.html#cb155-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(geomorph, <span class="st">&quot;SpatRaster&quot;</span>)) {</span>
<span id="cb155-19"><a href="sampling-design-for-soil-surveys.html#cb155-19" aria-hidden="true" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">as</span>(geomorph, <span class="st">&quot;SpatVector&quot;</span>), cov.dat, <span class="at">field =</span> <span class="st">&quot;GEOMORPH&quot;</span>)</span>
<span id="cb155-20"><a href="sampling-design-for-soil-surveys.html#cb155-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb155-21"><a href="sampling-design-for-soil-surveys.html#cb155-21" aria-hidden="true" tabindex="-1"></a>  geomorph <span class="ot">&lt;-</span> <span class="fu">dummies</span>(<span class="at">ca.rast =</span> geomorph<span class="sc">$</span>GEOMORPH, <span class="at">preval =</span> <span class="dv">1</span>, <span class="at">absval =</span> <span class="dv">0</span>)</span>
<span id="cb155-22"><a href="sampling-design-for-soil-surveys.html#cb155-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-23"><a href="sampling-design-for-soil-surveys.html#cb155-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure matching extent and resolution</span></span>
<span id="cb155-24"><a href="sampling-design-for-soil-surveys.html#cb155-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">identical</span>(<span class="fu">ext</span>(cov.dat), <span class="fu">ext</span>(geomorph))) {</span>
<span id="cb155-25"><a href="sampling-design-for-soil-surveys.html#cb155-25" aria-hidden="true" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">extend</span>(geomorph, cov.dat)</span>
<span id="cb155-26"><a href="sampling-design-for-soil-surveys.html#cb155-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb155-27"><a href="sampling-design-for-soil-surveys.html#cb155-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">res</span>(cov.dat) <span class="sc">==</span> <span class="fu">res</span>(geomorph))) {</span>
<span id="cb155-28"><a href="sampling-design-for-soil-surveys.html#cb155-28" aria-hidden="true" tabindex="-1"></a>    geomorph <span class="ot">&lt;-</span> <span class="fu">resample</span>(geomorph, cov.dat, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb155-29"><a href="sampling-design-for-soil-surveys.html#cb155-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb155-30"><a href="sampling-design-for-soil-surveys.html#cb155-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-31"><a href="sampling-design-for-soil-surveys.html#cb155-31" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat, geomorph)</span>
<span id="cb155-32"><a href="sampling-design-for-soil-surveys.html#cb155-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-33"><a href="sampling-design-for-soil-surveys.html#cb155-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-34"><a href="sampling-design-for-soil-surveys.html#cb155-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb155-35"><a href="sampling-design-for-soil-surveys.html#cb155-35" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(newhall, geomorph, geo)</span>
<span id="cb155-36"><a href="sampling-design-for-soil-surveys.html#cb155-36" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb155-37"><a href="sampling-design-for-soil-surveys.html#cb155-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-38"><a href="sampling-design-for-soil-surveys.html#cb155-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Final covariate stack: %d layers</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat)))</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: <strong>Stacking</strong> is the process of combining multiple spatial data layers (raster datasets) into a single multi-layer object. This is useful when multiple variables need to be analyzed together.</p>
</blockquote>
</div>
<div id="crop-and-save-covariates" class="section level4 hasAnchor" number="3.4.7.4">
<h4><span class="header-section-number">3.4.7.4</span> Crop and Save Covariates<a href="sampling-design-for-soil-surveys.html#crop-and-save-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="sampling-design-for-soil-surveys.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop covariates to administrative boundary</span></span>
<span id="cb156-2"><a href="sampling-design-for-soil-surveys.html#cb156-2" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, country_boundaries, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb156-3"><a href="sampling-design-for-soil-surveys.html#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(cov.dat, </span>
<span id="cb156-4"><a href="sampling-design-for-soil-surveys.html#cb156-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(raster.path, <span class="st">&quot;cov_dat_stack.tif&quot;</span>), </span>
<span id="cb156-5"><a href="sampling-design-for-soil-surveys.html#cb156-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb156-6"><a href="sampling-design-for-soil-surveys.html#cb156-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-7"><a href="sampling-design-for-soil-surveys.html#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb156-8"><a href="sampling-design-for-soil-surveys.html#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co"># cov.dat &lt;- rast(paste0(raster.path, &quot;cov_dat_stack.tif&quot;))</span></span></code></pre></div>
</div>
</div>
<div id="pca" class="section level3 hasAnchor" number="3.4.8">
<h3><span class="header-section-number">3.4.8</span> Principal Component Analysis (PCA)<a href="sampling-design-for-soil-surveys.html#pca" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>PCA reduces dimensionality while retaining the most important information. Components explaining 99% of variance are kept.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="sampling-design-for-soil-surveys.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCA</span></span>
<span id="cb157-2"><a href="sampling-design-for-soil-surveys.html#cb157-2" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> synoptReg<span class="sc">::</span><span class="fu">raster_pca</span>(cov.dat)  <span class="co"># Faster than terra::princomp</span></span>
<span id="cb157-3"><a href="sampling-design-for-soil-surveys.html#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="sampling-design-for-soil-surveys.html#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get SpatRaster layers</span></span>
<span id="cb157-5"><a href="sampling-design-for-soil-surveys.html#cb157-5" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb157-6"><a href="sampling-design-for-soil-surveys.html#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="sampling-design-for-soil-surveys.html#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary</span></span>
<span id="cb157-8"><a href="sampling-design-for-soil-surveys.html#cb157-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cov.dat)</span>
<span id="cb157-9"><a href="sampling-design-for-soil-surveys.html#cb157-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-10"><a href="sampling-design-for-soil-surveys.html#cb157-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to main PCs (variance explained &gt;= 0.99)</span></span>
<span id="cb157-11"><a href="sampling-design-for-soil-surveys.html#cb157-11" aria-hidden="true" tabindex="-1"></a>n_comps <span class="ot">&lt;-</span> <span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,] <span class="sc">&gt;</span> <span class="fl">0.99</span>))</span>
<span id="cb157-12"><a href="sampling-design-for-soil-surveys.html#cb157-12" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span>n_comps]]</span>
<span id="cb157-13"><a href="sampling-design-for-soil-surveys.html#cb157-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-14"><a href="sampling-design-for-soil-surveys.html#cb157-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Retained %d principal components (99%% variance)</span><span class="sc">\n</span><span class="st">&quot;</span>, n_comps))</span>
<span id="cb157-15"><a href="sampling-design-for-soil-surveys.html#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="sampling-design-for-soil-surveys.html#cb157-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Save PCA rasters</span></span>
<span id="cb157-17"><a href="sampling-design-for-soil-surveys.html#cb157-17" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(cov.dat, </span>
<span id="cb157-18"><a href="sampling-design-for-soil-surveys.html#cb157-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(results.path, <span class="st">&quot;PCA_projected.tif&quot;</span>), </span>
<span id="cb157-19"><a href="sampling-design-for-soil-surveys.html#cb157-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb157-20"><a href="sampling-design-for-soil-surveys.html#cb157-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-21"><a href="sampling-design-for-soil-surveys.html#cb157-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb157-22"><a href="sampling-design-for-soil-surveys.html#cb157-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(pca)</span>
<span id="cb157-23"><a href="sampling-design-for-soil-surveys.html#cb157-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-24"><a href="sampling-design-for-soil-surveys.html#cb157-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb157-25"><a href="sampling-design-for-soil-surveys.html#cb157-25" aria-hidden="true" tabindex="-1"></a><span class="co"># cov.dat &lt;- rast(paste0(results.path, &quot;PCA_projected.tif&quot;))</span></span></code></pre></div>
</div>
<div id="sampling-universe" class="section level3 hasAnchor" number="3.4.9">
<h3><span class="header-section-number">3.4.9</span> Organize the Sampling Universe<a href="sampling-design-for-soil-surveys.html#sampling-universe" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="load-and-process-land-use-data" class="section level4 hasAnchor" number="3.4.9.1">
<h4><span class="header-section-number">3.4.9.1</span> Load and process land-use data<a href="sampling-design-for-soil-surveys.html#load-and-process-land-use-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="sampling-design-for-soil-surveys.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define land-use raster path</span></span>
<span id="cb158-2"><a href="sampling-design-for-soil-surveys.html#cb158-2" aria-hidden="true" tabindex="-1"></a>landuse <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;cropland_clipped_zmb_v1_epsg_3857.tif&quot;</span>))</span>
<span id="cb158-3"><a href="sampling-design-for-soil-surveys.html#cb158-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-4"><a href="sampling-design-for-soil-surveys.html#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load binary raster (1 = target land use, NA = other)</span></span>
<span id="cb158-5"><a href="sampling-design-for-soil-surveys.html#cb158-5" aria-hidden="true" tabindex="-1"></a>crops <span class="ot">&lt;-</span> <span class="fu">rast</span>(landuse)</span>
<span id="cb158-6"><a href="sampling-design-for-soil-surveys.html#cb158-6" aria-hidden="true" tabindex="-1"></a>crops <span class="ot">&lt;-</span> crops <span class="sc">/</span> crops  <span class="co"># Normalize</span></span>
<span id="cb158-7"><a href="sampling-design-for-soil-surveys.html#cb158-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-8"><a href="sampling-design-for-soil-surveys.html#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(crops) <span class="ot">&lt;-</span> <span class="st">&quot;lu&quot;</span></span>
<span id="cb158-9"><a href="sampling-design-for-soil-surveys.html#cb158-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-10"><a href="sampling-design-for-soil-surveys.html#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display raster info</span></span>
<span id="cb158-11"><a href="sampling-design-for-soil-surveys.html#cb158-11" aria-hidden="true" tabindex="-1"></a>crops</span></code></pre></div>
</div>
<div id="exclude-protected-areas" class="section level4 hasAnchor" number="3.4.9.2">
<h4><span class="header-section-number">3.4.9.2</span> Exclude Protected Areas<a href="sampling-design-for-soil-surveys.html#exclude-protected-areas" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="sampling-design-for-soil-surveys.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;npa&quot;</span>)) {</span>
<span id="cb159-2"><a href="sampling-design-for-soil-surveys.html#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If npa is a shapefile</span></span>
<span id="cb159-3"><a href="sampling-design-for-soil-surveys.html#cb159-3" aria-hidden="true" tabindex="-1"></a>  crops <span class="ot">&lt;-</span> <span class="fu">mask</span>(crops, npa)</span>
<span id="cb159-4"><a href="sampling-design-for-soil-surveys.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-5"><a href="sampling-design-for-soil-surveys.html#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If npa is a raster (uncomment if applicable)</span></span>
<span id="cb159-6"><a href="sampling-design-for-soil-surveys.html#cb159-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># npa &lt;- resample(npa, crops, method = &quot;near&quot;)</span></span>
<span id="cb159-7"><a href="sampling-design-for-soil-surveys.html#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># crops &lt;- crops * npa</span></span>
<span id="cb159-8"><a href="sampling-design-for-soil-surveys.html#cb159-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb159-9"><a href="sampling-design-for-soil-surveys.html#cb159-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-10"><a href="sampling-design-for-soil-surveys.html#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(npa)</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: Use the correct operation for your npa dataset type (shapefile or raster).</p>
</blockquote>
</div>
<div id="restrict-to-accessible-slopes" class="section level4 hasAnchor" number="3.4.9.3">
<h4><span class="header-section-number">3.4.9.3</span> Restrict to Accessible Slopes<a href="sampling-design-for-soil-surveys.html#restrict-to-accessible-slopes" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="sampling-design-for-soil-surveys.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;slope&quot;</span>)) {</span>
<span id="cb160-2"><a href="sampling-design-for-soil-surveys.html#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Resample to match crops resolution</span></span>
<span id="cb160-3"><a href="sampling-design-for-soil-surveys.html#cb160-3" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">resample</span>(slope, crops, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>)</span>
<span id="cb160-4"><a href="sampling-design-for-soil-surveys.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  crops <span class="ot">&lt;-</span> crops <span class="sc">*</span> slope</span>
<span id="cb160-5"><a href="sampling-design-for-soil-surveys.html#cb160-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-6"><a href="sampling-design-for-soil-surveys.html#cb160-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-7"><a href="sampling-design-for-soil-surveys.html#cb160-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(slope)</span></code></pre></div>
</div>
<div id="aggregate-to-100m-resolution" class="section level4 hasAnchor" number="3.4.9.4">
<h4><span class="header-section-number">3.4.9.4</span> Aggregate to 100m Resolution<a href="sampling-design-for-soil-surveys.html#aggregate-to-100m-resolution" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Resampling to 100m resolution significantly optimizes processing speed and reduces storage requirements.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="sampling-design-for-soil-surveys.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate 20m pixels to 100m (5Ã—5 grid using modal value)</span></span>
<span id="cb161-2"><a href="sampling-design-for-soil-surveys.html#cb161-2" aria-hidden="true" tabindex="-1"></a>lu <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(crops, <span class="dv">5</span>, <span class="at">fun =</span> modal, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb161-3"><a href="sampling-design-for-soil-surveys.html#cb161-3" aria-hidden="true" tabindex="-1"></a>lu <span class="ot">&lt;-</span> lu <span class="sc">/</span> lu</span>
<span id="cb161-4"><a href="sampling-design-for-soil-surveys.html#cb161-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-5"><a href="sampling-design-for-soil-surveys.html#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Display new resolution</span></span>
<span id="cb161-6"><a href="sampling-design-for-soil-surveys.html#cb161-6" aria-hidden="true" tabindex="-1"></a>lu</span></code></pre></div>
</div>
</div>
<div id="save-processed-land-use" class="section level3 hasAnchor" number="3.4.10">
<h3><span class="header-section-number">3.4.10</span> Save Processed Land Use<a href="sampling-design-for-soil-surveys.html#save-processed-land-use" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="sampling-design-for-soil-surveys.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(lu, </span>
<span id="cb162-2"><a href="sampling-design-for-soil-surveys.html#cb162-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(raster.path, <span class="st">&quot;cropland_zmb_100m_v1_epsg_3857.tif&quot;</span>), </span>
<span id="cb162-3"><a href="sampling-design-for-soil-surveys.html#cb162-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb162-4"><a href="sampling-design-for-soil-surveys.html#cb162-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-5"><a href="sampling-design-for-soil-surveys.html#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb162-6"><a href="sampling-design-for-soil-surveys.html#cb162-6" aria-hidden="true" tabindex="-1"></a>lu <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">paste0</span>(raster.path, <span class="st">&quot;cropland_zmb_100m_v1_epsg_3857.tif&quot;</span>))</span></code></pre></div>
<div id="filter-legacy-data" class="section level4 hasAnchor" number="3.4.10.1">
<h4><span class="header-section-number">3.4.10.1</span> Filter Legacy Data<a href="sampling-design-for-soil-surveys.html#filter-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="sampling-design-for-soil-surveys.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb163-2"><a href="sampling-design-for-soil-surveys.html#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only legacy points within land-use areas</span></span>
<span id="cb163-3"><a href="sampling-design-for-soil-surveys.html#cb163-3" aria-hidden="true" tabindex="-1"></a>  legacy<span class="sc">$</span>INSIDE <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(crops, legacy) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(lu)</span>
<span id="cb163-4"><a href="sampling-design-for-soil-surveys.html#cb163-4" aria-hidden="true" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> legacy[<span class="sc">!</span><span class="fu">is.na</span>(legacy<span class="sc">$</span>INSIDE), ] <span class="sc">%&gt;%</span></span>
<span id="cb163-5"><a href="sampling-design-for-soil-surveys.html#cb163-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="st">&quot;INSIDE&quot;</span>)</span>
<span id="cb163-6"><a href="sampling-design-for-soil-surveys.html#cb163-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-7"><a href="sampling-design-for-soil-surveys.html#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Legacy points within land-use areas: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(legacy)))</span>
<span id="cb163-8"><a href="sampling-design-for-soil-surveys.html#cb163-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="create-psu-grid" class="section level3 hasAnchor" number="3.4.11">
<h3><span class="header-section-number">3.4.11</span> Create Primary Sampling Units (PSU Grid)<a href="sampling-design-for-soil-surveys.html#create-psu-grid" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="generate-2km-2km-grid" class="section level4 hasAnchor" number="3.4.11.1">
<h4><span class="header-section-number">3.4.11.1</span> Generate 2km Ã— 2km Grid<a href="sampling-design-for-soil-surveys.html#generate-2km-2km-grid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="sampling-design-for-soil-surveys.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create grid</span></span>
<span id="cb164-2"><a href="sampling-design-for-soil-surveys.html#cb164-2" aria-hidden="true" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(country_boundaries, </span>
<span id="cb164-3"><a href="sampling-design-for-soil-surveys.html#cb164-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cellsize =</span> <span class="fu">c</span>(psu_size, psu_size), </span>
<span id="cb164-4"><a href="sampling-design-for-soil-surveys.html#cb164-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">square =</span> <span class="cn">TRUE</span>)</span>
<span id="cb164-5"><a href="sampling-design-for-soil-surveys.html#cb164-5" aria-hidden="true" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> psu_grid)</span>
<span id="cb164-6"><a href="sampling-design-for-soil-surveys.html#cb164-6" aria-hidden="true" tabindex="-1"></a>psu_grid<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(psu_grid)</span>
<span id="cb164-7"><a href="sampling-design-for-soil-surveys.html#cb164-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-8"><a href="sampling-design-for-soil-surveys.html#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Generated %d PSU grid cells</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(psu_grid)))</span></code></pre></div>
</div>
<div id="trim-to-country-boundaries" class="section level4 hasAnchor" number="3.4.11.2">
<h4><span class="header-section-number">3.4.11.2</span> Trim to Country Boundaries<a href="sampling-design-for-soil-surveys.html#trim-to-country-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="sampling-design-for-soil-surveys.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This operation is computationally intensive</span></span>
<span id="cb165-2"><a href="sampling-design-for-soil-surveys.html#cb165-2" aria-hidden="true" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> psu_grid[country_boundaries[<span class="dv">1</span>], ]</span>
<span id="cb165-3"><a href="sampling-design-for-soil-surveys.html#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="sampling-design-for-soil-surveys.html#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;PSUs within country boundaries: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(psu_grid)))</span></code></pre></div>
</div>
<div id="save-psu-grid" class="section level4 hasAnchor" number="3.4.11.3">
<h4><span class="header-section-number">3.4.11.3</span> Save PSU Grid<a href="sampling-design-for-soil-surveys.html#save-psu-grid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="sampling-design-for-soil-surveys.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(psu_grid, </span>
<span id="cb166-2"><a href="sampling-design-for-soil-surveys.html#cb166-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;../grid2k.shp&quot;</span>), </span>
<span id="cb166-3"><a href="sampling-design-for-soil-surveys.html#cb166-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb166-4"><a href="sampling-design-for-soil-surveys.html#cb166-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-5"><a href="sampling-design-for-soil-surveys.html#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload if needed</span></span>
<span id="cb166-6"><a href="sampling-design-for-soil-surveys.html#cb166-6" aria-hidden="true" tabindex="-1"></a>psu_grid <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path, <span class="st">&quot;../grid2k.shp&quot;</span>)))</span></code></pre></div>
</div>
</div>
<div id="select-psus" class="section level3 hasAnchor" number="3.4.12">
<h3><span class="header-section-number">3.4.12</span> Select PSUs with Sufficient Land Use Coverage<a href="sampling-design-for-soil-surveys.html#select-psus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="calculate-land-use-percentage" class="section level4 hasAnchor" number="3.4.12.1">
<h4><span class="header-section-number">3.4.12.1</span> Calculate Land Use Percentage<a href="sampling-design-for-soil-surveys.html#calculate-land-use-percentage" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="sampling-design-for-soil-surveys.html#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract land-use values for each PSU</span></span>
<span id="cb167-2"><a href="sampling-design-for-soil-surveys.html#cb167-2" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(lu, psu_grid)</span>
<span id="cb167-3"><a href="sampling-design-for-soil-surveys.html#cb167-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-4"><a href="sampling-design-for-soil-surveys.html#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate percentage (400 pixels = 2km Ã— 2km PSU at 100m resolution)</span></span>
<span id="cb167-5"><a href="sampling-design-for-soil-surveys.html#cb167-5" aria-hidden="true" tabindex="-1"></a>crop_perc <span class="ot">&lt;-</span> extracted_values <span class="sc">%&gt;%</span></span>
<span id="cb167-6"><a href="sampling-design-for-soil-surveys.html#cb167-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb167-7"><a href="sampling-design-for-soil-surveys.html#cb167-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">crop_perc =</span> <span class="fu">sum</span>(lu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> <span class="dv">400</span>)</span>
<span id="cb167-8"><a href="sampling-design-for-soil-surveys.html#cb167-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-9"><a href="sampling-design-for-soil-surveys.html#cb167-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(extracted_values)</span>
<span id="cb167-10"><a href="sampling-design-for-soil-surveys.html#cb167-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-11"><a href="sampling-design-for-soil-surveys.html#cb167-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to PSU grid</span></span>
<span id="cb167-12"><a href="sampling-design-for-soil-surveys.html#cb167-12" aria-hidden="true" tabindex="-1"></a>psu_grid<span class="sc">$</span>crop_perc <span class="ot">&lt;-</span> crop_perc<span class="sc">$</span>crop_perc</span>
<span id="cb167-13"><a href="sampling-design-for-soil-surveys.html#cb167-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-14"><a href="sampling-design-for-soil-surveys.html#cb167-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Crop percentage calculated for all PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
</div>
<div id="filter-psus" class="section level4 hasAnchor" number="3.4.12.2">
<h4><span class="header-section-number">3.4.12.2</span> Filter PSUs<a href="sampling-design-for-soil-surveys.html#filter-psus" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="sampling-design-for-soil-surveys.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only PSUs with sufficient crop coverage</span></span>
<span id="cb168-2"><a href="sampling-design-for-soil-surveys.html#cb168-2" aria-hidden="true" tabindex="-1"></a>psu_grid_filtered <span class="ot">&lt;-</span> psu_grid[psu_grid<span class="sc">$</span>crop_perc <span class="sc">&gt;</span> percent_crop, <span class="st">&quot;ID&quot;</span>]</span>
<span id="cb168-3"><a href="sampling-design-for-soil-surveys.html#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="sampling-design-for-soil-surveys.html#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;PSUs with &gt;%d%% crop coverage: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb168-5"><a href="sampling-design-for-soil-surveys.html#cb168-5" aria-hidden="true" tabindex="-1"></a>            percent_crop, <span class="fu">nrow</span>(psu_grid_filtered)))</span>
<span id="cb168-6"><a href="sampling-design-for-soil-surveys.html#cb168-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-7"><a href="sampling-design-for-soil-surveys.html#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save filtered grid</span></span>
<span id="cb168-8"><a href="sampling-design-for-soil-surveys.html#cb168-8" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(psu_grid_filtered, </span>
<span id="cb168-9"><a href="sampling-design-for-soil-surveys.html#cb168-9" aria-hidden="true" tabindex="-1"></a>         <span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path, <span class="st">&quot;/psu_grid_counts.shp&quot;</span>)), </span>
<span id="cb168-10"><a href="sampling-design-for-soil-surveys.html#cb168-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
</div>
<div id="rasterize-psus" class="section level3 hasAnchor" number="3.4.13">
<h3><span class="header-section-number">3.4.13</span> Rasterize PSUs for Covariate Space Coverage<a href="sampling-design-for-soil-surveys.html#rasterize-psus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="sampling-design-for-soil-surveys.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create raster template at PSU resolution</span></span>
<span id="cb169-2"><a href="sampling-design-for-soil-surveys.html#cb169-2" aria-hidden="true" tabindex="-1"></a>template <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">vect</span>(psu_grid_filtered), <span class="at">res =</span> psu_size)</span>
<span id="cb169-3"><a href="sampling-design-for-soil-surveys.html#cb169-3" aria-hidden="true" tabindex="-1"></a>template <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="fu">vect</span>(psu_grid_filtered), template, <span class="at">field =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb169-4"><a href="sampling-design-for-soil-surveys.html#cb169-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-5"><a href="sampling-design-for-soil-surveys.html#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop covariates to filtered PSUs</span></span>
<span id="cb169-6"><a href="sampling-design-for-soil-surveys.html#cb169-6" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, psu_grid_filtered, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb169-7"><a href="sampling-design-for-soil-surveys.html#cb169-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-8"><a href="sampling-design-for-soil-surveys.html#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample covariates to match PSU template</span></span>
<span id="cb169-9"><a href="sampling-design-for-soil-surveys.html#cb169-9" aria-hidden="true" tabindex="-1"></a>PSU.r <span class="ot">&lt;-</span> <span class="fu">resample</span>(cov.dat, template)</span>
<span id="cb169-10"><a href="sampling-design-for-soil-surveys.html#cb169-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-11"><a href="sampling-design-for-soil-surveys.html#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Covariates resampled to PSU resolution</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Why this matters</strong>: Cropping and resampling ensure that spatial resolution and extent of covariates match the PSU grid, facilitating accurate clustering.</p>
</blockquote>
</div>
<div id="optimal-sample-size" class="section level3 hasAnchor" number="3.4.14">
<h3><span class="header-section-number">3.4.14</span> Compute Optimal Sample Size<a href="sampling-design-for-soil-surveys.html#optimal-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After rasterizing PSUs for Covariate Space Coverage, calculate the optimal sample size based on divergence metrics <span class="citation">(<a href="#ref-saurette2023" role="doc-biblioref">Saurette <em>et al.</em>, 2023</a>)</span>.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="sampling-design-for-soil-surveys.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load optimization script</span></span>
<span id="cb170-2"><a href="sampling-design-for-soil-surveys.html#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;scripts/opt_sample.R&quot;</span>)</span>
<span id="cb170-3"><a href="sampling-design-for-soil-surveys.html#cb170-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-4"><a href="sampling-design-for-soil-surveys.html#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare covariate data</span></span>
<span id="cb170-5"><a href="sampling-design-for-soil-surveys.html#cb170-5" aria-hidden="true" tabindex="-1"></a>psu.r.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(PSU.r)</span>
<span id="cb170-6"><a href="sampling-design-for-soil-surveys.html#cb170-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-7"><a href="sampling-design-for-soil-surveys.html#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters</span></span>
<span id="cb170-8"><a href="sampling-design-for-soil-surveys.html#cb170-8" aria-hidden="true" tabindex="-1"></a>initial.n <span class="ot">&lt;-</span> <span class="dv">50</span>     <span class="co"># Minimum sample size</span></span>
<span id="cb170-9"><a href="sampling-design-for-soil-surveys.html#cb170-9" aria-hidden="true" tabindex="-1"></a>final.n <span class="ot">&lt;-</span> <span class="dv">3000</span>     <span class="co"># Maximum sample size</span></span>
<span id="cb170-10"><a href="sampling-design-for-soil-surveys.html#cb170-10" aria-hidden="true" tabindex="-1"></a>by.n <span class="ot">&lt;-</span> <span class="dv">25</span>          <span class="co"># Increment step</span></span>
<span id="cb170-11"><a href="sampling-design-for-soil-surveys.html#cb170-11" aria-hidden="true" tabindex="-1"></a>iters <span class="ot">&lt;-</span> <span class="dv">4</span>          <span class="co"># Iterations per trial</span></span></code></pre></div>
<div id="run-optimization" class="section level4 hasAnchor" number="3.4.14.1">
<h4><span class="header-section-number">3.4.14.1</span> Run Optimization<a href="sampling-design-for-soil-surveys.html#run-optimization" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="sampling-design-for-soil-surveys.html#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate optimal sample size using normalized KL-divergence</span></span>
<span id="cb171-2"><a href="sampling-design-for-soil-surveys.html#cb171-2" aria-hidden="true" tabindex="-1"></a>opt_N_fcs <span class="ot">&lt;-</span> <span class="fu">opt_sample</span>(</span>
<span id="cb171-3"><a href="sampling-design-for-soil-surveys.html#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">alg =</span> <span class="st">&quot;fcs&quot;</span>,              <span class="co"># Feature coverage sampling</span></span>
<span id="cb171-4"><a href="sampling-design-for-soil-surveys.html#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_min =</span> initial.n, </span>
<span id="cb171-5"><a href="sampling-design-for-soil-surveys.html#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_max =</span> final.n, </span>
<span id="cb171-6"><a href="sampling-design-for-soil-surveys.html#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_step =</span> by.n, </span>
<span id="cb171-7"><a href="sampling-design-for-soil-surveys.html#cb171-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_reps =</span> iters, </span>
<span id="cb171-8"><a href="sampling-design-for-soil-surveys.html#cb171-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">covs =</span> psu.r.df, </span>
<span id="cb171-9"><a href="sampling-design-for-soil-surveys.html#cb171-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cpus =</span> <span class="cn">NULL</span>,              <span class="co"># Use all available cores</span></span>
<span id="cb171-10"><a href="sampling-design-for-soil-surveys.html#cb171-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf =</span> <span class="fl">0.95</span></span>
<span id="cb171-11"><a href="sampling-design-for-soil-surveys.html#cb171-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb171-12"><a href="sampling-design-for-soil-surveys.html#cb171-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-13"><a href="sampling-design-for-soil-surveys.html#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb171-14"><a href="sampling-design-for-soil-surveys.html#cb171-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(opt_N_fcs<span class="sc">$</span>optimal_sites)</span></code></pre></div>
</div>
<div id="extract-optimal-sample-size" class="section level4 hasAnchor" number="3.4.14.2">
<h4><span class="header-section-number">3.4.14.2</span> Extract Optimal Sample Size<a href="sampling-design-for-soil-surveys.html#extract-optimal-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="sampling-design-for-soil-surveys.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Kullback-Leibler Divergence (most reliable)</span></span>
<span id="cb172-2"><a href="sampling-design-for-soil-surveys.html#cb172-2" aria-hidden="true" tabindex="-1"></a>optimal_N_KLD <span class="ot">&lt;-</span> opt_N_fcs<span class="sc">$</span>optimal_sites[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb172-3"><a href="sampling-design-for-soil-surveys.html#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="sampling-design-for-soil-surveys.html#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Optimal sample size: %d PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>, optimal_N_KLD))</span>
<span id="cb172-5"><a href="sampling-design-for-soil-surveys.html#cb172-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-6"><a href="sampling-design-for-soil-surveys.html#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set final PSU count</span></span>
<span id="cb172-7"><a href="sampling-design-for-soil-surveys.html#cb172-7" aria-hidden="true" tabindex="-1"></a>n.psu <span class="ot">&lt;-</span> optimal_N_KLD</span>
<span id="cb172-8"><a href="sampling-design-for-soil-surveys.html#cb172-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-9"><a href="sampling-design-for-soil-surveys.html#cb172-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected total sampling sites (4 per PSU)</span></span>
<span id="cb172-10"><a href="sampling-design-for-soil-surveys.html#cb172-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Expected total target sites: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, n.psu <span class="sc">*</span> <span class="dv">4</span>))</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: The optimal sample size is based on Kullback-Leibler Divergence, which does not overestimate like Jensen-Shannon methods.</p>
</blockquote>
</div>
</div>
<div id="csc-computing" class="section level3 hasAnchor" number="3.4.15">
<h3><span class="header-section-number">3.4.15</span> Covariate Space Coverage - Computing PSUs<a href="sampling-design-for-soil-surveys.html#csc-computing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Covariate Space Coverage (CSC) sampling ensures sampling units are distributed effectively across the multidimensional space of environmental covariates.</p>
<div id="prepare-function-parameters" class="section level4 hasAnchor" number="3.4.15.1">
<h4><span class="header-section-number">3.4.15.1</span> Prepare Function Parameters<a href="sampling-design-for-soil-surveys.html#prepare-function-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="sampling-design-for-soil-surveys.html#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert raster to dataframe with coordinates</span></span>
<span id="cb173-2"><a href="sampling-design-for-soil-surveys.html#cb173-2" aria-hidden="true" tabindex="-1"></a>PSU.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(PSU.r, <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb173-3"><a href="sampling-design-for-soil-surveys.html#cb173-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-4"><a href="sampling-design-for-soil-surveys.html#cb173-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get covariate names</span></span>
<span id="cb173-5"><a href="sampling-design-for-soil-surveys.html#cb173-5" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">&lt;-</span> <span class="fu">names</span>(cov.dat)</span>
<span id="cb173-6"><a href="sampling-design-for-soil-surveys.html#cb173-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-7"><a href="sampling-design-for-soil-surveys.html#cb173-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale covariates (mean = 0, SD = 1)</span></span>
<span id="cb173-8"><a href="sampling-design-for-soil-surveys.html#cb173-8" aria-hidden="true" tabindex="-1"></a>mygrd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">scale</span>(PSU.df[, covs]))</span>
<span id="cb173-9"><a href="sampling-design-for-soil-surveys.html#cb173-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-10"><a href="sampling-design-for-soil-surveys.html#cb173-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Prepared %d PSUs with %d covariates for clustering</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb173-11"><a href="sampling-design-for-soil-surveys.html#cb173-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(mygrd), <span class="fu">ncol</span>(mygrd)))</span></code></pre></div>
</div>
<div id="perform-k-means-clustering" class="section level4 hasAnchor" number="3.4.15.2">
<h4><span class="header-section-number">3.4.15.2</span> Perform K-means Clustering<a href="sampling-design-for-soil-surveys.html#perform-k-means-clustering" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="sampling-design-for-soil-surveys.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># With legacy data</span></span>
<span id="cb174-2"><a href="sampling-design-for-soil-surveys.html#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb174-3"><a href="sampling-design-for-soil-surveys.html#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter legacy to PSU grid extent</span></span>
<span id="cb174-4"><a href="sampling-design-for-soil-surveys.html#cb174-4" aria-hidden="true" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> <span class="fu">st_filter</span>(legacy, psu_grid_filtered)</span>
<span id="cb174-5"><a href="sampling-design-for-soil-surveys.html#cb174-5" aria-hidden="true" tabindex="-1"></a>  legacy_df <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(legacy)</span>
<span id="cb174-6"><a href="sampling-design-for-soil-surveys.html#cb174-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-7"><a href="sampling-design-for-soil-surveys.html#cb174-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find nearest PSU for each legacy point</span></span>
<span id="cb174-8"><a href="sampling-design-for-soil-surveys.html#cb174-8" aria-hidden="true" tabindex="-1"></a>  units <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(legacy_df))</span>
<span id="cb174-9"><a href="sampling-design-for-soil-surveys.html#cb174-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(legacy_df)) {</span>
<span id="cb174-10"><a href="sampling-design-for-soil-surveys.html#cb174-10" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((PSU.df<span class="sc">$</span>x <span class="sc">-</span> legacy_df[i, <span class="st">&quot;X&quot;</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb174-11"><a href="sampling-design-for-soil-surveys.html#cb174-11" aria-hidden="true" tabindex="-1"></a>                     (PSU.df<span class="sc">$</span>y <span class="sc">-</span> legacy_df[i, <span class="st">&quot;Y&quot;</span>])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb174-12"><a href="sampling-design-for-soil-surveys.html#cb174-12" aria-hidden="true" tabindex="-1"></a>    units[i] <span class="ot">&lt;-</span> <span class="fu">which.min</span>(distances)</span>
<span id="cb174-13"><a href="sampling-design-for-soil-surveys.html#cb174-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-14"><a href="sampling-design-for-soil-surveys.html#cb174-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-15"><a href="sampling-design-for-soil-surveys.html#cb174-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create fixed centers from legacy points</span></span>
<span id="cb174-16"><a href="sampling-design-for-soil-surveys.html#cb174-16" aria-hidden="true" tabindex="-1"></a>  fixed <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">data.frame</span>(units, <span class="fu">scale</span>(PSU.df[, covs])[units, ]))</span>
<span id="cb174-17"><a href="sampling-design-for-soil-surveys.html#cb174-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-18"><a href="sampling-design-for-soil-surveys.html#cb174-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Incorporating %d legacy points as fixed centers</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(fixed)))</span>
<span id="cb174-19"><a href="sampling-design-for-soil-surveys.html#cb174-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-20"><a href="sampling-design-for-soil-surveys.html#cb174-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run constrained clustering</span></span>
<span id="cb174-21"><a href="sampling-design-for-soil-surveys.html#cb174-21" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">CSIS</span>(<span class="at">fixed =</span> fixed, </span>
<span id="cb174-22"><a href="sampling-design-for-soil-surveys.html#cb174-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">nsup =</span> n.psu, </span>
<span id="cb174-23"><a href="sampling-design-for-soil-surveys.html#cb174-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">nstarts =</span> iterations, </span>
<span id="cb174-24"><a href="sampling-design-for-soil-surveys.html#cb174-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">mygrd =</span> mygrd)</span>
<span id="cb174-25"><a href="sampling-design-for-soil-surveys.html#cb174-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-26"><a href="sampling-design-for-soil-surveys.html#cb174-26" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb174-27"><a href="sampling-design-for-soil-surveys.html#cb174-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standard k-means without legacy data</span></span>
<span id="cb174-28"><a href="sampling-design-for-soil-surveys.html#cb174-28" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(mygrd, </span>
<span id="cb174-29"><a href="sampling-design-for-soil-surveys.html#cb174-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">centers =</span> n.psu, </span>
<span id="cb174-30"><a href="sampling-design-for-soil-surveys.html#cb174-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">iter.max =</span> <span class="dv">10000</span>, </span>
<span id="cb174-31"><a href="sampling-design-for-soil-surveys.html#cb174-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">nstart =</span> <span class="dv">100</span>)</span>
<span id="cb174-32"><a href="sampling-design-for-soil-surveys.html#cb174-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-33"><a href="sampling-design-for-soil-surveys.html#cb174-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Running standard k-means with %d centers</span><span class="sc">\n</span><span class="st">&quot;</span>, n.psu))</span>
<span id="cb174-34"><a href="sampling-design-for-soil-surveys.html#cb174-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>ðŸ’¡ Note</strong>: Progress is printed as â€œX out of Yâ€ for each clustering iteration.</p>
</blockquote>
</div>
<div id="assign-clusters-and-calculate-distances" class="section level4 hasAnchor" number="3.4.15.3">
<h4><span class="header-section-number">3.4.15.3</span> Assign Clusters and Calculate Distances<a href="sampling-design-for-soil-surveys.html#assign-clusters-and-calculate-distances" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="sampling-design-for-soil-surveys.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign clusters to PSUs</span></span>
<span id="cb175-2"><a href="sampling-design-for-soil-surveys.html#cb175-2" aria-hidden="true" tabindex="-1"></a>PSU.df<span class="sc">$</span>cluster <span class="ot">&lt;-</span> res<span class="sc">$</span>cluster</span>
<span id="cb175-3"><a href="sampling-design-for-soil-surveys.html#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="sampling-design-for-soil-surveys.html#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute distances to nearest cluster center</span></span>
<span id="cb175-5"><a href="sampling-design-for-soil-surveys.html#cb175-5" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> res<span class="sc">$</span>centers, <span class="at">x2 =</span> <span class="fu">scale</span>(PSU.df[, covs]))</span>
<span id="cb175-6"><a href="sampling-design-for-soil-surveys.html#cb175-6" aria-hidden="true" tabindex="-1"></a>units <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> which.min)</span>
<span id="cb175-7"><a href="sampling-design-for-soil-surveys.html#cb175-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-8"><a href="sampling-design-for-soil-surveys.html#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Mean Squared Shortest Distance (MSSSD)</span></span>
<span id="cb175-9"><a href="sampling-design-for-soil-surveys.html#cb175-9" aria-hidden="true" tabindex="-1"></a>dmin <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">2</span>, min)</span>
<span id="cb175-10"><a href="sampling-design-for-soil-surveys.html#cb175-10" aria-hidden="true" tabindex="-1"></a>MSSSD <span class="ot">&lt;-</span> <span class="fu">mean</span>(dmin<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb175-11"><a href="sampling-design-for-soil-surveys.html#cb175-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-12"><a href="sampling-design-for-soil-surveys.html#cb175-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;MSSSD: %.6f</span><span class="sc">\n</span><span class="st">&quot;</span>, MSSSD))</span></code></pre></div>
</div>
<div id="extract-selected-psus" class="section level4 hasAnchor" number="3.4.15.4">
<h4><span class="header-section-number">3.4.15.4</span> Extract Selected PSUs<a href="sampling-design-for-soil-surveys.html#extract-selected-psus" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="sampling-design-for-soil-surveys.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get selected PSU coordinates and covariates</span></span>
<span id="cb176-2"><a href="sampling-design-for-soil-surveys.html#cb176-2" aria-hidden="true" tabindex="-1"></a>myCSCsample <span class="ot">&lt;-</span> PSU.df[units, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, covs)]</span>
<span id="cb176-3"><a href="sampling-design-for-soil-surveys.html#cb176-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-4"><a href="sampling-design-for-soil-surveys.html#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Label as legacy or new</span></span>
<span id="cb176-5"><a href="sampling-design-for-soil-surveys.html#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb176-6"><a href="sampling-design-for-soil-surveys.html#cb176-6" aria-hidden="true" tabindex="-1"></a>  myCSCsample<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;legacy&quot;</span>, <span class="fu">nrow</span>(fixed)), </span>
<span id="cb176-7"><a href="sampling-design-for-soil-surveys.html#cb176-7" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(<span class="st">&quot;new&quot;</span>, <span class="fu">length</span>(units) <span class="sc">-</span> <span class="fu">nrow</span>(fixed)))</span>
<span id="cb176-8"><a href="sampling-design-for-soil-surveys.html#cb176-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb176-9"><a href="sampling-design-for-soil-surveys.html#cb176-9" aria-hidden="true" tabindex="-1"></a>  myCSCsample<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;new&quot;</span></span>
<span id="cb176-10"><a href="sampling-design-for-soil-surveys.html#cb176-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb176-11"><a href="sampling-design-for-soil-surveys.html#cb176-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-12"><a href="sampling-design-for-soil-surveys.html#cb176-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to spatial object</span></span>
<span id="cb176-13"><a href="sampling-design-for-soil-surveys.html#cb176-13" aria-hidden="true" tabindex="-1"></a>myCSCsample <span class="ot">&lt;-</span> myCSCsample <span class="sc">%&gt;%</span></span>
<span id="cb176-14"><a href="sampling-design-for-soil-surveys.html#cb176-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> epsg)</span>
<span id="cb176-15"><a href="sampling-design-for-soil-surveys.html#cb176-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-16"><a href="sampling-design-for-soil-surveys.html#cb176-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate legacy and new points</span></span>
<span id="cb176-17"><a href="sampling-design-for-soil-surveys.html#cb176-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;legacy&quot;</span>)) {</span>
<span id="cb176-18"><a href="sampling-design-for-soil-surveys.html#cb176-18" aria-hidden="true" tabindex="-1"></a>  legacy <span class="ot">&lt;-</span> myCSCsample[myCSCsample<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;legacy&quot;</span>, ]</span>
<span id="cb176-19"><a href="sampling-design-for-soil-surveys.html#cb176-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb176-20"><a href="sampling-design-for-soil-surveys.html#cb176-20" aria-hidden="true" tabindex="-1"></a>new <span class="ot">&lt;-</span> myCSCsample[myCSCsample<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;new&quot;</span>, ]</span>
<span id="cb176-21"><a href="sampling-design-for-soil-surveys.html#cb176-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-22"><a href="sampling-design-for-soil-surveys.html#cb176-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Get PSU IDs</span></span>
<span id="cb176-23"><a href="sampling-design-for-soil-surveys.html#cb176-23" aria-hidden="true" tabindex="-1"></a>PSUs <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_intersection</span>(psu_grid_filtered, new) <span class="sc">%&gt;%</span> </span>
<span id="cb176-24"><a href="sampling-design-for-soil-surveys.html#cb176-24" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(ID)</span>
<span id="cb176-25"><a href="sampling-design-for-soil-surveys.html#cb176-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-26"><a href="sampling-design-for-soil-surveys.html#cb176-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract target PSUs</span></span>
<span id="cb176-27"><a href="sampling-design-for-soil-surveys.html#cb176-27" aria-hidden="true" tabindex="-1"></a>target.PSUs <span class="ot">&lt;-</span> psu_grid_filtered[psu_grid_filtered<span class="sc">$</span>ID <span class="sc">%in%</span> PSUs<span class="sc">$</span>ID, ] <span class="sc">%&gt;%</span> </span>
<span id="cb176-28"><a href="sampling-design-for-soil-surveys.html#cb176-28" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(ID)</span>
<span id="cb176-29"><a href="sampling-design-for-soil-surveys.html#cb176-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-30"><a href="sampling-design-for-soil-surveys.html#cb176-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Selected %d target PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(target.PSUs)))</span>
<span id="cb176-31"><a href="sampling-design-for-soil-surveys.html#cb176-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-32"><a href="sampling-design-for-soil-surveys.html#cb176-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb176-33"><a href="sampling-design-for-soil-surveys.html#cb176-33" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(new, dmin, MSSSD)</span></code></pre></div>
</div>
<div id="visualize-in-covariate-space" class="section level4 hasAnchor" number="3.4.15.5">
<h4><span class="header-section-number">3.4.15.5</span> Visualize in Covariate Space<a href="sampling-design-for-soil-surveys.html#visualize-in-covariate-space" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
</div>
<div id="compute-ssu-tsu" class="section level3 hasAnchor" number="3.4.16">
<h3><span class="header-section-number">3.4.16</span> Compute SSUs and TSUs<a href="sampling-design-for-soil-surveys.html#compute-ssu-tsu" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we generate Secondary Sampling Units (100m Ã— 100m) within each PSU and Tertiary Sampling Units (20m Ã— 20m points) within each SSU.</p>
<div id="load-high-resolution-covariates" class="section level4 hasAnchor" number="3.4.16.1">
<h4><span class="header-section-number">3.4.16.1</span> Load High-Resolution Covariates<a href="sampling-design-for-soil-surveys.html#load-high-resolution-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="sampling-design-for-soil-surveys.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load SSU-level covariates (100m resolution)</span></span>
<span id="cb177-2"><a href="sampling-design-for-soil-surveys.html#cb177-2" aria-hidden="true" tabindex="-1"></a>cov.dat.ssu <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">paste0</span>(raster.path, </span>
<span id="cb177-3"><a href="sampling-design-for-soil-surveys.html#cb177-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">&quot;hres_data/covs_stack_ssu_1ha_ZMB.tif&quot;</span>))</span>
<span id="cb177-4"><a href="sampling-design-for-soil-surveys.html#cb177-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-5"><a href="sampling-design-for-soil-surveys.html#cb177-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Loaded %d high-resolution covariates</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat.ssu)))</span>
<span id="cb177-6"><a href="sampling-design-for-soil-surveys.html#cb177-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-7"><a href="sampling-design-for-soil-surveys.html#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display covariate names</span></span>
<span id="cb177-8"><a href="sampling-design-for-soil-surveys.html#cb177-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cov.dat.ssu)</span>
<span id="cb177-9"><a href="sampling-design-for-soil-surveys.html#cb177-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-10"><a href="sampling-design-for-soil-surveys.html#cb177-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove system-specific bands if needed</span></span>
<span id="cb177-11"><a href="sampling-design-for-soil-surveys.html#cb177-11" aria-hidden="true" tabindex="-1"></a>cov.dat.ssu <span class="ot">&lt;-</span> <span class="fu">subset</span>(cov.dat.ssu, </span>
<span id="cb177-12"><a href="sampling-design-for-soil-surveys.html#cb177-12" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">names</span>(cov.dat.ssu)[<span class="sc">!</span><span class="fu">names</span>(cov.dat.ssu) <span class="sc">%in%</span> </span>
<span id="cb177-13"><a href="sampling-design-for-soil-surveys.html#cb177-13" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="st">&quot;sysisen_B2&quot;</span>, <span class="st">&quot;sysisen_B3&quot;</span>, <span class="st">&quot;sysisen_B4&quot;</span>, <span class="st">&quot;sysisen_B5&quot;</span>,</span>
<span id="cb177-14"><a href="sampling-design-for-soil-surveys.html#cb177-14" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;sysisen_B6&quot;</span>, <span class="st">&quot;sysisen_B7&quot;</span>, <span class="st">&quot;sysisen_B8&quot;</span>, <span class="st">&quot;sysisen_B8A&quot;</span>,</span>
<span id="cb177-15"><a href="sampling-design-for-soil-surveys.html#cb177-15" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;sysisen_B11&quot;</span>, <span class="st">&quot;sysisen_B12&quot;</span>)])</span>
<span id="cb177-16"><a href="sampling-design-for-soil-surveys.html#cb177-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-17"><a href="sampling-design-for-soil-surveys.html#cb177-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace NA with 0 (for categorical variables)</span></span>
<span id="cb177-18"><a href="sampling-design-for-soil-surveys.html#cb177-18" aria-hidden="true" tabindex="-1"></a>cov.dat.ssu[<span class="fu">is.na</span>(cov.dat.ssu)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb177-19"><a href="sampling-design-for-soil-surveys.html#cb177-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-20"><a href="sampling-design-for-soil-surveys.html#cb177-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Final SSU covariates: %d layers</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nlyr</span>(cov.dat.ssu)))</span></code></pre></div>
</div>
<div id="process-each-psu" class="section level4 hasAnchor" number="3.4.16.2">
<h4><span class="header-section-number">3.4.16.2</span> Process Each PSU<a href="sampling-design-for-soil-surveys.html#process-each-psu" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="sampling-design-for-soil-surveys.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize storage lists</span></span>
<span id="cb178-2"><a href="sampling-design-for-soil-surveys.html#cb178-2" aria-hidden="true" tabindex="-1"></a>selected_ssus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb178-3"><a href="sampling-design-for-soil-surveys.html#cb178-3" aria-hidden="true" tabindex="-1"></a>all_psus_tsus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb178-4"><a href="sampling-design-for-soil-surveys.html#cb178-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-5"><a href="sampling-design-for-soil-surveys.html#cb178-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Main loop: Process each PSU</span></span>
<span id="cb178-6"><a href="sampling-design-for-soil-surveys.html#cb178-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (psu_id <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(target.PSUs)) {</span>
<span id="cb178-7"><a href="sampling-design-for-soil-surveys.html#cb178-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-8"><a href="sampling-design-for-soil-surveys.html#cb178-8" aria-hidden="true" tabindex="-1"></a>  selected_psu <span class="ot">&lt;-</span> target.PSUs[psu_id, ]</span>
<span id="cb178-9"><a href="sampling-design-for-soil-surveys.html#cb178-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-10"><a href="sampling-design-for-soil-surveys.html#cb178-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate 100m Ã— 100m SSU grid</span></span>
<span id="cb178-11"><a href="sampling-design-for-soil-surveys.html#cb178-11" aria-hidden="true" tabindex="-1"></a>  ssu_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(selected_psu, </span>
<span id="cb178-12"><a href="sampling-design-for-soil-surveys.html#cb178-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cellsize =</span> <span class="fu">c</span>(ssu_size, ssu_size), </span>
<span id="cb178-13"><a href="sampling-design-for-soil-surveys.html#cb178-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">square =</span> <span class="cn">TRUE</span>)</span>
<span id="cb178-14"><a href="sampling-design-for-soil-surveys.html#cb178-14" aria-hidden="true" tabindex="-1"></a>  ssu_grid_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> ssu_grid)</span>
<span id="cb178-15"><a href="sampling-design-for-soil-surveys.html#cb178-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-16"><a href="sampling-design-for-soil-surveys.html#cb178-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to SpatVector for extraction</span></span>
<span id="cb178-17"><a href="sampling-design-for-soil-surveys.html#cb178-17" aria-hidden="true" tabindex="-1"></a>  ssu_grid_vect <span class="ot">&lt;-</span> <span class="fu">vect</span>(ssu_grid_sf)</span>
<span id="cb178-18"><a href="sampling-design-for-soil-surveys.html#cb178-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-19"><a href="sampling-design-for-soil-surveys.html#cb178-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract land-use values to filter SSUs</span></span>
<span id="cb178-20"><a href="sampling-design-for-soil-surveys.html#cb178-20" aria-hidden="true" tabindex="-1"></a>  extracted_values <span class="ot">&lt;-</span> <span class="fu">extract</span>(crops, ssu_grid_vect, <span class="at">fun =</span> table)</span>
<span id="cb178-21"><a href="sampling-design-for-soil-surveys.html#cb178-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-22"><a href="sampling-design-for-soil-surveys.html#cb178-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate land-use percentage (25 pixels per SSU at 20m resolution)</span></span>
<span id="cb178-23"><a href="sampling-design-for-soil-surveys.html#cb178-23" aria-hidden="true" tabindex="-1"></a>  ssu_grid_sf<span class="sc">$</span>lu <span class="ot">&lt;-</span> (extracted_values[, <span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">/</span> <span class="dv">25</span></span>
<span id="cb178-24"><a href="sampling-design-for-soil-surveys.html#cb178-24" aria-hidden="true" tabindex="-1"></a>  ssu_grid_sf <span class="ot">&lt;-</span> ssu_grid_sf[ssu_grid_sf<span class="sc">$</span>lu <span class="sc">&gt;</span> percent_crop, ]</span>
<span id="cb178-25"><a href="sampling-design-for-soil-surveys.html#cb178-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-26"><a href="sampling-design-for-soil-surveys.html#cb178-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Progress update</span></span>
<span id="cb178-27"><a href="sampling-design-for-soil-surveys.html#cb178-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (psu_id <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> psu_id <span class="sc">==</span> <span class="fu">nrow</span>(target.PSUs)) {</span>
<span id="cb178-28"><a href="sampling-design-for-soil-surveys.html#cb178-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">Progress: %.2f%% (%d out of %d)&quot;</span>, </span>
<span id="cb178-29"><a href="sampling-design-for-soil-surveys.html#cb178-29" aria-hidden="true" tabindex="-1"></a>                (psu_id <span class="sc">/</span> <span class="fu">nrow</span>(target.PSUs)) <span class="sc">*</span> <span class="dv">100</span>, </span>
<span id="cb178-30"><a href="sampling-design-for-soil-surveys.html#cb178-30" aria-hidden="true" tabindex="-1"></a>                psu_id, <span class="fu">nrow</span>(target.PSUs)))</span>
<span id="cb178-31"><a href="sampling-design-for-soil-surveys.html#cb178-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">flush.console</span>()</span>
<span id="cb178-32"><a href="sampling-design-for-soil-surveys.html#cb178-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-33"><a href="sampling-design-for-soil-surveys.html#cb178-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-34"><a href="sampling-design-for-soil-surveys.html#cb178-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check minimum SSU requirement</span></span>
<span id="cb178-35"><a href="sampling-design-for-soil-surveys.html#cb178-35" aria-hidden="true" tabindex="-1"></a>  total_ssus <span class="ot">&lt;-</span> <span class="fu">nrow</span>(ssu_grid_sf)</span>
<span id="cb178-36"><a href="sampling-design-for-soil-surveys.html#cb178-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (total_ssus <span class="sc">&lt;</span> (num_primary_ssus <span class="sc">+</span> num_alternative_ssus)) {</span>
<span id="cb178-37"><a href="sampling-design-for-soil-surveys.html#cb178-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">&quot;PSU&quot;</span>, psu_id, <span class="st">&quot;does not have enough SSUs. Skipping.&quot;</span>))</span>
<span id="cb178-38"><a href="sampling-design-for-soil-surveys.html#cb178-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb178-39"><a href="sampling-design-for-soil-surveys.html#cb178-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-40"><a href="sampling-design-for-soil-surveys.html#cb178-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-41"><a href="sampling-design-for-soil-surveys.html#cb178-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract covariate values for each SSU</span></span>
<span id="cb178-42"><a href="sampling-design-for-soil-surveys.html#cb178-42" aria-hidden="true" tabindex="-1"></a>  ssu_covariates <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(cov.dat.ssu, <span class="fu">vect</span>(ssu_grid_sf), <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb178-43"><a href="sampling-design-for-soil-surveys.html#cb178-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-44"><a href="sampling-design-for-soil-surveys.html#cb178-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge with SSU spatial data</span></span>
<span id="cb178-45"><a href="sampling-design-for-soil-surveys.html#cb178-45" aria-hidden="true" tabindex="-1"></a>  ssu_data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ssu_grid_sf, ssu_covariates[, <span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb178-46"><a href="sampling-design-for-soil-surveys.html#cb178-46" aria-hidden="true" tabindex="-1"></a>  ssu_data_values <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(ssu_data)</span>
<span id="cb178-47"><a href="sampling-design-for-soil-surveys.html#cb178-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-48"><a href="sampling-design-for-soil-surveys.html#cb178-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify columns to exclude from scaling (categorical)</span></span>
<span id="cb178-49"><a href="sampling-design-for-soil-surveys.html#cb178-49" aria-hidden="true" tabindex="-1"></a>  exclude <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;^geomorph_|^lu$&quot;</span>, <span class="fu">names</span>(ssu_data_values), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb178-50"><a href="sampling-design-for-soil-surveys.html#cb178-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-51"><a href="sampling-design-for-soil-surveys.html#cb178-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Separate scalable and non-scalable data</span></span>
<span id="cb178-52"><a href="sampling-design-for-soil-surveys.html#cb178-52" aria-hidden="true" tabindex="-1"></a>  to_scale <span class="ot">&lt;-</span> ssu_data_values[, <span class="sc">!</span><span class="fu">names</span>(ssu_data_values) <span class="sc">%in%</span> exclude]</span>
<span id="cb178-53"><a href="sampling-design-for-soil-surveys.html#cb178-53" aria-hidden="true" tabindex="-1"></a>  to_keep  <span class="ot">&lt;-</span> ssu_data_values[, <span class="fu">names</span>(ssu_data_values) <span class="sc">%in%</span> exclude, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb178-54"><a href="sampling-design-for-soil-surveys.html#cb178-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-55"><a href="sampling-design-for-soil-surveys.html#cb178-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove NA-only columns</span></span>
<span id="cb178-56"><a href="sampling-design-for-soil-surveys.html#cb178-56" aria-hidden="true" tabindex="-1"></a>  to_scale <span class="ot">&lt;-</span> to_scale[, <span class="fu">colSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(to_scale)) <span class="sc">&gt;</span> <span class="dv">0</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb178-57"><a href="sampling-design-for-soil-surveys.html#cb178-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-58"><a href="sampling-design-for-soil-surveys.html#cb178-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify zero-variance columns</span></span>
<span id="cb178-59"><a href="sampling-design-for-soil-surveys.html#cb178-59" aria-hidden="true" tabindex="-1"></a>  zero_variance_cols <span class="ot">&lt;-</span> <span class="fu">sapply</span>(to_scale, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb178-60"><a href="sampling-design-for-soil-surveys.html#cb178-60" aria-hidden="true" tabindex="-1"></a>  zero_variance_cols[<span class="fu">is.na</span>(zero_variance_cols)] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb178-61"><a href="sampling-design-for-soil-surveys.html#cb178-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-62"><a href="sampling-design-for-soil-surveys.html#cb178-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale only non-zero-variance columns</span></span>
<span id="cb178-63"><a href="sampling-design-for-soil-surveys.html#cb178-63" aria-hidden="true" tabindex="-1"></a>  scaled_part <span class="ot">&lt;-</span> to_scale</span>
<span id="cb178-64"><a href="sampling-design-for-soil-surveys.html#cb178-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>zero_variance_cols)) {</span>
<span id="cb178-65"><a href="sampling-design-for-soil-surveys.html#cb178-65" aria-hidden="true" tabindex="-1"></a>    scaled_part[, <span class="sc">!</span>zero_variance_cols] <span class="ot">&lt;-</span> <span class="fu">scale</span>(to_scale[, <span class="sc">!</span>zero_variance_cols])</span>
<span id="cb178-66"><a href="sampling-design-for-soil-surveys.html#cb178-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-67"><a href="sampling-design-for-soil-surveys.html#cb178-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-68"><a href="sampling-design-for-soil-surveys.html#cb178-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recombine</span></span>
<span id="cb178-69"><a href="sampling-design-for-soil-surveys.html#cb178-69" aria-hidden="true" tabindex="-1"></a>  mygrd_ssu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(to_keep, scaled_part)</span>
<span id="cb178-70"><a href="sampling-design-for-soil-surveys.html#cb178-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-71"><a href="sampling-design-for-soil-surveys.html#cb178-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform k-means clustering for this PSU</span></span>
<span id="cb178-72"><a href="sampling-design-for-soil-surveys.html#cb178-72" aria-hidden="true" tabindex="-1"></a>  optimal_k <span class="ot">&lt;-</span> num_primary_ssus  <span class="co"># 4 clusters</span></span>
<span id="cb178-73"><a href="sampling-design-for-soil-surveys.html#cb178-73" aria-hidden="true" tabindex="-1"></a>  kmeans_result <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(mygrd_ssu[, <span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb178-74"><a href="sampling-design-for-soil-surveys.html#cb178-74" aria-hidden="true" tabindex="-1"></a>                          <span class="at">centers =</span> optimal_k, </span>
<span id="cb178-75"><a href="sampling-design-for-soil-surveys.html#cb178-75" aria-hidden="true" tabindex="-1"></a>                          <span class="at">iter.max =</span> <span class="dv">10000</span>, </span>
<span id="cb178-76"><a href="sampling-design-for-soil-surveys.html#cb178-76" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nstart =</span> <span class="dv">10</span>)</span>
<span id="cb178-77"><a href="sampling-design-for-soil-surveys.html#cb178-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-78"><a href="sampling-design-for-soil-surveys.html#cb178-78" aria-hidden="true" tabindex="-1"></a>  ssu_data<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(kmeans_result<span class="sc">$</span>cluster)</span>
<span id="cb178-79"><a href="sampling-design-for-soil-surveys.html#cb178-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-80"><a href="sampling-design-for-soil-surveys.html#cb178-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CSC Sampling: Select closest SSUs to cluster centers</span></span>
<span id="cb178-81"><a href="sampling-design-for-soil-surveys.html#cb178-81" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="fu">rdist</span>(<span class="at">x1 =</span> kmeans_result<span class="sc">$</span>centers, <span class="at">x2 =</span> mygrd_ssu[, <span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb178-82"><a href="sampling-design-for-soil-surveys.html#cb178-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-83"><a href="sampling-design-for-soil-surveys.html#cb178-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target SSUs (closest to centers)</span></span>
<span id="cb178-84"><a href="sampling-design-for-soil-surveys.html#cb178-84" aria-hidden="true" tabindex="-1"></a>  target_units <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">order</span>(x)[<span class="dv">1</span>])</span>
<span id="cb178-85"><a href="sampling-design-for-soil-surveys.html#cb178-85" aria-hidden="true" tabindex="-1"></a>  target_ssus <span class="ot">&lt;-</span> ssu_data[target_units, ]</span>
<span id="cb178-86"><a href="sampling-design-for-soil-surveys.html#cb178-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-87"><a href="sampling-design-for-soil-surveys.html#cb178-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replacement SSUs (second closest to centers)</span></span>
<span id="cb178-88"><a href="sampling-design-for-soil-surveys.html#cb178-88" aria-hidden="true" tabindex="-1"></a>  replacement_units <span class="ot">&lt;-</span> <span class="fu">apply</span>(D, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">order</span>(x)[<span class="dv">2</span>])</span>
<span id="cb178-89"><a href="sampling-design-for-soil-surveys.html#cb178-89" aria-hidden="true" tabindex="-1"></a>  replacement_ssus <span class="ot">&lt;-</span> ssu_data[replacement_units, ]</span>
<span id="cb178-90"><a href="sampling-design-for-soil-surveys.html#cb178-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-91"><a href="sampling-design-for-soil-surveys.html#cb178-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add metadata</span></span>
<span id="cb178-92"><a href="sampling-design-for-soil-surveys.html#cb178-92" aria-hidden="true" tabindex="-1"></a>  target_ssus<span class="sc">$</span>SSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Target&quot;</span></span>
<span id="cb178-93"><a href="sampling-design-for-soil-surveys.html#cb178-93" aria-hidden="true" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>SSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Replacement&quot;</span></span>
<span id="cb178-94"><a href="sampling-design-for-soil-surveys.html#cb178-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-95"><a href="sampling-design-for-soil-surveys.html#cb178-95" aria-hidden="true" tabindex="-1"></a>  target_ssus<span class="sc">$</span>SSU_ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(target_ssus)</span>
<span id="cb178-96"><a href="sampling-design-for-soil-surveys.html#cb178-96" aria-hidden="true" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>SSU_ID <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(target_ssus) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">nrow</span>(target_ssus))</span>
<span id="cb178-97"><a href="sampling-design-for-soil-surveys.html#cb178-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-98"><a href="sampling-design-for-soil-surveys.html#cb178-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Link replacements to targets by cluster</span></span>
<span id="cb178-99"><a href="sampling-design-for-soil-surveys.html#cb178-99" aria-hidden="true" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>replacement_for <span class="ot">&lt;-</span> <span class="fu">sapply</span>(replacement_ssus<span class="sc">$</span>cluster, <span class="cf">function</span>(cl) {</span>
<span id="cb178-100"><a href="sampling-design-for-soil-surveys.html#cb178-100" aria-hidden="true" tabindex="-1"></a>    matched <span class="ot">&lt;-</span> target_ssus<span class="sc">$</span>SSU_ID[target_ssus<span class="sc">$</span>cluster <span class="sc">==</span> cl]</span>
<span id="cb178-101"><a href="sampling-design-for-soil-surveys.html#cb178-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(matched) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">return</span>(matched[<span class="dv">1</span>]) <span class="cf">else</span> <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb178-102"><a href="sampling-design-for-soil-surveys.html#cb178-102" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb178-103"><a href="sampling-design-for-soil-surveys.html#cb178-103" aria-hidden="true" tabindex="-1"></a>  target_ssus<span class="sc">$</span>replacement_for <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb178-104"><a href="sampling-design-for-soil-surveys.html#cb178-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-105"><a href="sampling-design-for-soil-surveys.html#cb178-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add PSU ID</span></span>
<span id="cb178-106"><a href="sampling-design-for-soil-surveys.html#cb178-106" aria-hidden="true" tabindex="-1"></a>  target_ssus<span class="sc">$</span>PSU_ID <span class="ot">&lt;-</span> selected_psu<span class="sc">$</span>ID</span>
<span id="cb178-107"><a href="sampling-design-for-soil-surveys.html#cb178-107" aria-hidden="true" tabindex="-1"></a>  replacement_ssus<span class="sc">$</span>PSU_ID <span class="ot">&lt;-</span> selected_psu<span class="sc">$</span>ID</span>
<span id="cb178-108"><a href="sampling-design-for-soil-surveys.html#cb178-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-109"><a href="sampling-design-for-soil-surveys.html#cb178-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store SSUs</span></span>
<span id="cb178-110"><a href="sampling-design-for-soil-surveys.html#cb178-110" aria-hidden="true" tabindex="-1"></a>  selected_ssus[[psu_id]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(target_ssus, replacement_ssus)</span>
<span id="cb178-111"><a href="sampling-design-for-soil-surveys.html#cb178-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-112"><a href="sampling-design-for-soil-surveys.html#cb178-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate TSUs for target SSUs</span></span>
<span id="cb178-113"><a href="sampling-design-for-soil-surveys.html#cb178-113" aria-hidden="true" tabindex="-1"></a>  primary_tsus <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rownames</span>(target_ssus), <span class="cf">function</span>(index) {</span>
<span id="cb178-114"><a href="sampling-design-for-soil-surveys.html#cb178-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_tsu_points_within_ssu</span>(</span>
<span id="cb178-115"><a href="sampling-design-for-soil-surveys.html#cb178-115" aria-hidden="true" tabindex="-1"></a>      ssu_grid_sf[<span class="fu">rownames</span>(ssu_grid_sf) <span class="sc">==</span> index, ], </span>
<span id="cb178-116"><a href="sampling-design-for-soil-surveys.html#cb178-116" aria-hidden="true" tabindex="-1"></a>      number_TSUs, </span>
<span id="cb178-117"><a href="sampling-design-for-soil-surveys.html#cb178-117" aria-hidden="true" tabindex="-1"></a>      index, </span>
<span id="cb178-118"><a href="sampling-design-for-soil-surveys.html#cb178-118" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Target&quot;</span>, </span>
<span id="cb178-119"><a href="sampling-design-for-soil-surveys.html#cb178-119" aria-hidden="true" tabindex="-1"></a>      crops</span>
<span id="cb178-120"><a href="sampling-design-for-soil-surveys.html#cb178-120" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb178-121"><a href="sampling-design-for-soil-surveys.html#cb178-121" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb178-122"><a href="sampling-design-for-soil-surveys.html#cb178-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-123"><a href="sampling-design-for-soil-surveys.html#cb178-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate TSUs for replacement SSUs</span></span>
<span id="cb178-124"><a href="sampling-design-for-soil-surveys.html#cb178-124" aria-hidden="true" tabindex="-1"></a>  alternative_tsus <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rownames</span>(replacement_ssus), <span class="cf">function</span>(index) {</span>
<span id="cb178-125"><a href="sampling-design-for-soil-surveys.html#cb178-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_tsu_points_within_ssu</span>(</span>
<span id="cb178-126"><a href="sampling-design-for-soil-surveys.html#cb178-126" aria-hidden="true" tabindex="-1"></a>      ssu_grid_sf[<span class="fu">rownames</span>(ssu_grid_sf) <span class="sc">==</span> index, ], </span>
<span id="cb178-127"><a href="sampling-design-for-soil-surveys.html#cb178-127" aria-hidden="true" tabindex="-1"></a>      number_TSUs, </span>
<span id="cb178-128"><a href="sampling-design-for-soil-surveys.html#cb178-128" aria-hidden="true" tabindex="-1"></a>      index, </span>
<span id="cb178-129"><a href="sampling-design-for-soil-surveys.html#cb178-129" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Replacement&quot;</span>, </span>
<span id="cb178-130"><a href="sampling-design-for-soil-surveys.html#cb178-130" aria-hidden="true" tabindex="-1"></a>      crops</span>
<span id="cb178-131"><a href="sampling-design-for-soil-surveys.html#cb178-131" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb178-132"><a href="sampling-design-for-soil-surveys.html#cb178-132" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb178-133"><a href="sampling-design-for-soil-surveys.html#cb178-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-134"><a href="sampling-design-for-soil-surveys.html#cb178-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all TSUs for this PSU</span></span>
<span id="cb178-135"><a href="sampling-design-for-soil-surveys.html#cb178-135" aria-hidden="true" tabindex="-1"></a>  all_psus_tsus[[psu_id]] <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">c</span>(primary_tsus, alternative_tsus))</span>
<span id="cb178-136"><a href="sampling-design-for-soil-surveys.html#cb178-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb178-137"><a href="sampling-design-for-soil-surveys.html#cb178-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-138"><a href="sampling-design-for-soil-surveys.html#cb178-138" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Processing complete</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb178-139"><a href="sampling-design-for-soil-surveys.html#cb178-139" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  Successful PSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">length</span>(selected_ssus)))</span></code></pre></div>
</div>
<div id="combine-ssus-and-tsus" class="section level4 hasAnchor" number="3.4.16.3">
<h4><span class="header-section-number">3.4.16.3</span> Combine SSUs and TSUs<a href="sampling-design-for-soil-surveys.html#combine-ssus-and-tsus" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="sampling-design-for-soil-surveys.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all SSUs</span></span>
<span id="cb179-2"><a href="sampling-design-for-soil-surveys.html#cb179-2" aria-hidden="true" tabindex="-1"></a>all_ssus <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, selected_ssus)</span>
<span id="cb179-3"><a href="sampling-design-for-soil-surveys.html#cb179-3" aria-hidden="true" tabindex="-1"></a>all_ssus <span class="ot">&lt;-</span> all_ssus <span class="sc">%&gt;%</span></span>
<span id="cb179-4"><a href="sampling-design-for-soil-surveys.html#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(PSU_ID, SSU_ID), as.numeric)</span>
<span id="cb179-5"><a href="sampling-design-for-soil-surveys.html#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="sampling-design-for-soil-surveys.html#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all TSUs</span></span>
<span id="cb179-7"><a href="sampling-design-for-soil-surveys.html#cb179-7" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, all_psus_tsus)</span>
<span id="cb179-8"><a href="sampling-design-for-soil-surveys.html#cb179-8" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb179-9"><a href="sampling-design-for-soil-surveys.html#cb179-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(PSU_ID, SSU_ID), as.numeric)</span>
<span id="cb179-10"><a href="sampling-design-for-soil-surveys.html#cb179-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-11"><a href="sampling-design-for-soil-surveys.html#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Join TSU and SSU metadata</span></span>
<span id="cb179-12"><a href="sampling-design-for-soil-surveys.html#cb179-12" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> <span class="fu">st_join</span>(all_tsus, </span>
<span id="cb179-13"><a href="sampling-design-for-soil-surveys.html#cb179-13" aria-hidden="true" tabindex="-1"></a>                    all_ssus[<span class="fu">c</span>(<span class="st">&quot;PSU_ID&quot;</span>, <span class="st">&quot;SSU_ID&quot;</span>, <span class="st">&quot;SSU_Type&quot;</span>, <span class="st">&quot;replacement_for&quot;</span>)])</span>
<span id="cb179-14"><a href="sampling-design-for-soil-surveys.html#cb179-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-15"><a href="sampling-design-for-soil-surveys.html#cb179-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorganize columns</span></span>
<span id="cb179-16"><a href="sampling-design-for-soil-surveys.html#cb179-16" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb179-17"><a href="sampling-design-for-soil-surveys.html#cb179-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PSU_ID =</span> PSU_ID.x, </span>
<span id="cb179-18"><a href="sampling-design-for-soil-surveys.html#cb179-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">SSU_ID =</span> SSU_ID.y, </span>
<span id="cb179-19"><a href="sampling-design-for-soil-surveys.html#cb179-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">SSU_Type =</span> SSU_Type.y,</span>
<span id="cb179-20"><a href="sampling-design-for-soil-surveys.html#cb179-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">Replacement_for =</span> replacement_for, </span>
<span id="cb179-21"><a href="sampling-design-for-soil-surveys.html#cb179-21" aria-hidden="true" tabindex="-1"></a>         TSU_ID, </span>
<span id="cb179-22"><a href="sampling-design-for-soil-surveys.html#cb179-22" aria-hidden="true" tabindex="-1"></a>         geometry)</span>
<span id="cb179-23"><a href="sampling-design-for-soil-surveys.html#cb179-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-24"><a href="sampling-design-for-soil-surveys.html#cb179-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Label TSU types</span></span>
<span id="cb179-25"><a href="sampling-design-for-soil-surveys.html#cb179-25" aria-hidden="true" tabindex="-1"></a>all_tsus<span class="sc">$</span>TSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Target&quot;</span></span>
<span id="cb179-26"><a href="sampling-design-for-soil-surveys.html#cb179-26" aria-hidden="true" tabindex="-1"></a>all_tsus[all_tsus<span class="sc">$</span>TSU_ID <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="st">&quot;TSU_Type&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Alternative&quot;</span></span>
<span id="cb179-27"><a href="sampling-design-for-soil-surveys.html#cb179-27" aria-hidden="true" tabindex="-1"></a>all_tsus<span class="sc">$</span>PSU_Type <span class="ot">&lt;-</span> <span class="st">&quot;Target&quot;</span></span>
<span id="cb179-28"><a href="sampling-design-for-soil-surveys.html#cb179-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-29"><a href="sampling-design-for-soil-surveys.html#cb179-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Final column selection</span></span>
<span id="cb179-30"><a href="sampling-design-for-soil-surveys.html#cb179-30" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb179-31"><a href="sampling-design-for-soil-surveys.html#cb179-31" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">&quot;PSU_ID&quot;</span>, <span class="st">&quot;SSU_ID&quot;</span>, <span class="st">&quot;SSU_Type&quot;</span>, <span class="st">&quot;Replacement_for&quot;</span>, </span>
<span id="cb179-32"><a href="sampling-design-for-soil-surveys.html#cb179-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;TSU_ID&quot;</span>, <span class="st">&quot;TSU_Type&quot;</span>, <span class="st">&quot;geometry&quot;</span>)</span>
<span id="cb179-33"><a href="sampling-design-for-soil-surveys.html#cb179-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-34"><a href="sampling-design-for-soil-surveys.html#cb179-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Total SSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(all_ssus)))</span>
<span id="cb179-35"><a href="sampling-design-for-soil-surveys.html#cb179-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;âœ“ Total TSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(all_tsus)))</span>
<span id="cb179-36"><a href="sampling-design-for-soil-surveys.html#cb179-36" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;âœ“ Target sampling sites: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb179-37"><a href="sampling-design-for-soil-surveys.html#cb179-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(all_tsus<span class="sc">$</span>SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> all_tsus<span class="sc">$</span>TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)))</span></code></pre></div>
</div>
</div>
<div id="export-units" class="section level3 hasAnchor" number="3.4.17">
<h3><span class="header-section-number">3.4.17</span> Export Sampling Units<a href="sampling-design-for-soil-surveys.html#export-units" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="create-cluster-raster" class="section level4 hasAnchor" number="3.4.17.1">
<h4><span class="header-section-number">3.4.17.1</span> Create Cluster Raster<a href="sampling-design-for-soil-surveys.html#create-cluster-raster" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="sampling-design-for-soil-surveys.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert cluster information to raster</span></span>
<span id="cb180-2"><a href="sampling-design-for-soil-surveys.html#cb180-2" aria-hidden="true" tabindex="-1"></a>dfr <span class="ot">&lt;-</span> PSU.df[, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;cluster&quot;</span>)]</span>
<span id="cb180-3"><a href="sampling-design-for-soil-surveys.html#cb180-3" aria-hidden="true" tabindex="-1"></a>dfr<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(dfr<span class="sc">$</span>cluster)</span>
<span id="cb180-4"><a href="sampling-design-for-soil-surveys.html#cb180-4" aria-hidden="true" tabindex="-1"></a>dfr <span class="ot">&lt;-</span> <span class="fu">rasterFromXYZ</span>(dfr)</span>
<span id="cb180-5"><a href="sampling-design-for-soil-surveys.html#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(dfr) <span class="ot">&lt;-</span> epsg</span>
<span id="cb180-6"><a href="sampling-design-for-soil-surveys.html#cb180-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-7"><a href="sampling-design-for-soil-surveys.html#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Associate clusters with PSUs</span></span>
<span id="cb180-8"><a href="sampling-design-for-soil-surveys.html#cb180-8" aria-hidden="true" tabindex="-1"></a>PSU_cluster.id <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">extract</span>(dfr, target.PSUs))</span>
<span id="cb180-9"><a href="sampling-design-for-soil-surveys.html#cb180-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-10"><a href="sampling-design-for-soil-surveys.html#cb180-10" aria-hidden="true" tabindex="-1"></a>valid.PSU_clusters <span class="ot">&lt;-</span> target.PSUs <span class="sc">%&gt;%</span> </span>
<span id="cb180-11"><a href="sampling-design-for-soil-surveys.html#cb180-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">extract</span>(dfr, target.PSUs, <span class="at">fun =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb180-12"><a href="sampling-design-for-soil-surveys.html#cb180-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-13"><a href="sampling-design-for-soil-surveys.html#cb180-13" aria-hidden="true" tabindex="-1"></a>all.PSU_clusters <span class="ot">&lt;-</span> psu_grid_filtered <span class="sc">%&gt;%</span> </span>
<span id="cb180-14"><a href="sampling-design-for-soil-surveys.html#cb180-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">extract</span>(dfr, psu_grid_filtered, <span class="at">fun =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb180-15"><a href="sampling-design-for-soil-surveys.html#cb180-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-16"><a href="sampling-design-for-soil-surveys.html#cb180-16" aria-hidden="true" tabindex="-1"></a>all.PSU_clusters <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(all.PSU_clusters)</span></code></pre></div>
</div>
<div id="join-cluster-info-to-tsus" class="section level4 hasAnchor" number="3.4.17.2">
<h4><span class="header-section-number">3.4.17.2</span> Join Cluster Info to TSUs<a href="sampling-design-for-soil-surveys.html#join-cluster-info-to-tsus" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="sampling-design-for-soil-surveys.html#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename cluster column</span></span>
<span id="cb181-2"><a href="sampling-design-for-soil-surveys.html#cb181-2" aria-hidden="true" tabindex="-1"></a>valid.PSU_clusters <span class="ot">&lt;-</span> valid.PSU_clusters <span class="sc">%&gt;%</span></span>
<span id="cb181-3"><a href="sampling-design-for-soil-surveys.html#cb181-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Replace_ID =</span> cluster)</span>
<span id="cb181-4"><a href="sampling-design-for-soil-surveys.html#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="sampling-design-for-soil-surveys.html#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join to TSUs</span></span>
<span id="cb181-6"><a href="sampling-design-for-soil-surveys.html#cb181-6" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> <span class="fu">st_join</span>(all_tsus, valid.PSU_clusters)</span>
<span id="cb181-7"><a href="sampling-design-for-soil-surveys.html#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="sampling-design-for-soil-surveys.html#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign sampling order</span></span>
<span id="cb181-9"><a href="sampling-design-for-soil-surveys.html#cb181-9" aria-hidden="true" tabindex="-1"></a>all_tsus <span class="ot">&lt;-</span> all_tsus <span class="sc">%&gt;%</span></span>
<span id="cb181-10"><a href="sampling-design-for-soil-surveys.html#cb181-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PSU_ID) <span class="sc">%&gt;%</span></span>
<span id="cb181-11"><a href="sampling-design-for-soil-surveys.html#cb181-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">order =</span> <span class="fu">match</span>(SSU_ID, <span class="fu">unique</span>(SSU_ID))) <span class="sc">%&gt;%</span></span>
<span id="cb181-12"><a href="sampling-design-for-soil-surveys.html#cb181-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
</div>
<div id="create-site-ids" class="section level4 hasAnchor" number="3.4.17.3">
<h4><span class="header-section-number">3.4.17.3</span> Create Site IDs<a href="sampling-design-for-soil-surveys.html#create-site-ids" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="sampling-design-for-soil-surveys.html#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate unique site IDs</span></span>
<span id="cb182-2"><a href="sampling-design-for-soil-surveys.html#cb182-2" aria-hidden="true" tabindex="-1"></a>all_tsus<span class="sc">$</span>site_id <span class="ot">&lt;-</span> <span class="fu">paste0</span>(ISO.code, </span>
<span id="cb182-3"><a href="sampling-design-for-soil-surveys.html#cb182-3" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sprintf</span>(<span class="st">&quot;%04d&quot;</span>, all_tsus<span class="sc">$</span>PSU_ID), </span>
<span id="cb182-4"><a href="sampling-design-for-soil-surveys.html#cb182-4" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;-&quot;</span>, all_tsus<span class="sc">$</span>SSU_ID, </span>
<span id="cb182-5"><a href="sampling-design-for-soil-surveys.html#cb182-5" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;-&quot;</span>, all_tsus<span class="sc">$</span>TSU_ID, </span>
<span id="cb182-6"><a href="sampling-design-for-soil-surveys.html#cb182-6" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;C&quot;</span>)  <span class="co"># C = Cropland</span></span>
<span id="cb182-7"><a href="sampling-design-for-soil-surveys.html#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="sampling-design-for-soil-surveys.html#cb182-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Created %d unique site IDs</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(all_tsus)))</span></code></pre></div>
</div>
<div id="export-shapefiles" class="section level4 hasAnchor" number="3.4.17.4">
<h4><span class="header-section-number">3.4.17.4</span> Export Shapefiles<a href="sampling-design-for-soil-surveys.html#export-shapefiles" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="sampling-design-for-soil-surveys.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export target PSUs</span></span>
<span id="cb183-2"><a href="sampling-design-for-soil-surveys.html#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(valid.PSU_clusters, </span>
<span id="cb183-3"><a href="sampling-design-for-soil-surveys.html#cb183-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/PSUs_target.shp&quot;</span>), </span>
<span id="cb183-4"><a href="sampling-design-for-soil-surveys.html#cb183-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb183-5"><a href="sampling-design-for-soil-surveys.html#cb183-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-6"><a href="sampling-design-for-soil-surveys.html#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Export target TSUs</span></span>
<span id="cb183-7"><a href="sampling-design-for-soil-surveys.html#cb183-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(all_tsus, </span>
<span id="cb183-8"><a href="sampling-design-for-soil-surveys.html#cb183-8" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/TSUs_target.shp&quot;</span>), </span>
<span id="cb183-9"><a href="sampling-design-for-soil-surveys.html#cb183-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb183-10"><a href="sampling-design-for-soil-surveys.html#cb183-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-11"><a href="sampling-design-for-soil-surveys.html#cb183-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Export all PSU clusters</span></span>
<span id="cb183-12"><a href="sampling-design-for-soil-surveys.html#cb183-12" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(all.PSU_clusters, </span>
<span id="cb183-13"><a href="sampling-design-for-soil-surveys.html#cb183-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/PSU_pattern_cl.shp&quot;</span>), </span>
<span id="cb183-14"><a href="sampling-design-for-soil-surveys.html#cb183-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb183-15"><a href="sampling-design-for-soil-surveys.html#cb183-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-16"><a href="sampling-design-for-soil-surveys.html#cb183-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Export cluster raster</span></span>
<span id="cb183-17"><a href="sampling-design-for-soil-surveys.html#cb183-17" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(dfr, </span>
<span id="cb183-18"><a href="sampling-design-for-soil-surveys.html#cb183-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(results.path, <span class="st">&quot;/clusters.tif&quot;</span>), </span>
<span id="cb183-19"><a href="sampling-design-for-soil-surveys.html#cb183-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb183-20"><a href="sampling-design-for-soil-surveys.html#cb183-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-21"><a href="sampling-design-for-soil-surveys.html#cb183-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ All files exported successfully</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb183-22"><a href="sampling-design-for-soil-surveys.html#cb183-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  Location: %s</span><span class="sc">\n</span><span class="st">&quot;</span>, results.path))</span></code></pre></div>
</div>
</div>
<div id="alternative-psus" class="section level3 hasAnchor" number="3.4.18">
<h3><span class="header-section-number">3.4.18</span> Compute Alternative PSUs<a href="sampling-design-for-soil-surveys.html#alternative-psus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Generate replacement PSUs from the same environmental clusters as targets.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="sampling-design-for-soil-surveys.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out already selected PSUs</span></span>
<span id="cb184-2"><a href="sampling-design-for-soil-surveys.html#cb184-2" aria-hidden="true" tabindex="-1"></a>remaining_psus <span class="ot">&lt;-</span> all.PSU_clusters <span class="sc">%&gt;%</span></span>
<span id="cb184-3"><a href="sampling-design-for-soil-surveys.html#cb184-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(ID <span class="sc">%in%</span> target.PSUs<span class="sc">$</span>ID))</span>
<span id="cb184-4"><a href="sampling-design-for-soil-surveys.html#cb184-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-5"><a href="sampling-design-for-soil-surveys.html#cb184-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique cluster IDs from targets</span></span>
<span id="cb184-6"><a href="sampling-design-for-soil-surveys.html#cb184-6" aria-hidden="true" tabindex="-1"></a>unique_clusters <span class="ot">&lt;-</span> <span class="fu">unique</span>(valid.PSU_clusters<span class="sc">$</span>Replace_ID)</span>
<span id="cb184-7"><a href="sampling-design-for-soil-surveys.html#cb184-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-8"><a href="sampling-design-for-soil-surveys.html#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize list for replacements</span></span>
<span id="cb184-9"><a href="sampling-design-for-soil-surveys.html#cb184-9" aria-hidden="true" tabindex="-1"></a>replacement_psus <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb184-10"><a href="sampling-design-for-soil-surveys.html#cb184-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-11"><a href="sampling-design-for-soil-surveys.html#cb184-11" aria-hidden="true" tabindex="-1"></a><span class="co"># For each target cluster, select a replacement</span></span>
<span id="cb184-12"><a href="sampling-design-for-soil-surveys.html#cb184-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (clust_id <span class="cf">in</span> unique_clusters) {</span>
<span id="cb184-13"><a href="sampling-design-for-soil-surveys.html#cb184-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find candidates in same cluster</span></span>
<span id="cb184-14"><a href="sampling-design-for-soil-surveys.html#cb184-14" aria-hidden="true" tabindex="-1"></a>  candidates <span class="ot">&lt;-</span> remaining_psus <span class="sc">%&gt;%</span> </span>
<span id="cb184-15"><a href="sampling-design-for-soil-surveys.html#cb184-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(cluster <span class="sc">==</span> clust_id)</span>
<span id="cb184-16"><a href="sampling-design-for-soil-surveys.html#cb184-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb184-17"><a href="sampling-design-for-soil-surveys.html#cb184-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(candidates) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb184-18"><a href="sampling-design-for-soil-surveys.html#cb184-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random selection from candidates</span></span>
<span id="cb184-19"><a href="sampling-design-for-soil-surveys.html#cb184-19" aria-hidden="true" tabindex="-1"></a>    replacement <span class="ot">&lt;-</span> candidates[<span class="fu">sample</span>(<span class="fu">nrow</span>(candidates), <span class="dv">1</span>), ]</span>
<span id="cb184-20"><a href="sampling-design-for-soil-surveys.html#cb184-20" aria-hidden="true" tabindex="-1"></a>    replacement<span class="sc">$</span>replaces_PSU <span class="ot">&lt;-</span> valid.PSU_clusters<span class="sc">$</span>ID[</span>
<span id="cb184-21"><a href="sampling-design-for-soil-surveys.html#cb184-21" aria-hidden="true" tabindex="-1"></a>      valid.PSU_clusters<span class="sc">$</span>Replace_ID <span class="sc">==</span> clust_id</span>
<span id="cb184-22"><a href="sampling-design-for-soil-surveys.html#cb184-22" aria-hidden="true" tabindex="-1"></a>    ][<span class="dv">1</span>]</span>
<span id="cb184-23"><a href="sampling-design-for-soil-surveys.html#cb184-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb184-24"><a href="sampling-design-for-soil-surveys.html#cb184-24" aria-hidden="true" tabindex="-1"></a>    replacement_psus <span class="ot">&lt;-</span> <span class="fu">rbind</span>(replacement_psus, replacement)</span>
<span id="cb184-25"><a href="sampling-design-for-soil-surveys.html#cb184-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb184-26"><a href="sampling-design-for-soil-surveys.html#cb184-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">sprintf</span>(<span class="st">&quot;No replacement found for cluster %d&quot;</span>, clust_id))</span>
<span id="cb184-27"><a href="sampling-design-for-soil-surveys.html#cb184-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-28"><a href="sampling-design-for-soil-surveys.html#cb184-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-29"><a href="sampling-design-for-soil-surveys.html#cb184-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-30"><a href="sampling-design-for-soil-surveys.html#cb184-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Generated %d replacement PSUs</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(replacement_psus)))</span>
<span id="cb184-31"><a href="sampling-design-for-soil-surveys.html#cb184-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-32"><a href="sampling-design-for-soil-surveys.html#cb184-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Export replacement PSUs</span></span>
<span id="cb184-33"><a href="sampling-design-for-soil-surveys.html#cb184-33" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(replacement_psus, </span>
<span id="cb184-34"><a href="sampling-design-for-soil-surveys.html#cb184-34" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste0</span>(results.path, <span class="st">&quot;/PSUs_replacements.shp&quot;</span>), </span>
<span id="cb184-35"><a href="sampling-design-for-soil-surveys.html#cb184-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<blockquote>
<p><strong>Note</strong>: Follow the same SSU and TSU generation process for replacement PSUs to create complete backup sampling locations.</p>
</blockquote>
</div>
<div id="merging-results" class="section level3 hasAnchor" number="3.4.19">
<h3><span class="header-section-number">3.4.19</span> Merging Results from Multiple Land Uses<a href="sampling-design-for-soil-surveys.html#merging-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After running the sampling design separately for cropland, grassland, and forest, combine all results into a unified dataset with country-wide unique IDs.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="sampling-design-for-soil-surveys.html#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb185-2"><a href="sampling-design-for-soil-surveys.html#cb185-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-3"><a href="sampling-design-for-soil-surveys.html#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define land uses and codes</span></span>
<span id="cb185-4"><a href="sampling-design-for-soil-surveys.html#cb185-4" aria-hidden="true" tabindex="-1"></a>landuses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;cropland&quot;</span>, <span class="st">&quot;grassland&quot;</span>, <span class="st">&quot;forest&quot;</span>)</span>
<span id="cb185-5"><a href="sampling-design-for-soil-surveys.html#cb185-5" aria-hidden="true" tabindex="-1"></a>lu_codes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;C&quot;</span>, <span class="st">&quot;G&quot;</span>, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb185-6"><a href="sampling-design-for-soil-surveys.html#cb185-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-7"><a href="sampling-design-for-soil-surveys.html#cb185-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize storage lists</span></span>
<span id="cb185-8"><a href="sampling-design-for-soil-surveys.html#cb185-8" aria-hidden="true" tabindex="-1"></a>psus_target_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb185-9"><a href="sampling-design-for-soil-surveys.html#cb185-9" aria-hidden="true" tabindex="-1"></a>tsus_target_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb185-10"><a href="sampling-design-for-soil-surveys.html#cb185-10" aria-hidden="true" tabindex="-1"></a>psus_repl_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb185-11"><a href="sampling-design-for-soil-surveys.html#cb185-11" aria-hidden="true" tabindex="-1"></a>tsus_repl_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb185-12"><a href="sampling-design-for-soil-surveys.html#cb185-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-13"><a href="sampling-design-for-soil-surveys.html#cb185-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all shapefiles</span></span>
<span id="cb185-14"><a href="sampling-design-for-soil-surveys.html#cb185-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(landuses)) {</span>
<span id="cb185-15"><a href="sampling-design-for-soil-surveys.html#cb185-15" aria-hidden="true" tabindex="-1"></a>  lu <span class="ot">&lt;-</span> landuses[i]</span>
<span id="cb185-16"><a href="sampling-design-for-soil-surveys.html#cb185-16" aria-hidden="true" tabindex="-1"></a>  code <span class="ot">&lt;-</span> lu_codes[i]</span>
<span id="cb185-17"><a href="sampling-design-for-soil-surveys.html#cb185-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-18"><a href="sampling-design-for-soil-surveys.html#cb185-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target PSUs</span></span>
<span id="cb185-19"><a href="sampling-design-for-soil-surveys.html#cb185-19" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;results/%s/PSUs_target.shp&quot;</span>, lu)</span>
<span id="cb185-20"><a href="sampling-design-for-soil-surveys.html#cb185-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb185-21"><a href="sampling-design-for-soil-surveys.html#cb185-21" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb185-22"><a href="sampling-design-for-soil-surveys.html#cb185-22" aria-hidden="true" tabindex="-1"></a>    temp<span class="sc">$</span>lulc <span class="ot">&lt;-</span> code</span>
<span id="cb185-23"><a href="sampling-design-for-soil-surveys.html#cb185-23" aria-hidden="true" tabindex="-1"></a>    psus_target_list[[lu]] <span class="ot">&lt;-</span> temp</span>
<span id="cb185-24"><a href="sampling-design-for-soil-surveys.html#cb185-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;âœ“ Loaded %s target PSUs (%d)</span><span class="sc">\n</span><span class="st">&quot;</span>, lu, <span class="fu">nrow</span>(temp)))</span>
<span id="cb185-25"><a href="sampling-design-for-soil-surveys.html#cb185-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb185-26"><a href="sampling-design-for-soil-surveys.html#cb185-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-27"><a href="sampling-design-for-soil-surveys.html#cb185-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target TSUs</span></span>
<span id="cb185-28"><a href="sampling-design-for-soil-surveys.html#cb185-28" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;results/%s/TSUs_target.shp&quot;</span>, lu)</span>
<span id="cb185-29"><a href="sampling-design-for-soil-surveys.html#cb185-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb185-30"><a href="sampling-design-for-soil-surveys.html#cb185-30" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb185-31"><a href="sampling-design-for-soil-surveys.html#cb185-31" aria-hidden="true" tabindex="-1"></a>    temp<span class="sc">$</span>lulc <span class="ot">&lt;-</span> code</span>
<span id="cb185-32"><a href="sampling-design-for-soil-surveys.html#cb185-32" aria-hidden="true" tabindex="-1"></a>    tsus_target_list[[lu]] <span class="ot">&lt;-</span> temp</span>
<span id="cb185-33"><a href="sampling-design-for-soil-surveys.html#cb185-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;âœ“ Loaded %s target TSUs (%d)</span><span class="sc">\n</span><span class="st">&quot;</span>, lu, <span class="fu">nrow</span>(temp)))</span>
<span id="cb185-34"><a href="sampling-design-for-soil-surveys.html#cb185-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb185-35"><a href="sampling-design-for-soil-surveys.html#cb185-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-36"><a href="sampling-design-for-soil-surveys.html#cb185-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replacement PSUs and TSUs</span></span>
<span id="cb185-37"><a href="sampling-design-for-soil-surveys.html#cb185-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (similar loading process)</span></span>
<span id="cb185-38"><a href="sampling-design-for-soil-surveys.html#cb185-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb185-39"><a href="sampling-design-for-soil-surveys.html#cb185-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-40"><a href="sampling-design-for-soil-surveys.html#cb185-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge using data.table (handles different column names)</span></span>
<span id="cb185-41"><a href="sampling-design-for-soil-surveys.html#cb185-41" aria-hidden="true" tabindex="-1"></a>psus_target <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(<span class="fu">rbindlist</span>(psus_target_list, <span class="at">fill =</span> <span class="cn">TRUE</span>))</span>
<span id="cb185-42"><a href="sampling-design-for-soil-surveys.html#cb185-42" aria-hidden="true" tabindex="-1"></a>tsus_target <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(<span class="fu">rbindlist</span>(tsus_target_list, <span class="at">fill =</span> <span class="cn">TRUE</span>))</span>
<span id="cb185-43"><a href="sampling-design-for-soil-surveys.html#cb185-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-44"><a href="sampling-design-for-soil-surveys.html#cb185-44" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">=== MERGED DATASETS ===</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb185-45"><a href="sampling-design-for-soil-surveys.html#cb185-45" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Target PSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(psus_target)))</span>
<span id="cb185-46"><a href="sampling-design-for-soil-surveys.html#cb185-46" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Target TSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(tsus_target)))</span></code></pre></div>
<div id="assign-unique-ids" class="section level4 hasAnchor" number="3.4.19.1">
<h4><span class="header-section-number">3.4.19.1</span> Assign Country-Wide Unique IDs<a href="sampling-design-for-soil-surveys.html#assign-unique-ids" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="sampling-design-for-soil-surveys.html#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign sequential IDs to target PSUs</span></span>
<span id="cb186-2"><a href="sampling-design-for-soil-surveys.html#cb186-2" aria-hidden="true" tabindex="-1"></a>psus_target<span class="sc">$</span>PSU_ID_country <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(psus_target)</span>
<span id="cb186-3"><a href="sampling-design-for-soil-surveys.html#cb186-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-4"><a href="sampling-design-for-soil-surveys.html#cb186-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue numbering for replacements</span></span>
<span id="cb186-5"><a href="sampling-design-for-soil-surveys.html#cb186-5" aria-hidden="true" tabindex="-1"></a>start_id <span class="ot">&lt;-</span> <span class="fu">nrow</span>(psus_target) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb186-6"><a href="sampling-design-for-soil-surveys.html#cb186-6" aria-hidden="true" tabindex="-1"></a>psus_repl<span class="sc">$</span>PSU_ID_country <span class="ot">&lt;-</span> start_id<span class="sc">:</span>(start_id <span class="sc">+</span> <span class="fu">nrow</span>(psus_repl) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb186-7"><a href="sampling-design-for-soil-surveys.html#cb186-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-8"><a href="sampling-design-for-soil-surveys.html#cb186-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer country-wide IDs to TSUs</span></span>
<span id="cb186-9"><a href="sampling-design-for-soil-surveys.html#cb186-9" aria-hidden="true" tabindex="-1"></a>tsus_target<span class="sc">$</span>PSU_temp_ID <span class="ot">&lt;-</span> <span class="fu">paste0</span>(tsus_target<span class="sc">$</span>PSU_ID, <span class="st">&quot;-&quot;</span>, tsus_target<span class="sc">$</span>lulc)</span>
<span id="cb186-10"><a href="sampling-design-for-soil-surveys.html#cb186-10" aria-hidden="true" tabindex="-1"></a>psus_target<span class="sc">$</span>PSU_temp_ID <span class="ot">&lt;-</span> <span class="fu">paste0</span>(psus_target<span class="sc">$</span>ID, <span class="st">&quot;-&quot;</span>, psus_target<span class="sc">$</span>lulc)</span>
<span id="cb186-11"><a href="sampling-design-for-soil-surveys.html#cb186-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-12"><a href="sampling-design-for-soil-surveys.html#cb186-12" aria-hidden="true" tabindex="-1"></a>tsus_target<span class="sc">$</span>PSU_ID_country <span class="ot">&lt;-</span> psus_target<span class="sc">$</span>PSU_ID_country[</span>
<span id="cb186-13"><a href="sampling-design-for-soil-surveys.html#cb186-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">match</span>(tsus_target<span class="sc">$</span>PSU_temp_ID, psus_target<span class="sc">$</span>PSU_temp_ID)</span>
<span id="cb186-14"><a href="sampling-design-for-soil-surveys.html#cb186-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb186-15"><a href="sampling-design-for-soil-surveys.html#cb186-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-16"><a href="sampling-design-for-soil-surveys.html#cb186-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create final site IDs with country-wide PSU numbers</span></span>
<span id="cb186-17"><a href="sampling-design-for-soil-surveys.html#cb186-17" aria-hidden="true" tabindex="-1"></a>tsus_target <span class="ot">&lt;-</span> tsus_target <span class="sc">%&gt;%</span></span>
<span id="cb186-18"><a href="sampling-design-for-soil-surveys.html#cb186-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site_id =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%s%04d-%d-%d%s&quot;</span>, </span>
<span id="cb186-19"><a href="sampling-design-for-soil-surveys.html#cb186-19" aria-hidden="true" tabindex="-1"></a>                          ISO.code, PSU_ID_country, SSU_ID, TSU_ID, lulc))</span>
<span id="cb186-20"><a href="sampling-design-for-soil-surveys.html#cb186-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-21"><a href="sampling-design-for-soil-surveys.html#cb186-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up</span></span>
<span id="cb186-22"><a href="sampling-design-for-soil-surveys.html#cb186-22" aria-hidden="true" tabindex="-1"></a>tsus_target <span class="ot">&lt;-</span> tsus_target <span class="sc">%&gt;%</span></span>
<span id="cb186-23"><a href="sampling-design-for-soil-surveys.html#cb186-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PSU_ID =</span> PSU_ID_country, SSU_ID, SSU_Type, TSU_ID, TSU_Type, </span>
<span id="cb186-24"><a href="sampling-design-for-soil-surveys.html#cb186-24" aria-hidden="true" tabindex="-1"></a>         site_id, lulc, geometry)</span>
<span id="cb186-25"><a href="sampling-design-for-soil-surveys.html#cb186-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-26"><a href="sampling-design-for-soil-surveys.html#cb186-26" aria-hidden="true" tabindex="-1"></a>psus_target <span class="ot">&lt;-</span> psus_target <span class="sc">%&gt;%</span></span>
<span id="cb186-27"><a href="sampling-design-for-soil-surveys.html#cb186-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PSU_ID =</span> PSU_ID_country, lulc, geometry)</span>
<span id="cb186-28"><a href="sampling-design-for-soil-surveys.html#cb186-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-29"><a href="sampling-design-for-soil-surveys.html#cb186-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Assigned country-wide unique IDs</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
</div>
<div id="export-unified" class="section level4 hasAnchor" number="3.4.19.2">
<h4><span class="header-section-number">3.4.19.2</span> Export Unified Datasets<a href="sampling-design-for-soil-surveys.html#export-unified" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="sampling-design-for-soil-surveys.html#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export unified datasets</span></span>
<span id="cb187-2"><a href="sampling-design-for-soil-surveys.html#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(psus_target, <span class="st">&quot;results/all/all_psus_target.shp&quot;</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb187-3"><a href="sampling-design-for-soil-surveys.html#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(tsus_target, <span class="st">&quot;results/all/all_tsus_target.shp&quot;</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb187-4"><a href="sampling-design-for-soil-surveys.html#cb187-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(psus_repl, <span class="st">&quot;results/all/all_psus_replacements.shp&quot;</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb187-5"><a href="sampling-design-for-soil-surveys.html#cb187-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(tsus_repl, <span class="st">&quot;results/all/all_tsus_replacements.shp&quot;</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb187-6"><a href="sampling-design-for-soil-surveys.html#cb187-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-7"><a href="sampling-design-for-soil-surveys.html#cb187-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ All unified datasets exported to results/all/</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
</div>
<div id="summary-stats" class="section level4 hasAnchor" number="3.4.19.3">
<h4><span class="header-section-number">3.4.19.3</span> Summary Statistics<a href="sampling-design-for-soil-surveys.html#summary-stats" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="sampling-design-for-soil-surveys.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count target sites by land use</span></span>
<span id="cb188-2"><a href="sampling-design-for-soil-surveys.html#cb188-2" aria-hidden="true" tabindex="-1"></a>summary_lu <span class="ot">&lt;-</span> tsus_target <span class="sc">%&gt;%</span></span>
<span id="cb188-3"><a href="sampling-design-for-soil-surveys.html#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb188-4"><a href="sampling-design-for-soil-surveys.html#cb188-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb188-5"><a href="sampling-design-for-soil-surveys.html#cb188-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lulc) <span class="sc">%&gt;%</span></span>
<span id="cb188-6"><a href="sampling-design-for-soil-surveys.html#cb188-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb188-7"><a href="sampling-design-for-soil-surveys.html#cb188-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_PSUs =</span> <span class="fu">n_distinct</span>(PSU_ID),</span>
<span id="cb188-8"><a href="sampling-design-for-soil-surveys.html#cb188-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_sites =</span> <span class="fu">n</span>(),</span>
<span id="cb188-9"><a href="sampling-design-for-soil-surveys.html#cb188-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sites_per_PSU =</span> n <span class="sc">/</span> <span class="fu">n_distinct</span>(PSU_ID)</span>
<span id="cb188-10"><a href="sampling-design-for-soil-surveys.html#cb188-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb188-11"><a href="sampling-design-for-soil-surveys.html#cb188-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-12"><a href="sampling-design-for-soil-surveys.html#cb188-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_lu)</span>
<span id="cb188-13"><a href="sampling-design-for-soil-surveys.html#cb188-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-14"><a href="sampling-design-for-soil-surveys.html#cb188-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Total counts</span></span>
<span id="cb188-15"><a href="sampling-design-for-soil-surveys.html#cb188-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">=== FINAL SAMPLING DESIGN ===</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb188-16"><a href="sampling-design-for-soil-surveys.html#cb188-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Total PSUs: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">n_distinct</span>(tsus_target<span class="sc">$</span>PSU_ID)))</span>
<span id="cb188-17"><a href="sampling-design-for-soil-surveys.html#cb188-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Total target sampling sites: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb188-18"><a href="sampling-design-for-soil-surveys.html#cb188-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(tsus_target<span class="sc">$</span>SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> tsus_target<span class="sc">$</span>TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)))</span>
<span id="cb188-19"><a href="sampling-design-for-soil-surveys.html#cb188-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  - Cropland: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb188-20"><a href="sampling-design-for-soil-surveys.html#cb188-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(tsus_target<span class="sc">$</span>lulc <span class="sc">==</span> <span class="st">&quot;C&quot;</span> <span class="sc">&amp;</span> tsus_target<span class="sc">$</span>SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> </span>
<span id="cb188-21"><a href="sampling-design-for-soil-surveys.html#cb188-21" aria-hidden="true" tabindex="-1"></a>                tsus_target<span class="sc">$</span>TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)))</span>
<span id="cb188-22"><a href="sampling-design-for-soil-surveys.html#cb188-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  - Grassland: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb188-23"><a href="sampling-design-for-soil-surveys.html#cb188-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(tsus_target<span class="sc">$</span>lulc <span class="sc">==</span> <span class="st">&quot;G&quot;</span> <span class="sc">&amp;</span> tsus_target<span class="sc">$</span>SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> </span>
<span id="cb188-24"><a href="sampling-design-for-soil-surveys.html#cb188-24" aria-hidden="true" tabindex="-1"></a>                tsus_target<span class="sc">$</span>TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)))</span>
<span id="cb188-25"><a href="sampling-design-for-soil-surveys.html#cb188-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  - Forest: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb188-26"><a href="sampling-design-for-soil-surveys.html#cb188-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(tsus_target<span class="sc">$</span>lulc <span class="sc">==</span> <span class="st">&quot;F&quot;</span> <span class="sc">&amp;</span> tsus_target<span class="sc">$</span>SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> </span>
<span id="cb188-27"><a href="sampling-design-for-soil-surveys.html#cb188-27" aria-hidden="true" tabindex="-1"></a>                tsus_target<span class="sc">$</span>TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)))</span></code></pre></div>
</div>
<div id="distribution-maps" class="section level4 hasAnchor" number="3.4.19.4">
<h4><span class="header-section-number">3.4.19.4</span> Create Distribution Maps<a href="sampling-design-for-soil-surveys.html#distribution-maps" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="sampling-design-for-soil-surveys.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb189-2"><a href="sampling-design-for-soil-surveys.html#cb189-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-3"><a href="sampling-design-for-soil-surveys.html#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to target sites only</span></span>
<span id="cb189-4"><a href="sampling-design-for-soil-surveys.html#cb189-4" aria-hidden="true" tabindex="-1"></a>target_sites <span class="ot">&lt;-</span> tsus_target <span class="sc">%&gt;%</span></span>
<span id="cb189-5"><a href="sampling-design-for-soil-surveys.html#cb189-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)</span>
<span id="cb189-6"><a href="sampling-design-for-soil-surveys.html#cb189-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-7"><a href="sampling-design-for-soil-surveys.html#cb189-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load country boundaries</span></span>
<span id="cb189-8"><a href="sampling-design-for-soil-surveys.html#cb189-8" aria-hidden="true" tabindex="-1"></a>country <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;shapes/roi_country_epsg_4326.shp&quot;</span>)</span>
<span id="cb189-9"><a href="sampling-design-for-soil-surveys.html#cb189-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-10"><a href="sampling-design-for-soil-surveys.html#cb189-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create distribution map</span></span>
<span id="cb189-11"><a href="sampling-design-for-soil-surveys.html#cb189-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb189-12"><a href="sampling-design-for-soil-surveys.html#cb189-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> country, <span class="at">fill =</span> <span class="st">&quot;gray95&quot;</span>, <span class="at">color =</span> <span class="st">&quot;gray50&quot;</span>) <span class="sc">+</span></span>
<span id="cb189-13"><a href="sampling-design-for-soil-surveys.html#cb189-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> target_sites, <span class="fu">aes</span>(<span class="at">color =</span> lulc), <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb189-14"><a href="sampling-design-for-soil-surveys.html#cb189-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb189-15"><a href="sampling-design-for-soil-surveys.html#cb189-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Land Use&quot;</span>,</span>
<span id="cb189-16"><a href="sampling-design-for-soil-surveys.html#cb189-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;C&quot;</span> <span class="ot">=</span> <span class="st">&quot;#F096FF&quot;</span>, <span class="st">&quot;G&quot;</span> <span class="ot">=</span> <span class="st">&quot;#FFFF4C&quot;</span>, <span class="st">&quot;F&quot;</span> <span class="ot">=</span> <span class="st">&quot;#006400&quot;</span>),</span>
<span id="cb189-17"><a href="sampling-design-for-soil-surveys.html#cb189-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;C&quot;</span> <span class="ot">=</span> <span class="st">&quot;Cropland&quot;</span>, <span class="st">&quot;G&quot;</span> <span class="ot">=</span> <span class="st">&quot;Grassland&quot;</span>, <span class="st">&quot;F&quot;</span> <span class="ot">=</span> <span class="st">&quot;Forest&quot;</span>)</span>
<span id="cb189-18"><a href="sampling-design-for-soil-surveys.html#cb189-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb189-19"><a href="sampling-design-for-soil-surveys.html#cb189-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;SoilFER Sampling Design - Final Site Distribution&quot;</span>,</span>
<span id="cb189-20"><a href="sampling-design-for-soil-surveys.html#cb189-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%d sampling locations across %d PSUs&quot;</span>, </span>
<span id="cb189-21"><a href="sampling-design-for-soil-surveys.html#cb189-21" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">nrow</span>(target_sites), <span class="fu">n_distinct</span>(target_sites<span class="sc">$</span>PSU_ID))) <span class="sc">+</span></span>
<span id="cb189-22"><a href="sampling-design-for-soil-surveys.html#cb189-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb189-23"><a href="sampling-design-for-soil-surveys.html#cb189-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb189-24"><a href="sampling-design-for-soil-surveys.html#cb189-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-25"><a href="sampling-design-for-soil-surveys.html#cb189-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;results/all/final_site_distribution.png&quot;</span>, </span>
<span id="cb189-26"><a href="sampling-design-for-soil-surveys.html#cb189-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb189-27"><a href="sampling-design-for-soil-surveys.html#cb189-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-28"><a href="sampling-design-for-soil-surveys.html#cb189-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">âœ“ Distribution map saved</span><span class="sc">\n</span><span class="st">&quot;</span>))</span></code></pre></div>
</div>
</div>
<div id="field-protocol" class="section level3 hasAnchor" number="3.4.20">
<h3><span class="header-section-number">3.4.20</span> Field Sampling Protocol<a href="sampling-design-for-soil-surveys.html#field-protocol" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="gps-prep" class="section level4 hasAnchor" number="3.4.20.1">
<h4><span class="header-section-number">3.4.20.1</span> GPS Device Preparation<a href="sampling-design-for-soil-surveys.html#gps-prep" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="export-to-gpx-format" class="section level5 hasAnchor" number="3.4.20.1.1">
<h5><span class="header-section-number">3.4.20.1.1</span> Export to GPX Format<a href="sampling-design-for-soil-surveys.html#export-to-gpx-format" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="sampling-design-for-soil-surveys.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load target TSUs</span></span>
<span id="cb190-2"><a href="sampling-design-for-soil-surveys.html#cb190-2" aria-hidden="true" tabindex="-1"></a>tsus_field <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;results/all/all_tsus_target.shp&quot;</span>)</span>
<span id="cb190-3"><a href="sampling-design-for-soil-surveys.html#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="sampling-design-for-soil-surveys.html#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to primary targets only (1 per SSU)</span></span>
<span id="cb190-5"><a href="sampling-design-for-soil-surveys.html#cb190-5" aria-hidden="true" tabindex="-1"></a>tsus_field <span class="ot">&lt;-</span> tsus_field <span class="sc">%&gt;%</span></span>
<span id="cb190-6"><a href="sampling-design-for-soil-surveys.html#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span> <span class="sc">&amp;</span> TSU_Type <span class="sc">==</span> <span class="st">&quot;Target&quot;</span>)</span>
<span id="cb190-7"><a href="sampling-design-for-soil-surveys.html#cb190-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-8"><a href="sampling-design-for-soil-surveys.html#cb190-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform to WGS84 (required for GPS)</span></span>
<span id="cb190-9"><a href="sampling-design-for-soil-surveys.html#cb190-9" aria-hidden="true" tabindex="-1"></a>tsus_field_wgs84 <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(tsus_field, <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb190-10"><a href="sampling-design-for-soil-surveys.html#cb190-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-11"><a href="sampling-design-for-soil-surveys.html#cb190-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Export to GPX</span></span>
<span id="cb190-12"><a href="sampling-design-for-soil-surveys.html#cb190-12" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(tsus_field_wgs84, </span>
<span id="cb190-13"><a href="sampling-design-for-soil-surveys.html#cb190-13" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;results/all/field_sampling_points.gpx&quot;</span>, </span>
<span id="cb190-14"><a href="sampling-design-for-soil-surveys.html#cb190-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;GPX&quot;</span>, </span>
<span id="cb190-15"><a href="sampling-design-for-soil-surveys.html#cb190-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb190-16"><a href="sampling-design-for-soil-surveys.html#cb190-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-17"><a href="sampling-design-for-soil-surveys.html#cb190-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;âœ“ Exported %d waypoints to GPX</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(tsus_field_wgs84)))</span></code></pre></div>
</div>
<div id="load-onto-gps-device" class="section level5 hasAnchor" number="3.4.20.1.2">
<h5><span class="header-section-number">3.4.20.1.2</span> Load onto GPS Device<a href="sampling-design-for-soil-surveys.html#load-onto-gps-device" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ol style="list-style-type: decimal">
<li>Connect GPS device to computer</li>
<li>Copy <code>field_sampling_points.gpx</code> to GPS memory</li>
<li>Load waypoints in GPS software</li>
<li>Waypoint names will be <code>site_id</code> values (e.g., KEN0001-1-1C)</li>
</ol>
</div>
</div>
<div id="sampling-procedure" class="section level4 hasAnchor" number="3.4.20.2">
<h4><span class="header-section-number">3.4.20.2</span> Sampling Procedure<a href="sampling-design-for-soil-surveys.html#sampling-procedure" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><strong>For each PSU (in order of PSU_ID):</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>Navigate to TSU 1</strong> (SSU_ID=1, TSU_ID=1)</p>
<ul>
<li>If accessible â†’ Sample at exact GPS location</li>
<li>If inaccessible (physical barrier) â†’ Use TSU 2 (Alternative 1) or TSU 3 (Alternative 2)</li>
</ul></li>
<li><p><strong>Navigate to TSU 2</strong> (SSU_ID=2, TSU_ID=1)</p>
<ul>
<li>Repeat accessibility check and sampling</li>
</ul></li>
<li><p><strong>Navigate to TSU 3</strong> (SSU_ID=3, TSU_ID=1)</p></li>
<li><p><strong>Navigate to TSU 4</strong> (SSU_ID=4, TSU_ID=1)</p></li>
</ol>
<p><strong>If entire PSU is inaccessible:</strong> - Use <code>replacement_PSU_ID</code> to find backup PSU - Navigate to replacement PSU location - Sample at replacement TSUs (SSU_ID = 5, 6, 7, 8)</p>
</div>
<div id="data-recording" class="section level4 hasAnchor" number="3.4.20.3">
<h4><span class="header-section-number">3.4.20.3</span> Data Recording<a href="sampling-design-for-soil-surveys.html#data-recording" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Field form should capture (Table <a href="sampling-design-for-soil-surveys.html#tab:field-form">3.6</a>):</p>
<pre><code>## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)

## Warning: &#39;xfun::attr()&#39; is deprecated.
## Use &#39;xfun::attr2()&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<table>
<caption><span id="tab:field-form">Table 3.6: </span>Required field data recording</caption>
<colgroup>
<col width="26%" />
<col width="28%" />
<col width="45%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Field</th>
<th align="left">Example</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">site_id</td>
<td align="left">KEN0001-1-1C</td>
<td align="left"><strong>CRITICAL</strong> - Unique identifier</td>
</tr>
<tr class="even">
<td align="left">date</td>
<td align="left">2025-01-15</td>
<td align="left">Date of sampling</td>
</tr>
<tr class="odd">
<td align="left">team</td>
<td align="left">Team A</td>
<td align="left">Field team name</td>
</tr>
<tr class="even">
<td align="left">coordinates_actual</td>
<td align="left">-1.2345, 36.7890</td>
<td align="left">Actual GPS coordinates</td>
</tr>
<tr class="odd">
<td align="left">accessibility</td>
<td align="left">Target / Alt1 / Alt2</td>
<td align="left">Which TSU was sampled</td>
</tr>
<tr class="even">
<td align="left">land_use_observed</td>
<td align="left">Maize field</td>
<td align="left">Visual confirmation</td>
</tr>
<tr class="odd">
<td align="left">soil_depth</td>
<td align="left">45 cm</td>
<td align="left">Depth to restrictive layer</td>
</tr>
<tr class="even">
<td align="left">photos</td>
<td align="left">KEN0001-1-1C_001.jpg</td>
<td align="left">Geotagged photos</td>
</tr>
<tr class="odd">
<td align="left">notes</td>
<td align="left">Rocky, 15% slope</td>
<td align="left">Relevant observations</td>
</tr>
</tbody>
</table>
</div>
<div id="qc" class="section level4 hasAnchor" number="3.4.20.4">
<h4><span class="header-section-number">3.4.20.4</span> Quality Control<a href="sampling-design-for-soil-surveys.html#qc" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><strong>During field work:</strong> - âœ… Verify land use matches expected type - âœ… Document if alternative TSU used (and reason) - âœ… Take geotagged photos at each site - âœ… Record actual GPS coordinates - âœ… Note any anomalies or challenges</p>
<p><strong>Post-field QC:</strong> - Check for duplicate <code>site_id</code> entries - Verify all mandatory fields completed - Cross-reference photos with field records - Flag sites with large GPS deviation (&gt;30m from waypoint)</p>
</div>
</div>
</div>
<div id="references-sdg1" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> References<a href="sampling-design-for-soil-surveys.html#references-sdg1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="refs" class="references csl-bib-body">
<div class="csl-entry">
<strong>Arrouays, D., Leenaars, J.G.B., Richer-de-Forges, A.C., Adhikari, K., Ballabio, C., Greve, M., Grundy, M., Guerrero, E., Hempel, J., Hengl, T., Heuvelink, G., Batjes, N., Carvalho, E., Hartemink, A., Hewitt, A., Hong, S.-Y., Krasilnikov, P., Lagacherie, P., Lelyk, G., Libohova, Z., Lilly, A., McBratney, A., McKenzie, N., Vasquez, G.M., Mulder, V.L., Minasny, B., Montanarella, L., Odeh, I., Padarian, J., Poggio, L., Roudier, P., Saby, N., Savin, I., Searle, R., Solbovoy, V., Thompson, J., Smith, S., Sulaeman, Y., Vintila, R., Rossel, R.V., Wilson, P., Zhang, G.-L., Swerts, M., Oorts, K., Karklins, A., Feng, L., Ibelles Navarro, A.R., Levin, A., Laktionova, T., Dellâ€™Acqua, M., Suvannang, N., Ruam, W., Prasad, J., Patil, N., Husnjak, S., PÃƒÂ¡sztor, L., Okx, J., Hallett, S., Keay, C., Farewell, T., Lilja, H., Juilleret, J., Marx, S., Takata, Y., Kazuyuki, Y., Mansuy, N., Panagos, P., Van Liedekerke, M., Skalsky, R., Sobocka, J., Kobza, J., Eftekhari, K., Alavipanah, S.K., Moussadek, R., Badraoui, M., Da Silva, M., Paterson, G., ConceiÃƒÂ§ÃƒÂ£o GonÃƒÂ§alves, M. da, Theocharopoulos, S., Yemefack, M., Tedou, S., Vrscaj, B., Grob, U., KozÃƒÂ¡k, J., Boruvka, L., Dobos, E., Taboada, M., Moretti, L. &amp; Rodriguez, D.</strong> 2017. Soil legacy data rescue via GlobalSoilMap and other international and national initiatives. <em>GeoResJ</em>, 14: 1â€“19. https://doi.org/<a href="https://doi.org/10.1016/j.grj.2017.06.001">https://doi.org/10.1016/j.grj.2017.06.001</a>
</div>
<div class="csl-entry">
<strong>Bishop, T.F.A., McBratney, A.B. &amp; Laslett, G.M.</strong> 1999. Modelling soil attribute depth functions with equal-area quadratic smoothing splines, 91: 27â€“45. <a href="https://doi.org/10.1016/s0016-7061(99)00003-8">https://doi.org/10.1016/s0016-7061(99)00003-8</a>
</div>
<div class="csl-entry">
<strong>Borden, K.A., Thomas, J.E. &amp; Rivard, C.</strong> 2020. Evaluation of diverse cover crop mixtures for use in semi-arid irrigated production systems. <em>Renewable Agriculture and Food Systems</em>, 35(3): 286â€“296. <a href="https://doi.org/10.1017/S1742170518000509">https://doi.org/10.1017/S1742170518000509</a>
</div>
<div class="csl-entry">
<strong>Breiman, L.</strong> 2001. Random forests. <em>Machine Learning</em>, 45(1): 5â€“32. <a href="https://doi.org/10.1023/A:1010933404324">https://doi.org/10.1023/A:1010933404324</a>
</div>
<div class="csl-entry">
<strong>Breiman, L., Friedman, J.H., Olshen, R.A. &amp; Stone, C.J.</strong> 1984. <em>Classification and regression trees</em>. Belmont, CA, Wadsworth.
</div>
<div class="csl-entry">
<strong>Brevik, E.C., Calzolari, C., Miller, B.A., Pereira, P., Kabala, C., Baumgarten, A. &amp; JordÃ¡n, A.</strong> 2016. Soil mapping, classification, and pedologic modeling: History and future directions. <em>Geoderma</em>, 264: 256â€“274. <a href="https://doi.org/10.1016/j.geoderma.2015.05.017">https://doi.org/10.1016/j.geoderma.2015.05.017</a>
</div>
<div class="csl-entry">
<strong>Brus, D.J.</strong> 2022. Sampling for digital soil mapping: A tutorial supported by <span>R</span> scripts. <em>Geoderma</em>, 338: 464â€“480. <a href="https://doi.org/10.1016/j.geoderma.2018.07.036">https://doi.org/10.1016/j.geoderma.2018.07.036</a>
</div>
<div class="csl-entry">
<strong>Brus, D.J., Kempen, B. &amp; Heuvelink, G.B.M.</strong> 2011 b. Sampling for validation of digital soil maps. <em>European Journal of Soil Science</em>, 62(3): 394â€“407. <a href="https://doi.org/10.1111/j.1365-2389.2011.01364.x">https://doi.org/10.1111/j.1365-2389.2011.01364.x</a>
</div>
<div class="csl-entry">
<strong>Brus, D.J., Kempen, B. &amp; Heuvelink, G.B.M.</strong> 2011 a. Sampling for digital soil mapping: A tutorial supported by <span>R</span> scripts. <em>Geoderma</em>, 338: 464â€“480. <a href="https://doi.org/10.1016/j.geoderma.2018.07.036">https://doi.org/10.1016/j.geoderma.2018.07.036</a>
</div>
<div class="csl-entry">
<strong>Bui, E.</strong> 2020. Soil survey as a knowledge system. <em>Geoderma</em>, 359: 113948. <a href="https://doi.org/10.1016/j.geoderma.2019.113948">https://doi.org/10.1016/j.geoderma.2019.113948</a>
</div>
<div class="csl-entry">
<strong>Clay, D.E., Chang, J., Malo, D.D., Carlson, C.G., Reese, C., Clay, S.A., Ellsbury, M. &amp; Berg, B.</strong> 2001. Factors influencing spatial variability of soil apparent electrical conductivity. <em>Communications in Soil Science and Plant Analysis</em>, 32(19-20): 2993â€“3008. <a href="https://doi.org/10.1081/CSS-120001104">https://doi.org/10.1081/CSS-120001104</a>
</div>
<div class="csl-entry">
<strong>Gobin, A., Campling, P. &amp; Feyen, J.</strong> 2001. Soil-landscape modelling to quantify spatial variability of soil texture. <em>Physics and Chemistry of the Earth, Part B: Hydrology, Oceans and Atmosphere</em>, 26(1): 41â€“45. <a href="https://doi.org/10.1016/S1464-1909(01)85011-7">https://doi.org/10.1016/S1464-1909(01)85011-7</a>
</div>
<div class="csl-entry">
<strong>Gruijter, J.J. de, Brus, D.J., Bierkens, M.F.P. &amp; Knotters, M.</strong> 2006. <em><a href="https://doi.org/10.1007/3-540-33161-1">Sampling for natural resource monitoring</a></em>. Berlin, Springer.
</div>
<div class="csl-entry">
<strong>Hengl, T., Heuvelink, G.B.M. &amp; Rossiter, D.G.</strong> 2007. About regression-kriging: From equations to case studies. <em>Computers &amp; Geosciences</em>, 33: 1301â€“1315. <a href="https://doi.org/10.1016/j.cageo.2007.05.001">https://doi.org/10.1016/j.cageo.2007.05.001</a>
</div>
<div class="csl-entry">
<strong>Heuvelink, G.B.M., Kros, J., Reinds, G.J. &amp; De Vries, W.</strong> 2016. Geostatistical prediction and simulation of european soil property maps. <em>Geoderma Regional</em>, 7: 201â€“215. <a href="https://doi.org/10.1016/j.geodrs.2016.04.002">https://doi.org/10.1016/j.geodrs.2016.04.002</a>
</div>
<div class="csl-entry">
<strong>Heuvelink, G.B.M. &amp; Webster, R.</strong> 2001. Modelling soil variation: Past, present, and future. <em>Geoderma</em>, 100: 269â€“301. <a href="https://doi.org/10.1016/S0016-7061(01)00025-8">https://doi.org/10.1016/S0016-7061(01)00025-8</a>
</div>
<div class="csl-entry">
<strong>Jenny, H.</strong> 1941. A system of quantitative pedology. In <span>â€œfactors of soil formationâ€</span>. McGraw Hill: New York.
</div>
<div class="csl-entry">
<strong>Kempen, B., Brus, D.J., Heuvelink, G.B.M. &amp; Stoorvogel, J.J.</strong> 2009. Updating the 1:50,000 dutch soil map using legacy soil data: A multinomial logistic regression approach. <em>Geoderma</em>, 151: 311â€“326. <a href="https://doi.org/10.1016/j.geoderma.2009.04.023">https://doi.org/10.1016/j.geoderma.2009.04.023</a>
</div>
<div class="csl-entry">
<strong>Kursa, M.B. &amp; Rudnicki, W.R.</strong> 2010. Feature selection with the <span>Boruta</span> package. <em>Journal of Statistical Software</em>, 36(11): 1â€“13. <a href="https://doi.org/10.18637/jss.v036.i11">https://doi.org/10.18637/jss.v036.i11</a>
</div>
<div class="csl-entry">
<strong>Lagacherie, P.</strong> 2008. Digital soil mapping: A state of the art. <em>In</em> A.E. Hartemink, A.B. McBratney &amp; M.L. MendonÃ§a-Santos, eds. <em>Digital soil mapping with limited data</em>, pp. 3â€“14. Dordrecht, Springer.
</div>
<div class="csl-entry">
<strong>Lagacherie, P. &amp; McBratney, A.B.</strong> 2006. Spatial soil information systems and spatial soil inference systems: Perspectives for digital soil mapping. <em>In</em> P. Lagacherie, A.B. McBratney &amp; M. Voltz, eds. <em>Digital soil mapping: An introductory perspective</em>, pp. 3â€“22. Amsterdam, Elsevier.
</div>
<div class="csl-entry">
<strong>Ma, Y., Minasny, B., Weerts, A., Poggio, L., Malone, B. &amp; McBratney, A.</strong> 2020. Comparison of conditioned <span>Latin</span> hypercube and feature space coverage sampling for predicting soil classes using simulation from soil maps. <em>Geoderma</em>, 370: 114366. <a href="https://doi.org/10.1016/j.geoderma.2020.114366">https://doi.org/10.1016/j.geoderma.2020.114366</a>
</div>
<div class="csl-entry">
<strong>McBratney, A.B., MendonÃ§a Santos, M.L. &amp; Minasny, B.</strong> 2003. On digital soil mapping. <em>Geoderma</em>, 117: 3â€“52. <a href="https://doi.org/10.1016/S0016-7061(03)00223-4">https://doi.org/10.1016/S0016-7061(03)00223-4</a>
</div>
<div class="csl-entry">
<strong>Medeiros, B.M., Rossi, L.S., Caten, A.T., Pereira, G.E., Silva, E.B. &amp; U., Daboit.K.T.</strong> 2024. Soil legacy data: An opportunity for digital soil mapping. <em>Rev. Bras. CiÃªnc. Solo</em>, 48. <a href="https://doi.org/10.36783/18069657rbcs20230130">https://doi.org/10.36783/18069657rbcs20230130</a>
</div>
<div class="csl-entry">
<strong>Meyer, H. &amp; Pebesma, E.</strong> 2021. Predicting into unknown space? <span>E</span>stimating the area of applicability of spatial prediction models. <em>Methods in Ecology and Evolution</em>, 12: 1620â€“1633. <a href="https://doi.org/10.1111/2041-210X.13650">https://doi.org/10.1111/2041-210X.13650</a>
</div>
<div class="csl-entry">
<strong>Milne, G.</strong> 1936. Normal erosion as a factor in soil profile development. <em>Nature</em>, 138: 548â€“549. <a href="https://doi.org/10.1038/138548c0">https://doi.org/10.1038/138548c0</a>
</div>
<div class="csl-entry">
<strong>Minasny, B. &amp; McBratney, A.B.</strong> 2006. A conditioned <span>Latin</span> hypercube method for sampling in the presence of ancillary information. <em>Computers &amp; Geosciences</em>, 32(9): 1378â€“1388. <a href="https://doi.org/10.1016/j.cageo.2005.12.009">https://doi.org/10.1016/j.cageo.2005.12.009</a>
</div>
<div class="csl-entry">
<strong>Minasny, B. &amp; McBratney, A.B.</strong> 2016. Digital soil mapping: A brief history and some lessons. <em>Geoderma</em>, 264: 301â€“311. <a href="https://doi.org/10.1016/j.geoderma.2015.07.017">https://doi.org/10.1016/j.geoderma.2015.07.017</a>
</div>
<div class="csl-entry">
<strong>Morton, P.A. &amp; Heinemeyer, O.</strong> 2000. Soil sampling and preparation. <em>Methods in Ecosystem Science</em>: 85â€“94.
</div>
<div class="csl-entry">
<strong>Norris, C.E., Quideau, S.A., Landhausser, S.M., Bernard, G.M. &amp; Wasylishen, R.E.</strong> 2013. Tracking stable isotope enrichment in tree seedlings with solid-state <span><span class="math inline">\(^{15}\)</span>N</span> <span>NMR</span> spectroscopy. <em>Biogeosciences</em>, 10: 3433â€“3445. <a href="https://doi.org/10.5194/bg-10-3433-2013">https://doi.org/10.5194/bg-10-3433-2013</a>
</div>
<div class="csl-entry">
<strong>Odeh, I.O.A., McBratney, A.B. &amp; Chittleborough, D.J.</strong> 1995. Further results on prediction of soil properties from terrain attributes: Heterotopic cokriging and regression-kriging. <em>Geoderma</em>, 67: 215â€“226. <a href="https://doi.org/10.1016/0016-7061(95)00007-B">https://doi.org/10.1016/0016-7061(95)00007-B</a>
</div>
<div class="csl-entry">
<strong>Odgers, N.P., McBratney, A.B. &amp; Minasny, B.</strong> 2011. Bottom-up digital soil mapping. <span>I</span>. <span>S</span>oil layer classes. <em>Geoderma</em>, 163: 38â€“44. <a href="https://doi.org/10.1016/j.geoderma.2011.03.014">https://doi.org/10.1016/j.geoderma.2011.03.014</a>
</div>
<div class="csl-entry">
<strong>Orton, T.G., Pringle, M.J., Page, K.L., Dalal, R.C. &amp; Bishop, T.F.A.</strong> 2014. Spatial prediction of soil organic carbon stock using a linear model of coregionalisation. <em>Geoderma</em>, 230â€“231: 119â€“130. <a href="https://doi.org/10.1016/j.geoderma.2014.04.016">https://doi.org/10.1016/j.geoderma.2014.04.016</a>
</div>
<div class="csl-entry">
<strong>Padarian, J. &amp; McBratney, A.B.</strong> 2023. <span>QuadMap</span>: Variable resolution maps to communicate uncertainty. <em>Computers and Geosciences</em>, 181: 105480. <a href="https://doi.org/10.1016/j.cageo.2023.105480">https://doi.org/10.1016/j.cageo.2023.105480</a>
</div>
<div class="csl-entry">
<strong>Prieto-Castrillo, F., RodrÃ­guez-Rastrero, M., Yunta, F., Borondo, F. &amp; Borondo, J.</strong> 2023. Disentangling jennyâ€™s equation by machine learning. <em>Scientific Reports</em>, 13(1): 20916. <a href="https://doi.org/10.1038/s41598-023-44171-x">https://doi.org/10.1038/s41598-023-44171-x</a>
</div>
<div class="csl-entry">
<strong>Roberts, D.R. &amp; others</strong>. 2017. Cross-validation strategies for data with temporal, spatial, hierarchical, or phylogenetic structure. <em>Ecography</em>, 40: 913â€“929. <a href="https://doi.org/10.1111/ecog.02881">https://doi.org/10.1111/ecog.02881</a>
</div>
<div class="csl-entry">
<strong>Robertson, B.L., Brown, J.A., McDonald, T. &amp; Jaksons, P.</strong> 2013. <span>BAS</span>: Balanced acceptance sampling of natural resources. <em>Biometrics</em>, 69(3): 776â€“784. <a href="https://doi.org/10.1111/biom.12059">https://doi.org/10.1111/biom.12059</a>
</div>
<div class="csl-entry">
<strong>Saurette, D.D., Berg, A., Laamrani, A., Heck, R.J., Gillespie, A.W. &amp; Biswas, A.</strong> 2023. Determining optimal sample size for soil spectroscopy applications: Learning curves and model validation. <em>Soil Science Society of America Journal</em>, 87(6): 1557â€“1572. <a href="https://doi.org/10.1002/saj2.20608">https://doi.org/10.1002/saj2.20608</a>
</div>
<div class="csl-entry">
<strong>Schmidinger, J., Heuvelink, G.B.M. &amp; Brus, D.J.</strong> 2024. Sampling design optimization for soil mapping with random forest. <em>Geoderma</em>, 444: 116849. <a href="https://doi.org/10.1016/j.geoderma.2024.116849">https://doi.org/10.1016/j.geoderma.2024.116849</a>
</div>
<div class="csl-entry">
<strong>Stevens, D.L. &amp; Olsen, A.R.</strong> 2004. Spatially balanced sampling of natural resources. <em>Journal of the American Statistical Association</em>, 99(465): 262â€“278. <a href="https://doi.org/10.1198/016214504000000250">https://doi.org/10.1198/016214504000000250</a>
</div>
<div class="csl-entry">
<strong>Styc, Q. &amp; Lagacherie, P.</strong> 2021. Combining spatial-environmental covariates and soil input data types to predict soil available water holding capacity. <em>Geoderma</em>, 401: 115171. <a href="https://doi.org/10.1016/j.geoderma.2021.115171">https://doi.org/10.1016/j.geoderma.2021.115171</a>
</div>
<div class="csl-entry">
<strong>Wadoux, A.M.J.-C., Minasny, B. &amp; McBratney, A.B.</strong> 2021. Machine learning for digital soil mapping: Applications, challenges and suggested solutions. <em>Earth-Science Reviews</em>, 210: 103359. <a href="https://doi.org/10.1016/j.earscirev.2020.103359">https://doi.org/10.1016/j.earscirev.2020.103359</a>
</div>
<div class="csl-entry">
<strong>Webster, R., Lessells, C.M. &amp; Hodgson, J.M.</strong> 1979. A reconnaissance soil survey of the ivybridge area of south devon. <em>Soil Survey Technical Monograph</em>, 12.
</div>
<div class="csl-entry">
<strong>Webster, R. &amp; Oliver, M.A.</strong> 2007. <em>Geostatistics for environmental scientists</em>. 2nd edition. Chichester, John Wiley &amp; Sons.
</div>
<div class="csl-entry">
<strong>Zhang, L., Heuvelink, G.B.M., Mulder, V.L., Chen, S., Deng, X. &amp; Yang, L.</strong> 2024. Using process-oriented model output to enhance machine learning-based soil organic carbon prediction in space and time. <em>Science of the Total Environment</em>, 922: 170778. <a href="https://doi.org/10.1016/j.scitotenv.2024.170778">https://doi.org/10.1016/j.scitotenv.2024.170778</a>
</div>
</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body">
<div id="ref-borden2020" class="csl-entry">
<strong>Borden, K.A., Thomas, J.E. &amp; Rivard, C.</strong> 2020. Evaluation of diverse cover crop mixtures for use in semi-arid irrigated production systems. <em>Renewable Agriculture and Food Systems</em>, 35(3): 286â€“296. <a href="https://doi.org/10.1017/S1742170518000509">https://doi.org/10.1017/S1742170518000509</a>
</div>
<div id="ref-brevik2016" class="csl-entry">
<strong>Brevik, E.C., Calzolari, C., Miller, B.A., Pereira, P., Kabala, C., Baumgarten, A. &amp; JordÃ¡n, A.</strong> 2016. Soil mapping, classification, and pedologic modeling: History and future directions. <em>Geoderma</em>, 264: 256â€“274. <a href="https://doi.org/10.1016/j.geoderma.2015.05.017">https://doi.org/10.1016/j.geoderma.2015.05.017</a>
</div>
<div id="ref-brus2022" class="csl-entry">
<strong>Brus, D.J.</strong> 2022. Sampling for digital soil mapping: A tutorial supported by <span>R</span> scripts. <em>Geoderma</em>, 338: 464â€“480. <a href="https://doi.org/10.1016/j.geoderma.2018.07.036">https://doi.org/10.1016/j.geoderma.2018.07.036</a>
</div>
<div id="ref-brus2018" class="csl-entry">
<strong>Brus, D.J., Kempen, B. &amp; Heuvelink, G.B.M.</strong> 2011 b. Sampling for validation of digital soil maps. <em>European Journal of Soil Science</em>, 62(3): 394â€“407. <a href="https://doi.org/10.1111/j.1365-2389.2011.01364.x">https://doi.org/10.1111/j.1365-2389.2011.01364.x</a>
</div>
<div id="ref-brus2021" class="csl-entry">
<strong>Brus, D.J., Kempen, B. &amp; Heuvelink, G.B.M.</strong> 2011 a. Sampling for digital soil mapping: A tutorial supported by <span>R</span> scripts. <em>Geoderma</em>, 338: 464â€“480. <a href="https://doi.org/10.1016/j.geoderma.2018.07.036">https://doi.org/10.1016/j.geoderma.2018.07.036</a>
</div>
<div id="ref-bui2020" class="csl-entry">
<strong>Bui, E.</strong> 2020. Soil survey as a knowledge system. <em>Geoderma</em>, 359: 113948. <a href="https://doi.org/10.1016/j.geoderma.2019.113948">https://doi.org/10.1016/j.geoderma.2019.113948</a>
</div>
<div id="ref-clay2018" class="csl-entry">
<strong>Clay, D.E., Chang, J., Malo, D.D., Carlson, C.G., Reese, C., Clay, S.A., Ellsbury, M. &amp; Berg, B.</strong> 2001. Factors influencing spatial variability of soil apparent electrical conductivity. <em>Communications in Soil Science and Plant Analysis</em>, 32(19-20): 2993â€“3008. <a href="https://doi.org/10.1081/CSS-120001104">https://doi.org/10.1081/CSS-120001104</a>
</div>
<div id="ref-gobin2000" class="csl-entry">
<strong>Gobin, A., Campling, P. &amp; Feyen, J.</strong> 2001. Soil-landscape modelling to quantify spatial variability of soil texture. <em>Physics and Chemistry of the Earth, Part B: Hydrology, Oceans and Atmosphere</em>, 26(1): 41â€“45. <a href="https://doi.org/10.1016/S1464-1909(01)85011-7">https://doi.org/10.1016/S1464-1909(01)85011-7</a>
</div>
<div id="ref-degruijter2006" class="csl-entry">
<strong>Gruijter, J.J. de, Brus, D.J., Bierkens, M.F.P. &amp; Knotters, M.</strong> 2006. <em><a href="https://doi.org/10.1007/3-540-33161-1">Sampling for natural resource monitoring</a></em>. Berlin, Springer.
</div>
<div id="ref-ma2020" class="csl-entry">
<strong>Ma, Y., Minasny, B., Weerts, A., Poggio, L., Malone, B. &amp; McBratney, A.</strong> 2020. Comparison of conditioned <span>Latin</span> hypercube and feature space coverage sampling for predicting soil classes using simulation from soil maps. <em>Geoderma</em>, 370: 114366. <a href="https://doi.org/10.1016/j.geoderma.2020.114366">https://doi.org/10.1016/j.geoderma.2020.114366</a>
</div>
<div id="ref-milne1936" class="csl-entry">
<strong>Milne, G.</strong> 1936. Normal erosion as a factor in soil profile development. <em>Nature</em>, 138: 548â€“549. <a href="https://doi.org/10.1038/138548c0">https://doi.org/10.1038/138548c0</a>
</div>
<div id="ref-minasny2006" class="csl-entry">
<strong>Minasny, B. &amp; McBratney, A.B.</strong> 2006. A conditioned <span>Latin</span> hypercube method for sampling in the presence of ancillary information. <em>Computers &amp; Geosciences</em>, 32(9): 1378â€“1388. <a href="https://doi.org/10.1016/j.cageo.2005.12.009">https://doi.org/10.1016/j.cageo.2005.12.009</a>
</div>
<div id="ref-morton2000" class="csl-entry">
<strong>Morton, P.A. &amp; Heinemeyer, O.</strong> 2000. Soil sampling and preparation. <em>Methods in Ecosystem Science</em>: 85â€“94.
</div>
<div id="ref-norris2020" class="csl-entry">
<strong>Norris, C.E., Quideau, S.A., Landhausser, S.M., Bernard, G.M. &amp; Wasylishen, R.E.</strong> 2013. Tracking stable isotope enrichment in tree seedlings with solid-state <span><span class="math inline">\(^{15}\)</span>N</span> <span>NMR</span> spectroscopy. <em>Biogeosciences</em>, 10: 3433â€“3445. <a href="https://doi.org/10.5194/bg-10-3433-2013">https://doi.org/10.5194/bg-10-3433-2013</a>
</div>
<div id="ref-robertson2013" class="csl-entry">
<strong>Robertson, B.L., Brown, J.A., McDonald, T. &amp; Jaksons, P.</strong> 2013. <span>BAS</span>: Balanced acceptance sampling of natural resources. <em>Biometrics</em>, 69(3): 776â€“784. <a href="https://doi.org/10.1111/biom.12059">https://doi.org/10.1111/biom.12059</a>
</div>
<div id="ref-saurette2023" class="csl-entry">
<strong>Saurette, D.D., Berg, A., Laamrani, A., Heck, R.J., Gillespie, A.W. &amp; Biswas, A.</strong> 2023. Determining optimal sample size for soil spectroscopy applications: Learning curves and model validation. <em>Soil Science Society of America Journal</em>, 87(6): 1557â€“1572. <a href="https://doi.org/10.1002/saj2.20608">https://doi.org/10.1002/saj2.20608</a>
</div>
<div id="ref-schmidinger2024" class="csl-entry">
<strong>Schmidinger, J., Heuvelink, G.B.M. &amp; Brus, D.J.</strong> 2024. Sampling design optimization for soil mapping with random forest. <em>Geoderma</em>, 444: 116849. <a href="https://doi.org/10.1016/j.geoderma.2024.116849">https://doi.org/10.1016/j.geoderma.2024.116849</a>
</div>
<div id="ref-stevens1999" class="csl-entry">
<strong>Stevens, D.L. &amp; Olsen, A.R.</strong> 2004. Spatially balanced sampling of natural resources. <em>Journal of the American Statistical Association</em>, 99(465): 262â€“278. <a href="https://doi.org/10.1198/016214504000000250">https://doi.org/10.1198/016214504000000250</a>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>Soils4Africa Project Secretariat. Avaliable at: <a href="https://www.soils4africa-h2020.eu/" class="uri">https://www.soils4africa-h2020.eu/</a><a href="sampling-design-for-soil-surveys.html#fnref1" class="footnote-back">â†©ï¸Ž</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="spatial-analysis-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="appendices.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": {},
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  },
  "fig_caption": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
